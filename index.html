<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{
      position:absolute;
      transform:translate(-50%,-50%);
      background:var(--yellow);
      color:#111;
      border:1px solid #fff;
      border-radius:999px;
      padding:6px 8px;
      font-size:11px;
      line-height:1;
      text-align:center;
      min-width:72px;
      max-width:90px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .marker .placeholder-name-field {
        opacity: 0.6;
    }

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem; min-width: 80px;}

    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 100;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    #close-video-modal{
        position: absolute;
        top: -10px;
        right: -10px;
        z-index: 110;
        font-size: 1.2rem;
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
        border-radius: var(--radius);
        overflow: hidden;
    }

    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}

    /* === Effetti di transizione per le sezioni visibili (.content-section) === */
    .content-section {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }
    .content-section.active {
      opacity: 1;
      pointer-events: all;
    }
  </style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; // Usato nella sezione admin-video-section

    // Variabili Globali per le sezioni Admin
    let currentMatchIdFormazione = null;
    let currentMatchIdRisultato = null;
    let currentMatchIdStatistiche = null;
    let currentMatchIdCandidature = null;
    let playersData = {}; // Cache per i dati dei giocatori
    
    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };


    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section','video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section',
      'admin-statistiche-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section'
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; 

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); 
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin - AGGIORNATA
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); 
        
        ALL_SECTIONS.forEach(secId => { 
          const el = byId(secId); 
          if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); 
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin (FIX E NUOVE CHIAMATE)
        if(id==='admin-calendario-section'){ loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); } // CHIAMATA AGGIUNTA
        if(id==='admin-statistiche-section'){ loadStatisticheAdmin(); } // CHIAMATA AGGIUNTA
        if(id==='admin-formazione-section'){ loadPartitePerFormazioneAdmin(); } // CHIAMATA AGGIUNTA
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); 

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); 
      toggleAdminUI(); 
      
      if(user && isAdmin) {
         if(byId('admin-inserimento-giocatori-section')?.style.display !== 'block'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) – usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section');
      loadRosa(); 
      loadProssimeGiornate(false); 
      loadStatistiche();
      loadClassifica(); 
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);
      byId('crud-statistiche-save')?.addEventListener('click', saveStatistiche);
      
      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', loadStatistiche);
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', loadClassifica); 
    });
    
    /* ===== FUNZIONE: Classifica AC Tuscolano con cache Firebase (solo admin aggiorna) ===== */
    const loadClassifica = async () => {
      const classificaContent = document.getElementById('classifica-content');
      if (!classificaContent) return;

      classificaContent.innerHTML = `<div class="help">Caricamento classifica in corso...</div>`;

      try {
        const now = new Date();
        const todayKey = now.toISOString().split('T')[0];
        const snap = await get(ref(db, 'classifica_cache'));
        const cache = snap.val() || {};
        const cachedHtml = cache.html;
        const cachedDate = cache.date;

        if (cachedHtml && cachedDate === todayKey) {
          classificaContent.innerHTML = cachedHtml;
          return;
        }

        if (!isAdmin) {
          if (cachedHtml) {
            classificaContent.innerHTML = cachedHtml;
          } else {
            classificaContent.innerHTML = `<div class="help" style="color:red">La classifica non è ancora disponibile. L'amministratore provvederà all'aggiornamento.</div>`;
          }
          return;
        }

        const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
        const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
        const response = await fetch(proxy);
        const data = await response.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");
        const table = doc.querySelector(".table-responsive table") || doc.querySelector("table[class*='table']") || doc.querySelector("table");

        if (!table) {
          classificaContent.innerHTML = `<div class="help">Impossibile trovare la classifica sul sito remoto.</div>`;
          return;
        }

        // Stile AC Tuscolano (Omesso per brevità, ma nell'originale)
        // ... Logica di styling e pulizia della tabella ...

        const htmlContent = `
          <div class="help">Classifica aggiornata automaticamente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto;">${table.outerHTML}</div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
          <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
        `;

        classificaContent.innerHTML = htmlContent;
        await set(ref(db, 'classifica_cache'), {
          html: htmlContent,
          date: todayKey,
          timestamp: Date.now()
        });
      } catch (error) {
        console.error("Errore caricamento classifica:", error);
        const snapFallback = await get(ref(db, 'classifica_cache'));
        const cache = snapFallback.val();
        if (cache && cache.html) {
          classificaContent.innerHTML = cache.html;
        } else {
          classificaContent.innerHTML = `<div class="help" style="color:red">Errore nel recupero della classifica.</div>`;
        }
      }
    };

    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; 
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); 
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); 
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Aggiunte/Corrette: Formazione, Candidature, Statistiche Admin ===== */
    
    /* ===== Utilità: Carica Giocatori in Cache ===== */
    const loadGiocatoriRosa = async () => {
        const snap = await get(ref(db, 'rosa'));
        playersData = snap.val() || {};
        return playersData;
    };

    /* ---------------------------------------------------------------------- */
    /* Sezione Formazione Admin (FIX: Popola Dropdown e Abilita Drag & Drop) */
    /* ---------------------------------------------------------------------- */

    const loadPartitePerFormazioneAdmin = async () => {
        const select = byId('formazione-match-select');
        if (!select) return;
        select.innerHTML = '<option value="">Caricamento...</option>';
        select.removeEventListener('change', updateFormazioneFormOnSelect);
        
        try {
            await loadGiocatoriRosa(); 
            const snapshot = await get(ref(db, 'calendario'));
            const partite = snapshot.val() || {};
            let options = '<option value="">Seleziona una partita (Futura/Recente)</option>';
            const today = new Date(); today.setHours(0, 0, 0, 0);

            const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[a].data) - toDate(partite[b].data));
            
            sortedKeys.forEach(key => {
                const p = partite[key];
                const matchDate = toDate(p.data);
                const isPast = matchDate < today;
                
                // Mostra partite future O partite passate ma senza risultato
                if (!isPast || !p.risultato || p.risultato === 'N/D') {
                    const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
                    options += `<option value="${key}">vs ${avversario} - ${p.data}</option>`;
                }
            });

            select.innerHTML = options;
            select.addEventListener('change', updateFormazioneFormOnSelect);
            updateFormazioneFormOnSelect(); 
            
        } catch(error) {
            console.error("Errore caricamento partite admin formazione:", error);
            select.innerHTML = '<option value="">Errore caricamento</option>';
        }
    };

    const updateFormazioneFormOnSelect = () => {
        const select = byId('formazione-match-select');
        currentMatchIdFormazione = select.value;
        if (currentMatchIdFormazione) {
            loadFormazione(currentMatchIdFormazione); 
            byId('formazione-editor-container').style.display = 'block';
        } else {
            byId('formazione-field').innerHTML = '<div class="help" style="margin-top:20px; text-align:center">Seleziona una partita per gestire la formazione.</div>';
            byId('formazione-sostituti').innerHTML = '';
            byId('formazione-pubblica-toggle').style.display = 'none';
            byId('formazione-editor-container').style.display = 'none';
        }
    };

    const loadFormazione = async (matchId) => {
        if (!matchId) return;

        const fieldEl = byId('formazione-field');
        const subsEl = byId('formazione-sostituti');
        fieldEl.innerHTML = '<div class="help" style="margin-top:20px; text-align:center">Caricamento formazione...</div>';
        subsEl.innerHTML = '';
        byId('formazione-pubblica-toggle').style.display = 'block';

        const matchSnap = await get(ref(db, `calendario/${matchId}`));
        const matchData = matchSnap.val() || {};
        const formazione = matchData.formazione || {};
        const isPublished = matchData.formazionePubblicata === true;

        byId('pubblica-formazione-checkbox').checked = isPublished;

        const giocatori = playersData; 
        
        let initialSetup = [];
        let sostituti = [];
        let allPlayerUidsInMatch = new Set();
        
        // Raccolta di tutti gli UID presenti in rosa.
        Object.keys(giocatori).forEach(uid => allPlayerUidsInMatch.add(uid));

        // 1. Identifica titolari e sostituti predefiniti
        Object.keys(giocatori).forEach(uid => {
            const g = giocatori[uid];
            let position = null;
            let isSub = false;

            // Cerca se è in campo
            for (const pos in formazione) {
                if (formazione[pos] === uid) {
                    position = pos;
                    initialSetup.push({ uid: uid, nome: g.nome + ' ' + g.cognome, numero: g.numero, posizione: position });
                    return; 
                }
            }

            // Cerca se è un sostituto salvato
            if (matchData.sostituti && matchData.sostituti[uid]) {
                sostituti.push({ uid: uid, nome: g.nome + ' ' + g.cognome, numero: g.numero });
                return;
            }
            
            // Se non è né titolare né sostituto salvato, e non è in formazione (e quindi non in initialSetup),
            // lo aggiungiamo alla lista dei "disponibili" (sostituti) per il drag & drop
            if (!position) {
                 sostituti.push({ uid: uid, nome: g.nome + ' ' + g.cognome, numero: g.numero });
            }
        });

        // 2. Rimuove duplicati e ordina i sostituti (potrebbero esserci duplicati se usiamo il filtraggio precedente)
        const uniqueSubsMap = sostituti.reduce((acc, sub) => {
            if (!initialSetup.find(p => p.uid === sub.uid)) {
                acc[sub.uid] = sub;
            }
            return acc;
        }, {});
        
        const uniqueSortedSubs = Object.values(uniqueSubsMap).sort((a, b) => a.numero - b.numero);

        // 3. Genera la UI del campo e dei sostituti (Draggable/Droppable)
        fieldEl.innerHTML = generateFieldHTML(initialSetup);
        subsEl.innerHTML = `<h3>Sostituti disponibili (Trascina sul campo)</h3><div id="subs-drag-container" style="display:flex; flex-wrap:wrap; gap:8px;">${generateSubsHTML(uniqueSortedSubs)}</div>`;

        // 4. Attiva Draggable e Droppable
        initDragAndDrop();
    };

    const generateFieldHTML = (initialSetup) => {
        // Formazione 4-2-1
        const positions = {
            'P': { left: '50%', top: '10%', name: 'Portiere (P)' },
            'TD': { left: '10%', top: '35%', name: 'Terzino Dx (TD)' }, 'DC1': { left: '35%', top: '35%', name: 'Difensore C (DC)' }, 'DC2': { left: '65%', top: '35%', name: 'Difensore C (DC)' }, 'TS': { left: '90%', top: '35%', name: 'Terzino Sx (TS)' },
            'CC1': { left: '30%', top: '60%', name: 'Centrocampo (CC)' }, 'CC2': { left: '70%', top: '60%', name: 'Centrocampo (CC)' },
            'ATT': { left: '50%', top: '85%', name: 'Attaccante (ATT)' }
        };

        let markersHTML = '';
        Object.keys(positions).forEach(posId => {
            const pos = positions[posId];
            const player = initialSetup.find(p => p.posizione === posId);
            
            const playerInfo = player ? 
                `<span class="player-name-field" data-uid="${player.uid}" data-position="${posId}">#${player.numero} ${player.nome}</span>` : 
                `<span class="placeholder-name-field" data-position="${posId}">${pos.name}</span>`;

            markersHTML += `
                <div 
                    class="marker formation-droppable" 
                    data-position="${posId}" 
                    style="left:${pos.left}; top:${pos.top}"
                    data-uid-attualmente-dentro="${player ? player.uid : ''}"
                >
                    ${playerInfo}
                </div>
            `;
        });

        return `<div class="field" id="drag-field-container">${markersHTML}</div><div class="help" style="margin-top:10px;">Trascina i giocatori dal pannello 'Sostituti' al campo. Per spostare un giocatore dal campo alla panchina, trascinalo sulla sezione "Sostituti disponibili".</div>`;
    };

    const generateSubsHTML = (sostituti) => {
        return sostituti.map(g => `
            <div 
                class="pill formation-draggable" 
                data-uid="${g.uid}"
                style="cursor:move;"
            >
                #${g.numero} ${g.nome}
            </div>
        `).join('');
    };

    const initDragAndDrop = () => {
        $(".formation-draggable").draggable({
            revert: "invalid",
            helper: "clone",
            cursor: "move",
            start: function(event, ui) {
                $(this).addClass("is-dragging");
                ui.helper.css({
                    'background': 'var(--red)',
                    'color': 'white',
                    'box-shadow': '0 4px 8px rgba(0,0,0,.25)'
                });
            },
            stop: function(event, ui) {
                $(this).removeClass("is-dragging");
            }
        });

        $(".formation-droppable").droppable({
            accept: ".formation-draggable",
            drop: function(event, ui) {
                const $droppable = $(this);
                const $draggable = ui.draggable;
                const playerUid = $draggable.data('uid');
                const positionId = $droppable.data('position');

                // 1. Rimuovi il giocatore dal suo spot precedente, se esiste
                const prevUid = $droppable.data('uid-attualmente-dentro');
                if (prevUid) {
                    const $prevPlayerNameEl = $droppable.find('.player-name-field');
                    const prevNameWithNum = $prevPlayerNameEl.text().trim();
                    const prevPositionName = $prevPlayerNameEl.closest('.marker').text().trim().split(' ')[0]; // Esempio: P: Portiere (P)
                    
                    // Crea un nuovo elemento draggable per il giocatore che esce
                    const newPill = `<div class="pill formation-draggable" data-uid="${prevUid}" style="cursor:move;">${prevNameWithNum}</div>`;
                    $("#subs-drag-container").append(newPill);
                    initDragAndDrop(); 
                }
                
                // 2. Aggiorna lo spot con il nuovo giocatore
                $droppable.data('uid-attualmente-dentro', playerUid);
                const playerName = $draggable.text().trim();
                const positionNamePlaceholder = $droppable.find('.placeholder-name-field').text().trim();
                
                $droppable.html(`
                    <span class="player-name-field" data-uid="${playerUid}" data-position="${positionId}">${playerName}</span>
                `);
                
                // 3. Rimuovi l'elemento dalla lista dei sostituti
                $draggable.remove();
                
                // 4. Salva immediatamente la formazione nel database
                saveFormazione(currentMatchIdFormazione);
            }
        });
        
        // Zona di 'revert' per i giocatori rimossi dal campo (ritornano sostituti)
        $("#subs-drag-container").droppable({
            accept: ".formation-draggable",
            drop: function(event, ui) {
                const $draggable = ui.draggable;
                const playerUid = $draggable.data('uid');
                
                // Controlla se il draggable proveniva da un marker del campo (se non era già nella lista sostituti)
                if ($draggable.closest('.formation-droppable').length > 0) {
                    const $prevDroppable = $draggable.closest('.formation-droppable');
                    const positionId = $prevDroppable.data('position');
                    const positionName = $prevDroppable.data('position'); // Esempio P, TD, ATT

                    // Ripristina il marker del campo
                    $prevDroppable.data('uid-attualmente-dentro', '');
                    $prevDroppable.html(`
                        <span class="placeholder-name-field" data-position="${positionId}">${positionName}: Trascina qui il giocatore</span>
                    `);

                    // Aggiungi di nuovo il giocatore alla lista sostituti e riattiva D&D
                    $("#subs-drag-container").append($draggable.clone().removeClass("ui-draggable-dragging is-dragging"));
                    $draggable.remove(); // Rimuove l'helper temporaneo
                    initDragAndDrop();
                    
                    // Salva immediatamente la formazione
                    saveFormazione(currentMatchIdFormazione);
                }
            }
        });
    };
    
    // Funzione di salvataggio formazione
    const saveFormazione = async (matchId = currentMatchIdFormazione) => {
        if (!matchId) return alert("Seleziona una partita per salvare.");

        const formazione = {};
        const sostituti = {};
        
        // 1. Raccogli i titolari dal campo
        $('.formation-droppable').each(function() {
            const uid = $(this).data('uid-attualmente-dentro');
            const pos = $(this).data('position');
            if (uid) {
                formazione[pos] = uid;
            }
        });

        // 2. Raccogli i sostituti dalla lista
        $('#subs-drag-container .formation-draggable').each(function() {
            const uid = $(this).data('uid');
            sostituti[uid] = true; 
        });
        
        const isPublished = byId('pubblica-formazione-checkbox').checked;

        try {
            const updates = {};
            updates[`/calendario/${matchId}/formazione`] = formazione;
            updates[`/calendario/${matchId}/sostituti`] = sostituti;
            updates[`/calendario/${matchId}/formazionePubblicata`] = isPublished;

            await update(ref(db), updates);
            // alert('Formazione e sostituti salvati con successo!'); // Evita alert continui
        } catch(error) {
            alert('Errore salvataggio formazione: ' + error.message);
            console.error(error);
        }
    };
    
    // Funzione chiamata dal pulsante Formazione & Sost. (FIX ERRORE)
    window.showFormazioneForm = async (matchId, avversaria) => {
        if (!isAdmin) return showLogin(); 
        
        window.showAdminSection('admin-formazione-section');
        
        // Forza il caricamento dei dati e la selezione
        await loadPartitePerFormazioneAdmin(); 
        
        const select = byId('formazione-match-select');
        if (select && select.querySelector(`option[value="${matchId}"]`)) {
            select.value = matchId; 
            updateFormazioneFormOnSelect(); 
            // alert(`Formazione per partita vs ${avversaria} caricata.`);
        } else {
            alert("Errore: La partita non è stata trovata o non è idonea per la formazione.");
        }
    };
    
    /* -------------------------------------------------------- */
    /* Sezione Candidature Admin (FIX: Popola Dropdown) */
    /* -------------------------------------------------------- */
    
    const loadPartitePerCandidature = async () => {
        const select = byId('candidature-match-select');
        if (!select) return;
        select.innerHTML = '<option value="">Caricamento...</option>';
        select.removeEventListener('change', updateCandidatureFormOnSelect);
        
        try {
            await loadGiocatoriRosa(); 
            const snapshot = await get(ref(db, 'calendario'));
            const partite = snapshot.val() || {};
            let options = '<option value="">Seleziona una partita futura</option>';
            const today = new Date(); today.setHours(0, 0, 0, 0);

            const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[a].data) - toDate(partite[b].data));
            
            sortedKeys.forEach(key => {
                const p = partite[key];
                const matchDate = toDate(p.data);
                const isFuture = matchDate >= today;
                
                if (isFuture) {
                    const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
                    options += `<option value="${key}">vs ${avversario} - ${p.data}</option>`;
                }
            });

            select.innerHTML = options;
            select.addEventListener('change', updateCandidatureFormOnSelect);
            updateCandidatureFormOnSelect(); 
            
        } catch(error) {
            console.error("Errore caricamento partite admin candidature:", error);
            select.innerHTML = '<option value="">Errore caricamento</option>';
        }
    };
    
    const loadCandidature = () => {
        loadPartitePerCandidature();
    }
    
    const updateCandidatureFormOnSelect = () => {
        const select = byId('candidature-match-select');
        currentMatchIdCandidature = select.value;
        if (currentMatchIdCandidature) {
            loadMatchCandidature(currentMatchIdCandidature);
            byId('candidature-table-container').style.display = 'block';
        } else {
            byId('crud-candidature-body').innerHTML = '';
            byId('candidature-table-container').style.display = 'none';
        }
    };
    
    const loadMatchCandidature = async (matchId) => {
        const tbody = byId('crud-candidature-body');
        tbody.innerHTML = '<tr><td colspan="3">Caricamento giocatori...</td></tr>';
        
        try {
            const snapCandidature = await get(ref(db, `calendario/${matchId}/candidature`));
            const candidature = snapCandidature.val() || {};
            
            const giocatori = playersData; 
            let html = '';
            
            const sortedPlayers = Object.entries(giocatori).sort((a, b) => (a[1].numero || 0) - (b[1].numero || 0));

            for (const [uid, g] of sortedPlayers) {
                const isCandidato = candidature[uid] === true; 
                
                html += `
                    <tr>
                        <td>${g.nome} ${g.cognome} (#${g.numero})</td>
                        <td><small>${uid}</small></td>
                        <td>
                            <input type="checkbox" data-uid="${uid}" ${isCandidato ? 'checked' : ''} onchange="toggleCandidatura('${matchId}', '${uid}', this.checked)">
                        </td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html || '<tr><td colspan="3">Nessun giocatore in rosa.</td></tr>';
            
        } catch(error) {
            console.error("Errore caricamento candidature:", error);
            tbody.innerHTML = '<tr><td colspan="3">Errore nel caricamento delle candidature.</td></tr>';
        }
    };

    window.toggleCandidatura = async (matchId, uid, isChecked) => {
        if (!isAdmin) return alert("Solo admin può modificare.");
        
        try {
            const path = `calendario/${matchId}/candidature/${uid}`;
            if (isChecked) {
                await set(ref(db, path), true);
            } else {
                await remove(ref(db, path));
            }
            console.log(`Candidatura per ${uid} aggiornata.`);
        } catch(e) {
            alert('Errore aggiornamento candidatura: ' + e.message);
            console.error(e);
        }
    };
    
    /* -------------------------------------------------------- */
    /* Sezione Statistiche Admin (FIX: Popola Dropdown) */
    /* -------------------------------------------------------- */

    const loadPartitePerStatistiche = async () => {
        const select = byId('statistiche-match-select');
        if (!select) return;
        select.innerHTML = '<option value="">Caricamento...</option>';
        select.removeEventListener('change', updateStatisticheFormOnSelect);

        try {
            await loadGiocatoriRosa(); 
            const snapshot = await get(ref(db, 'calendario'));
            const partite = snapshot.val() || {};
            let options = '<option value="">Seleziona una partita conclusa</option>';

            const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));
            
            sortedKeys.forEach(key => {
                const p = partite[key];
                if (p.risultato && p.risultato !== 'N/D') {
                    const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
                    const statsStatus = p.statistiche ? ' [STATS ESISTENTI]' : '';
                    options += `<option value="${key}">vs ${avversario} - ${p.risultato} (${p.data})${statsStatus}</option>`;
                }
            });

            select.innerHTML = options;
            select.addEventListener('change', updateStatisticheFormOnSelect);
            updateStatisticheFormOnSelect(); 
            
        } catch(error) {
            console.error("Errore caricamento partite admin statistiche:", error);
            select.innerHTML = '<option value="">Errore caricamento</option>';
        }
    };
    
    const loadStatisticheAdmin = () => {
        loadPartitePerStatistiche();
    };

    const updateStatisticheFormOnSelect = () => {
        const select = byId('statistiche-match-select');
        currentMatchIdStatistiche = select.value;
        if (currentMatchIdStatistiche) {
            loadMatchStats(currentMatchIdStatistiche);
            byId('statistiche-table-container').style.display = 'block';
        } else {
            byId('crud-statistiche-body').innerHTML = '';
            byId('statistiche-table-container').style.display = 'none';
        }
    };
    
    const loadMatchStats = async (matchId) => {
        const tbody = byId('crud-statistiche-body');
        tbody.innerHTML = '<tr><td colspan="5">Caricamento statistiche...</td></tr>';
        
        try {
            const snapStats = await get(ref(db, `calendario/${matchId}/statistiche`));
            const matchStats = snapStats.val() || {};
            
            const giocatori = playersData; 
            let html = '';
            
            const sortedPlayers = Object.entries(giocatori).sort((a, b) => (a[1].numero || 0) - (b[1].numero || 0));
            
            sortedPlayers.forEach(([uid, g]) => {
                const stats = matchStats[uid] || {};
                const goals = stats.gol || 0;
                const assists = stats.assist || 0;
                const yellow = stats.gialli || 0;
                const red = stats.rossi || 0;
                
                html += `
                    <tr>
                        <td>${g.nome} ${g.cognome} (#${g.numero})</td>
                        <td><input type="number" min="0" data-uid="${uid}" data-stat="gol" value="${goals}"></td>
                        <td><input type="number" min="0" data-uid="${uid}" data-stat="assist" value="${assists}"></td>
                        <td><input type="number" min="0" data-uid="${uid}" data-stat="gialli" value="${yellow}"></td>
                        <td><input type="number" min="0" data-uid="${uid}" data-stat="rossi" value="${red}"></td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="5">Nessun giocatore in rosa.</td></tr>';
            
        } catch(error) {
            console.error("Errore caricamento statistiche:", error);
            tbody.innerHTML = '<tr><td colspan="5">Errore nel caricamento delle statistiche.</td></tr>';
        }
    };

    const saveStatistiche = async () => {
        if (!isAdmin) return alert("Solo admin può salvare.");
        if (!currentMatchIdStatistiche) return alert("Seleziona una partita per salvare.");

        const statistiche = {};
        
        $('#crud-statistiche-body input').each(function() {
            const $input = $(this);
            const uid = $input.data('uid');
            const stat = $input.data('stat');
            const value = parseInt($input.val()) || 0;
            
            if (!statistiche[uid]) {
                statistiche[uid] = {};
            }
            if (value > 0) {
                statistiche[uid][stat] = value;
            }
        });
        
        try {
            const updates = {};
            updates[`/calendario/${currentMatchIdStatistiche}/statistiche`] = Object.keys(statistiche).length > 0 ? statistiche : null;

            await update(ref(db), updates);
            alert('Statistiche salvate con successo!');
            loadPartitePerStatistiche(); 
            window.loadStatistiche(); 
        } catch(error) {
            alert('Errore salvataggio statistiche: ' + error.message);
            console.error(error);
        }
    };
    
    
    /* ===== Funzioni Originali dell'Utente (Mockup per completezza) ===== */
    async function loadRosa(){ 
        const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML=''; 
        const snap = await get(ref(db,'rosa')); const val = snap.val() || {}; 
        const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0)); 
        if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; } 
        ul.className='grid cols-2'; 
        rows.forEach(([id,g])=>{ const li = document.createElement('li'); li.className='card'; 
        li.innerHTML = ` <div class="row" style="justify-content:space-between"> <div> <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div> <div class="player-sub">Ruolo: <b>${g.ruolo}</b> • Stato: <b>${g.stato}</b></div> </div> </div>`; 
        ul.appendChild(li); }); 
    } 
    
    async function loadProssimeGiornate(asAdmin){ 
        const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list'; 
        const ul = byId(listId); if(!ul) return; ul.innerHTML=''; 
        const snap = await get(ref(db,'calendario')); const val = snap.val() || {}; 
        let entries = Object.entries(val); 
        const today = new Date(); today.setHours(0, 0, 0, 0); 
        entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data)); 
        if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; } 
        ul.className='grid cols-3'; 
        for(const [matchId,m] of entries){ 
            const candSnap = await get(ref(db,`calendario/${matchId}/candidature`)); 
            const cand = candSnap.val() || {}; 
            const candCount = Object.values(cand).filter(Boolean).length; 
            const isPublished = m.formazionePubblicata === true; 
            const matchDate = toDate(m.data); 
            const isPast = matchDate < today; 
            let candButton = ''; 
            if (isPast) { 
                candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`; 
            } else { 
                candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`; 
            } 
            const li = document.createElement('li'); li.className='card'; 
            li.innerHTML = ` <div class="row" style="justify-content:space-between;align-items:flex-start"> <div> <div style="font-weight:800;font-size:1.05rem">vs ${m.avversaria}</div> <div class="player-sub">${m.data} • ${m.orario} • ${m.campo} • ${m.casa? 'Casa':'Trasferta'}</div> <div class="player-sub">Candidature: <b>${candCount}</b></div> <div class="player-sub">Risultato: <b>${m.risultato||'N/D'}</b></div> </div> <div class="row"> ${!asAdmin ? ` ${candButton} ${isPublished ? `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria)}')">Vedi Formazione</button>` : ''} `:''} ${asAdmin ? ` <button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria)}')">Formazione & Sost.</button> <button class="btn btn--admin" onclick="showRisultatoForm('${matchId}','${escapeHtml(m.avversaria)}')">Risultato</button> `:''} </div> </div>`; 
            ul.appendChild(li); 
        } 
    } 
    window.candidati = async(matchId)=>{ 
        const user = auth.currentUser; 
        if(!user){ showLogin(); alert('Per candidarti devi effettuare il login.'); return; } 
        await set(ref(db,`calendario/${matchId}/candidature/${user.uid}`), true); 
        alert('Disponibilità inviata.'); loadProssimeGiornate(false); 
    }; 
    async function loadStatistiche(){ 
        const rl = byId('statistiche-risultati-list'); if(rl){ rl.innerHTML='<li>Caricamento risultati...</li>'; } 
        const sl = byId('statistiche-marcatori-list'); if(sl){ sl.innerHTML='<li>Caricamento marcatori...</li>'; }
        // ... (Corpo completo di loadStatistiche)
    }
    // ... (Altre funzioni come showFormazionePubblica, showRisultatoForm, ecc.)

  </script>
</head>
<body>

  <header>
    <div class="hero">
      <img src="logo.png" alt="Logo AC Tuscolano" />
      <div class="brand">
        <h1 class="club">A.C. Tuscolano</h1>
        <p class="tag">Gestione Squadra</p>
      </div>
      <button id="auth-toggle-btn" class="btn">Login</button>
    </div>
  </header>

  <nav>
    <div class="nav-wrap">
      <button class="tab" data-target="rosa-section" id="rosa-tab" aria-current="page">Rosa</button>
      <button class="tab" data-target="calendario-section" id="calendario-tab">Calendario</button>
      <button class="tab" data-target="statistiche-section" id="statistiche-tab">Statistiche</button>
      <button class="tab" data-target="classifica-section" id="classifica-tab">Classifica</button>
      <button class="tab" data-target="video-section" id="video-tab">Video Partite</button>
    </div>
  </nav>

  <div id="admin-menu">
    <div class="nav-wrap">
      <button class="tab btn--admin" data-admin-target="admin-inserimento-giocatori-section">Aggiungi Giocatore</button>
      <button class="tab btn--admin" data-admin-target="admin-inserimento-giornate-section">Aggiungi Partita</button>
      <button class="tab btn--admin" data-admin-target="admin-calendario-section">Gest. Calendario</button>
      <button class="tab btn--admin" data-admin-target="admin-formazione-section">Gest. Formazione</button>
      <button class="tab btn--admin" data-admin-target="admin-statistiche-section">Gest. Statistiche</button>
      <button class="tab btn--admin" data-admin-target="admin-candidature-section">Gest. Candidature</button>
      <button class="tab btn--admin" data-admin-target="admin-video-section">Gest. Video</button>
      <button class="tab btn--admin" data-admin-target="admin-gestione-dati-section">Crud Giocatori/Partite</button>
      <button class="tab btn--admin" data-admin-target="admin-utenti-section">Gest. Utenti</button>
    </div>
  </div>

  <main>
    <section id="login-section">
      <h2>Accesso Area Riservata</h2>
      <form id="login-form">
        <label>Email</label><input id="login-email" type="email" required />
        <label>Password</label><input id="login-password" type="password" required />
        <div class="actions"><button class="btn btn--accent" type="submit">Login</button></div>
      </form>
    </section>
    
    <section id="rosa-section" class="content-section">
      <h2>Rosa</h2>
      <ul id="rosa-list" class="grid cols-2"></ul>
    </section>

    <section id="calendario-section" class="content-section">
      <h2>Prossime Partite</h2>
      <ul id="calendario-list" class="grid cols-3"></ul>
    </section>
    
    <section id="admin-calendario-section" class="content-section" style="display:none">
      <h2>Admin · Gestione Calendario (Formazione, Risultati)</h2>
      <ul id="admin-calendario-list" class="grid cols-3"></ul>
    </section>
    
    <section id="formazione-pubblica-section" class="content-section" style="display:none">
      <h2 id="formazione-pubblica-title">Formazione vs Avversario</h2>
      <div id="formazione-pubblica-field" class="field"></div>
      <div id="formazione-pubblica-sostituti" style="margin-top:15px">
        <h3>Sostituti</h3>
        <div id="formazione-pubblica-subs-list" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
      </div>
    </section>

    <section id="admin-formazione-section" class="content-section" style="display:none">
      <h2>Admin · Gestione Formazione & Sostituti</h2>
      
      <label for="formazione-match-select">Seleziona Partita</label>
      <select id="formazione-match-select">
        <option value="">Caricamento...</option>
      </select>
      
      <div id="formazione-editor-container" style="margin-top:20px; display:none;">
        
        <div id="formazione-pubblica-toggle" style="margin-bottom:15px; display:none;">
          <input type="checkbox" id="pubblica-formazione-checkbox" onchange="saveFormazione()" style="width:auto; max-width:18px; margin-right:8px; display:inline-block;" />
          <label for="pubblica-formazione-checkbox" style="display:inline-block; margin-top:0;">Pubblica la formazione (Visibile a tutti)</label>
        </div>
        
        <div id="formazione-field" class="field">
          <div class="help" style="margin-top:20px; text-align:center">Seleziona una partita per gestire la formazione.</div>
        </div>
        
        <div id="formazione-sostituti" style="margin-top:15px">
          </div>
        
        <div class="actions" style="margin-top:20px">
          <button id="crud-formazione-save" class="btn btn--admin" type="button" onclick="saveFormazione()">Salva Formazione & Sostituti</button>
        </div>
      </div>
    </section>
    
    <section id="admin-candidature-section" class="content-section" style="display:none">
      <h2>Admin · Gestione Candidature Giocatori</h2>
      
      <label for="candidature-match-select">Seleziona Partita</label>
      <select id="candidature-match-select">
        <option value="">Caricamento...</option>
      </select>
      
      <div id="candidature-table-container" style="margin-top:20px; display:none;">
        <div class="help">Spunta/deseleziona la disponibilità dei giocatori (richiede che il giocatore abbia un utente collegato con lo stesso UID di rosa per l'auto-candidatura).</div>
        <table class="table">
          <thead><tr><th>Giocatore</th><th>UID</th><th>Disponibile</th></tr></thead>
          <tbody id="crud-candidature-body"></tbody>
        </table>
        <div class="actions" style="margin-top:10px">
          <button id="crud-candidature-save" class="btn btn--admin" type="button">Salva candidature (Automatico)</button>
        </div>
      </div>
    </section>

    <section id="admin-statistiche-section" class="content-section" style="display:none">
      <h2>Admin · Gestione Statistiche Partita</h2>
      
      <label for="statistiche-match-select">Seleziona Partita</label>
      <select id="statistiche-match-select">
        <option value="">Caricamento...</option>
      </select>
      
      <div id="statistiche-table-container" style="margin-top:20px; display:none;">
        <div class="help">Inserisci i dati statistici (Gol, Assist, Cartellini) per la partita selezionata.</div>
        <table class="table">
          <thead><tr><th>Giocatore</th><th>Gol</th><th>Assist</th><th>Gialli</th><th>Rossi</th></tr></thead>
          <tbody id="crud-statistiche-body"></tbody>
        </table>
        <div class="actions" style="margin-top:10px">
          <button id="crud-statistiche-save" class="btn btn--admin" type="button">Salva Statistiche</button>
        </div>
      </div>
    </section>

    <section id="statistiche-section" class="content-section">
      <h2>Statistiche Squadra</h2>
      <h3>Risultati Recenti</h3>
      <ul id="statistiche-risultati-list">
        <li>Caricamento...</li>
      </ul>
      <h3>Top Marcatori</h3>
      <ul id="statistiche-marcatori-list" class="grid cols-3">
        <li>Caricamento...</li>
      </ul>
    </section>
    
    <section id="video-section" class="content-section">
      <h2>Video Partite</h2>
      <ul id="video-list-ul" style="padding-top:10px">
        <li>Caricamento video...</li>
      </ul>
    </section>
    
    <section id="admin-video-section" class="content-section" style="display:none">
      <h2>Admin · Gestione Link Video</h2>
      <label for="video-partita-select">Seleziona Partita</label>
      <select id="video-partita-select">
        <option value="">Caricamento...</option>
      </select>
      
      <label for="video-link-input">Link Video YouTube</label>
      <input type="url" id="video-link-input" placeholder="Inserisci il link YouTube (es. https://youtu.be/...)"/>
      
      <div class="actions">
        <button id="save-video-btn" class="btn btn--admin" type="button" disabled>Salva Link Video</button>
      </div>
      <div class="help" style="margin-top:10px">Inserisci l'URL di YouTube del video della partita selezionata.</div>
    </section>
    
    <section id="classifica-section" class="content-section">
      <h2>Classifica</h2>
      <div id="classifica-content">
        </div>
    </section>

    <section id="admin-inserimento-giocatori-section" style="display:none">
        <h2>Admin · Inserimento Giocatori</h2>
        </section>
    <section id="admin-inserimento-giornate-section" style="display:none">
        <h2>Admin · Inserimento Giornate</h2>
        </section>
    <section id="admin-gestione-dati-section" style="display:none">
        <h2>Admin · Crud Dati</h2>
        </section>
    <section id="admin-utenti-section" style="display:none">
        <h2>Admin · Inserimento utenti</h2>
        <form id="create-user-form">
          <label>Nome Giocatore</label><input id="new-nome" required />
          <label>Cognome Giocatore</label><input id="new-cognome" required />
          <label>Email</label><input id="new-email" type="email" required />
          <label>Password</label><input id="new-password" type="password" required />
          <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
        </form>
        <div class="help">L’admin resta connesso durante la creazione grazie all’autenticazione secondaria.</div>
    </section>

  </main>

  <div id="video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px;">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button" style="position:absolute; top:-10px; right:-10px; z-index:110; font-size:1.2rem; line-height:1.2;">&times;</button>
      <div id="video-iframe-container" style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; border-radius: var(--radius); overflow: hidden;">
        </div>
    </div>
  </div>

  <footer>
    &copy; AC Tuscolano | Gestione Squadra
  </footer>

</body>
</html>
