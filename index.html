<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale (omesso per brevit√†, resta invariato) */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    /* Rimuovo display:none qui, lo gestir√† il JS */
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000} /* QUESTA REGOLA RENDE IL TESTO SCURO, VIENE SOVRASCRITTA INLINE */
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }
    
    /* NUOVI STILI: Barre Voto */
    .voto-bar-container{
        background: #f0f0f0;
        border-radius: 8px;
        height: 8px;
        overflow: hidden;
        margin-top: 4px;
    }
    .voto-bar{
        height: 100%;
        transition: width var(--duration) var(--ease);
    }
    .voto-bar.red{ background-color: var(--red); }
    .voto-bar.yellow{ background-color: var(--yellow); }
    .voto-bar.green{ background-color: #0e7a0d; }


    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

/* === Effetti di transizione per le sezioni visibili (.content-section) === */
/* Importante: transition-duration √® 0.4s */
.content-section {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease; 
  display: none; 
}
.content-section.active {
  opacity: 1;
  pointer-events: all;
  display: block; 
}


/* ================================================= */
/* === STILI MOBILE-APP (max-width: 600px) START === */
/* ================================================= */

/* Nasconde la navigazione mobile su schermi grandi */
#bottom-nav {
    display: none;
}

@media (max-width: 600px) {
    /* 1. Layout Full-Screen e scroll del contenuto */
    html, body {
        height: 100%;
        overflow: hidden; /* Previene lo scroll del body */
    }
    body {
        display: flex;
        flex-direction: column;
    }
    main {
        flex: 1; /* Il contenuto prende lo spazio rimanente */
        overflow-y: auto; /* Rende il contenuto scrollabile */
        margin: 0; /* Rimuove i margini di default */
        max-width: 100%;
        padding: 10px 10px 80px 10px; /* Padding per il bottom nav */
    }
    
    /* 2. Header Refinement */
    header {
        position: static; /* Non pi√π sticky, ma parte del flow */
        border-bottom: 3px solid var(--yellow); /* Bordo ridotto */
    }
    .hero {
        padding: 8px 10px; /* Padding ridotto */
    }
    .hero img {
        width: 36px; /* Logo pi√π piccolo */
        height: 36px;
    }
    .brand .club {
        font-size: 18px; /* Titolo ridotto */
    }
    .brand .tag {
        font-size: 10px; /* Sottotitolo ridotto */
    }
    
    /* 3. Nasconde Top Nav e Footer */
    nav, footer {
        display: none; /* Nasconde navigazione orizzontale e footer su mobile */
    }
    
    /* 4. Bottom Navigation Bar */
    #bottom-nav {
        display: flex; /* Mostra la navigazione in basso */
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;
        background: var(--card); 
        border-top: 1px solid var(--line);
        box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        justify-content: space-around;
        align-items: center;
        height: 60px; 
    }
    /* Stile per i pulsanti della Bottom Nav */
    #bottom-nav .tab, #bottom-nav .btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin: 0;
        height: 100%;
        border-radius: 0;
        box-shadow: none;
        background: transparent;
        font-size: 10px; /* Testo compatto */
        font-weight: 600;
        color: var(--ink-sub);
        gap: 2px;
    }
    #bottom-nav .tab:hover {
        transform: none; /* Disabilita effetto hover */
    }
    /* Stato attivo */
    #bottom-nav .tab[aria-current="page"], #bottom-nav .btn[aria-current="page"] {
        color: var(--red);
    }
    
    /* Placeholder Icone (utilizzando testo/emoji per simulare l'icona) */
    #bottom-nav .tab::before {
        font-size: 18px;
        line-height: 1;
        margin-bottom: 2px;
        font-weight: 400; /* Per emoji */
    }
    #mobile-rosa-tab::before { content: 'üë•'; }
    #mobile-calendario-tab::before { content: '‚öΩ'; }
    #mobile-classifica-tab::before { content: 'üèÜ'; }
    #mobile-statistiche-tab::before { content: 'üìà'; }
    #mobile-video-tab::before { content: 'üé¨'; }
    
    /* Auth Button Styling */
    #mobile-auth-toggle-btn.btn--accent {
        color: var(--red); /* Rosso per Logout */
    }
    #mobile-auth-toggle-btn::before {
        content: 'üîí'; /* Icona Login */
        font-size: 18px;
        margin-bottom: 2px;
    }
    #mobile-auth-toggle-btn.btn--accent::before {
        content: 'üîì'; /* Icona Logout */
    }
    
    /* Adatta gli elementi di contenuto */
    section {
        padding: 14px; /* Padding ridotto nelle sezioni */
        border-radius: 12px;
        margin: 10px 0;
    }

    /* Assicura che la barra admin non sia coperta dal bottom nav */
    #admin-menu {
        margin-bottom: 60px;
    }
}
/* ================================================= */
/* === STILI MOBILE-APP (max-width: 600px) END === */
/* ================================================= */

</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; 

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    // escapeHtml ora √® pi√π robusto, necessario per gli argomenti onclick che contengono entit√† HTML (es. '->&#39;)
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section', 'prestazioni-partita-section', 'video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section',
      'admin-statistiche-section', 
      'admin-prestazioni-partita-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section',
      'admin-classifica-section'
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; 

    // SWITCHER PUBBLICO
window.showPublicSection = (id) => window.switchSection(id, false);

// SWITCHER ADMIN
window.showAdminSection = (id) => {
    if(!isAdmin) return showLogin();
    if(id === 'admin-utenti-section'){
        loadGestionePermessi();
    }
    window.switchSection(id, true);
};
window.showDettaglioPrestazioniGiocatore = async function(pidRosa, nome, cognome){
    window.showPublicSection('prestazioni-partita-section');
    const box = byId('prestazioni-partita-content');
    box.innerHTML = 'Caricamento dati...';

    const snapPrest = await get(ref(db, 'prestazioni'));
    const snapCal = await get(ref(db, 'calendario'));
    const prestazioni = snapPrest.val() || {};
    const calendario = snapCal.val() || {};

    let rows = [];
    Object.entries(prestazioni).forEach(([matchId, players])=>{
        if(players[pidRosa] && players[pidRosa].voto != null){
            const m = calendario[matchId] || {};
            rows.push({
              voto: players[pidRosa].voto,
              avversaria: m.avversaria || '',
              data: m.data || '',
              matchId
            });
        }
    });

    console.log("PREST DEBUG ‚Üí PID", pidRosa, rows);
  
    if(rows.length === 0){
        box.innerHTML = `<h2>${nome} ${cognome}</h2><p>Nessuna prestazione registrata.</p>`;
        return;
    }



  // Seleziona il pulsante usando l'attributo data
  const btn = document.querySelector(`[data-match-cand-btn="${matchId}"]`);
  if (btn) btn.disabled = true; // Disabilita subito per prevenire doppi click

  try {
    const uid = auth.currentUser.uid;
    const candRef = ref(db, `calendario/${matchId}/candidature/${uid}`);

    const snap = await get(candRef);
    const isCandidato = snap.exists() && snap.val() === true;
    const nuovoValore = !isCandidato;

    await set(candRef, nuovoValore); // SCRITTURA NEL DATABASE

    // FIX 1: AGGIORNAMENTO IMMEDIATO DEL DOM (QUESTO DEVE BASTARE)
    if (btn) {
        btn.innerText = nuovoValore ? "Annulla Candidatura" : "Candidati";
        // Toggla la classe CSS, se necessario:
        btn.classList.toggle('btn--accent', nuovoValore); 
    }

    // FIX 2 (CRUCIALE): RIMOSSA la chiamata a await loadProssimeGiornate(false);
    // In questo modo, il tuo aggiornamento del DOM NON viene sovrascritto.

    // Se √® admin, aggiorna solo la vista admin
    if(window.isAdmin){
      await loadProssimeGiornate(true);
    }
  } catch (error) {
    console.error("Errore candidatura:", error);
    alert("Si √® verificato un errore durante l'operazione.");
    // In caso di errore, ricarica per ripristinare lo stato corretto
    await loadProssimeGiornate(false);
  } finally {
    if (btn) btn.disabled = false; // Riabilita il pulsante
  }
};



    // ordina correttamente date in formato dd/mm/yyyy
    rows.sort((a,b)=>{
       const pa = a.data.split('/');
       const pb = b.data.split('/');
       const da = new Date(`${pa[2]}-${pa[1]}-${pa[0]}`);
       const db = new Date(`${pb[2]}-${pb[1]}-${pb[0]}`);
       return da - db;
    });

    let html = `<h2>${nome} ${cognome}</h2>
    <table class="table"><thead><tr><th>Data</th><th>Avversaria</th><th>Voto</th></tr></thead><tbody>`;

    rows.forEach(r=>{
        html += `<tr><td>${r.data}</td><td>${r.avversaria}</td><td><b>${r.voto}</b></td></tr>`;
    });

    html += `</tbody></table>`;
    box.innerHTML = html;
};



    /* ========================================================================= */
    /* === FIX: LOGICA UNIFICATA PER IL CAMBIO SEZIONE (GESTIONE FADE PI√ô ROBUSTA) === */
    /* ========================================================================= */

    window.switchSection = (id, isAdminTarget = false) => {
        const next = byId(id);
        if (!next) return;

        const transitionDuration = 400; // Corrisponde a transition: opacity 0.4s ease;
        
        // 1. Fade out la sezione corrente (se presente)
        document.querySelectorAll('.content-section.active').forEach(section => {
            section.classList.remove('active'); // Avvia la dissolvenza (opacity 1 -> 0)
        });
        
        // 2. Gestisce il display per tutte le sezioni
        document.querySelectorAll('.content-section').forEach(section => {
            if (section.id !== id) {
                // Imposta display: none DOPO il tempo di transizione per consentire il fade-out
                setTimeout(() => {
                    section.style.display = 'none';
                }, transitionDuration); 
            } else {
                // Imposta display: block sulla sezione di destinazione immediatamente (starting opacity 0 via CSS)
                section.style.display = 'block';
            }
        });
        
        // 3. Aggiunge la classe 'active' alla sezione di destinazione
        // Questo avvia la dissolvenza in entrata (opacity 0 -> 1)
        // Usiamo un piccolo ritardo (10ms) per assicurare che 'display: block' venga letto dal browser 
        // prima di avviare la transizione di opacit√†.
        setTimeout(() => {
            next.classList.add('active');
            // Assicuriamoci che pointer-events sia attivo per interazioni immediate
            next.style.pointerEvents = 'all'; 
        }, 10); 
        
        // 4. Gestione evidenziazione tab/menu (Logica invariata)
        document.querySelectorAll('.tab[data-target]').forEach(t => { 
            t.setAttribute('aria-current', t.dataset.target === id ? 'page' : 'false'); 
        });
        document.querySelectorAll('#admin-menu .tab').forEach(t => { 
            t.setAttribute('aria-current', t.dataset.adminTarget === id ? 'page' : 'false'); 
        });
        
        // 5. Logica specifica Admin (Logica invariata)
        if (isAdminTarget) {
            if(id==='admin-calendario-section'){ window.loadProssimeGiornate(true); }
            if(id==='admin-inserimento-giornate-section'){ byId("match-data") && $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
            if(id==='admin-candidature-section'){ loadCandidature(); } 
            // AGGIUNTA CHIAMATA PER CRUD DATI E SELETTORE CANDIDATURE
            if(id==='admin-gestione-dati-section'){ 
                window.loadCrudGiocatori(); 
                window.loadCrudPartite(); 
                loadCrudCandidatureSelect();
            } 
            if (id === 'admin-video-section') loadPartitePerVideoAdmin(); 
        }

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // Re-map the old functions to the new unified function (FIX: Must be attached to window to work with inline onclicks)
 window.showAdminSection = (id) => {
    if(!isAdmin) return showLogin();

    // auto-load permessi quando entro nella sezione utenti
    if(id === 'admin-utenti-section'){
        loadGestionePermessi();
    }

    window.switchSection(id, true);
};


    function showLogin(){ 
        // Usa switchSection per mostrare SOLO il form di login, nascondendo gli altri
        window.switchSection('login-section', false); 
        window.scrollTo({top:0,behavior:'smooth'}); 
    }
    
    // La funzione toggleAdminUI non deve pi√π chiamare showPublicSection, 
    // ma affidarsi al listener di onAuthStateChanged per la sezione iniziale
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
    }
    
    // Aggiornamento per gestire i bottoni desktop e mobile
    function setAuthButton(user){ 
        const buttons = document.querySelectorAll('#auth-toggle-btn, #mobile-auth-toggle-btn');
        if(user){ 
            buttons.forEach(b => {
                b.textContent='Logout'; 
                b.classList.add('btn--accent'); 
            });
        } else { 
            buttons.forEach(b => {
                b.textContent='Login'; 
                b.classList.remove('btn--accent'); 
            });
        } 
    }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      // DI BASE: nessun admin
isAdmin = false;
window.currentUserRole = null;

if(user){
  const snapRole = await get(ref(db, 'utenti/'+user.uid));
  const uData = snapRole.val() || {};

  // fallback: se non esiste role ma √® Aldo ‚Üí superadmin
  const role = uData.role || (user.uid === "tbHGXtpvBDfmVIrNT2QVyeBinCV2" ? "superadmin" : "user");

  window.currentUserRole = role;

  if(role === 'admin' || role === 'superadmin'){
    isAdmin = true;
  }
}

      setAuthButton(user);
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      const currentActiveSection = document.querySelector('.content-section.active');

      // Se non c'√® una sezione attiva o se la sezione attiva √® il login (dopo cambio stato)
      if(!currentActiveSection || currentActiveSection.id === 'login-section') {
        if(user && isAdmin) {
           window.showAdminSection('admin-inserimento-giocatori-section');
        } else {
           // Se non loggato o non admin, mostra la rosa
           window.showPublicSection('rosa-section');
        }
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          // Dopo il logout, onAuthStateChanged gestir√† il reindirizzamento alla rosa
        });
      } else {
        // Se non √® loggato, mostra solo la pagina di login
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ 
            // Dopo il login, onAuthStateChanged gestir√† il reindirizzamento
        }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) ‚Äì usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      // L'attivazione della prima sezione √® gestita da onAuthStateChanged
      loadRosa(); 
      window.loadProssimeGiornate(false); // Carica calendario
      loadStatistiche(); // Carica solo risultati
      window.loadPrestazioniAggregato(); // Carica aggregato giocatori
      window.loadClassifica(); // Carica classifica da cache
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      // NOTA: La chiamata a switchSection avviene tramite l'onclick nel codice HTML
      document.querySelectorAll('#rosa-tab, #mobile-rosa-tab').forEach(el => el.addEventListener('click', loadRosa));
      document.querySelectorAll('#calendario-tab, #mobile-calendario-tab').forEach(el => el.addEventListener('click', () => window.loadProssimeGiornate(false)));
      document.querySelectorAll('#statistiche-tab, #mobile-statistiche-tab').forEach(el => el.addEventListener('click', () => {
          loadStatistiche(); 
          window.loadPrestazioniAggregato();
      }));
      document.querySelectorAll('#video-tab, #mobile-video-tab').forEach(el => el.addEventListener('click', loadVideoList));
      document.querySelectorAll('#classifica-tab, #mobile-classifica-tab').forEach(el => el.addEventListener('click', window.loadClassifica));
      
      // Imposto la rosa come attiva all'avvio se non c'√® una sezione attiva
      if (!document.querySelector('.content-section.active')) {
            window.showPublicSection('rosa-section');
      }

    });
    
    
    /**
     * Funzione Classifica:
     * Legge dalla cache di Firebase e riformatta la tabella senza loghi. (FIX RICHIESTO: Colore Intestazione + Evidenziazione)
     */
    window.loadClassifica = async () => {
      const classificaContent = byId('classifica-content');
      if (!classificaContent) return;
      classificaContent.innerHTML = `<div class="help">Caricamento classifica...</div>`;
      
      try {
          const snap = await get(ref(db, 'classifica_cache'));
          const cache = (snap.exists() && snap.val()) ? snap.val() : {};
          
          if (!cache.html) {
              classificaContent.innerHTML = `<div class="help">Classifica non ancora disponibile o non aggiornata. L'amministratore deve aggiornarla.</div>`;
              return;
          }

          const parser = new DOMParser();
          // Parse the raw HTML saved in cache by the admin function
          const doc = parser.parseFromString(cache.html, "text/html");
          
          // Find the table inside the parsed document
          const remoteTable = doc.querySelector("table.table"); 
          if (!remoteTable) {
              classificaContent.innerHTML = `<div class="help">Errore nel formato dei dati salvati. Impossibile trovare la tabella.</div>`;
              return;
          }

          const rows = remoteTable.querySelectorAll("tbody tr");
          if (rows.length === 0) {
              classificaContent.innerHTML = `<div class="help">Nessuna riga dati trovata nella classifica.</div>`;
              return;
          }

          // Standard Romatornei Columns (approx): 0:Pos, 1:Squadra, 2:Punti, 3:Giocate, 4:V, 5:N, 6:P, 7:F, 8:S, 9:DR
          
          let tableBodyHtml = '';

          // *** INIZIO FIX 1 (Classifica) ***
          // Helper per unire gli stili ed evitare attributi 'style' duplicati
          const getCellStyle = (isTuscolano, baseStyle = "") => {
              let tuscolanoStyle = '';
              if (isTuscolano) {
                  // Stile Tuscolano (con centratura richiesta)
                  tuscolanoStyle = 'background:var(--yellow) !important; color:var(--ink) !important; font-weight:900; text-align:center !important;';
              }
              // Unisce lo stile Tuscolano (se presente) e lo stile di base della cella
              const finalStyle = [tuscolanoStyle, baseStyle].filter(Boolean).join('; ');
              return finalStyle ? ` style="${finalStyle}"` : '';
          };
          // *** FINE FIX 1 (Classifica) ***

          rows.forEach((tr, index) => {
              const cells = Array.from(tr.children);
              
              // Skip rows that don't look like data rows (e.g., headers repeated in tbody)
              if (cells.length < 8) return; 

              // 1. Estrazione dati
              const pos = cells[0]?.textContent.trim() || '‚Äî';
              
              // Rimuovi eventuali immagini/loghi dal nome della squadra prima di estrarre il testo
              const squadraCell = cells[1].cloneNode(true);
              squadraCell.querySelectorAll('img, .logo').forEach(el => el.remove());
              const squadra = squadraCell.textContent.trim();
              
              const punti = cells[2]?.textContent.trim() || '0';
              const giocate = cells[3]?.textContent.trim() || '0';
              const vinte = cells[4]?.textContent.trim() || '0';
              const pareggiate = cells[5]?.textContent.trim() || '0';
              const perse = cells[6]?.textContent.trim() || '0';
              // DR (Differenza Reti) √® l'ultima cella in genere (indice 9)
              const dr = cells[cells.length - 1]?.textContent.trim() || '0'; 
              
              // 2. Stile per evidenziare AC Tuscolano
              const isTuscolano = squadra.toUpperCase().includes('TUSCOLANO');
              
              // Applica il colore zebra solo se non √® AC Tuscolano
              const rowStyle = index % 2 === 1 && !isTuscolano ? ' style="background:#f8f8f8;"' : '';

              // *** MODIFICA FIX 1 (Classifica): Applica getCellStyle alle <td> ***
              tableBodyHtml += `
                  <tr${rowStyle}>
                      <td${getCellStyle(isTuscolano, "text-align:center;")}>${pos}</td>
                      <td${getCellStyle(isTuscolano, isTuscolano ? "" : "font-weight:700;")}>${escapeHtml(squadra)}</td>
                      <td${getCellStyle(isTuscolano, "text-align:center;")}><b>${punti}</b></td>
                      <td${getCellStyle(isTuscolano, "text-align:center; color:var(--ink-sub);")}>${giocate}</td>
                      <td${getCellStyle(isTuscolano, "text-align:center; color:#0e7a0d;")}>${vinte}</td>
                      <td${getCellStyle(isTuscolano, "text-align:center;")}>${pareggiate}</td>
                      <td${getCellStyle(isTuscolano, "text-align:center; color:var(--red);")}>${perse}</td>
                      <td${getCellStyle(isTuscolano, "text-align:center;")}>${dr}</td>
                  </tr>
              `;
              // *** FINE MODIFICA FIX 1 (Classifica) ***
          });
          
          const tableHtml = `
              <div class="help">Classifica aggiornata da dati esterni. L'AC Tuscolano √® evidenziata.</div>
              <div style="overflow-x:auto">
                  <table class="table" style="width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; table-layout:auto;">
                      <thead>
                          <tr style="background:var(--ink);"> 
                              <th style="width:5%; text-align:center; padding:8px 4px; color:var(--white);">Pos</th>
                              <th style="width:35%; padding:8px 4px; text-align:left; color:var(--white);">Squadra</th>
                              <th style="width:10%; text-align:center; padding:8px 4px; color:var(--white);">Pti</th>
                              <th style="width:10%; text-align:center; color:var(--white);">G</th>
                              <th style="width:10%; text-align:center; color:var(--white);">V</th>
                              <th style="width:10%; text-align:center; color:var(--white);">N</th>
                              <th style="width:10%; text-align:center; color:var(--white);">P</th>
                              <th style="width:10%; text-align:center; color:var(--white);">DR</th>
                          </tr>
                      </thead>
                      <tbody>
                          ${tableBodyHtml}
                      </tbody>
                  </table>
              </div>
              <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date(cache.timestamp || Date.now()).toLocaleString("it-IT")}</div>
          `;

          classificaContent.innerHTML = tableHtml;

      } catch (e) {
          console.error("Errore caricamento classifica:", e);
          classificaContent.innerHTML = `<div class="help" style="color:red">Errore caricamento classifica.</div>`;
      }
    };

    /**
     * Funzione Admin:
     * Aggiorna la classifica dal sito e la salva su Firebase.
     */
    window.updateClassificaFromSito = async () => {
      if (!isAdmin) return alert('Accesso negato. Solo gli amministratori possono aggiornare la classifica.');
      
      alert('Aggiornamento classifica in corso... Attendere prego.');

      try {
        const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
        const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
        const response = await fetch(proxy);
        const data = await response.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");

        const remoteTable = doc.querySelector(".table-responsive table, table.table, table");
        if (!remoteTable) {
          alert('Errore: Impossibile trovare la tabella della classifica sul sito remoto.');
          return;
        }

        // Rimuovi loghi dalla copia locale per la cache
        remoteTable.querySelectorAll("img").forEach(img => {
          img.remove();
        });
        
        // Pulizia: Rimuovi larghezze fisse e aggiungi la classe 'table'
        remoteTable.removeAttribute('style');
        remoteTable.classList.add('table');
        
        // Estrai l'HTML del TABLE (Thead e Tbody)
        const normalizedHTML = `
          <div class="help">Classifica aggiornata da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto">
            ${remoteTable.outerHTML}
          </div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
        `;

        // Salva cache
        await set(ref(db, 'classifica_cache'), {
          html: normalizedHTML,
          timestamp: Date.now()
        });

        // Aggiorna la vista
        await window.loadClassifica();
        alert('Classifica aggiornata con successo!');

      } catch (e) {
        console.error('Errore aggiornamento classifica:', e);
        alert('Errore durante l\'aggiornamento della classifica: ' + e.message);
      }
    };


    /* ===== FUNZIONI VIDEO ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      if (!select) return;
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */
    
    async function loadRosa(){
      const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; }
      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> ‚Ä¢ Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    /**
     * FUNZIONE loadProssimeGiornate (AGGIORNATA PER LISTA CANDIDATI)
     * IMPLEMENTAZIONE FIX: Logica di join /candidature -> /utenti -> /rosa (FIX RICHIESTO)
     */
window.loadProssimeGiornate = async function(asAdmin){
  const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
  const ul = byId(listId); if(!ul) return; ul.innerHTML='';

  // carico calendario + rosa + utenti
  const [snapCalendar, snapRosa, snapUtenti] = await Promise.all([
    get(ref(db,'calendario')),
    get(ref(db,'rosa')),
    get(ref(db,'utenti'))
  ]);

  const val = snapCalendar.val() || {};
  const rosa = snapRosa.val() || {};
  const utenti = snapUtenti.val() || {};

  const rosaArray = Object.values(rosa);

  let entries = Object.entries(val);
  const toDate = (d)=>{ const [dd,mm,yyyy]=String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
  const today = new Date(); today.setHours(0,0,0,0);

  entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));

  if(!entries.length){
    ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>';
    return;
  }

  ul.className='grid cols-3';
ul.innerHTML = "";

  for(const [matchId,m] of entries){

    // Leggi candidature match
    const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
    const cand = candSnap.val() || {};

    const candidatiAuthUIDs = Object.keys(cand).filter(uid => cand[uid] === true);
    const candCount = candidatiAuthUIDs.length;

    const candidatiTrovati = [];
    for(const authUid of candidatiAuthUIDs){
      const utente = utenti[authUid];
      if(utente && utente.nome && utente.cognome){
        const giocatore = rosaArray.find(p => p.nome === utente.nome && p.cognome === utente.cognome);
        if(giocatore) candidatiTrovati.push(giocatore);
      }
    }
    const sortedCandidati = candidatiTrovati.sort((a,b)=> (a.numero||0)-(b.numero||0));

    const matchDate = toDate(m.data);
    const isPast = matchDate < today;

    const risultatoValido = !!(m.risultato && /\d+\s*-\s*\d+/.test(m.risultato));

    // cand utente corrente
    const candidature = cand || {};
    const candidatiUID = Object.entries(candidature).filter(([,v])=>v===true).map(([uid])=>uid);
    const uid = auth.currentUser ? auth.currentUser.uid : null;
    const isCandidato = uid && candidatiUID.includes(uid);

    // ---- BTN Prestazioni
    let prestazioniBtn='';
    if(risultatoValido){
      prestazioniBtn = `<button class="btn" onclick="showPrestazioniPubbliche('${matchId}','${escapeHtml(m.avversaria||'')}')">Prestazioni</button>`;
    } else {
      prestazioniBtn = `<button class="btn" disabled style="opacity:0.6;">Prestazioni</button>`;
    }

 // ---- BTN Candidatura
let candButton='';
if(risultatoValido){
  candButton = `<button class="btn" disabled style="opacity:0.6;">Candidatura terminata</button>`;
} else if(isPast){
  candButton = `<button class="btn" disabled style="opacity:0.6;">Candidatura scaduta</button>`;
} else {
  const label = isCandidato ? 'Annulla Candidatura' : 'Candidati';
  // *** QUESTA √à LA RIGA DA MODIFICARE ***
  // Aggiunto data-match-cand-btn="${matchId}"
  candButton = `<button class="btn btn--accent" data-match-cand-btn="${matchId}" onclick="toggleCandidatura('${matchId}')">${label}</button>`;
}
    ul.innerHTML += `
      <div class="card">
        <div class="player-title">${escapeHtml(m.avversaria||'')}</div>
        <div class="player-sub">${m.data} - ${m.orario}</div>
        <div class="player-sub">${m.campo}</div>
        <div style="margin-top:10px;font-weight:bold">Candidati: ${candCount}</div>
        <div class="row" style="margin-top:14px;">
          ${candButton}
          ${prestazioniBtn}
        </div>
      </div>
    `;
  }
};

    /**
     * CORREZIONE 1: Implementazione del layout a blocchi/griglia per i risultati (Risultati squadra)
     */
    async function loadStatistiche(){
      const ul = byId('statistiche-risultati-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      const entries = Object.entries(val);
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));

      let totalGames = 0;
      let wins = 0;
      let draws = 0;
      let losses = 0;

      const html = entries.map(([matchId, p]) => {
        if (!p.risultato || p.risultato === 'N/D') return '';

        totalGames++;
        
        let esitoPill = '<span class="pill" style="background:#ddd; color:#333; padding:2px 8px;">N/D</span>';
        const [scoreCasa, scoreOspite] = p.risultato.split('-').map(s => parseInt(s.trim()));
        const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
        const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';

        if (!isNaN(scoreCasa) && !isNaN(scoreOspite)) {
            let esito = '';
            let esitoColor = '';
            
            // AC Tuscolano score depends on 'casa' flag
            const scoreTuscolano = p.casa ? scoreCasa : scoreOspite;
            const scoreAvversaria = p.casa ? scoreOspite : scoreCasa;

            if (scoreTuscolano > scoreAvversaria) {
                esito = 'VITTORIA';
                esitoColor = 'background:#0e7a0d; color:#fff;'; // Green
                wins++;
            } else if (scoreTuscolano < scoreAvversaria) {
                esito = 'SCONFITTA';
                esitoColor = 'background:var(--red); color:#fff;'; // Red
                losses++;
            } else {
                esito = 'PAREGGIO';
                esitoColor = 'background:var(--yellow); color:#111;'; // Yellow
                draws++;
            }
            esitoPill = `<span class="pill" style="${esitoColor} padding:2px 8px; font-size:.75rem; margin-top:4px; display:inline-block;">${esito}</span>`;
        }
        
        return `
            <li class="card" style="margin-bottom:10px; padding:12px; display:grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;">
                <div>
                    <div style="font-size:0.9rem; color:var(--ink-sub); margin-bottom: 4px;">${p.data || 'N/D'} ‚Ä¢ ${p.casa ? 'Casa' : 'Trasferta'}</div>
                    <strong style="font-size:1.1rem; display:block;">vs ${avversario}</strong>
                    <span class="player-sub">${campo}</span>
                </div>
                <div style="text-align:right; flex-shrink:0;">
                    <div style="font-weight:800; font-size:1.4rem; line-height:1.2;">${p.risultato}</div>
                    ${esitoPill}
                </div>
            </li>
        `;
      }).join('');
      
      const riepilogo = `
        <div class="grid cols-3" style="margin-bottom:16px;">
            <div class="card" style="background:#0e7a0d; color:#fff; text-align:center;">
                <div style="font-size:1.5rem; font-weight:900;">${wins}</div>
                Vittorie
            </div>
            <div class="card" style="background:var(--yellow); color:#111; text-align:center;">
                <div style="font-size:1.5rem; font-weight:900;">${draws}</div>
                Pareggi
            </div>
            <div class="card" style="background:var(--red); color:#fff; text-align:center;">
                <div style="font-size:1.5rem; font-weight:900;">${losses}</div>
                Sconfitte
            </div>
        </div>
        <div class="help" style="text-align:center; font-weight:700; margin-bottom:16px;">Totale partite con risultato: ${totalGames}</div>
      `;

      ul.innerHTML = riepilogo + html;
    }

    /**
     * CORREZIONE 2: Esposizione a window e logica per mostrare i dati del Riepilogo Giocatori
     */
    window.loadPrestazioniAggregato = function(){
        // Logica omessa per brevit√†, resta invariata rispetto alla precedente versione corretta.
        // Assumo che la logica di calcolo e visualizzazione sia corretta.
        const cont = byId('prestazioni-aggregate-content');
        if(!cont) return;
        cont.innerHTML = '<h3>Riepilogo Giocatori</h3><div class="help">Calcolo media voti e goal in corso‚Ä¶</div>';
      
        // Funzione asincrona interna per non bloccare il DOM, ma non usiamo await qui
        (async () => {
          try {
            const [snapRosa, snapPrests] = await Promise.all([
              get(ref(db, 'rosa')),
              get(ref(db, 'prestazioni'))
            ]);
            const rosa = snapRosa.val() || {};
            const prestazioniByMatch = snapPrests.val() || {};
            
            // 1. Aggrega dati
            const aggregato = {};
            Object.keys(rosa).forEach(pid => {
  aggregato[pid] = { 
     pid, // la chiave rosa
     uid: rosa[pid].uid || pid,
     totalVoto: 0, 
     countVoto: 0, 
     goal: 0, 
     nome: `${rosa[pid].nome} ${rosa[pid].cognome}`, 
     numero: rosa[pid].numero, 
     cognome: rosa[pid].cognome 
  };
});


            Object.values(prestazioniByMatch).forEach(matchPrests => {
              Object.entries(matchPrests).forEach(([pid, data]) => {
                if (aggregato[pid]) {
                  // Assicurati che data.voto sia un numero e non NaN
                  if (data.voto !== null && typeof data.voto === 'number' && !Number.isNaN(data.voto)) {
                    aggregato[pid].totalVoto += data.voto;
                    aggregato[pid].countVoto += 1;
                  }
                  aggregato[pid].goal += data.goal || 0;
                }
              });
            });

            // 2. Calcola media e prepara righe
            const rows = Object.values(aggregato).map(a => {
              const media = a.countVoto > 0 ? a.totalVoto / a.countVoto : null;
              
 return { pid: a.pid, uid: a.uid, nome: a.nome, cognome: a.cognome, numero: a.numero, 
         partite: a.countVoto, 
         mediaVoto: media !== null ? Number(media.toFixed(2)) : null, 
         goal: a.goal };
              
            }).sort((a,b)=> {
              // Ordina per media voto (decrescente), poi goal (decrescente)
              const am = a.mediaVoto===null ? -1 : a.mediaVoto;
              const bm = b.mediaVoto===null ? -1 : b.mediaVoto;
              if (bm !== am) return bm - am;
              if (b.goal !== a.goal) return b.goal - a.goal;
              return a.nome.localeCompare(b.nome);
            });

            // 3. Genera HTML
            const rowsHtml = rows.map(r => {
              let mediaVotoDisplay = '‚Äî';
              let bar = '';
              if (r.mediaVoto !== null) {
                const votoNum = r.mediaVoto;
                mediaVotoDisplay = `<b>${votoNum.toFixed(2)}</b>`;
                // Calcolo barra
                const perc = Math.max(0, Math.min(100, Math.round((votoNum/10)*100)));
                const color = (votoNum >= 7 ? 'green' : (votoNum >= 6 ? 'yellow' : 'red'));
                bar = `
                  <div class="voto-bar-container">
                    <div class="voto-bar ${color}" style="width:${perc}%;"></div>
                  </div>`;
              }
              
         
              const clickAttr = r.partite > 0 ? `onclick="showDettaglioPrestazioniGiocatore('${r.pid}','${escapeHtml(r.nome)}','${escapeHtml(r.cognome)}')"` : '';


return `
  <li class="card" ${clickAttr} style="cursor:${r.partite > 0 ? 'pointer' : 'default'}">
    <div class="row" style="justify-content:space-between; align-items:flex-start;">
      <div>
        <div class="player-title">${r.nome} ${r.numero ? `<span class="pill">#${r.numero}</span>` : ''}</div>
        <div class="player-sub">Partite con voto: <b>${r.partite}</b></div>
      </div>
      <div style="text-align:right;">
        <div class="player-title">Voto Medio: ${mediaVotoDisplay}</div>
        <div class="player-sub" style="margin-top:6px;">Goal: <b>${r.goal}</b></div>
      </div>
    </div>
    ${bar}
  </li>
              `;
            }).join('');
            
            cont.innerHTML = `
              <h3>Riepilogo Giocatori</h3>
              <div class="help">Media voto calcolata solo sulle partite con voto assegnato.</div>
              <ul class="grid cols-2" style="margin-top:14px;">
                ${rowsHtml}
              </ul>
            `;
          } catch (e) {
            console.error("Errore caricamento prestazioni aggregate:", e);
            cont.innerHTML = `<h3>Riepilogo Giocatori</h3><div class="help" style="color:red">Errore durante il caricamento dei dati. Controlla la console per i dettagli.</div>`;
          }
        })();
    }
// ================== ADMIN: FORMATION EDITOR ==================
window.showFormazioneForm = async function(matchId, avv, formazioneJsonString){
  window.showAdminSection('admin-formazione-section');
  const container = byId('formazione-form-container');
  container.innerHTML = 'Caricamento dati formazione...';

  const norm = s => (String(s||'').trim().toLowerCase());

  try {
    // Carico partita, rosa, candidature (TRUE) e utenti per join UID se manca
    const [snapMatch, snapRosa, snapCand, snapUsers] = await Promise.all([
      get(ref(db, `calendario/${matchId}`)),
      get(ref(db, 'rosa')),
      get(ref(db, `calendario/${matchId}/candidature`)),
      get(ref(db, 'utenti'))
    ]);

    const match = snapMatch.val() || {};
    const rosa  = snapRosa.val()  || {};
    const cand  = snapCand.val()  || {};   // {uid:true}
    const utenti= snapUsers.val() || {};

    // Indice utenti: nome|cognome -> uid
    const nameIndex = {};
    for (const [uid, u] of Object.entries(utenti)) {
      const key = `${norm(u.nome)}|${norm(u.cognome)}`;
      if (!nameIndex[key]) nameIndex[key] = uid;
    }


    // Arricchisco rosa con uid (scrivo solo se mancante e se trovo match)
    const updates = {};
    const players = Object.entries(rosa).map(([pid, p]) => {
      let uid = p.uid || '';
      if (!uid) {
        const key = `${norm(p.nome)}|${norm(p.cognome)}`;
        if (nameIndex[key]) {
          uid = nameIndex[key];
          updates[`rosa/${pid}/uid`] = uid; // ONLY if missing
        }
      }
      return {
        pid, uid,
        nome: p.nome || '',
        cognome: p.cognome || '',
        numero: p.numero || 0,
        ruolo: p.ruolo || ''
      };
    });

    if (Object.keys(updates).length) {
      try { await update(ref(db), updates); }
      catch(e){ console.warn('Impossibile aggiornare alcuni UID in rosa:', e); }
    }

    // Solo candidati TRUE
    const candidati = players.filter(pl => pl.uid && cand[pl.uid] === true);

    // Ordina RUOLO -> NUMERO (estetico)
    const ruoloOrder = (r) => {
      const POR = ['Portiere'];
      const DEF = ['Terzino sinistro','Terzino destro','Difensore centrale'];
      const CEN = ['Centrocampista centrale','Centrocampista sinistro','Centrocampista destro'];
      const ATT = ['Attaccante centrale'];
      if (POR.includes(r)) return 0;
      if (DEF.includes(r)) return 1;
      if (CEN.includes(r)) return 2;
      if (ATT.includes(r)) return 3;
      return 9;
    };
    candidati.sort((a,b)=>{
      const ra = ruoloOrder(a.ruolo), rb = ruoloOrder(b.ruolo);
      if (ra !== rb) return ra - rb;
      return (a.numero||0) - (b.numero||0);
    });

    const optionOf = (pl) =>
      `<option value="${pl.uid}">${escapeHtml(pl.cognome)} ${escapeHtml(pl.nome)} (#${pl.numero} - ${pl.ruolo||'‚Äî'})</option>`;
    const optionsHtml = candidati.map(optionOf).join('');

    // Precarico eventuale formazione esistente (dal JSON string passato dal bottone)
    const f0 = (() => { try { return (JSON.parse(formazioneJsonString)||{})['0'] || {}; } catch(_){ return {}; }})();
    const titolariSaved = f0.formazione || {};
    const panchinaSaved = Array.isArray(f0.panchina) ? f0.panchina : [];

    const slotSelect = (id, label) => `
      <label class="form-row">
        <span class="form-label">${label}</span>
        <select name="${id}" id="slot-${id}" class="form-input">
          <option value="">‚Äî Seleziona ‚Äî</option>
          ${optionsHtml}
        </select>
      </label>`;

    const benchSize = Math.min(8, Math.max(4, Math.max(0, candidati.length - 8)));
// set panchina runtime store
window._selectedPanchinaSet = new Set(panchinaSaved);

// funzione render lista panchina
function renderPanchinaList(){
  const el = document.getElementById('panchina-list');
  if(!el) return;

  // recupero tutti i titolari attuali
  const titolariUsati = new Set([
    byId('slot-portiere')?.value,
    byId('slot-d1')?.value,
    byId('slot-d2')?.value,
    byId('slot-d3')?.value,
    byId('slot-c1')?.value,
    byId('slot-c2')?.value,
    byId('slot-c3')?.value,
    byId('slot-attaccante')?.value
  ].filter(Boolean));

  // genera lista solo candidati non presenti nei titolari
  const benchCandidates = candidati.filter(pl => !titolariUsati.has(pl.uid));

  el.innerHTML = benchCandidates.map(pl => {
    const active = window._selectedPanchinaSet.has(pl.uid);
    return `
      <div class="card" data-uid="${pl.uid}" style="padding:8px; margin-bottom:6px; cursor:pointer; border:1px solid ${active?'#0a0':'#444'};">
        <b>${escapeHtml(pl.cognome)} ${escapeHtml(pl.nome)}</b> (#${pl.numero} - ${pl.ruolo||'‚Äî'})
        <div style="font-size:12px; color:${active?'#0a0':'#999'}">${active?'IN PANCHINA':'TOCCA PER AGGIUNGERE'}</div>
      </div>
    `;
  }).join('');

  el.querySelectorAll('[data-uid]').forEach(node=>{
    node.onclick = ()=>{
      const uid = node.getAttribute('data-uid');
     if(window._selectedPanchinaSet.has(uid)) window._selectedPanchinaSet.delete(uid);
else window._selectedPanchinaSet.add(uid);
      renderPanchinaList();
    }
  });
}


    container.innerHTML = `
      <h3>Gestione Formazione vs ${escapeHtml(avv)}</h3>
      <form id="formazione-editor-form" data-match-id="${matchId}">
        <fieldset class="card" style="margin-bottom:12px">
          <legend>Formazione iniziale (3-3-1)</legend>
          ${slotSelect('portiere', 'Portiere')}
          <div class="grid grid-cols-3 gap-2">
            ${slotSelect('d1','Difensore 1')}
            ${slotSelect('d2','Difensore 2')}
            ${slotSelect('d3','Difensore 3')}
          </div>
          <div class="grid grid-cols-3 gap-2">
            ${slotSelect('c1','Centrocampista 1')}
            ${slotSelect('c2','Centrocampista 2')}
            ${slotSelect('c3','Centrocampista 3')}
          </div>
          ${slotSelect('attaccante','Attaccante')}
        </fieldset>

      <fieldset class="card" style="margin-bottom:12px; padding:8px;">
  <legend>Panchina</legend>
  <div id="panchina-list"></div>
  <div class="help">Tocca i giocatori per inserirli / rimuoverli dalla panchina.</div>
</fieldset>

<fieldset class="card" style="margin-bottom:12px; padding:8px;">
  <legend>Pianificazione Sostituzioni (Equal time)</legend>
  <div class="form-row" style="gap:12px; align-items:center;">
    <label class="form-row" style="margin:0;">
      <span class="form-label">Giocatori alla volta</span>
      <select id="subs-blocco" class="form-input">
        <option value="1">1 alla volta</option>
        <option value="2">2 alla volta</option>
      </select>
    </label>
    <button type="button" id="btn-genera-sostituzioni" class="btn">Genera piano</button>
    <button type="button" id="btn-salva-sostituzioni" class="btn btn--accent">Salva Sostituzioni</button>
  </div>
  <div class="help">Il portiere √® escluso; il tempo totale in campo dei giocatori di movimento sar√† distribuito il pi√π equamente possibile (differenza ‚â§ 1‚Äô).</div>
  <div id="subs-editor" style="margin-top:10px;"></div>
</fieldset>

        <div class="actions">
          <button type="submit" class="btn btn--accent">Salva Formazione</button>
          <button type="button" id="btn-pubblica-formazione" class="btn">Pubblica Formazione</button>
        </div>
      </form>
    `;
renderPanchinaList();

// ====== SOSTITUZIONI: Equal-Time Planner ======
const subsEditor = byId('subs-editor');
window._subsPlan = Array.isArray(match.sostituzioni) ? [...match.sostituzioni] : []; // mantieni eventuali sostituzioni esistenti

// mappa uid -> info utili
const uidInfo = {};
players.forEach(p => { if (p.uid) uidInfo[p.uid] = p; });

// render editor tabellare con possibilit√† di modifica
function renderSubsEditor(){
  const plan = window._subsPlan || [];
  if (!plan.length){
    subsEditor.innerHTML = `<div class="help">Nessuna sostituzione pianificata. Premi "Genera piano".</div>`;
    return;
  }

  const partecipanti = getPartecipantiOutfield(); // tutti i giocatori di movimento titolari+panchina (uid), ordinati per numero
  const opts = partecipanti.map(uid=>{
    const pl = uidInfo[uid];
    return `<option value="${uid}">${escapeHtml(pl.cognome)} ${escapeHtml(pl.nome)} (#${pl.numero||'-'})</option>`;
  }).join('');

  const rows = plan.map((s, idx)=>`
    <tr>
      <td><input type="number" min="0" max="49" value="${s.minuto}" data-idx="${idx}" class="subs-minute form-input" style="width:80px"/></td>
      <td>
        <select class="subs-esce form-input" data-idx="${idx}">
          ${opts}
        </select>
      </td>
      <td>
        <select class="subs-entra form-input" data-idx="${idx}">
          ${opts}
        </select>
      </td>
      <td><button type="button" class="btn" data-remove="${idx}">Rimuovi</button></td>
    </tr>
  `).join('');

  subsEditor.innerHTML = `
    <div class="card" style="padding:8px;">
      <table class="table" style="width:100%">
        <thead><tr><th>Min</th><th>Esce</th><th>Entra</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;

  // set valori selects
  const tbody = subsEditor.querySelector('tbody');
  plan.forEach((s, idx)=>{
    const esceSel  = tbody.querySelector(`.subs-esce[data-idx="${idx}"]`);
    const entraSel = tbody.querySelector(`.subs-entra[data-idx="${idx}"]`);
    if (esceSel)  esceSel.value  = s.esce || '';
    if (entraSel) entraSel.value = s.entra || '';
  });

  // bind listeners
  subsEditor.querySelectorAll('.subs-minute').forEach(inp=>{
    inp.onchange = (e)=>{
      const i = parseInt(inp.getAttribute('data-idx'),10);
      window._subsPlan[i].minuto = Math.max(0, Math.min(49, parseInt(inp.value||'0',10)));
    };
  });
  subsEditor.querySelectorAll('.subs-esce').forEach(sel=>{
    sel.onchange = ()=>{ const i = parseInt(sel.getAttribute('data-idx'),10); window._subsPlan[i].esce = sel.value; };
  });
  subsEditor.querySelectorAll('.subs-entra').forEach(sel=>{
    sel.onchange = ()=>{ const i = parseInt(sel.getAttribute('data-idx'),10); window._subsPlan[i].entra = sel.value; };
  });
  subsEditor.querySelectorAll('[data-remove]').forEach(btn=>{
    btn.onclick = ()=>{
      const i = parseInt(btn.getAttribute('data-remove'),10);
      window._subsPlan.splice(i,1);
      renderSubsEditor();
    };
  });
}

// utility: prendi titolari outfield + panchina (escludi portiere)
function getPartecipantiOutfield(){
  const tit = {
    portiere: byId('slot-portiere')?.value || '',
    d1: byId('slot-d1')?.value || '',
    d2: byId('slot-d2')?.value || '',
    d3: byId('slot-d3')?.value || '',
    c1: byId('slot-c1')?.value || '',
    c2: byId('slot-c2')?.value || '',
    c3: byId('slot-c3')?.value || '',
    attaccante: byId('slot-attaccante')?.value || ''
  };
  const startersOut = [tit.d1,tit.d2,tit.d3,tit.c1,tit.c2,tit.c3,tit.attaccante].filter(Boolean);
  const bench = Array.from(window._selectedPanchinaSet || new Set());
  // UID unici
  const set = new Set([...startersOut, ...bench]);
  const arr = [...set];
  // ordina per numero maglia
  arr.sort((a,b)=> (uidInfo[a]?.numero||0) - (uidInfo[b]?.numero||0));
  return arr;
}

// Generatore equal-time (greedy, minuti interi, 7 on-field, blocchi 1 o 2 giocatori)
// Generatore equal-time (illimitate, rientri liberi, minuti interi)
// - eventi a cadenza fissa in funzione dei giocatori di movimento (Nout)
// - a ogni evento scambiamo fino a "blocco" giocatori (1 o 2) tra campo e panchina
function generaSostituzioniAutomatiche(blocco){
  // Parametri base
  const TOT = 50;      // minuti gara
  const K   = 7;       // giocatori di movimento in campo (portiere escluso)

  // Rileva titolari/panchina corrente (solo movimento) e ordina per numero maglia
  const partecipanti = getPartecipantiOutfield(); // UID uniq: startersOut + bench, ordinati per numero
  const starters = [
    byId('slot-d1')?.value, byId('slot-d2')?.value, byId('slot-d3')?.value,
    byId('slot-c1')?.value, byId('slot-c2')?.value, byId('slot-c3')?.value,
    byId('slot-attaccante')?.value
  ].filter(Boolean);
  let onField = starters.slice();
  let onBench = partecipanti.filter(uid => !onField.includes(uid));

  const Nout = partecipanti.length;        // giocatori di movimento totali
  const FIELD_MIN = TOT * K;               // minuti "sul campo" complessivi (= 350)
  if (Nout <= K) {
    // Nessuna rotazione necessaria: tutti giocano sempre (o non c'√® panchina)
    window._subsPlan = [];
    renderSubsEditor();
    return;
  }

  // Target minuti per ciascuno (distribuzione equa ¬±1) seguendo l'ordine per numero maglia
  const base = Math.floor(FIELD_MIN / Nout);
  let r = FIELD_MIN % Nout;
  const targets = {}; // uid -> minuti target
  partecipanti.forEach(uid=>{
    const extra = (r>0) ? 1 : 0;
    targets[uid] = base + extra;
    r -= extra;
  });

  // --- Cadenzamento eventi: dinamico in base a Nout (minuti interi)
  // Pi√π giocatori abbiamo, pi√π fitta la cadenza.
  // step = max(2', round(50 / Nout))  ‚Üí es: Nout=10 => 5'; Nout=13 => 4'; Nout=8 => 6'
  const step = Math.max(2, Math.round(TOT / Nout));
  const times = [];
  for (let m = step; m < TOT; m += step) times.push(m); // esclude 0 e 50

  // Stato simulazione minuti giocati
  const played = {}; partecipanti.forEach(uid=> played[uid]=0);
  let tPrev = 0;
  const events = [];

  const advance = (toMinute) => {
    const dt = Math.max(0, toMinute - tPrev);
    onField.forEach(uid => played[uid] += dt);
    tPrev = toMinute;
  };
  const surplus = uid => played[uid] - (targets[uid]||0);
  const deficit = uid => (targets[uid]||0) - played[uid];

  // A ogni evento scambiamo fino a "blocco" giocatori (1 o 2) usando criterio surplus/deficit.
  times.forEach(min=>{
    advance(min);

    // Chi esce: pi√π "in surplus" tra quelli in campo (se parit√†, numero maglia pi√π alto esce)
    const candOut = onField.slice().sort((a,b)=>{
      const sa = surplus(a), sb = surplus(b);
      if (sb !== sa) return sb - sa;
      return (uidInfo[b]?.numero||0) - (uidInfo[a]?.numero||0);
    });

    // Chi entra: pi√π "in deficit" tra i panchinari (se parit√†, numero maglia pi√π basso entra)
    const candIn = onBench.slice().sort((a,b)=>{
      const da = deficit(a), db = deficit(b);
      if (db !== da) return db - da;
      return (uidInfo[a]?.numero||0) - (uidInfo[b]?.numero||0);
    });

    const n = Math.min(Math.max(1,blocco), candOut.length, candIn.length);
    for (let i=0;i<n;i++){
      const esce = candOut[i];
      const entra = candIn[i];

      // Swap
      onField = onField.filter(u => u !== esce);
      onField.push(entra);
      onBench = onBench.filter(u => u !== entra);
      onBench.push(esce);

      events.push({ minuto:min, esce, entra });
    }
  });

  // Chiudi fino al 50'
  advance(TOT);

  // Risultato: piano sostituzioni generato (modificabile a mano in editor)
  window._subsPlan = events;
  renderSubsEditor();
}


// bind bottoni piano sostituzioni
byId('btn-genera-sostituzioni').onclick = ()=>{
  const blocco = parseInt(byId('subs-blocco').value, 10) || 1;
  generaSostituzioniAutomatiche(blocco);
};
byId('btn-salva-sostituzioni').onclick = ()=>{
  window.saveSostituzioni(matchId);
};

// se c'erano sostituzioni gi√† salvate, mostra editor
renderSubsEditor();

    
    // Preselezioni titolari e panchina
    const setVal = (id, uid) => { const el = byId(`slot-${id}`); if (el && uid) el.value = uid; };
    setVal('portiere',   titolariSaved.portiere   || '');
    setVal('d1',         titolariSaved.d1         || '');
    setVal('d2',         titolariSaved.d2         || '');
    setVal('d3',         titolariSaved.d3         || '');
    setVal('c1',         titolariSaved.c1         || '');
    setVal('c2',         titolariSaved.c2         || '');
    setVal('c3',         titolariSaved.c3         || '');
    setVal('attaccante', titolariSaved.attaccante || '');
['portiere','d1','d2','d3','c1','c2','c3','attaccante'].forEach(id=>{
  const el = byId(`slot-${id}`);
  if(el) el.onchange = renderPanchinaList;
});
    const panSel = byId('panchina-select');
    if (panSel && panchinaSaved.length) {
      const values = new Set(panchinaSaved);
      [...panSel.options].forEach(o => { if (values.has(o.value)) o.selected = true; });
    }

    // Bindazioni
    byId('formazione-editor-form').onsubmit = (ev) => {
      ev.preventDefault();
      window.saveFormazione(matchId);
    };
    byId('btn-pubblica-formazione').onclick = () => window.pubblicaFormazione(matchId);

  } catch(e) {
    console.error('Errore showFormazioneForm:', e);
    container.innerHTML = `<div class="error">Errore nel caricamento dati formazione.</div>`;
  }
};
// ================== ADMIN: SAVE FORMATION ==================
window.saveFormazione = async function(matchId){
  try {
    const getVal = id => (byId(`slot-${id}`)?.value || '');
    const formazione = {
      portiere:   getVal('portiere'),
      d1:         getVal('d1'),
      d2:         getVal('d2'),
      d3:         getVal('d3'),
      c1:         getVal('c1'),
      c2:         getVal('c2'),
      c3:         getVal('c3'),
      attaccante: getVal('attaccante')
    };

    // Panchina (multi)
    const panchina = Array.from(window._selectedPanchinaSet);

    // Candidati TRUE della partita
    const snapCand = await get(ref(db, `calendario/${matchId}/candidature`));
    const candidature = snapCand.val() || {};
    const candidatiUID = Object.entries(candidature).filter(([,v])=>v===true).map(([uid])=>uid);
const uid = auth.currentUser ? auth.currentUser.uid : null;

// controlla se utente gi√† candidato
const isCandidato = uid && candidatiUID.includes(uid);



    
    // Esclusi = candidati - (titolari ‚à™ panchina)
    const used = new Set(Object.values(formazione).filter(Boolean));
    panchina.forEach(uid => used.add(uid));
    const esclusi = candidatiUID.filter(uid => !used.has(uid));

    const payload = { '0': { formazione, panchina, esclusi } };
    await update(ref(db, `calendario/${matchId}/formazioni`), payload);

    alert('Formazione salvata.');
  } catch(e) {
    console.error('Errore salvataggio formazione:', e);
    alert('Errore durante il salvataggio della formazione.');
  }
};
// ================== ADMIN: PUBLISH FORMATION ==================
window.pubblicaFormazione = async function(matchId){
  try {
    await update(ref(db, `calendario/${matchId}`), { formazionePubblicata: true });
    alert('Formazione pubblicata. Ora √® visibile nel Calendario pubblico.');
  } catch(e) {
    console.error('Errore pubblicazione formazione:', e);
    alert('Errore nella pubblicazione della formazione.');
  }
};

// ================== ADMIN: SAVE SOSTITUZIONI ==================
window.saveSostituzioni = async function(matchId){
  try {
    const plan = Array.isArray(window._subsPlan) ? window._subsPlan : [];
    // valida basic: minuto int [0..49], uid non vuoti e diversi
    const valid = plan.filter(s => Number.isInteger(s.minuto) && s.minuto>=0 && s.minuto<=49 && s.esce && s.entra && s.esce !== s.entra);
    await update(ref(db, `calendario/${matchId}`), { sostituzioni: valid });
    alert('Sostituzioni salvate.');
  } catch(e) {
    console.error('Errore salvataggio sostituzioni:', e);
    alert('Errore durante il salvataggio delle sostituzioni.');
  }
};


    
    /**
     * FIX: Esposto a window per essere accessibile dall'onclick HTML
     */
window.showFormazionePubblica = async function(matchId, avv){
  window.showPublicSection('formazione-pubblica-section');
  const box = byId('formazione-pubblica-content');
  box.innerHTML = 'Caricamento formazione...';

  const [snapMatch, snapRosa] = await Promise.all([
    get(ref(db, `calendario/${matchId}`)),
    get(ref(db, 'rosa'))
  ]);

  const match = snapMatch.val() || {};
  const rosa = snapRosa.val() || {};

  if(!match.formazionePubblicata || !match.formazioni || !match.formazioni['0']){
    box.innerHTML = `<h2>Formazione vs ${escapeHtml(avv)}</h2><p>Formazione non ancora pubblicata.</p>`;
    return;
  }

 let tit = match.formazioni['0'].formazione || {};

// retrocompatibilit√† vecchio formato ruoli testuali
const MAP_OLD2NEW = {
  'Portiere':'portiere',
  'Terzino sinistro':'d1',
  'Difensore centrale':'d2',
  'Terzino destro':'d3',
  'Centrocampista sinistro':'c1',
  'Centrocampista centrale':'c2',
  'Centrocampista destro':'c3',
  'Attaccante centrale':'attaccante'
};

// converti se necessario
const newFormat = {};
Object.entries(tit).forEach(([ruolo, pid])=>{
  if (MAP_OLD2NEW[ruolo]) {
    newFormat[MAP_OLD2NEW[ruolo]] = pid;
  } else {
    newFormat[ruolo] = pid; // gi√† nuovo formato
  }
});
tit = newFormat;

  const pan = match.formazioni['0'].panchina || [];
  const sost = match.sostituzioni || [];

  let html = [];
  html.push(`<h2>Formazione vs ${escapeHtml(avv)}</h2>`);

  // campo titolari (3-3-1)
  html.push(`<h4>Titolari (Minuto 0)</h4>`);
  html.push(`<div class="field" style="height:320px; position:relative;">`);

  const POS_331 = {
    'portiere':   {top:'90%', left:'50%'},
    'd1':         {top:'65%', left:'20%'},
    'd2':         {top:'65%', left:'50%'},
    'd3':         {top:'65%', left:'80%'},
    'c1':         {top:'40%', left:'20%'},
    'c2':         {top:'40%', left:'50%'},
    'c3':         {top:'40%', left:'80%'},
    'attaccante': {top:'10%', left:'50%'}
  };

  Object.entries(tit).forEach(([slot, id])=>{

  // NEW FORMAT ‚Üí UID auth
  let pl = Object.values(rosa).find(r=>r.uid === id);

  // OLD FORMAT ‚Üí PID rosa
  if (!pl && rosa[id]) {
    pl = rosa[id];
  }

    const pos = POS_331[slot];
    if(pl && pos){
      html.push(`
        <div class="marker" style="top:${pos.top}; left:${pos.left};">
          <b>${escapeHtml(pl.cognome)}</b><br>${escapeHtml(pl.nome)}
        </div>
      `);
    }
  });

  html.push(`</div>`);

  // panchina
  if(pan.length > 0){
    html.push(`<h4>Panchina</h4>`);
    html.push(`<ul class="grid cols-3">`);
    pan.forEach(uid=>{
      const pl = Object.values(rosa).find(r=>r.uid === uid);
      if(pl){
        html.push(`<li class="card"><b>${escapeHtml(pl.nome)} ${escapeHtml(pl.cognome)}</b> (#${pl.numero||''})</li>`);
      }
    });
    html.push(`</ul>`);
  }

  // sostituzioni
  if(sost.length > 0){
    html.push(`<h4>Sostituzioni</h4>`);
    html.push(`<ul class="grid cols-2">`);
    sost.forEach(s=>{
      const plEntra = Object.values(rosa).find(r=>r.uid === s.entra);
      const plEsce = Object.values(rosa).find(r=>r.uid === s.esce);
      html.push(`
        <li class="card">
          <div style="font-weight:700">Minuto ${s.minuto}</div>
          Entra: <b>${plEntra?plEntra.cognome:'?'}</b> ‚Ä¢ Esce: <b>${plEsce?plEsce.cognome:'?'}</b>
        </li>
      `);
    });
    html.push(`</ul>`);
  }

  box.innerHTML = html.join('');
}





    

    /**
     * FIX: Esposto a window per essere accessibile dall'onclick HTML
     */
    window.showPrestazioniPubbliche = async function(matchId, avv){
      window.showPublicSection('prestazioni-partita-section');
      const content = byId('prestazioni-partita-content');
      content.innerHTML = 'Caricamento prestazioni...';

      try {
        const [snapRosa, snapPrests, snapMatch] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, `prestazioni/${matchId}`)),
          get(ref(db, `calendario/${matchId}`))
        ]);
        
        const rosa = snapRosa.val() || {};
        const prestazioni = snapPrests.val() || {};
        const match = snapMatch.val() || {};
        
        // Determina quali giocatori erano candidati (ou titolari/riserve) per la partita
        const cand = match.candidature || {};
        const titolariIds = Object.values(match.formazioni?.['0']?.formazione || {});
        const panchinaIds = match.formazioni?.['0']?.panchina || [];
        const availablePids = new Set([...titolariIds, ...panchinaIds, ...Object.keys(cand)]);
        
        const finalRows = Object.entries(prestazioni)
          .filter(([pid, data]) => availablePids.has(pid)) // FILTRA PER CANDIDATURA/FORMAZIONE
          .map(([pid, data]) => {
            const player = rosa[pid] || { nome: 'Giocatore', cognome: 'Sconosciuto', numero: '?' };
            let voto = data.voto;
            // Formatta il voto
            if (voto === null || Number.isNaN(voto)) {
              voto = '‚Äî';
            }
            return { 
              nome: `${player.nome} ${player.cognome}`, 
              numero: player.numero, 
              voto: voto, 
              goal: data.goal || 0 // goal is always a number (or 0)
            };
          })
          // Ordina per Voto (numeri prima, '‚Äî' dopo), poi Goal
          .sort((a, b) => {
            const votoA = a.voto === '‚Äî' ? -1 : a.voto;
            const votoB = b.voto === '‚Äî' ? -1 : b.voto;
            if (votoB !== votoA) return votoB - votoA;
            return (b.goal || 0) - (a.goal || 0);
          });

        if (finalRows.length === 0) {
          content.innerHTML = `<h3>vs ${escapeHtml(avv)}</h3><p>Nessun giocatore ha ricevuto prestazioni per questa partita.</p>`;
          return;
        }

        let tableHtml = `<table class="table"><thead><tr><th>#</th><th>Giocatore</th><th>Voto</th><th>Goal</th></tr></thead><tbody>`;
        finalRows.forEach(r => {
          tableHtml += `<tr><td>${r.numero}</td><td>${escapeHtml(r.nome)}</td><td><b>${r.voto}</b></td><td>${r.goal}</td></tr>`;
        });
        tableHtml += `</tbody></table>`;

        content.innerHTML = `<h3>Prestazioni vs ${escapeHtml(avv)}</h3>` + tableHtml;
      } catch (err) {
        console.error('Errore caricamento prestazioni partita:', err);
        content.innerHTML = `<h3>Prestazioni vs ${escapeHtml(avv)}</h3><p style="color:red">Impossibile caricare le prestazioni.</p>`;
      }
    }
    




    
    /* ========================================================================= */
    /* === FIX: IMPLEMENTAZIONE FUNZIONI ADMIN (CRUD/READ) === */
    /* ========================================================================= */
    
    // Funzioni Admin placeholder (CREATE/UPDATE/DELETE)
    // ================== ADMIN: ADD PLAYER DEFINITIVO ==================
window.addPlayer = async function(e){
  e.preventDefault();

  const nome = byId('giocatore-nome').value.trim();
  const cognome = byId('giocatore-cognome').value.trim();
  const numero = Number(byId('giocatore-numero').value.trim());
  const ruolo = byId('giocatore-ruolo').value.trim();
  const stato = byId('giocatore-stato').value.trim();

  if(!nome || !cognome || !numero || !ruolo || !stato){
    alert("Compila tutti i campi");
    return;
  }

  const rosaRef = ref(db, 'rosa');
  const newNode = push(rosaRef);

  await set(newNode, {
    nome,
    cognome,
    numero,
    ruolo,
    stato,
    assist: 0,
    goal: 0,
    partite: 0,
    voto: 0,
    uid: "" // non associato account auth finch√© non associamo utente
  });

  alert("Giocatore inserito correttamente!");

  // reset input form
  byId('giocatore-nome').value = "";
  byId('giocatore-cognome').value = "";
  byId('giocatore-numero').value = "";
  byId('giocatore-ruolo').value = "";
  byId('giocatore-stato').value = "Titolare";

  // ricarica rosa pubblica se gi√† visualizzata
  if(document.getElementById('rosa-section').classList.contains('active')){
    if(window.loadRosa) window.loadRosa();
  }
}


    
   // ================== ADMIN: SAVE NEW MATCH (NUOVA PARTITA) ==================
window.saveNewMatch = async function(){

  const data = byId('match-data').value.trim();
  const orario = byId('match-orario').value.trim();
  const avv = byId('match-avversaria').value.trim();
  const campo = byId('match-campo').value.trim();
  const casa = (byId('match-casa-trasferta').value === "true"); // true/false

  if(!data || !orario || !avv || !campo){
    alert("Compila tutti i campi obbligatori!");
    return;
  }

  const calRef = ref(db, 'calendario');
  const newNode = push(calRef);

  await set(newNode, {
    data,
    orario,
    avversaria: avv,
    campo,
    casa,
    candidature: {},
    formazioni: {},
    formazionePubblicata:false,
    risultato:"",
    linkVideo:""
  });

  alert("Partita inserita correttamente!");

  // reset
  byId('match-data').value="";
  byId('match-orario').value="";
  byId('match-avversaria').value="";
  byId('match-campo').value="";
  byId('match-casa-trasferta').value="true";
};




    
    window.crudUpdateGiocatore = async function(pid){

  const pSnap = await get(ref(db, 'rosa/'+pid));
  const p = pSnap.val();

  if(!p){
    alert("Giocatore non trovato.");
    return;
  }

  const nuovoNome = prompt("Nome:", p.nome);
  if(nuovoNome===null) return;

  const nuovoCognome = prompt("Cognome:", p.cognome);
  if(nuovoCognome===null) return;

  const nuovoNumero = prompt("Numero maglia:", p.numero);
  if(nuovoNumero===null) return;

  const nuovoRuolo = prompt("Ruolo:", p.ruolo);
  if(nuovoRuolo===null) return;

  const nuovoStato = prompt("Stato (Titolare/Riserva):", p.stato);
  if(nuovoStato===null) return;

  await update(ref(db, 'rosa/'+pid),{
    nome: nuovoNome.trim(),
    cognome: nuovoCognome.trim(),
    numero: Number(nuovoNumero),
    ruolo: nuovoRuolo,
    stato: nuovoStato
  });

  alert("Giocatore aggiornato!");

  // ricarica tabella CRUD
  if(window.loadCrudGiocatori) window.loadCrudGiocatori();
      if(window.loadRosa) window.loadRosa();
if(window.loadRosaAdmin) window.loadRosaAdmin?.();
};

   window.crudDeleteGiocatore = async function(pid){
  if(!confirm("Sei sicuro di eliminare questo giocatore?")) return;
  
  await remove(ref(db, 'rosa/'+pid));

  alert("Giocatore eliminato!");
  
  if(window.loadCrudGiocatori) window.loadCrudGiocatori();
     if(window.loadRosa) window.loadRosa();
if(window.loadRosaAdmin) window.loadRosaAdmin?.();
};

    // ===================== CRUD UPDATE PARTITA =====================
window.crudUpdatePartita = async function(matchId){

  const snap = await get(ref(db, 'calendario/'+matchId));
  const m = snap.val();
  if(!m){ alert("Partita non trovata"); return; }

  const data = prompt("Data (gg/mm/aaaa):", m.data || "");
  if(data===null) return;

  const orario = prompt("Orario (hh:mm):", m.orario || "");
  if(orario===null) return;

  const avv = prompt("Avversaria:", m.avversaria || "");
  if(avv===null) return;

  const campo = prompt("Campo:", m.campo || "");
  if(campo===null) return;

  const casa = confirm("Partita in CASA? (OK = Casa | Cancel = Trasferta)");

  await update(ref(db, 'calendario/'+matchId), {
    data,
    orario,
    avversaria: avv,
    campo,
    casa
  });

  alert("Partita aggiornata!");

  if(window.loadCrudPartite) window.loadCrudPartite();
};


// ===================== CRUD DELETE PARTITA =====================
window.crudDeletePartita = async function(matchId){
  if(!confirm("Sei sicuro di eliminare DEFINITIVAMENTE questa partita?")) return;

  await remove(ref(db,'calendario/'+matchId));

  alert("Partita eliminata!");

  if(window.loadCrudPartite) window.loadCrudPartite();
};

    window.loadCandidature=()=>document.getElementById('candidature-list').innerHTML = "<h3>Gestione Candidature</h3><div class=\"help\">Seleziona una partita dal menu Formaz./Voti/Cand. per vedere i dettagli, oppure implementa qui un selettore globale.</div>";
    window.closeCandidatureEditor = ()=>{
  byId('crud-candidature-panel').style.display='none';
  byId('crud-candidature-select').value="";
}


    /**
     * FIX: Carica la lista dei giocatori per il CRUD (Admin - Gestione Dati)
     */
    window.loadCrudGiocatori = async function(){
      const tbody = byId('crud-giocatori-body'); if(!tbody) return; 
      tbody.innerHTML='<tr><td colspan="7">Caricamento giocatori...</td></tr>';
      
      try {
        const [snapRosa, snapPrests] = await Promise.all([
            get(ref(db, 'rosa')),
            get(ref(db, 'prestazioni')) // Fetch all performances
        ]);
        const val = snapRosa.val() || {};
        const allPrests = snapPrests.val() || {};
        
        const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
        
        if(!rows.length){ tbody.innerHTML = '<tr><td colspan="7">Nessun giocatore inserito.</td></tr>'; return; }
        
        let html = '';
        for(const [id, g] of rows){
          let presenzeCount = 0;
          
          // Count performances for this player
          Object.values(allPrests).forEach(matchPrests => {
              if (matchPrests[id]) {
                  presenzeCount++;
              }
          });

          html += `
            <tr>
              <td><input type="text" value="${escapeHtml(g.nome)}" data-field="nome" data-id="${id}"/></td>
              <td><input type="text" value="${escapeHtml(g.cognome)}" data-field="cognome" data-id="${id}"/></td>
              <td><input type="number" min="1" max="99" value="${g.numero}" data-field="numero" data-id="${id}"/></td>
              <td><input type="text" value="${escapeHtml(g.ruolo)}" data-field="ruolo" data-id="${id}"/></td>
              <td><input type="text" value="${escapeHtml(g.stato)}" data-field="stato" data-id="${id}"/></td>
              <td>${presenzeCount}</td>
              <td>
              <button class="btn" onclick="crudUpdateGiocatore('${id}')">Modifica</button>
              <button class="btn btn--danger" onclick="crudDeleteGiocatore('${id}')">Elimina</button>
              </td>
            </tr>
          `;
        }
        tbody.innerHTML = html;

      } catch(e) {
        console.error("Errore caricamento CRUD Giocatori:", e);
        tbody.innerHTML = '<tr><td colspan="7" style="color:red">Errore durante il caricamento dei dati.</td></tr>';
      }
    }


    /**
     * FIX: Carica la lista delle partite per il CRUD (Admin - Gestione Dati)
     */
    window.loadCrudPartite = async function(){
      const tbody = byId('crud-partite-body'); if(!tbody) return; 
      tbody.innerHTML='<tr><td colspan="7">Caricamento partite...</td></tr>';
      
      try {
        const snap = await get(ref(db,'calendario'));
        const val = snap.val() || {};
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        const rows = Object.entries(val).sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
        
        if(!rows.length){ tbody.innerHTML = '<tr><td colspan="7">Nessuna partita inserita.</td></tr>'; return; }
        
        let html = rows.map(([id, m]) => {
          const isCasa = m.casa === true || m.casa === 'true';
          return `
            <tr>
              <td><input type="text" value="${escapeHtml(m.data)}" data-field="data" data-id="${id}"/></td>
              <td><input type="time" value="${escapeHtml(m.orario||'')}" data-field="orario" data-id="${id}"/></td>
              <td><input type="text" value="${escapeHtml(m.avversaria)}" data-field="avversaria" data-id="${id}"/></td>
              <td><input type="text" value="${escapeHtml(m.risultato||'N/D')}" data-field="risultato" data-id="${id}"/></td>
              <td><input type="text" value="${escapeHtml(m.campo)}" data-field="campo" data-id="${id}"/></td>
              <td>
                <select data-field="casa" data-id="${id}">
                  <option value="true" ${isCasa ? 'selected' : ''}>Casa</option>
                  <option value="false" ${!isCasa ? 'selected' : ''}>Trasferta</option>
                </select>
              </td>
              <td>
                <button class="btn btn--accent" onclick="crudUpdatePartita('${id}')" style="padding:4px 8px; font-size:.8rem;">Salva</button>
                <button class="btn" onclick="crudDeletePartita('${id}')" style="padding:4px 8px; font-size:.8rem; background:var(--ink-sub); color:#fff;">Elimina</button>
              </td>
            </tr>
          `;
        }).join('');
        
        tbody.innerHTML = html;

      } catch(e) {
        console.error("Errore caricamento CRUD Partite:", e);
        tbody.innerHTML = '<tr><td colspan="7" style="color:red">Errore durante il caricamento dei dati.</td></tr>';
      }
    }


    // Helper per popolare il selettore delle candidature
    const loadCrudCandidatureSelect = async () => {
        const select = byId('crud-candidature-select');
        if (!select) return;
        select.innerHTML = '<option value="">Caricamento...</option>';
        byId('crud-candidature-panel').style.display = 'none'; // Nasconde il pannello all'inizio
        
        try {
            const snap = await get(ref(db, 'calendario'));
            const partite = snap.val() || {};
            let options = '<option value="">Seleziona una partita...</option>';

            const toDate = (d) => { const [dd, mm, yyyy] = String(d || '').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
            const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

            sortedKeys.forEach(key => {
                const p = partite[key];
                const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
                options += `<option value="${key}">vs ${avversario} (${p.data || 'N/D'})</option>`;
            });

            select.innerHTML = options;
        } catch (e) {
            console.error("Errore caricamento selettore candidature:", e);
            select.innerHTML = '<option value="">Errore caricamento</option>';
        }
    };

   /**
 * FIX: Carica la lista delle candidature per una partita (Admin - Gestione Dati)
 * NOTA: Questa funzione assume che /rosa/{pid}/uid esista e sia l'Auth UID.
 */
window.loadCandidatureForMatch = async function(matchId){
  const tbody = byId('crud-candidature-body');
  const panel = byId('crud-candidature-panel');
  if(!tbody || !panel) return;
  
  if (!matchId) {
    panel.style.display = 'none';
    return;
  }
  
  tbody.innerHTML='<tr><td colspan="3">Caricamento candidature‚Ä¶</td></tr>';
  panel.style.display = 'block';

  try {
    const [snapRosa, snapCand] = await Promise.all([
      get(ref(db, 'rosa')),
      get(ref(db, `calendario/${matchId}/candidature`))
    ]);

    const rosa = snapRosa.val() || {};
    const candidature = snapCand.val() || {}; // { AuthUID: true|false }

    const rows = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));

    let htmlRows = rows.map(([pid, p]) => {
      const uid = p.uid || "";
      const isCandidato = !!uid && candidature[uid] === true;

      return `
        <tr>
          <td>${escapeHtml(p.nome)} ${escapeHtml(p.cognome)} (#${p.numero})</td>
          <td>${uid || 'N/D'}</td>
          <td>
            <input type="checkbox" id="cand-${pid}" data-uid="${uid}" ${isCandidato ? 'checked' : ''} style="width:auto; margin:0;" ${!uid ? 'disabled' : ''}>
            <label for="cand-${pid}" style="display:inline; font-weight:400; margin-left:8px;">Candidato ${!uid ? '(UID mancante)' : ''}</label>
          </td>
        </tr>
      `;
    }).join('');

    tbody.innerHTML = htmlRows || '<tr><td colspan="3">Nessun giocatore in rosa.</td></tr>';

    const saveBtn = byId('crud-candidature-save');
    if (saveBtn) saveBtn.onclick = async ()=>{

  const checks = document.querySelectorAll('#crud-candidature-body input[type="checkbox"]');
  let updates = {};

  checks.forEach(ch=>{
    const uid = ch.dataset.uid;
    if(!uid) return;
    updates[uid] = ch.checked;   // true or false
  });

  await update(ref(db, `calendario/${matchId}/candidature`), updates);

  alert("Candidature aggiornate correttamente!");

  // ricarico tabella per sicurezza visuale
  window.loadCandidatureForMatch(matchId);
};


  } catch(e) {
    console.error("Errore caricamento Candidature CRUD:", e);
    tbody.innerHTML = '<tr><td colspan="3" style="color:red">Errore durante il caricamento dei dati.</td></tr>';
  }
};
window.loadGestionePermessi = async function(){

  const user = auth.currentUser;
  const snapMy = await get(ref(db, 'utenti/' + user.uid));
  const myData = snapMy.val() || {};

  // se non √® superadmin ‚Üí non mostra elenco permessi
  if(myData.role !== 'superadmin'){
    byId('users-permission-table').style.display='none';
    byId('btn-salva-permessi').style.display='none';
    return;
  }

  // carica utenti
  const snap = await get(ref(db, 'utenti'));
  const utenti = snap.val() || {};

  let html = '';
  Object.entries(utenti).forEach(([uid, u])=>{
    const role = u.role || 'user';
    html += `
      <tr>
        <td>${escapeHtml(u.nome)} ${escapeHtml(u.cognome)}</td>
        <td>${escapeHtml(u.email)}</td>
        <td>
          <select class="role-select" data-uid="${uid}">
            <option value="user" ${role==='user'?'selected':''}>User</option>
            <option value="admin" ${role==='admin'?'selected':''}>Admin</option>
            <option value="superadmin" ${role==='superadmin'?'selected':''}>Superadmin</option>
          </select>
        </td>
      </tr>`;
  });

  byId('users-list-body').innerHTML = html;
}

// SALVATAGGIO permessi
byId('btn-salva-permessi').onclick = async function(){
  const selects = document.querySelectorAll('.role-select');
  for(const sel of selects){
    const uid = sel.dataset.uid;
    const newRole = sel.value;
    await update(ref(db, 'utenti/'+uid), { role:newRole });
  }
  alert('Permessi aggiornati!');
};

    // Funzioni Admin per i form (Mostra struttura + Caricamento dati)
    
    /**
     * FIX: Carica dati esistenti per il form Risultato/Video.
     */
    window.showResultForm = async function(matchId, avv) {
      window.showAdminSection('admin-statistiche-section');
      const container = byId('risultato-form-container');
      container.innerHTML = 'Caricamento dati partita...';
      
      const snap = await get(ref(db, `calendario/${matchId}`));
      const m = snap.val() || {};
      
      const risultatoValue = escapeHtml(m.risultato || '');
      const linkVideoValue = escapeHtml(m.linkVideo || '');

      container.innerHTML = `
        <h3>Inserimento Risultato/Video vs ${escapeHtml(avv)}</h3>
        <div class="help">**Attenzione:** La funzione di salvataggio del risultato e del video √® da implementare.</div>
        <form id="result-entry-form" data-match-id="${matchId}">
            <label>Risultato (Esempio: 5-3)</label>
            <input type="text" id="risultato" placeholder="X-Y" value="${risultatoValue}" required>
            <label>Link YouTube (Facoltativo)</label>
            <input type="url" id="linkVideo" placeholder="https://www.youtube.com/watch?v=..." value="${linkVideoValue}" />
            <p class="help">ID Partita: <b>${matchId}</b></p>
            <div class="actions">
                <button type="submit" class="btn btn--accent" onclick="alert('Funzione di salvataggio da implementare!')">Salva Risultato e Video</button>
            </div>
        </form>
      `;
    };
    

    
    /**
     * FIX: Carica dati esistenti per il form Valutazione Prestazioni.
     */
    window.showValutazionePartitaForm = async function(matchId, avv) {
      window.showAdminSection('admin-prestazioni-partita-section');
      const container = byId('prestazioni-form-container');
      container.innerHTML = 'Caricamento dati prestazioni...';
      
      const [snapRosa, snapPrests] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, `prestazioni/${matchId}`))
      ]);
      
      const rosa = snapRosa.val() || {};
      const prestazioni = snapPrests.val() || {};
      
      // Get all players, sort by number
      const players = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      
      let rowsHtml = players.map(([pid, p]) => {
          const data = prestazioni[pid] || {};
          // Usa Number.isFinite per controllare che voto sia un numero finito prima di mostrarlo
          const voto = (data.voto !== null && Number.isFinite(data.voto)) ? data.voto : '';
          const goal = data.goal || 0;
          return `
            <tr>
              <td>${p.numero}</td>
              <td>${escapeHtml(p.nome)} ${escapeHtml(p.cognome)}</td>
              <td><input type="number" min="4" max="10" step="0.5" value="${voto}" data-id="${pid}" data-field="voto" style="width:70px;"></td>
              <td><input type="number" min="0" value="${goal}" data-id="${pid}" data-field="goal" style="width:50px;"></td>
              <td><input type="text" value="${escapeHtml(data.note || '')}" data-id="${pid}" data-field="note" placeholder="Note"></td>
            </tr>
          `;
      }).join('');
      
      let tableHtml = `<table class="table"><thead><tr><th>#</th><th>Giocatore</th><th>Voto</th><th>Goal</th><th>Note</th></tr></thead><tbody>${rowsHtml}</tbody></table>`;

      container.innerHTML = `
        <h3>Valutazione Prestazioni vs ${escapeHtml(avv)}</h3>
        <div class="help">**Attenzione:** La funzione di salvataggio dei dati non √® implementata. I valori mostrati sono quelli attualmente salvati.</div>
        <form id="prestazioni-valutazione-form" data-match-id="${matchId}">
            <h4>Assegna Voti e Goal (Giocatori nella Rosa: ${players.length})</h4>
            <div style="overflow-x:auto; margin-bottom:14px;">${tableHtml}</div>
            <p class="help">ID Partita: <b>${matchId}</b></p>
            <div class="actions">
                <button type="submit" class="btn btn--accent" onclick="alert('Funzione di salvataggio da implementare!')">Salva Prestazioni</button>
            </div>
        </form>
      `;
    };
    
    /**
     * FIX: Carica dati esistenti per il form Gestione Candidature (Admin Calendario).
     * NOTA: Questa funzione assume che /rosa/{pid}/uid esista e sia l'Auth UID.
     */
    window.showCandidatureEditor = async function(matchId, avv) {
        window.showAdminSection('admin-candidature-section');
        const container = byId('candidature-list');
        container.innerHTML = 'Caricamento dati candidature...';
        
        const [snapRosa, snapCand] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, `calendario/${matchId}/candidature`))
        ]);
        
        const rosa = snapRosa.val() || {};
        const candidature = snapCand.val() || {}; // { AuthUID_123: true }
        
        const rows = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
        
        let listHtml = rows.map(([pid, p]) => {
          // *** Controlla la candidatura usando l'UID del giocatore (p.uid) ***
          const isCandidato = p.uid && candidature[p.uid] === true;
          return `
            <li class="card" style="display:flex; justify-content:space-between; align-items:center;">
              <div><b>${escapeHtml(p.nome)} ${escapeHtml(p.cognome)}</b> (#${p.numero})</div>
              <div>
                <input type="checkbox" id="cand-edit-${pid}" data-uid="${p.uid || ''}" ${isCandidato ? 'checked' : ''} style="width:auto; margin:0;" ${!p.uid ? 'disabled' : ''}>
                <label for="cand-edit-${pid}" style="display:inline; font-weight:400; margin-left:8px;">Candidato ${!p.uid ? '(UID mancante)' : ''}</label>
              </div>
            </li>
          `;
        }).join('');
        
        container.innerHTML = `
            <h3>Gestione Candidature vs ${escapeHtml(avv)}</h3>
            <div class="help">**Attenzione:** La funzione di salvataggio √® da implementare. I check/uncheck attuali riflettono lo stato del database.</div>
            <form id="candidature-admin-form" data-match-id="${matchId}">
                <h4>Lista Candidati (Giocatori nella Rosa: ${rows.length})</h4>
                <ul class="grid cols-2" style="margin-top:14px;">
                    ${listHtml}
                </ul>
                <p class="help">ID Partita: <b>${matchId}</b></p>
                <div class="actions">
                    <button type="submit" class="btn btn--accent" onclick="alert('Funzione di salvataggio da implementare!')">Salva Selezione Candidati</button>
                </div>
            </form>
        `;
    };

    
     /**
     * funzione toggle candidatura
     */
window.toggleCandidatura = async function(matchId) {
  if(!auth.currentUser){
    return showLogin();
  }

  const user = auth.currentUser;
  const snapMatch = await get(ref(db, `calendario/${matchId}`));
  const match = snapMatch.val() || {};

  // --- BLOCCO 48h solo non admin ---
  if(window.currentUserRole !== 'admin' && window.currentUserRole !== 'superadmin'){
    if(match.data){
      const [dd,mm,yy] = match.data.split('/');
      const matchDate = new Date(`${yy}-${mm}-${dd}T00:00:00`);
      const diffHours = (matchDate - new Date()) / 36e5;
      if(diffHours < 48){
        alert("Candidature bloccate. Mancano meno di 48 ore alla partita.");
        return;
      }
    }
  }

  const candRef = ref(db, `calendario/${matchId}/candidature/${user.uid}`);
  const snap = await get(candRef);
  const curr = snap.exists() ? snap.val() : false;
  const nuovoValore = !curr;

  await set(candRef, nuovoValore);

  // refresh UI
  if(window.loadCalendario) window.loadCalendario(); 
}
    
  

window.loadCandidatureForMatch = async function(matchId){
  const tbody = byId('crud-candidature-body');
  const panel = byId('crud-candidature-panel');
  if(!tbody || !panel) return;
  
  if (!matchId) {
    panel.style.display = 'none';
    return;
  }
  
  tbody.innerHTML='<tr><td colspan="3">Caricamento candidature‚Ä¶</td></tr>';
  panel.style.display = 'block';

  try {
    // Carico: rosa, candidature della partita, e UTENTI (per join runtime + scrittura UID in rosa se mancante)
    const [snapRosa, snapCand, snapUsers] = await Promise.all([
      get(ref(db, 'rosa')),
      get(ref(db, `calendario/${matchId}/candidature`)),
      get(ref(db, 'utenti'))
    ]);

    const rosa = snapRosa.val() || {};
    const candidature = snapCand.val() || {}; // { AuthUID: true|false }
    const utenti = snapUsers.val() || {};

    // Helper: normalizza stringhe per confronto robusto
    const norm = s => (String(s||'').trim().toLowerCase());

    // Prepara indice veloce degli utenti per nome+cognome -> uid
    const nameIndex = {};
    for (const [uid, u] of Object.entries(utenti)) {
      const key = norm(u.nome) + '|' + norm(u.cognome);
      if (!nameIndex[key]) nameIndex[key] = uid; // prima corrispondenza vince (runtime)
    }

    const rows = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));

    const uidsToPersist = []; // [ [pid, uid], ... ]

    let htmlRows = rows.map(([pid, p]) => {
      // 1) UID preferito: quello gi√† presente in rosa
      let uid = p.uid || "";
      // 2) Se assente, prova join runtime con nodo utenti (nome+cognome)
      if (!uid) {
        const key = norm(p.nome) + '|' + norm(p.cognome);
        if (nameIndex[key]) uid = nameIndex[key];
        // Opzione A (solo se mancante): persistere UID dentro /rosa/{pid}/uid
        if (!p.uid && uid) {
          uidsToPersist.push([pid, uid]);
        }
      }

      const isCandidato = !!uid && candidature[uid] === true;

      return `
        <tr>
          <td>${escapeHtml(p.nome)} ${escapeHtml(p.cognome)} (#${p.numero})</td>
          <td>${uid || 'N/D'}</td>
          <td>
            <input type="checkbox" id="cand-${pid}" data-uid="${uid || ''}" ${isCandidato ? 'checked' : ''} style="width:auto; margin:0;" ${!uid ? 'disabled' : ''}>
            <label for="cand-${pid}" style="display:inline; font-weight:400; margin-left:8px;">Candidato ${!uid ? '(UID mancante)' : ''}</label>
          </td>
        </tr>
      `;
    }).join('');

    tbody.innerHTML = htmlRows || '<tr><td colspan="3">Nessun giocatore in rosa.</td></tr>';

    // Persistenza UID solo per quelli mancanti (opzione 1: solo se non esisteva)
    if (uidsToPersist.length > 0) {
      const updates = {};
      for (const [pid, uid] of uidsToPersist) {
        updates[`rosa/${pid}/uid`] = uid;
      }
      try {
        await update(ref(db), updates);
        console.log('UID aggiunti alla rosa per', uidsToPersist.length, 'giocatori.');
      } catch (persistErr) {
        console.warn('Impossibile aggiornare alcuni UID nella rosa:', persistErr);
      }
    }

    // Pulsante Salva (placeholder, coerente con il resto del file)
    const saveBtn = byId('crud-candidature-save');
    if (saveBtn) saveBtn.onclick = () => alert(`Funzione per salvare le candidature per la partita ${matchId} da implementare.`);

  } catch(e) {
    console.error("Errore caricamento Candidature CRUD:", e);
    tbody.innerHTML = '<tr><td colspan="3" style="color:red">Errore durante il caricamento dei dati.</td></tr>';
  }
}

</script>
</head>
<body> 
<header> 
  <div class="hero" role="banner"> 
    <img src="Logo.png" alt="Logo AC Tuscolano" /> 
    <div class="brand"> 
      <h1 class="club">AC Tuscolano</h1> 
      <p class="tag">Football Club</p> 
    </div> 
  </div> 
</header> 
<nav aria-label="Navigazione principale"> 
  <div class="nav-wrap"> 
    <button id="rosa-tab" class="tab" data-target="rosa-section" aria-current="page" onclick="showPublicSection('rosa-section')">La nostra Rosa</button> 
    <button id="calendario-tab" class="tab" data-target="calendario-section" onclick="showPublicSection('calendario-section')">Calendario & Partite</button> 
    <button id="classifica-tab" class="tab" data-target="classifica-section" onclick="showPublicSection('classifica-section')">Classifica</button> 
    <button id="statistiche-tab" class="tab" data-target="statistiche-section" onclick="showPublicSection('statistiche-section')">Statistiche & Voti</button> 
    <button id="video-tab" class="tab" data-target="video-section" onclick="showPublicSection('video-section')">Video</button> 
    <a href="https://www.romatornei.it/calcio-a-8-over-40-roma-sud" target="_blank" class="tab" style="text-decoration:none;">Torneo</a> 
    <button id="auth-toggle-btn" class="btn" onclick="handleAuthToggle()">Login</button> 
  </div> 
</nav> 
<div id="admin-menu"> 
  <div class="nav-wrap" style="max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;">
    <button class="tab" data-admin-target="admin-inserimento-giocatori-section" onclick="showAdminSection('admin-inserimento-giocatori-section')">Nuovo Giocatore</button>
    <button class="tab" data-admin-target="admin-inserimento-giornate-section" onclick="showAdminSection('admin-inserimento-giornate-section')">Nuova Partita</button>
    <button class="tab" data-admin-target="admin-calendario-section" onclick="showAdminSection('admin-calendario-section')">Formaz./Voti/Cand.</button>
    <button class="tab" data-admin-target="admin-video-section" onclick="showAdminSection('admin-video-section')">Gestione Video</button>
    <button class="tab" data-admin-target="admin-classifica-section" onclick="showAdminSection('admin-classifica-section')">Aggiorna Classifica</button>
    <button class="tab" data-admin-target="admin-gestione-dati-section" onclick="showAdminSection('admin-gestione-dati-section')">CRUD Dati</button>
    <button class="tab" data-admin-target="admin-utenti-section" onclick="showAdminSection('admin-utenti-section')">Gestione Utenti</button>
  </div>
</div>
<main>
  <section id="login-section" class="content-section">
    <h2>Login Amministratore</h2>
    <form id="login-form">
      <label>Email</label><input id="login-email" type="email" required />
      <label>Password</label><input id="login-password" type="password" required />
      <div class="actions">
        <button type="submit" class="btn btn--accent">Accedi</button>
      </div>
    </form>
  </section>

  <section id="rosa-section" class="content-section active">
    <h2>La nostra Rosa</h2>
    <div class="help">Lista dei giocatori, ruolo e stato. Ordinati per numero di maglia.</div>
    <ul id="rosa-list"></ul>
  </section>

  <section id="calendario-section" class="content-section">
    <h2>Calendario & Partite</h2>
    <div class="help">Lista ordinata dalla partita pi√π recente. Clicca su "Candidatura" per confermare la disponibilit√†.</div>
    <ul id="calendario-list" class="grid cols-3"></ul>
  </section>

  <section id="classifica-section" class="content-section">
    <h2>Classifica</h2>
    <div id="classifica-content" style="overflow-x:auto;"> 
    </div>
  </section>

  <section id="statistiche-section" class="content-section">
    <h2>Prestazioni</h2>
    <h3>Risultati squadra</h3>
    <div class="help">Lista ordinata dalla partita pi√π recente.</div>
    <ul id="statistiche-risultati-list"> 
    </ul>
    <div id="prestazioni-aggregate-content">
      <h3>Riepilogo Giocatori</h3>
      <div class="help">Calcolo media voti e goal in corso‚Ä¶</div>
    </div>
  </section>

  <section id="video-section" class="content-section">
    <h2>Video Partite Concluse</h2>
    <ul id="video-list-ul" style="display:grid; gap:16px;"> 
    </ul>
  </section>

  <section id="formazione-pubblica-section" class="content-section">
    <h2>Formazione Ufficiale</h2>
    <div id="formazione-pubblica-content"></div>
    <div class="actions" style="margin-top:10px"><button class="btn" onclick="showPublicSection('calendario-section')">Torna al calendario</button></div>
  </section>

  <section id="prestazioni-partita-section" class="content-section">
    <h2>Prestazioni Partita</h2>
    <div id="prestazioni-partita-content"></div>
    <div class="actions" style="margin-top:10px"><button onclick="showPublicSection('statistiche-section')" class="btn">Torna alle statistiche</button></div>
  </section>

  <section id="admin-inserimento-giocatori-section" class="content-section">
    <h2>Admin ¬∑ Inserimento giocatori</h2>
    <form id="giocatore-form" onsubmit="window.addPlayer(event)">
      <label>Nome</label><input id="giocatore-nome" required />
      <label>Cognome</label><input id="giocatore-cognome" required />
      <label>Numero Maglia</label><input id="giocatore-numero" type="number" min="1" max="99" required />
      <label>Ruolo</label>
      <select id="giocatore-ruolo" required>
        <option value="">Seleziona ruolo</option>
        <option>Portiere</option>
        <option>Terzino sinistro</option>
        <option>Terzino destro</option>
        <option>Difensore centrale</option>
        <option>Centrocampista centrale</option>
        <option>Centrocampista sinistro</option>
        <option>Centrocampista destro</option>
        <option>Attaccante centrale</option>
      </select>
      <label>Stato Iniziale</label>
      <select id="giocatore-stato" required>
        <option>Titolare</option>
        <option>Riserva</option>
      </select>
      <div class="actions">
        <button type="submit" class="btn btn--accent">Aggiungi Giocatore</button>
      </div>
    </form>
    <div class="help" style="margin-top:10px">I nuovi giocatori non appaiono subito nella rosa pubblica finch√© non ricarichi la pagina o usi la sezione CRUD.</div>
  </section>

  <section id="admin-inserimento-giornate-section" class="content-section">
    <h2>Admin ¬∑ Inserimento giornate</h2>
    <form id="match-form">
      <div class="grid cols-2">
        <div><label>Data (gg/mm/aaaa)</label><input id="match-data" required /></div>
        <div><label>Ora (hh:mm)</label><input id="match-orario" type="time" placeholder="18:00" /></div>
      </div>
      <label>Avversaria</label><input id="match-avversaria" required />
      <label>Campo di Gioco</label><input id="match-campo" required />
      <label>Partita in Casa/Trasferta</label>
      <select id="match-casa-trasferta" required>
        <option value="true">Casa</option>
        <option value="false">Trasferta</option>
      </select>
      <div class="actions">
        <button type="button" class="btn btn--accent" onclick="saveNewMatch()">Inserisci Partita</button>
      </div>
    </form>
  </section>

  <section id="admin-calendario-section" class="content-section">
    <h2>Admin ¬∑ Gestione Partite</h2>
    <div class="help">Lista ordinata dalla partita pi√π recente. Puoi inserire formazioni, risultati e valutazioni.</div>
    <ul id="admin-calendario-list" class="grid cols-3"></ul>
  </section>
  
  <section id="admin-classifica-section" class="content-section">
    <h2>Admin ¬∑ Gestione Classifica</h2>
    <div class="help">Aggiorna la classifica prendendola dal sito esterno romatornei.it e salvala nel database per la visualizzazione pubblica.</div>
    <div class="actions">
      <button class="btn btn--accent" onclick="updateClassificaFromSito()">Aggiorna Classifica Ora</button>
    </div>
    <div id="classifica-risultato-update" style="margin-top:10px;"></div>
  </section>

  <section id="admin-statistiche-section" class="content-section">
    <h2>Admin ¬∑ Inserimento Risultato/Video</h2>
    <div id="risultato-form-container"></div>
    <div class="actions" style="margin-top:10px"><button class="btn" onclick="showAdminSection('admin-calendario-section')">Torna al calendario Admin</button></div>
  </section>

  <section id="admin-formazione-section" class="content-section">
    <h2>Admin ¬∑ Inserimento Formazione</h2>
    <div id="formazione-form-container"></div>
    <div class="actions" style="margin-top:10px"><button class="btn" onclick="showAdminSection('admin-calendario-section')">Torna al calendario Admin</button></div>
  </section>

  <section id="admin-candidature-section" class="content-section">
    <h2>Admin ¬∑ Gestione Candidature</h2>
    <div id="candidature-list"></div>
    <div class="actions" style="margin-top:10px"><button class="btn" onclick="showAdminSection('admin-calendario-section')">Torna al calendario Admin</button></div>
  </section>
  
  <section id="admin-prestazioni-partita-section" class="content-section">
    <h2>Admin ¬∑ Valutazione Prestazioni</h2>
    <div id="prestazioni-form-container"></div>
    <div class="actions" style="margin-top:10px"><button class="btn" onclick="showAdminSection('admin-calendario-section')">Torna al calendario Admin</button></div>
  </section>
  
  <section id="admin-gestione-dati-section" class="content-section">
    <h2>Admin ¬∑ Gestione dati</h2>
    <div class="card" style="margin-bottom:14px">
      <div class="row">
        <button class="tab" aria-current="page" onclick="document.getElementById('crud-giocatori').style.display='block';document.getElementById('crud-partite').style.display='none';document.getElementById('crud-candidature').style.display='none';loadCrudGiocatori()">Giocatori</button>
        <button class="tab" onclick="document.getElementById('crud-giocatori').style.display='none';document.getElementById('crud-partite').style.display='block';document.getElementById('crud-candidature').style.display='none';loadCrudPartite()">Partite</button>
        <button class="tab" onclick="document.getElementById('crud-giocatori').style.display='none';document.getElementById('crud-partite').style.display='none';document.getElementById('crud-candidature').style.display='block'">Candidature (dati)</button>
      </div>
    </div>
    <div id="crud-giocatori" style="display:block">
      <h3>Gestione Giocatori</h3>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead><tr><th>Nome</th><th>Cognome</th><th>Num.</th><th>Ruolo</th><th>Stato</th><th>Pres.</th><th>Azioni</th></tr></thead>
          <tbody id="crud-giocatori-body"></tbody>
        </table>
        <div class="help" style="margin-top:10px;">**Azioni:** I pulsanti Salva ed Elimina sono placeholder e non funzionano.</div>
      </div>
    </div>
    <div id="crud-partite" style="display:none">
      <h3>Gestione Partite</h3>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead><tr><th>Data</th><th>Ora</th><th>Avversaria</th><th>Risultato</th><th>Campo</th><th>Casa?</th><th>Azioni</th></tr></thead>
          <tbody id="crud-partite-body"></tbody>
        </table>
        <div class="help" style="margin-top:10px;">**Azioni:** I pulsanti Salva ed Elimina sono placeholder e non funzionano.</div>
      </div>
    </div>
    <div id="crud-candidature" style="display:none">
      <h3>Candidature per Partita</h3>
      <label>Seleziona Partita</label>
      <select id="crud-candidature-select" onchange="loadCandidatureForMatch(this.value)">
        <option value="">Seleziona una partita...</option>
      </select>
      
      <div id="crud-candidature-panel" class="card" style="margin-top:14px; display:none;">
        <div style="overflow-x:auto;">
          <table class="table">
            <thead><tr><th>Giocatore</th><th>Utente ID</th><th>Candidato</th></tr></thead>
            <tbody id="crud-candidature-body"></tbody>
          </table>
        </div>
        <div class="actions" style="margin-top:14px">
          <button id="crud-candidature-save" class="btn btn--accent">Salva Candidature</button>
          <button class="btn" onclick="closeCandidatureEditor()">Chiudi</button>
        </div>
      </div>
      <div class="help" style="margin-top:10px;">**Azioni:** I pulsanti Salva e Chiudi sono placeholder e non funzionano.</div>
    </div>
  </section>


  <section id="admin-utenti-section" class="content-section">
    <h2>Admin ¬∑ Creazione Utente</h2>
    <form id="create-user-form">
      <label>Nome</label><input id="new-nome" required />
      <label>Cognome</label><input id="new-cognome" required />
      <label>Email (per login)</label><input id="new-email" type="email" required />
      <label>Password (temporanea)</label><input id="new-password" type="text" required />
      <div class="actions">
        <button type="submit" class="btn btn--accent">Crea Utente</button>
      </div>
    </form>
    <div class="help">L‚Äôadmin resta connesso durante la creazione grazie all‚Äôautenticazione secondaria.</div>
    <hr style="margin:25px 0">

<h3>Elenco Utenti & Permessi</h3>
<p class="help">Qui puoi modificare ruolo degli utenti. Solo il SUPERADMIN vede questa parte.</p>

<table id="users-permission-table" class="table">
  <thead>
    <tr>
      <th>Nome</th>
      <th>Email</th>
      <th>Ruolo</th>
    </tr>
  </thead>
  <tbody id="users-list-body">
    <!-- users runtime -->
  </tbody>
</table>

<div class="actions" style="margin-top:14px;">
  <button id="btn-salva-permessi" class="btn btn--accent">Salva Permessi</button>
</div>
  </section>

  <section id="admin-video-section" class="content-section">
    <h2>Admin ¬∑ Gestione Video</h2>
    <div class="help">Inserisci o aggiorna il link YouTube di una partita conclusa.</div>
    <label>Seleziona Partita</label>
    <select id="video-partita-select"></select>
    <label>Link YouTube</label>
    <input id="video-link-input" placeholder="https://www.youtube.com/watch?v=..." />
    <div class="actions">
      <button id="save-video-btn" class="btn btn--accent" type="button" disabled>Salva Link Video</button>
    </div>
  </section>
</main>

<div id="bottom-nav" role="navigation" aria-label="Navigazione mobile principale">
    <button id="mobile-rosa-tab" class="tab" data-target="rosa-section" aria-current="page" onclick="showPublicSection('rosa-section')">Rosa</button>
    <button id="mobile-calendario-tab" class="tab" data-target="calendario-section" onclick="showPublicSection('calendario-section')">Partite</button>
    <button id="mobile-classifica-tab" class="tab" data-target="classifica-section" onclick="showPublicSection('classifica-section')">Classifica</button>
    <button id="mobile-statistiche-tab" class="tab" data-target="statistiche-section" onclick="showPublicSection('statistiche-section')">Statistiche</button>
    <button id="mobile-video-tab" class="tab" data-target="video-section" onclick="showPublicSection('video-section')">Video</button>
    <button id="mobile-auth-toggle-btn" class="btn" onclick="handleAuthToggle()">Login</button>
</div>

<div id="video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px;">
  <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
    <button id="close-video-modal" class="btn btn--accent" type="button" style="position:absolute; top:-10px; right:-10px; z-index:110; font-size:1.2rem; line-height:1.2;">X</button>
    <div id="video-iframe-container" style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; border-radius: var(--radius); overflow: hidden;">
    </div>
  </div>
</div>
<footer>¬© 2025 AC Tuscolano | Aldo Sasso</footer>
</body>
</html>
