<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Tracker - Firestore & HTML</title>
    <!-- Caricamento di Tailwind CSS CDN per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configurazione Tailwind per utilizzare il font Inter e stili puliti -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-500': '#4f46e5',
                        'primary-600': '#4338ca',
                    }
                },
            },
        }
    </script>
    <style>
        /* Stile per nascondere il form di default, mostrato dopo l'inizializzazione */
        #main-content {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .loaded #main-content {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">

    <div id="app" class="p-4 sm:p-8">
        <div class="max-w-4xl mx-auto">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-extrabold text-primary-600 tracking-tight mb-2">
                    Job Application Tracker
                </h1>
                <p class="text-gray-600 text-lg">
                    Tieni traccia delle tue candidature di lavoro con la potenza di Firestore.
                </p>
                <div class="text-sm text-gray-500 mt-2">
                    ID Utente: <span id="user-id-display" class="font-mono text-[10px] sm:text-xs">Caricamento...</span>
                </div>
            </header>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex items-center justify-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
            </div>

            <div id="main-content" class="space-y-8">
                
                <!-- Feedback Message Area -->
                <div id="feedback-message"></div>

                <!-- Sezione Aggiungi Nuova Candidatura -->
                <div class="p-6 bg-white shadow-lg rounded-xl border border-indigo-100">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <!-- Icona PlusCircle -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-primary-500"><circle cx="12" cy="12" r="10"/><path d="M12 8v8m-4-4h8"/></svg>
                        Aggiungi Nuova Candidatura
                    </h2>
                    <form id="candidatura-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="position" class="block text-sm font-medium text-gray-700">Posizione</label>
                                <input type="text" id="position" name="position" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="company" class="block text-sm font-medium text-gray-700">Azienda</label>
                                <input type="text" id="company" name="company" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-primary-500 focus:border-primary-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Data Invio</label>
                                <input type="date" id="date" name="date" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="status" class="block text-sm font-medium text-gray-700">Stato</label>
                                <select id="status" name="status" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border bg-white focus:ring-primary-500 focus:border-primary-500">
                                    <option value="Inviata">Inviata</option>
                                    <option value="In Revisione">In Revisione</option>
                                    <option value="Colloquio">Colloquio</option>
                                    <option value="Offerta Ricevuta">Offerta Ricevuta</option>
                                    <option value="Rifiutata">Rifiutata</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700">Note Aggiuntive</label>
                            <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-primary-500 focus:border-primary-500"></textarea>
                        </div>
                        <button type="submit" class="w-full inline-flex justify-center py-3 px-4 border border-transparent shadow-lg text-sm font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                            Salva Candidatura
                        </button>
                    </form>
                </div>

                <!-- Sezione Lista Candidature -->
                <div class="p-6 bg-white shadow-lg rounded-xl border border-indigo-100">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <!-- Icona BookOpen -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-primary-500"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        Le Tue Candidature
                    </h2>
                    <div id="candidature-list" class="space-y-4">
                        <!-- Le candidature verranno renderizzate qui -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Script di inizializzazione Firebase e Logica Applicativa -->
    <script type="module">
        // Importazioni Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            serverTimestamp, 
            collection, 
            onSnapshot, 
            deleteDoc, // Includiamo deleteDoc per la completezza
            query 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Variabili Globali ---
        let db = null;
        let auth = null;
        let currentUserId = null;
        let appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const STATUS_STYLES = {
            'Inviata': 'bg-blue-100 text-blue-800',
            'In Revisione': 'bg-yellow-100 text-yellow-800',
            'Colloquio': 'bg-purple-100 text-purple-800',
            'Offerta Ricevuta': 'bg-green-100 text-green-800',
            'Rifiutata': 'bg-red-100 text-red-800',
        };

        const initialCandidaturaState = {
            position: '',
            company: '',
            date: new Date().toISOString().substring(0, 10),
            status: 'Inviata',
            notes: ''
        };

        // --- Funzioni di Utility ---

        /**
         * Mostra un messaggio di feedback all'utente.
         * @param {string} text - Il messaggio da mostrare.
         * @param {string} type - Il tipo di messaggio ('success' o 'error').
         */
        function displayFeedback(text, type) {
            const container = document.getElementById('feedback-message');
            const baseStyle = "p-3 mb-4 rounded-lg text-sm flex items-center shadow-md";
            const typeStyles = {
                'success': 'bg-green-100 text-green-800 border-l-4 border-green-500',
                'error': 'bg-red-100 text-red-800 border-l-4 border-red-500',
            };
            const icon = type === 'success' ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/></svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`;
            
            container.innerHTML = `
                <div class="${baseStyle} ${typeStyles[type] || 'bg-gray-100 text-gray-700'}">
                    ${icon}
                    <p>${text}</p>
                </div>
            `;
            
            // Cancella il messaggio dopo 5 secondi
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        /**
         * Ottiene il valore in secondi dal timestamp di Firestore, gestendo i valori nulli.
         * @param {object} timestamp - L'oggetto timestamp di Firestore.
         * @returns {number} I secondi o 0 se non disponibili.
         */
        function getSeconds(timestamp) {
            if (timestamp && timestamp.seconds) {
                return timestamp.seconds;
            }
            return 0;
        }

        // --- Logica Firebase e Rendering ---

        /**
         * Inizializza Firebase e gestisce l'autenticazione.
         */
        async function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                document.getElementById('loading-spinner').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('user-id-display').textContent = currentUserId;
                        startCandidatureListener();
                        
                        document.getElementById('loading-spinner').style.display = 'none';
                        document.body.classList.add('loaded'); // Attiva la transizione
                    } else if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                });
            } catch (e) {
                console.error("Errore di inizializzazione Firebase:", e);
                displayFeedback("Errore critico di inizializzazione Firebase. Controlla la console.", 'error');
                document.getElementById('loading-spinner').style.display = 'none';
            }
        }

        /**
         * Avvia il listener in tempo reale per le candidature.
         */
        function startCandidatureListener() {
            if (!db || !currentUserId) return;

            const path = `/artifacts/${appId}/users/${currentUserId}/candidatures`;
            const q = collection(db, path);

            // Listener in tempo reale
            onSnapshot(q, (snapshot) => {
                const newCandidature = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    id: doc.id
                })).sort((a, b) => {
                    // Ordina per timestamp (più recente in alto)
                    const timeA = getSeconds(a.timestamp);
                    const timeB = getSeconds(b.timestamp);
                    return timeB - timeA;
                });
                
                renderCandidatureList(newCandidature);
            }, (error) => {
                console.error("Errore listener Firestore:", error);
                displayFeedback("Errore durante l'aggiornamento dei dati in tempo reale.", 'error');
            });
        }

        /**
         * Renderizza la lista delle candidature sul DOM.
         * @param {Array<Object>} data - I dati delle candidature.
         */
        function renderCandidatureList(data) {
            const listContainer = document.getElementById('candidature-list');
            
            if (data.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-10 text-gray-500">
                        Non hai ancora aggiunto nessuna candidatura. Inizia con il modulo qui sopra!
                    </div>
                `;
                return;
            }

            // Genera l'HTML per ogni elemento
            const html = data.map(item => {
                const statusClass = STATUS_STYLES[item.status] || 'bg-gray-100 text-gray-800';
                
                const dateString = item.date ? new Date(item.date).toLocaleDateString('it-IT') : 'N/D';
                
                const notesHtml = item.notes ? `
                    <div class="mt-2 p-2 bg-gray-50 rounded-md border border-gray-100">
                        <p class="text-xs font-medium text-gray-700 flex items-start">
                            <!-- Icona MessageSquare -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 mt-0.5 mr-1 flex-shrink-0"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                            Note: ${item.notes}
                        </p>
                    </div>
                ` : '';

                return `
                    <div class="p-4 border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-150 ease-in-out">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold text-gray-900">${item.position}</h3>
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${statusClass}">
                                ${item.status}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${item.company}</p>
                        <div class="text-xs text-gray-500 flex flex-wrap items-center space-x-4">
                            <span class="flex items-center mr-4 mb-1">
                                <!-- Icona Calendar -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-3 h-3 mr-1"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                ${dateString}
                            </span>
                        </div>
                        ${notesHtml}
                        <button data-id="${item.id}" class="delete-btn mt-3 text-red-500 hover:text-red-700 transition duration-150 ease-in-out flex items-center text-sm">
                            <!-- Icona Trash2 -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2m-6 5v6m4-6v6"/></svg>
                            Elimina
                        </button>
                    </div>
                `;
            }).join('');

            listContainer.innerHTML = html;
            
            // Aggiunge i listener per i pulsanti di eliminazione
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    handleDelete(id);
                });
            });
        }

        /**
         * Gestisce l'invio del modulo.
         * @param {Event} e - Evento di submit.
         */
        async function handleSubmit(e) {
            e.preventDefault();
            if (!db || !currentUserId) {
                displayFeedback("Attendere il completamento dell'autenticazione.", 'error');
                return;
            }

            const form = e.target;
            const formData = {
                position: form.position.value,
                company: form.company.value,
                date: form.date.value,
                status: form.status.value,
                notes: form.notes.value,
                timestamp: serverTimestamp() // Aggiunge il timestamp del server
            };

            try {
                const candidatureCollectionRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/candidatures`);
                // Crea un nuovo documento con ID automatico
                await setDoc(doc(candidatureCollectionRef), formData);
                
                // Reset del form e della data
                form.reset();
                form.date.value = new Date().toISOString().substring(0, 10);
                displayFeedback("Candidatura aggiunta con successo!", 'success');
            } catch (error) {
                console.error("Errore nell'aggiunta del documento: ", error);
                displayFeedback(`Errore nell'aggiunta della candidatura: ${error.message}`, 'error');
            }
        }

        /**
         * Gestisce l'eliminazione di una candidatura.
         * @param {string} id - ID del documento da eliminare.
         */
        async function handleDelete(id) {
            if (!db || !currentUserId) return;

            if (!confirm("Sei sicuro di voler eliminare questa candidatura?")) {
                return;
            }

            try {
                const docRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/candidatures`, id);
                await deleteDoc(docRef);
                displayFeedback("Candidatura eliminata con successo.", 'success');
            } catch (error) {
                console.error("Errore durante l'eliminazione: ", error);
                displayFeedback(`Errore durante l'eliminazione: ${error.message}`, 'error');
            }
        }

        // --- Inizializzazione ---
        window.addEventListener('load', () => {
            // Assegna la funzione di submit
            document.getElementById('candidatura-form').addEventListener('submit', handleSubmit);
            // Imposta la data di default corrente
            document.getElementById('date').value = initialCandidaturaState.date;
            
            setupFirebase();
        });

    </script>
</body>
</html>


