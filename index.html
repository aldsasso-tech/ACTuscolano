<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AC TUSCOLANO - Team Manager</title>
    
    <!-- Caricamento di Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configurazione Content Security Policy (CSP) -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' https://cdn.tailwindcss.com https://unpkg.com https://www.gstatic.com 'unsafe-inline' 'unsafe-eval'; 
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; 
        font-src 'self' data: https://fonts.gstatic.com;
        connect-src 'self' https://*.firebaseio.com https://firestore.googleapis.com https://identitytoolkit.googleapis.com; 
        img-src 'self' data: https:;" 
    />
    
    <!-- Configurazione Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#C0392B', // Rosso Scuro
                        secondary: '#F1C40F', // Giallo/Oro
                        accent: '#2C3E50', // Blu Scuro/Navy
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Stili Custom incorporati -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f4f9;
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 768px; 
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        #pitch-container {
            background: #1e8449; /* Verde campo */
            background-image: 
              linear-gradient(to right, rgba(255,255,255,0.2) 1px, transparent 1px),
              linear-gradient(to bottom, rgba(255,255,255,0.2) 1px, transparent 1px);
            background-size: 10% 10%, 10% 10%;
            border: 4px solid rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
        }

        #pitch-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            border: 2px solid white;
            border-radius: 10%;
            box-shadow: 0 0 0 2px white;
        }

        .player-circle {
            position: absolute;
            width: 40px;
            height: 40px;
            background-color: #f1c40f; 
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #2c3e50; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            cursor: default;
            transition: transform 0.3s ease-in-out;
        }
        
        /* Stili per il pulsante di rimozione formazione */
        .remove-formation-btn {
            background-color: #E74C3C; /* Rosso vivo */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .remove-formation-btn:hover {
            background-color: #C0392B;
        }
    </style>
</head>
<body class="bg-gray-100">

<div id="app-container" class="app-container bg-white">

    <header class="bg-accent p-4 shadow-lg sticky top-0 z-10">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-extrabold text-white tracking-wider flex items-center">
                <span class="bg-primary text-secondary px-2 py-1 rounded-full mr-2">AC</span>
                TUSCOLANO
            </h1>
            <button id="admin-button" class="text-white hover:text-secondary p-2 rounded-full hidden" title="Pannello di Amministrazione" onclick="toggleAdminModal(true)">
                <i data-lucide="settings" class="lucide w-6 h-6"></i>
            </button>
        </div>
        <div class="text-center text-xs text-gray-300 mt-1">
            (App Team Manager)
        </div>
    </header>

    <nav class="flex justify-around bg-white border-b border-gray-200 shadow-md p-2">
        <button id="nav-stats" onclick="showView('stats')" class="tab-button flex-1 text-center py-2 font-semibold text-accent border-b-2 border-primary transition-all duration-300">
            <i data-lucide="layout-dashboard" class="lucide w-5 h-5 mx-auto mb-1"></i> Statistiche
        </button>
        <button id="nav-calendar" onclick="showView('calendar')" class="tab-button flex-1 text-center py-2 font-semibold text-gray-500 border-b-2 border-transparent hover:border-gray-300 transition-all duration-300">
            <i data-lucide="calendar" class="lucide w-5 h-5 mx-auto mb-1"></i> Calendario
        </button>
    </nav>

    <main class="p-4 flex-grow overflow-y-auto">

        <section id="stats-view" class="view">
            <h2 class="text-2xl font-bold mb-4 text-accent border-b-2 pb-2 border-primary">Classifica Giocatori</h2>
            <div id="loading-stats" class="text-center text-gray-500 p-8">
                <!-- Messaggio di caricamento o errore -->
                <i data-lucide="loader" class="lucide w-8 h-8 mx-auto animate-spin mb-2 text-primary"></i>
                Caricamento statistiche...
            </div>
            <div id="player-list-container">
                <!-- Lista giocatori -->
            </div>
        </section>

        <section id="calendar-view" class="view hidden">
            <h2 class="text-2xl font-bold mb-4 text-accent border-b-2 pb-2 border-primary">Calendario Incontri (Clicca per Dettagli Partita)</h2>
            <div id="loading-calendar" class="text-center text-gray-500 p-8">
                <i data-lucide="loader" class="lucide w-8 h-8 mx-auto animate-spin mb-2 text-primary"></i>
                Caricamento calendario...
            </div>
            <div id="upcoming-matches" class="mb-6">
                <h3 class="text-xl font-semibold mb-3 text-primary">Prossimi Incontri</h3>
                <div id="upcoming-list" class="space-y-3"></div>
            </div>
            <div id="past-matches">
                <h3 class="text-xl font-semibold mb-3 text-primary">Risultati Precedenti</h3>
                <div id="past-list" class="space-y-3"></div>
            </div>
        </section>

    </main>

    <footer class="p-3 text-center text-xs text-gray-500 border-t">
        AC TUSCOLANO - App Ufficiale (Non-profit)
    </footer>
</div>

<!-- Modale Amministrazione PRINCIPALE -->
<div id="admin-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-lg">
        <h3 id="admin-modal-title" class="text-2xl font-bold text-accent mb-4 border-b pb-2">Gestione Dati (Admin)</h3>
        
        <button onclick="toggleAdminModal(false); toggleMatchManagement(true);" class="w-full bg-secondary text-accent font-bold py-3 mb-4 rounded-lg hover:bg-yellow-400 transition-colors duration-300 shadow-md">
            <i data-lucide="pencil-line" class="lucide w-5 h-5 mr-2 inline-block"></i> Gestisci Partite & Formazioni
        </button>
        
        <p class="text-sm text-gray-600 mb-4">
            Opzione per inserire rapidamente i dati di prova iniziali (sovrascrive le statistiche).
        </p>
        <button onclick="addInitialMockData()" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-red-700 transition-colors duration-300 shadow-md">
            <i data-lucide="database" class="lucide w-5 h-5 mr-2 inline-block"></i> Inserisci Dati di Prova in Firestore
        </button>
        <button onclick="toggleAdminModal(false)" class="w-full mt-3 bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg hover:bg-gray-400 transition-colors duration-300">
            Chiudi
        </button>
        
        <div class="mt-4 pt-4 border-t border-gray-200">
            <p class="text-xs text-gray-500">Percorsi Firestore:</p>
            <p class="text-xs font-mono bg-gray-50 p-1 rounded break-all">Giocatori: <code class="text-primary" id="path-players"></code></p>
            <p class="text-xs font-mono bg-gray-50 p-1 rounded break-all">Partite: <code class="text-primary" id="path-matches"></code></p>
        </div>
    </div>
</div>

<!-- Modale GESTIONE PARTITE -->
<div id="match-management-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-2xl font-bold text-accent">Gestione Partite</h3>
            <button onclick="toggleMatchManagement(false); toggleAdminModal(true);" class="text-gray-500 hover:text-accent">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- SELEZIONE/CREAZIONE PARTITA -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <label for="match-select" class="block text-sm font-medium text-gray-700 mb-1">Seleziona Partita Esistente:</label>
                <select id="match-select" onchange="loadMatchForEditing(this.value)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    <option value="">-- Nuova Partita --</option>
                    <!-- Opzioni popolate da JS -->
                </select>
            </div>
            
            <!-- FORM DETTAGLI PARTITA -->
            <div id="match-form-container" class="bg-white p-4 border border-gray-200 rounded-lg">
                <h4 id="match-form-title" class="text-xl font-bold text-primary mb-3">Nuova Partita</h4>
                
                <label class="block text-sm font-medium text-gray-700">Avversario</label>
                <input type="text" id="opponent" class="w-full p-2 mb-3 border rounded-lg" placeholder="Nome squadra avversaria" required>

                <label class="block text-sm font-medium text-gray-700">Data e Ora (formato YYYY-MM-DDTHH:MM)</label>
                <input type="datetime-local" id="match-date" class="w-full p-2 mb-3 border rounded-lg" required>
                
                <label class="block text-sm font-medium text-gray-700">Luogo</label>
                <input type="text" id="location" class="w-full p-2 mb-4 border rounded-lg" placeholder="Stadio/Campo">

                <div class="flex space-x-4 mb-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">Il Nostro Punteggio (Risultato)</label>
                        <input type="number" id="score-us" class="w-full p-2 border rounded-lg" placeholder="0">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">Punteggio Avversario</label>
                        <input type="number" id="score-opponent" class="w-full p-2 border rounded-lg" placeholder="0">
                    </div>
                </div>
                
                <button onclick="saveMatchDetails()" class="w-full bg-primary text-white font-bold py-2 rounded-lg hover:bg-red-700 transition-colors duration-300">
                    Salva Dettagli Partita
                </button>
            </div>
            
            <!-- GESTIONE FORMAZIONI -->
            <div id="formations-management" class="bg-white p-4 border border-gray-200 rounded-lg hidden">
                <h4 class="text-xl font-bold text-primary mb-3">Formazioni e Azioni</h4>
                <div id="formation-list-container" class="space-y-3 mb-4">
                    <!-- Formazioni esistenti -->
                </div>
                
                <button onclick="openFormationEditor()" class="w-full bg-accent text-white font-bold py-2 rounded-lg hover:bg-gray-700 transition-colors duration-300">
                    <i data-lucide="plus-circle" class="lucide w-5 h-5 mr-1 inline-block"></i> Aggiungi Nuova Formazione
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale Dettagli Partita (VISUALIZZAZIONE) -->
<div id="match-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-2xl w-11/12 max-w-xl max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <div>
                <h3 id="match-detail-title" class="text-xl font-bold text-accent">Dettaglio Partita</h3>
                <p id="match-detail-subtitle" class="text-sm text-gray-500"></p>
            </div>
            <button onclick="closeMatchDetail()" class="text-gray-500 hover:text-accent">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>

        <div class="space-y-4">
            <div class="flex justify-between items-center bg-gray-100 p-3 rounded-lg">
                <button id="prev-formation-btn" onclick="navigateFormation(-1)" class="p-2 bg-primary text-white rounded-full disabled:bg-gray-400 hover:bg-red-700 transition-colors duration-300" disabled>
                    <i data-lucide="chevron-left" class="lucide w-5 h-5"></i>
                </button>
                <div class="text-center">
                    <p class="font-bold text-accent">Formazione: <span id="current-formation-index">1 di 1</span></p>
                    <p id="formation-description" class="text-sm text-gray-600 italic"></p>
                </div>
                <button id="next-formation-btn" onclick="navigateFormation(1)" class="p-2 bg-primary text-white rounded-full disabled:bg-gray-400 hover:bg-red-700 transition-colors duration-300" disabled>
                    <i data-lucide="chevron-right" class="lucide w-5 h-5"></i>
                </button>
            </div>

            <div id="pitch-container" class="relative w-full aspect-[2/3] mx-auto">
            </div>

            <div id="formation-table-container">
            </div>
        </div>
    </div>
</div>

<!-- Modale EDITOR FORMAZIONE -->
<div id="formation-editor-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-2xl w-11/12 max-w-3xl max-h-[95vh] overflow-y-auto">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 id="formation-editor-title" class="text-2xl font-bold text-accent">Aggiungi/Modifica Formazione</h3>
            <button onclick="closeFormationEditor()" class="text-gray-500 hover:text-accent">
                <i data-lucide="x" class="lucide w-6 h-6"></i>
            </button>
        </div>

        <input type="hidden" id="editing-formation-index">
        
        <label class="block text-sm font-medium text-gray-700">Descrizione (Es: Primo Tempo, 4-4-2)</label>
        <input type="text" id="formation-description-input" class="w-full p-2 mb-4 border rounded-lg" placeholder="Descrizione della formazione">

        <!-- Posizionamento Giocatori (Area per interazione drag&drop, per ora solo lista) -->
        <h4 class="text-xl font-bold text-primary mb-3">Giocatori in Campo (Max 7)</h4>
        
        <div id="formation-players-list" class="space-y-2 mb-4">
            <!-- Lista dei giocatori nella formazione con posizione (X, Y) e azioni -->
        </div>

        <!-- SELEZIONE NUOVO GIOCATORE -->
        <div class="flex gap-4 items-end bg-gray-50 p-3 rounded-lg border border-gray-200">
            <div class="flex-grow">
                <label for="available-players-select" class="block text-sm font-medium text-gray-700">Aggiungi Giocatore</label>
                <select id="available-players-select" class="w-full p-2 border rounded-lg">
                    <option value="">-- Seleziona --</option>
                    <!-- Opzioni popolate da JS -->
                </select>
            </div>
            <button onclick="addPlayerToFormation()" class="bg-accent text-white py-2 px-4 rounded-lg hover:bg-gray-700 transition-colors duration-300 flex-shrink-0">
                Aggiungi
            </button>
        </div>
        
        <!-- PULSANTE SALVA -->
        <button onclick="saveFormation()" class="w-full bg-primary text-white font-bold py-3 mt-6 rounded-lg hover:bg-red-700 transition-colors duration-300">
            Salva Formazione
        </button>
    </div>
</div>

<!-- Caricamento Icone -->
<script src="https://unpkg.com/lucide@latest"></script>


<!-- LOGICA JAVASCRIPT INTEGRATA -->
<script type="module">
    // Importazioni Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, collection, query, setDoc, runTransaction, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Variabili Globali del Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    // Configurazione Firebase fornita dall'utente (Ora Reale)
    const firebaseConfig = {
        apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
        authDomain: "actuscolano.firebaseapp.com",
        projectId: "actuscolano",
        storageBucket: "actuscolano.firebasestorage.app",
        messagingSenderId: "62685359731",
        appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
        measurementId: "G-TSVH8PH4RC"
    };

    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Collezioni Firestore
    const COLLECTIONS = {
        PLAYERS: `artifacts/${appId}/public/data/ac_tuscolano_players`,
        MATCHES: `artifacts/${appId}/public/data/ac_tuscolano_matches`,
    };

    // Stato Globale
    let db, auth;
    let userId;
    let allPlayers = [];
    let allMatches = [];
    let currentMatchDetail = null;
    let currentFormationIndex = 0;
    let editingMatchId = null; 
    let editingFormation = null; // Struttura della formazione in fase di editing

    const adminButton = document.getElementById('admin-button');
    const adminModal = document.getElementById('admin-modal');
    const matchManagementModal = document.getElementById('match-management-modal');
    const matchDetailModal = document.getElementById('match-detail-modal');
    const formationEditorModal = document.getElementById('formation-editor-modal');

    // --- FUNZIONI DI UTILITY ---

    /** Mostra un errore nella console e sulla UI di Statistiche in modo prominente */
    function logError(message, error) {
        if (error) console.error("ERRORE APP:", message, error);
        
        const loadingElement = document.getElementById('loading-stats');
        if (loadingElement) {
            loadingElement.classList.remove('text-gray-500', 'animate-spin');
            loadingElement.classList.add('text-red-700', 'bg-red-50', 'p-4', 'rounded-xl', 'border-2', 'border-red-400');
            loadingElement.innerHTML = `
                <i data-lucide="alert-octagon" class="lucide w-8 h-8 mx-auto mb-2 text-red-500"></i>
                <p class="font-bold">${message}</p>
                <p class="text-xs mt-2 text-red-500 break-all">
                   ${error && error.code ? `Codice Errore: ${error.code}. ` : ''} 
                   ${error && error.message ? `Messaggio: ${error.message}` : 'Dettagli non disponibili.'}
                </p>
            `;
            lucide.createIcons();
        }
        // Nasconde il caricamento del calendario in caso di errore generale
        document.getElementById('loading-calendar')?.classList.add('hidden');
    }

    /** Helper per formattare una data */
    function formatDate(timestamp) {
        if (!timestamp) return 'Data non specificata';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return new Intl.DateTimeFormat('it-IT', { dateStyle: 'full', timeStyle: 'short' }).format(date);
    }
    
    /** Converte un Timestamp Firestore in stringa per input datetime-local */
    function timestampToInputString(timestamp) {
        if (!timestamp) return '';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        const h = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        return `${y}-${m}-${d}T${h}:${min}`;
    }
    
    /** Aggiorna la vista corrente */
    window.showView = function(viewId) {
        document.querySelectorAll('.view').forEach(view => {
            view.classList.add('hidden');
        });
        document.getElementById(`${viewId}-view`).classList.remove('hidden');

        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('text-accent', 'border-primary');
            button.classList.add('text-gray-500', 'border-transparent', 'hover:border-gray-300');
        });
        document.getElementById(`nav-${viewId}`).classList.add('text-accent', 'border-primary');
        document.getElementById(`nav-${viewId}`).classList.remove('text-gray-500', 'border-transparent', 'hover:border-gray-300');
    }

    // --- GESTIONE MODALI ---

    window.toggleAdminModal = function(show) {
        if (show) {
            document.getElementById('path-players').textContent = COLLECTIONS.PLAYERS;
            document.getElementById('path-matches').textContent = COLLECTIONS.MATCHES;
            adminModal.classList.remove('hidden');
        } else {
            adminModal.classList.add('hidden');
        }
    }
    
    window.toggleMatchManagement = function(show) {
        if (show) {
            populateMatchSelect();
            resetMatchForm();
            matchManagementModal.classList.remove('hidden');
        } else {
            matchManagementModal.classList.add('hidden');
        }
    }
    
    window.closeMatchDetail = function() {
        matchDetailModal.classList.add('hidden');
        currentMatchDetail = null;
    }

    window.closeFormationEditor = function() {
        editingFormation = null;
        formationEditorModal.classList.add('hidden');
    }

    // --- FIREBASE E AUTENTICAZIONE ---

    /** Inizializzazione Firebase e gestione Autenticazione */
    async function setupFirebase() {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    adminButton.classList.remove('hidden'); 
                    startDataListeners();
                } else {
                    logError("Autenticazione Fallita. Assicurati che l'Auth Anonima sia abilitata nel tuo progetto Firebase.", null);
                }
            });

        } catch (error) {
            logError("Errore durante l'inizializzazione o l'autenticazione di Firebase. Controlla le tue API Key e le regole di Auth.", error);
        }
    }
    
    /** Avvia i listener onSnapshot per i dati in tempo reale */
    function startDataListeners() {
        if (!db) {
            logError("Database non inizializzato. Impossibile avviare i listener.", null);
            return;
        }

        // Listener per i Giocatori (Statistiche)
        const playersQuery = collection(db, COLLECTIONS.PLAYERS);
        onSnapshot(playersQuery, (snapshot) => {
            allPlayers = [];
            snapshot.forEach(doc => {
                allPlayers.push({ id: doc.id, ...doc.data() });
            });
            renderPlayerList(allPlayers);
            populateAvailablePlayersSelect(); // Aggiorna la select nell'editor
        }, (error) => {
            logError("Errore nel listener Giocatori. Controlla le regole di sicurezza (Permission Denied).", error);
        });

        // Listener per le Partite (Calendario)
        const matchesQuery = query(collection(db, COLLECTIONS.MATCHES));
        onSnapshot(matchesQuery, (snapshot) => {
            allMatches = [];
            snapshot.forEach(doc => {
                allMatches.push({ id: doc.id, ...doc.data() });
            });
            renderCalendar(allMatches);
            populateMatchSelect(); // Aggiorna la select nel pannello di gestione
        }, (error) => {
            const loadingCalendar = document.getElementById('loading-calendar');
            if (loadingCalendar) {
                 loadingCalendar.innerHTML = `<p class="text-red-500 font-bold">Errore di caricamento calendario: ${error.code || 'sconosciuto'}. Controlla le regole di sicurezza.</p>`;
                 loadingCalendar.classList.remove('hidden');
            }
            console.error("Errore nel listener Partite:", error);
        });
    }

    // --- GESTIONE DEI DATI DELLE PARTITE (ADMIN) ---

    /** Popola la select delle partite nel pannello di gestione */
    function populateMatchSelect() {
        const select = document.getElementById('match-select');
        select.innerHTML = '<option value="">-- Nuova Partita --</option>';

        // Ordina per data decrescente
        const sortedMatches = allMatches.sort((a, b) => {
            const dateA = a.date ? a.date.toDate() : new Date(0);
            const dateB = b.date ? b.date.toDate() : new Date(0);
            return dateB - dateA; 
        });

        sortedMatches.forEach(match => {
            const option = document.createElement('option');
            option.value = match.id;
            const dateStr = match.date ? new Intl.DateTimeFormat('it-IT', { day: '2-digit', month: 'short' }).format(match.date.toDate()) : 'N/D';
            option.textContent = `${dateStr} - vs ${match.opponent || 'Avversario N/D'}`;
            select.appendChild(option);
        });
        // Ripristina la selezione corrente se stiamo modificando
        select.value = editingMatchId || ""; 
    }
    
    /** Carica i dettagli della partita selezionata per la modifica */
    window.loadMatchForEditing = function(matchId) {
        editingMatchId = matchId;
        resetMatchForm(); 
        
        const formTitle = document.getElementById('match-form-title');
        const formationsContainer = document.getElementById('formations-management');

        if (!matchId) {
            formTitle.textContent = 'Nuova Partita';
            formationsContainer.classList.add('hidden');
            return;
        }

        const match = allMatches.find(m => m.id === matchId);
        if (!match) return; 

        formTitle.textContent = `Modifica Partita vs ${match.opponent}`;
        formationsContainer.classList.remove('hidden');
        
        document.getElementById('opponent').value = match.opponent || '';
        document.getElementById('location').value = match.location || '';
        
        // Data
        document.getElementById('match-date').value = timestampToInputString(match.date);

        // Risultato
        document.getElementById('score-us').value = match.result ? (match.result.score_us || '') : '';
        document.getElementById('score-opponent').value = match.result ? (match.result.score_opponent || '') : '';

        // Formazioni
        renderFormationsListForEditing(match.formations || []);
    }

    /** Resetta il form di gestione partita */
    function resetMatchForm() {
        document.getElementById('match-form-title').textContent = 'Nuova Partita';
        document.getElementById('opponent').value = '';
        document.getElementById('match-date').value = '';
        document.getElementById('location').value = '';
        document.getElementById('score-us').value = '';
        document.getElementById('score-opponent').value = '';
        document.getElementById('formations-management').classList.add('hidden');
        document.getElementById('match-select').value = '';
        editingMatchId = null;
    }
    
    /** Salva i dettagli base della partita */
    window.saveMatchDetails = async function() {
        if (!db) return logError("Database non pronto.", null);

        const opponent = document.getElementById('opponent').value.trim();
        const dateInput = document.getElementById('match-date').value;
        const location = document.getElementById('location').value.trim();
        const scoreUs = parseInt(document.getElementById('score-us').value) || null;
        const scoreOpponent = parseInt(document.getElementById('score-opponent').value) || null;

        if (!opponent || !dateInput) {
            alert("Devi inserire Avversario e Data.");
            return;
        }

        const matchData = {
            opponent: opponent,
            date: Timestamp.fromDate(new Date(dateInput)),
            location: location,
            result: (scoreUs !== null && scoreOpponent !== null) ? { score_us: scoreUs, score_opponent: scoreOpponent } : null,
        };

        try {
            const matchRef = editingMatchId ? doc(db, COLLECTIONS.MATCHES, editingMatchId) : doc(collection(db, COLLECTIONS.MATCHES));
            
            // Se esiste, carica anche le formazioni per non sovrascriverle
            if (editingMatchId) {
                const existingMatch = allMatches.find(m => m.id === editingMatchId);
                if (existingMatch) {
                    matchData.formations = existingMatch.formations || [];
                }
            } else {
                 matchData.formations = [];
            }
            
            await setDoc(matchRef, matchData);
            
            // Aggiorna lo stato di editing se era una nuova partita
            if (!editingMatchId) {
                editingMatchId = matchRef.id;
            }
            
            // Aggiorna la modale
            loadMatchForEditing(editingMatchId);
            alert(`Dettagli Partita ${editingMatchId ? 'Aggiornati' : 'Salvata'} con successo!`);
        } catch (error) {
            logError("Errore durante il salvataggio dei dettagli della partita.", error);
            alert("Errore nel salvataggio. Controlla la console.");
        }
    }
    
    // --- GESTIONE FORMAZIONI (ADMIN) ---

    /** Renderizza l'elenco delle formazioni per la modifica */
    function renderFormationsListForEditing(formations) {
        const listContainer = document.getElementById('formation-list-container');
        listContainer.innerHTML = '';

        if (formations.length === 0) {
            listContainer.innerHTML = '<p class="text-sm text-gray-500">Nessuna formazione inserita per questa partita.</p>';
            return;
        }

        formations.forEach((f, index) => {
            const playersCount = f.players ? f.players.length : 0;
            const actionsCount = f.actions ? f.actions.length : 0;
            
            const itemHtml = `
                <div class="flex justify-between items-center p-3 bg-white border rounded-lg shadow-sm">
                    <div class="flex-grow">
                        <p class="font-semibold text-accent">Formazione #${index + 1}: ${f.description || 'N/D'}</p>
                        <p class="text-xs text-gray-500">${playersCount} giocatori, ${actionsCount} azioni registrate.</p>
                    </div>
                    <div class="space-x-2">
                        <button onclick="editFormation(${index})" class="text-secondary hover:text-yellow-600" title="Modifica Formazione">
                            <i data-lucide="edit-3" class="lucide w-5 h-5"></i>
                        </button>
                        <button onclick="removeFormation(${index})" class="text-red-500 hover:text-red-700" title="Rimuovi Formazione">
                            <i data-lucide="trash-2" class="lucide w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `;
            listContainer.insertAdjacentHTML('beforeend', itemHtml);
        });
        lucide.createIcons();
    }
    
    /** Apertura Editor Formazione */
    window.openFormationEditor = function(index = null) {
        const descriptionInput = document.getElementById('formation-description-input');
        const editorTitle = document.getElementById('formation-editor-title');
        
        // Reset stato
        document.getElementById('editing-formation-index').value = index !== null ? index : '';
        editingFormation = {
            description: '',
            players: [],
            actions: [] 
        };
        
        if (index !== null && editingMatchId) {
            const match = allMatches.find(m => m.id === editingMatchId);
            if (match && match.formations && match.formations[index]) {
                // Cloniamo l'oggetto per evitare modifiche dirette allo stato globale
                editingFormation = JSON.parse(JSON.stringify(match.formations[index]));
                descriptionInput.value = editingFormation.description || '';
                editorTitle.textContent = `Modifica Formazione #${index + 1}`;
            }
        } else {
            editorTitle.textContent = 'Aggiungi Nuova Formazione';
            descriptionInput.value = '';
        }
        
        renderFormationPlayersList();
        formationEditorModal.classList.remove('hidden');
    }
    
    /** Popola la select dei giocatori disponibili */
    function populateAvailablePlayersSelect() {
        const select = document.getElementById('available-players-select');
        select.innerHTML = '<option value="">-- Seleziona Giocatore --</option>';

        // Filtra solo i giocatori non ancora in campo in questa formazione (se in editing)
        const currentPlayersIds = editingFormation ? editingFormation.players.map(p => p.playerId) : [];

        allPlayers.sort((a, b) => a.number - b.number).forEach(player => {
            // Se non stiamo editando una formazione o il giocatore non è in campo, lo aggiungiamo
            if (currentPlayersIds.length === 0 || !currentPlayersIds.includes(player.id)) {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = `#${player.number || 'N/A'} ${player.name} (${player.role})`;
                select.appendChild(option);
            }
        });
    }

    /** Renderizza i giocatori nella lista dell'editor (inclusa la posizione fissa 7v7) */
    function renderFormationPlayersList() {
        const listContainer = document.getElementById('formation-players-list');
        listContainer.innerHTML = '';
        
        populateAvailablePlayersSelect();
        
        if (editingFormation.players.length === 0) {
            listContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Nessun giocatore in questa formazione.</p>';
            return;
        }

        editingFormation.players.forEach((p, index) => {
            const player = allPlayers.find(pl => pl.id === p.playerId);
            if (!player) return;

            const goals = editingFormation.actions.filter(a => a.playerId === p.playerId && a.type === 'goal').length;
            const assists = editingFormation.actions.filter(a => a.playerId === p.playerId && a.type === 'assist').length;

            const html = `
                <div class="flex items-center p-3 bg-gray-100 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex-grow">
                        <p class="font-semibold text-accent">#${player.number || 'N/A'} ${player.name}</p>
                        <p class="text-xs text-gray-500">${player.role}</p>
                        <div class="mt-1 text-sm">
                            <span class="mr-3">Gol: <input type="number" data-player-id="${player.id}" data-action-type="goal" value="${goals}" min="0" onchange="updatePlayerActions(this.dataset.playerId, this.dataset.actionType, this.value)" class="w-12 p-1 border rounded text-right"></span>
                            <span>Assist: <input type="number" data-player-id="${player.id}" data-action-type="assist" value="${assists}" min="0" onchange="updatePlayerActions(this.dataset.playerId, this.dataset.actionType, this.value)" class="w-12 p-1 border rounded text-right"></span>
                        </div>
                    </div>
                    <button onclick="removePlayerFromFormation('${player.id}')" class="text-red-500 hover:text-red-700 ml-4 p-1" title="Rimuovi Giocatore">
                        <i data-lucide="minus-circle" class="lucide w-5 h-5"></i>
                    </button>
                </div>
            `;
            listContainer.insertAdjacentHTML('beforeend', html);
        });
        lucide.createIcons();
    }
    
    /** Aggiunge un giocatore alla formazione in editing (assegnando posizioni di default) */
    window.addPlayerToFormation = function() {
        const select = document.getElementById('available-players-select');
        const playerId = select.value;
        if (!playerId) return;
        
        // Posizioni di default (basate su 7 giocatori, usaremo una posizione fissa per ogni aggiunta)
        const defaultPositions = [
            { x: 50, y: 5, role: 'Portiere' },
            { x: 20, y: 30, role: 'Difensore' },
            { x: 80, y: 30, role: 'Difensore' },
            { x: 40, y: 55, role: 'Centrocampista' },
            { x: 60, y: 55, role: 'Centrocampista' },
            { x: 30, y: 85, role: 'Attaccante' },
            { x: 70, y: 85, role: 'Attaccante' },
        ];
        
        // Trova la prima posizione non occupata (per simulazione 7v7)
        const occupiedCount = editingFormation.players.length;
        const defaultPos = defaultPositions[occupiedCount];

        if (occupiedCount >= 7) {
            alert("Massimo 7 giocatori in campo per questa demo.");
            return;
        }
        
        if (defaultPos) {
            editingFormation.players.push({
                playerId: playerId,
                x: defaultPos.x,
                y: defaultPos.y,
            });
            renderFormationPlayersList();
        }
    }
    
    /** Rimuove un giocatore dalla formazione in editing */
    window.removePlayerFromFormation = function(playerId) {
        editingFormation.players = editingFormation.players.filter(p => p.playerId !== playerId);
        editingFormation.actions = editingFormation.actions.filter(a => a.playerId !== playerId); // Rimuovi anche le azioni
        renderFormationPlayersList();
    }

    /** Aggiorna il conteggio di gol/assist nella formazione in editing */
    window.updatePlayerActions = function(playerId, type, count) {
        const newCount = parseInt(count) || 0;
        
        // Rimuovi tutte le azioni precedenti di questo tipo per questo giocatore
        editingFormation.actions = editingFormation.actions.filter(
            a => !(a.playerId === playerId && a.type === type)
        );

        // Aggiungi il nuovo numero di azioni
        for (let i = 0; i < newCount; i++) {
            editingFormation.actions.push({
                playerId: playerId,
                type: type,
                minute: 0 // Minuto non specificato nell'editor semplificato
            });
        }
    }

    /** Salva la formazione nell'oggetto partita su Firestore */
    window.saveFormation = async function() {
        if (!editingMatchId) {
            alert("Devi prima salvare i dettagli della partita.");
            return;
        }
        
        const match = allMatches.find(m => m.id === editingMatchId);
        if (!match) return;

        const description = document.getElementById('formation-description-input').value.trim();
        editingFormation.description = description || `Formazione Senza Descrizione`;

        const index = document.getElementById('editing-formation-index').value;
        const formations = match.formations || [];

        if (index !== '') {
            // Modifica
            formations[parseInt(index)] = editingFormation;
        } else {
            // Aggiungi
            formations.push(editingFormation);
        }
        
        try {
            const matchRef = doc(db, COLLECTIONS.MATCHES, editingMatchId);
            await setDoc(matchRef, { formations: formations }, { merge: true }); // Aggiorna solo il campo formazioni
            
            closeFormationEditor();
            loadMatchForEditing(editingMatchId); // Ricarica la lista per mostrare la formazione aggiornata
            alert("Formazione salvata con successo!");
            
            // Aggiorna anche le statistiche globali (Gol/Assist)
            updateGlobalPlayerStats();
            
        } catch (error) {
            logError("Errore nel salvataggio della formazione.", error);
            alert("Errore nel salvataggio della formazione. Controlla la console.");
        }
    }

    /** Rimuove una formazione */
    window.removeFormation = async function(index) {
        if (!confirm(`Sei sicuro di voler rimuovere la Formazione #${index + 1}?`)) return;

        const match = allMatches.find(m => m.id === editingMatchId);
        if (!match) return;

        const formations = match.formations || [];
        formations.splice(index, 1);

        try {
            const matchRef = doc(db, COLLECTIONS.MATCHES, editingMatchId);
            await setDoc(matchRef, { formations: formations }, { merge: true });
            loadMatchForEditing(editingMatchId);
            updateGlobalPlayerStats();
            alert("Formazione rimossa con successo.");
        } catch (error) {
            logError("Errore nella rimozione della formazione.", error);
            alert("Errore nella rimozione della formazione. Controlla la console.");
        }
    }

    /** Ricalcola e salva le statistiche aggregate di tutti i giocatori */
    async function updateGlobalPlayerStats() {
        if (!db) return;
        
        // 1. Inizializza statistiche a zero
        const playerStats = {};
        allPlayers.forEach(p => {
            playerStats[p.id] = { id: p.id, name: p.name, role: p.role, number: p.number, goals: 0, assists: 0 };
        });

        // 2. Aggrega da tutte le formazioni di tutte le partite
        allMatches.forEach(match => {
            if (match.formations) {
                match.formations.forEach(formation => {
                    if (formation.actions) {
                        formation.actions.forEach(action => {
                            if (playerStats[action.playerId]) {
                                if (action.type === 'goal') {
                                    playerStats[action.playerId].goals += 1;
                                } else if (action.type === 'assist') {
                                    playerStats[action.playerId].assists += 1;
                                }
                            }
                        });
                    }
                });
            }
        });

        // 3. Salva su Firestore con Transaction
        try {
            await runTransaction(db, async (transaction) => {
                for (const playerId in playerStats) {
                    const stats = playerStats[playerId];
                    const docRef = doc(db, COLLECTIONS.PLAYERS, playerId);
                    // Usiamo transaction.set per aggiornare le statistiche sul documento giocatore
                    transaction.set(docRef, {
                        goals: stats.goals,
                        assists: stats.assists,
                        name: stats.name, 
                        role: stats.role,
                        number: stats.number,
                    });
                }
            });
            console.log("Statistiche giocatori aggiornate con successo.");
        } catch (error) {
            logError("Errore durante l'aggiornamento delle statistiche globali.", error);
        }
    }
    
    // --- FUNZIONI DI RENDERIZZAZIONE (USER VIEW) ---

    /** Renderizza la lista dei giocatori ordinata per gol, poi assist */
    function renderPlayerList(players) {
        const container = document.getElementById('player-list-container');
        const loading = document.getElementById('loading-stats');

        if (loading) loading.classList.add('hidden');
        
        const sortedPlayers = players.sort((a, b) => {
            if ((b.goals || 0) !== (a.goals || 0)) {
                return (b.goals || 0) - (a.goals || 0);
            }
            if ((b.assists || 0) !== (a.assists || 0)) {
                return (b.assists || 0) - (a.assists || 0);
            }
            return (a.name || '').localeCompare(b.name || '');
        });


        if (sortedPlayers.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 p-8">Nessun dato giocatore trovato. Usa il pannello Admin per inserire dati di prova.</p>';
            return;
        }

        let html = '';
        sortedPlayers.forEach((player, index) => {
            const rank = index + 1;
            const rankColor = rank === 1 ? 'bg-secondary text-accent' : 
                              rank === 2 ? 'bg-gray-300 text-accent' : 
                              rank === 3 ? 'bg-yellow-600 text-white' : 'bg-gray-100 text-gray-600';

            html += `
                <div class="flex items-center p-3 bg-white rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow duration-200">
                    <span class="w-8 h-8 flex items-center justify-center rounded-full font-bold mr-3 ${rankColor}">
                        ${rank}
                    </span>
                    <div class="flex-grow">
                        <p class="font-semibold text-accent">#${player.number || 'N/A'} ${player.name || 'Nome Sconosciuto'}</p>
                        <p class="text-sm text-gray-500">${player.role || 'Ruolo N/D'}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-primary">${player.goals || 0} GOL</p>
                        <p class="text-sm text-gray-500">${player.assists || 0} assist</p>
                    </div>
                </div>
            `;
        });
        container.innerHTML = html;
    }
    
    /** Renderizza il calendario partite */
    function renderCalendar(matches) {
        const loading = document.getElementById('loading-calendar');
        if (loading) loading.classList.add('hidden');

        const sortedMatches = matches.sort((a, b) => {
            const dateA = a.date ? a.date.toDate() : new Date(0);
            const dateB = b.date ? b.date.toDate() : new Date(0);
            return dateB - dateA; 
        });

        const now = new Date();
        const upcomingList = document.getElementById('upcoming-list');
        const pastList = document.getElementById('past-list');
        upcomingList.innerHTML = '';
        pastList.innerHTML = '';

        if (sortedMatches.length === 0) {
            upcomingList.innerHTML = '<p class="text-center text-gray-500 p-4">Non ci sono prossimi incontri in programma.</p>';
            pastList.innerHTML = '';
            return;
        }

        sortedMatches.forEach(match => {
            const matchDate = match.date ? match.date.toDate() : new Date(0);
            const isUpcoming = matchDate > now;
            const statusColor = match.result ? (match.result.score_us > match.result.score_opponent ? 'bg-green-100 border-green-500' : 
                                               match.result.score_us < match.result.score_opponent ? 'bg-red-100 border-red-500' : 'bg-yellow-100 border-yellow-500') : 'bg-blue-100 border-blue-500';
            const statusText = match.result ? (match.result.score_us > match.result.score_opponent ? 'VITTORIA' : 
                                               match.result.score_us < match.result.score_opponent ? 'SCONFITTA' : 'PAREGGIO') : 'DA GIOCARE';

            const matchHtml = `
                <div class="match-card p-4 rounded-xl border-l-4 ${statusColor} shadow-md cursor-pointer hover:shadow-lg transition-shadow duration-200" 
                     onclick="openMatchDetail('${match.id}')">
                    <div class="flex justify-between items-center">
                        <p class="text-sm font-semibold text-gray-600">${formatDate(match.date)}</p>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                    </div>
                    <p class="text-xl font-extrabold text-accent mt-1">${match.opponent || 'Avversario Sconosciuto'}</p>
                    ${match.result ? 
                        `<p class="text-2xl font-black text-primary mt-2">${match.result.score_us} - ${match.result.score_opponent}</p>` : 
                        `<p class="text-lg font-medium text-gray-700 mt-2">Stadio: ${match.location || 'N/D'}</p>`
                    }
                </div>
            `;
            
            if (isUpcoming) {
                upcomingList.insertAdjacentHTML('beforeend', matchHtml);
            } else {
                pastList.insertAdjacentHTML('beforeend', matchHtml);
            }
        });
        
        if (upcomingList.innerHTML === '') upcomingList.innerHTML = '<p class="text-center text-gray-500 p-4">Non ci sono prossimi incontri in programma.</p>';
        if (pastList.innerHTML === '') pastList.innerHTML = '<p class="text-center text-gray-500 p-4">Non ci sono risultati precedenti.</p>';
    }

    // --- FUNZIONI DETTAGLIO PARTITA E CAMPO ---

    window.openMatchDetail = function(matchId) {
        currentMatchDetail = allMatches.find(m => m.id === matchId);
        if (!currentMatchDetail) {
            logError("Dettaglio partita non trovato.", null);
            return;
        }

        document.getElementById('match-detail-title').textContent = `Partita vs ${currentMatchDetail.opponent}`;
        document.getElementById('match-detail-subtitle').textContent = currentMatchDetail.result ? `Risultato: ${currentMatchDetail.result.score_us} - ${currentMatchDetail.result.score_opponent}` : 'Pre-Partita';

        if (currentMatchDetail.formations && currentMatchDetail.formations.length > 0) {
            currentFormationIndex = 0; 
            renderFormation();
        } else {
            document.getElementById('current-formation-index').textContent = '0 di 0';
            document.getElementById('formation-description').textContent = 'Formazione non disponibile.';
            document.getElementById('pitch-container').innerHTML = '<p class="text-center text-gray-500 p-8">Dati formazione mancanti.</p>';
            document.getElementById('formation-table-container').innerHTML = '';
            document.getElementById('prev-formation-btn').disabled = true;
            document.getElementById('next-formation-btn').disabled = true;
        }

        matchDetailModal.classList.remove('hidden');
    }

    
    /** Renderizza la formazione corrente sul campo */
    function renderFormation() {
        const formation = currentMatchDetail.formations[currentFormationIndex];
        const pitch = document.getElementById('pitch-container');
        const totalFormations = currentMatchDetail.formations.length;
        
        // Aggiorna navigazione
        document.getElementById('current-formation-index').textContent = `${currentFormationIndex + 1} di ${totalFormations}`;
        document.getElementById('formation-description').textContent = formation.description || `Formazione ${currentFormationIndex + 1}`;
        document.getElementById('prev-formation-btn').disabled = currentFormationIndex === 0;
        document.getElementById('next-formation-btn').disabled = currentFormationIndex === totalFormations - 1;

        // Renderizza il campo
        pitch.innerHTML = ''; 

        if (!formation.players) {
            pitch.innerHTML = '<p class="text-center text-gray-500 p-8">Giocatori non specificati per questa formazione.</p>';
            return;
        }
        
        // La logica di posizione è basata su percentuale
        formation.players.forEach(p => {
            const player = allPlayers.find(pl => pl.id === p.playerId);
            if (!player) return;

            const left = p.x; // Percentuale da 0 a 100
            const top = p.y; // Percentuale da 0 a 100

            const circle = document.createElement('div');
            circle.className = 'player-circle transition-all duration-500';
            circle.style.left = `calc(${left}% - 20px)`; // -20px per centrare (metà della larghezza del cerchio)
            circle.style.top = `${top}%`; 
            circle.style.transform = 'translateY(-50%)'; 
            circle.innerHTML = player.number || 'N/A';
            circle.title = `${player.name} (${player.role})`;
            
            pitch.appendChild(circle);
        });
        
        renderFormationTable(formation);
    }
    
    /** Renderizza la tabella dei giocatori per la formazione corrente */
    function renderFormationTable(formation) {
        const tableContainer = document.getElementById('formation-table-container');
        let tableHtml = `
            <h4 class="text-lg font-bold text-accent mb-2 mt-4">Lista Giocatori in Campo</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600">N.</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600">Nome</th>
                            <th class="py-2 px-4 border-b text-left text-xs font-semibold text-gray-600">Ruolo</th>
                            <th class="py-2 px-4 border-b text-right text-xs font-semibold text-gray-600">Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        // Ottieni la lista degli ID dei giocatori nella formazione per un lookup efficiente
        const playersInFormationIds = formation.players.map(p => p.playerId);
        
        // Filtra le azioni relative a questa formazione
        const formationActions = formation.actions || [];

        // Raggruppa le azioni per giocatore
        const playerActionsSummary = playersInFormationIds.reduce((acc, playerId) => {
            acc[playerId] = {
                goals: formationActions.filter(a => a.playerId === playerId && a.type === 'goal').length,
                assists: formationActions.filter(a => a.playerId === playerId && a.type === 'assist').length
            };
            return acc;
        }, {});


        formation.players.forEach(p => {
            const player = allPlayers.find(pl => pl.id === p.playerId);
            if (!player) return;
            
            const summary = playerActionsSummary[p.playerId] || { goals: 0, assists: 0 };
            const goals = summary.goals;
            const assists = summary.assists;

            let actionText = '';
            if (goals > 0) actionText += `<span class="text-primary font-bold mr-1">${goals} G</span>`;
            if (assists > 0) actionText += `<span class="text-green-600 font-bold">${assists} A</span>`;
            if (!actionText) actionText = '-';

            tableHtml += `
                <tr class="hover:bg-gray-50">
                    <td class="py-2 px-4 border-b text-sm text-accent font-mono">${player.number || '-'}</td>
                    <td class="py-2 px-4 border-b text-sm text-gray-800">${player.name}</td>
                    <td class="py-2 px-4 border-b text-sm text-gray-600">${player.role}</td>
                    <td class="py-2 px-4 border-b text-right text-sm">${actionText}</td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table></div>';
        tableContainer.innerHTML = tableHtml;
    }

    /** Naviga tra le formazioni */
    window.navigateFormation = function(direction) {
        const totalFormations = currentMatchDetail.formations.length;
        let newIndex = currentFormationIndex + direction;

        if (newIndex >= 0 && newIndex < totalFormations) {
            currentFormationIndex = newIndex;
            renderFormation();
        }
    }

    // --- FUNZIONI MOCK DATA (per l'Admin) ---
    
    /** Aggiunge dati iniziali di test a Firestore */
    window.addInitialMockData = async function() {
        if (!db || !userId) {
            logError("Firebase non è ancora pronto o autenticato.", null);
            return;
        }
        
        const button = document.querySelector('#admin-modal button[onclick="addInitialMockData()"]');
        button.disabled = true;
        button.textContent = 'Inserimento in corso...';

        try {
            // 1. Dati Giocatori (Usiamo ID statici per poterli riferire nelle Partite)
            const mockPlayers = [
                { id: 'p1_portiere', name: 'Mario Rossi', role: 'Portiere', number: 1, goals: 0, assists: 0 },
                { id: 'p2_difesa', name: 'Luca Bianchi', role: 'Difensore', number: 2, goals: 1, assists: 0 },
                { id: 'p3_difesa', name: 'Marco Verdi', role: 'Difensore', number: 3, goals: 0, assists: 1 },
                { id: 'p4_centrocampo', name: 'Andrea Gialli', role: 'Centrocampista', number: 8, goals: 3, assists: 2 },
                { id: 'p5_centrocampo', name: 'Giovanni Neri', role: 'Centrocampista', number: 10, goals: 5, assists: 3 },
                { id: 'p6_attacco', name: 'Daniele Marroni', role: 'Attaccante', number: 9, goals: 10, assists: 4 },
                { id: 'p7_attacco', name: 'Simone Viola', role: 'Attaccante', number: 11, goals: 2, assists: 0 },
            ];

            // 2. Dati Partite
            const now = new Date();
            const pastDate = new Date();
            pastDate.setDate(now.getDate() - 7); 
            
            const futureDate = new Date();
            futureDate.setDate(now.getDate() + 7); 

            const mockMatches = [
                // Partita Passata con Dettagli
                {
                    opponent: 'FC Acquedotto',
                    location: 'Campo Comunale A',
                    date: Timestamp.fromDate(pastDate),
                    result: { score_us: 4, score_opponent: 2 }, 
                    formations: [
                        {
                            description: 'Primo Tempo (30 min) - 4-4-2',
                            players: [
                                { playerId: 'p1_portiere', x: 50, y: 5 }, // P
                                { playerId: 'p2_difesa', x: 20, y: 30 }, // D
                                { playerId: 'p3_difesa', x: 80, y: 30 }, // D
                                { playerId: 'p4_centrocampo', x: 40, y: 55 }, // C
                                { playerId: 'p5_centrocampo', x: 60, y: 55 }, // C
                                { playerId: 'p6_attacco', x: 30, y: 85 }, // A
                                { playerId: 'p7_attacco', x: 70, y: 85 }, // A
                            ],
                            actions: [
                                { playerId: 'p6_attacco', type: 'goal', minute: 15 },
                                { playerId: 'p6_attacco', type: 'goal', minute: 28 },
                            ]
                        },
                         {
                            description: 'Secondo Tempo (30 min) - Cambio Tattico 3-4-3',
                            players: [
                                { playerId: 'p1_portiere', x: 50, y: 5 }, // P
                                { playerId: 'p2_difesa', x: 25, y: 35 }, // D
                                { playerId: 'p3_difesa', x: 50, y: 35 }, // D
                                { playerId: 'p4_centrocampo', x: 75, y: 35 }, // D
                                { playerId: 'p5_centrocampo', x: 40, y: 60 }, // C
                                { playerId: 'p6_attacco', x: 60, y: 60 }, // C
                                { playerId: 'p7_attacco', x: 50, y: 85 }, // A
                            ],
                            actions: [
                                { playerId: 'p5_centrocampo', type: 'assist', minute: 40 },
                                { playerId: 'p4_centrocampo', type: 'goal', minute: 50 }, 
                                { playerId: 'p2_difesa', type: 'assist', minute: 55 },
                                { playerId: 'p7_attacco', type: 'goal', minute: 55 },
                            ]
                        }
                    ]
                },
                // Partita Futura (Semplice)
                {
                    opponent: 'AC Trastevere',
                    location: 'Stadio Olimpico B',
                    date: Timestamp.fromDate(futureDate),
                    result: null, 
                    formations: [] 
                },
            ];

            await runTransaction(db, async (transaction) => {
                // 1. Salva i Giocatori (sovrascrive se esistono)
                mockPlayers.forEach(player => {
                    const docRef = doc(db, COLLECTIONS.PLAYERS, player.id);
                    // Usiamo solo i dati rilevanti per la statistica totale
                    transaction.set(docRef, { 
                        name: player.name, 
                        role: player.role, 
                        number: player.number, 
                        goals: player.goals, 
                        assists: player.assists 
                    });
                });

                // 2. Salva le Partite (usa setDoc con doc() vuoto per generare un ID)
                mockMatches.forEach(match => {
                    const colRef = collection(db, COLLECTIONS.MATCHES);
                    transaction.set(doc(colRef), match); 
                });
            });

            // Avviso di successo
            const successMsg = document.getElementById('admin-modal-title');
            successMsg.textContent = 'Dati di Prova Inseriti con Successo!';
            successMsg.classList.add('text-green-600');
            setTimeout(() => { 
                successMsg.textContent = 'Gestione Dati (Admin)';
                successMsg.classList.remove('text-green-600');
            }, 3000);

        } catch (error) {
            const errorArea = document.getElementById('admin-modal').querySelector('p.text-sm.text-gray-600');
            errorArea.innerHTML = `<p class="text-sm text-red-600 mt-2 font-bold">ERRORE: Impossibile inserire i dati. Controlla che le credenziali siano corrette e che le regole di sicurezza permettano la scrittura.</p>`;
            logError("Errore durante l'inserimento dei dati di test in Firestore", error);
        } finally {
            button.disabled = false;
            button.textContent = 'Inserisci Dati di Prova in Firestore';
        }
    }


    // --- AVVIO DELL'APPLICAZIONE ---
    
    window.onload = () => {
        lucide.createIcons();
        setupFirebase();
    }
</script>

</body>
</html>
