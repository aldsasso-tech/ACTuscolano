<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <script> 
/* ===== SCHEDULAZIONE: refresh giornaliero alle 23:00 ===== */
function msUntilNext(hour, minute = 0, second = 0) {
  const now = new Date();
  const next = new Date(now);
  next.setHours(hour, minute, second, 0);
  if (next <= now) next.setDate(next.getDate() + 1);
  return next - now;
}
window.scheduleDailyClassificaRefresh = () => {
  const ms = msUntilNext(23, 0, 0);
  const infoEl = document.getElementById('classifica-next-run');
  if (infoEl) {
    const when = new Date(Date.now() + ms).toLocaleString('it-IT');
    infoEl.textContent = `Prossimo aggiornamento: ${when}`;
  }
  setTimeout(async function tick() {
    await loadClassifica();
    window.scheduleDailyClassificaRefresh();
  }, ms);
};


/* ===== EFFETTO FADE NAVIGAZIONE (solo .content-section, fix visibilità completa) ===== */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.getAttribute('data-target');
    const current = document.querySelector('.content-section.active');
    const next = document.getElementById(target);
    if (!next || current === next) return;

    if (current) {
      current.style.opacity = '0';
      current.style.pointerEvents = 'none';
      setTimeout(() => {
        current.classList.remove('active');
        next.classList.add('active');
        next.style.opacity = '0';
        next.style.pointerEvents = 'all';
        setTimeout(() => { next.style.opacity = '1'; }, 50);
      }, 400);
    } else {
      next.classList.add('active');
      next.style.opacity = '1';
      next.style.pointerEvents = 'all';
    }

    // Aggiorna contenuto dinamico
    if (target === 'classifica-section' && typeof loadClassifica === 'function') {
      setTimeout(() => loadClassifica(), 600);
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  const firstSection = document.querySelector('.content-section') || document.querySelector('section');
  if (firstSection) firstSection.classList.add('active');
  if (typeof window.scheduleDailyClassificaRefresh === 'function') {
    window.scheduleDailyClassificaRefresh();
  }
});

// Chiusura del blocco di codice custom
  </script> 
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }

    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

/* === Effetti di transizione per le sezioni visibili (.content-section) === */
.content-section {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
}
.content-section.active {
  opacity: 1;
  pointer-events: all;
}


/* NUOVI STILI CLASSIFICA: per layout ordinato, allineato e loghi ridotti */
.classifica-table {
    width: 100%;
    border-collapse: collapse;
}

/* TH: Header con colori del brand */
.classifica-table th {
    background-color: var(--red);
    color: var(--white);
    padding: 10px 8px;
    text-align: center;
    font-size: 0.95rem;
    border-bottom: 2px solid var(--yellow);
    white-space: nowrap; 
}

/* TD: Celle dati */
.classifica-table td {
    padding: 8px 8px;
    border-bottom: 1px solid var(--line);
    text-align: center; /* Allineamento predefinito a centro per i numeri */
    white-space: nowrap; 
}

/* Allineamento a sinistra per la colonna del nome squadra (2° colonna) */
.classifica-table td:nth-child(2) {
    text-align: left; 
    font-weight: 600; /* Team name in grassetto */
}

/* Allineamento a destra per le statistiche (dalla 3a colonna in poi) */
.classifica-table td:nth-child(n+3) {
    text-align: right; 
}

/* Rendi la colonna della Posizione (1°) in grassetto */
.classifica-table td:nth-child(1) {
    font-weight: 800;
}

/* Righe pari/dispari (striping) - usa i colori del tema */
.classifica-table tbody tr:nth-child(odd) {
    background-color: var(--card); /* Bianco */
}
.classifica-table tbody tr:nth-child(even) {
    background-color: var(--bg); /* Grigio chiaro del tema */
}

/* Evidenzia la riga dell'AC Tuscolano */
.tuscolano-row {
    background-color: var(--yellow) !important; 
    color: var(--ink);
    font-weight: 700;
    border: 2px solid var(--red) !important;
}
.tuscolano-row td {
     border-bottom: none !important; 
}

/* Stile per i loghi ridotti */
.classifica-table img {
    max-width: 20px !important; /* Logo Ridotto */
    height: auto;
    vertical-align: middle;
    margin-right: 4px; /* Spazio tra logo e nome */
}
</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; // Usato nella sezione admin-video-section

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section','video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section',
      'admin-statistiche-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section' // Aggiunto per il video
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; // Includo il login per nasconderlo

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); // Protezione base
        
        ALL_SECTIONS.forEach(secId => { 
          const el = byId(secId); 
          if (el) el.style.display = (secId === id) ? 'block' : 'none'; 
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dal pubblico
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin (dal tuo codice originale)
        if(id==='admin-calendario-section'){ loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); // Carica per la sezione video

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); // Nasconde il form di login dopo lo stato di auth
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      if(user && isAdmin) {
         // Se admin loggato, mostra la sezione predefinita admin (es. inserimento giocatori)
         if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         // Se loggout o utente normale, mostra la sezione pubblica predefinita
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          // Ricarica la sezione pubblica dopo il logout
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded',()=>{
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) – usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section');
      loadRosa(); 
      loadProssimeGiornate(false); 
      loadStatistiche();
      loadClassifica(); // ** NUOVO: Carica la classifica all'avvio
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', loadStatistiche);
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', loadClassifica); // ** NUOVO: Evento per la classifica
    });
    
/* ===== FUNZIONE: Classifica AC Tuscolano con cache Firebase (solo admin aggiorna) ===== */
const loadClassifica = async () => {
  const classificaContent = document.getElementById('classifica-content');
  if (!classificaContent) return;

  classificaContent.innerHTML = `<div class="help">Caricamento classifica in corso...</div>`;

  try {
    const now = new Date();
    const todayKey = now.toISOString().split('T')[0];
    const snap = await get(ref(db, 'classifica_cache'));
    const cache = snap.val() || {};
    const cachedHtml = cache.html;
    const cachedDate = cache.date;

    if (cachedHtml && cachedDate === todayKey) {
      classificaContent.innerHTML = cachedHtml;
      // Aggiorna l'info sul prossimo refresh anche se da cache
      const infoEl = document.getElementById('classifica-next-run');
      if (infoEl) {
          window.scheduleDailyClassificaRefresh(); 
      }
      return;
    }

    if (!isAdmin) {
      if (cachedHtml) {
        classificaContent.innerHTML = cachedHtml;
      } else {
        classificaContent.innerHTML = `<div class="help" style="color:red">La classifica non è ancora disponibile. L'amministratore provvederà all'aggiornamento.</div>`;
      }
      return;
    }

    const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
    const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
    const response = await fetch(proxy);
    const data = await response.json();

    const parser = new DOMParser();
    const doc = parser.parseFromString(data.contents, "text/html");
    // Seleziona la tabella che contiene i dati. Uso lo stesso selettore del codice originale.
    const table = doc.querySelector(".table-responsive table") || doc.querySelector("table[class*='table']") || doc.querySelector("table");

    if (!table) {
      classificaContent.innerHTML = `<div class="help">Impossibile trovare la classifica sul sito remoto.</div>`;
      return;
    }
    
    // === LOGICA DI ORDINAMENTO E STYLING MIGLIORATO ===
    
    // 1. Pulizia e Preparazione dei Dati per il Sorting
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    
    // Mappa le righe in un formato dati sortabile.
    // Assunzione: la tabella remota ha 10 colonne (POS, SQUADRA, G, V, N, P, RF, RS, DR, PT)
    const dataRows = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('td'));
        
        if (cells.length < 10) {
            console.warn("Classifica: Numero di colonne insufficiente per il sort basato sui punti. Usando l'ordinamento originale.");
            // Ritorna dati base per mantenere la riga ma con un peso basso
            return { element: row, points: 0, gd: -999999 };
        }
        
        // Punti (Pt) è l'ultima cella (indice cells.length - 1)
        const pointsCell = cells[cells.length - 1];
        // Differenza Reti (DR) è la penultima cella (indice cells.length - 2)
        const gdCell = cells[cells.length - 2]; 

        return {
            element: row,
            points: parseInt(pointsCell?.textContent.trim(), 10) || 0,
            gd: parseInt(gdCell?.textContent.trim(), 10) || 0,
        };
    }).filter(dataRow => dataRow.element.textContent.trim().length > 0); // Rimuove righe vuote o malformate

    // 2. Sorting (Punti Decrescente, poi DG Decrescente)
    dataRows.sort((a, b) => {
        if (b.points !== a.points) {
            return b.points - a.points; // Ordina per Punti (Decrescente)
        }
        return b.gd - a.gd; // Tie-breaker: Ordina per Differenza Reti (Decrescente)
    });
    
    // 3. Riassemblaggio del Table e Stili
    const tbody = table.querySelector("tbody") || document.createElement('tbody');
    tbody.innerHTML = ''; // Svuoto il body
    
    dataRows.forEach((dataRow, index) => {
        const row = dataRow.element;
        // Aggiorno la posizione con il nuovo ordinamento (index + 1)
        const rankCell = row.querySelector('td:first-child');
        if (rankCell) {
            rankCell.textContent = index + 1;
        }
        
        // Evidenzia la riga dell'AC Tuscolano
        if (row.textContent.includes('Tuscolano')) {
            row.classList.add('tuscolano-row');
        } else {
            row.classList.remove('tuscolano-row');
        }
        
        // Pulisco eventuali stili inline vecchi su righe, celle e immagini
        row.removeAttribute('style');
        row.querySelectorAll('td').forEach(td => td.removeAttribute('style'));
        row.querySelectorAll('img').forEach(img => img.removeAttribute('style'));

        tbody.appendChild(row);
    });
    
    // Pulisco vecchi stili inline da table e header
    table.removeAttribute('style');
    table.querySelectorAll("th").forEach(th => th.removeAttribute('style'));

    // Applica classe per il nuovo styling CSS
    table.classList.add('classifica-table'); 
    
    // Assicura che tbody sia presente
    const existingTbody = table.querySelector('tbody');
    if(existingTbody && existingTbody !== tbody) existingTbody.remove();
    if(!table.querySelector('tbody')) table.appendChild(tbody);


    const htmlContent = `
      <div class="help">Classifica aggiornata e ordinata per Punti (poi Differenza Reti) automaticamente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
      <div style="overflow-x:auto;">${table.outerHTML}</div>
      <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
      <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
    `;

    classificaContent.innerHTML = htmlContent;
    await set(ref(db, 'classifica_cache'), {
      html: htmlContent,
      date: todayKey,
      timestamp: Date.now()
    });
    window.scheduleDailyClassificaRefresh(); 
    
  } catch (error) {
    console.error("Errore caricamento classifica:", error);
    const snapFallback = await get(ref(db, 'classifica_cache'));
    const cache = snapFallback.val();
    if (cache && cache.html) {
      classificaContent.innerHTML = cache.html;
    } else {
      classificaContent.innerHTML = `<div class="help" style="color:red">Errore nel recupero della classifica.</div>`;
    }
  }
};


    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */
    
    async function loadRosa(){
      const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; }
      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> • Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    async function loadProssimeGiornate(asAdmin){
        const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
        const ul = byId(listId); if(!ul) return; ul.innerHTML='';
        const snap = await get(ref(db,'calendario'));
        const val = snap.val() || {};
        let entries = Object.entries(val);
        
        // Funzione per convertire la data (gg/mm/aaaa)
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        // Data di oggi normalizzata a mezzanotte per confronto
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        
        entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));

        if(!entries.length){ ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; return; }
        ul.className='grid cols-3';

        for(const [matchId,m] of entries){
            const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
            const cand = candSnap.val() || {};
            const candCount = Object.values(cand).filter(Boolean).length;
            const isPublished = m.formazionePubblicata === true;
            
            // Nuovo controllo sulla data della partita
            const matchDate = toDate(m.data);
            // È nel passato se la data della partita è strettamente precedente a 'today' (normalizzato)
            const isPast = matchDate < today; 

            // Generazione condizionale del pulsante di candidatura
            let candButton = '';
            if (isPast) {
                // Partita passata: bottone disabilitato con testo aggiornato
                candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
            } else {
                // Partita futura: bottone attivo
                candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`;
            }
            
            const li = document.createElement('li'); li.className='card';
            li.innerHTML = `
              <div class="row" style="justify-content:space-between;align-items:flex-start">
                <div>
                  <div style="font-weight:800;font-size:1.05rem">vs ${m.avversaria}</div>
                  <div class="player-sub">${m.data} • ${m.orario} • ${m.campo} • ${m.casa? 'Casa':'Trasferta'}</div>
                  <div class="player-sub">Candidature: <b>${candCount}</b></div>
                  <div class="player-sub">Risultato: <b>${m.risultato||'N/D'}</b></div>
                </div>
                <div class="row">
                  ${!asAdmin ? `
                    ${candButton}
                    ${isPublished ? `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria)}')">Vedi Formazione</button>` : ''}
                  `:''}
                  ${asAdmin ? `
                    <button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria)}')">Formazione & Sost.</button>
                    <button class="btn btn--admin" onclick="showRisultatoForm('${matchId}','${escapeHtml(m.avversaria)}')">Risultato</button>
                  `:''}
                </div>
              </div>`;
            ul.appendChild(li);
        }
    }

    window.candidati = async(matchId)=>{
      const user = auth.currentUser;
      if(!user){ showLogin(); alert('Per candidarti devi effettuare il login.'); return; }
      await set(ref(db,`calendario/${matchId}/candidature/${user.uid}`), true);
      alert('Disponibilità inviata.');
      loadProssimeGiornate(false);
    };

    async function loadStatistiche(){
      const rl = byId('statistiche-risultati-list'); if(rl){ rl.innerHTML=''; }
      const gl = byId('statistiche-voti-list'); if(gl){ gl.innerHTML=''; }

      const snapCal = await get(ref(db,'calendario'));
      const cal = snapCal.val()||{};
      const rows = Object.entries(cal);
      
      if(rl){
        if(!rows.length) rl.innerHTML = '<div class="help">Ancora nessun risultato.</div>';
        rows.forEach(([id,m])=>{
          const li = document.createElement('li'); li.className='card';
          li.innerHTML = `<div><b>${m.data}</b> • vs ${m.avversaria} — Risultato: <b>${m.risultato||'N/D'}</b></div>`;
          rl.appendChild(li);
        });
      }
      
      const snapR = await get(ref(db,'rosa'));
      const rosa = snapR.val()||{};
      const players = Object.values(rosa);
      
      if(gl){
        if(!players.length) gl.innerHTML = '<div class="help">Rosa vuota.</div>';
        players.sort((a,b)=> (b.goal||0)-(a.goal||0)).forEach(g=>{
          const li = document.createElement('li'); li.className='card';
          li.innerHTML = `<div class="row" style="justify-content:space-between"><div><b>${g.nome} ${g.cognome}</b> <span class="pill">#${g.numero}</span></div><div class="player-sub">Voto: <b>${g.voto||0}</b> • Presenze: <b>${g.presenze||0}</b> • Goal: <b>${g.goal||0}</b></div></div>`;
          gl.appendChild(li);
        });
      }
    }

    /* Posizioni modulo 3-3-1 */
    const POS_331 = { 
      'Portiere': { top:'90%', left:'50%' }, 
      'Difensore centrale': { top:'70%', left:'50%' }, 
      'Terzino sinistro': { top:'70%', left:'25%' }, 
      'Terzino destro': { top:'70%', left:'75%' }, 
      'Centrocampista centrale': { top:'45%', left:'50%' }, 
      'Centrocampista sinistro': { top:'45%', left:'25%' }, 
      'Centrocampista destro': { top:'45%', left:'75%' }, 
      'Attaccante centrale': { top:'15%', left:'50%' } 
    };

    /** VISUALIZZAZIONE PUBBLICA: Formazione */
    window.showFormazionePubblica = async (matchId, avv) => {
      window.showPublicSection('formazione-pubblica-section');
      const content = byId('formazione-pubblica-content');
      content.innerHTML = `<h3>vs ${escapeHtml(avv)}: Formazione Iniziale e Sostituzioni</h3><p>Caricamento...</p>`;

      const [snapMatch, snapRosa] = await Promise.all([ 
        get(ref(db, `calendario/${matchId}`)), 
        get(ref(db, 'rosa')) 
      ]);
      
      const match = snapMatch.val();
      const rosa = snapRosa.val() || {};
      const formazioni = match?.formazioni || {};
      const panchina = match?.panchina || []; // Recupera la panchina salvata
      const html = [];
      
      const rolesOrder = ['Portiere', 'Difensore centrale', 'Terzino sinistro', 'Terzino destro', 'Centrocampista centrale', 'Centrocampista sinistro', 'Centrocampista destro', 'Attaccante centrale'];
      const titolari = formazioni['0']?.formazione;

      if (titolari) {
        html.push(`<h4>Formazione Titolare (3-3-1)</h4>`);
        html.push(`<div class="field" style="margin-bottom: 14px; position:relative">`);
        Object.entries(titolari).forEach(([ruolo, pid]) => {
          const p = rosa[pid];
          const pos = POS_331[ruolo];
          if(p && pos) html.push(`<div class="marker" style="top:${pos.top}; left:${pos.left};"><b>${escapeHtml(p.cognome)}</b><br>${ruolo}</div>`);
        });
        html.push(`</div>`);

        html.push(`<h4>Dettaglio Titolari</h4>`);
        html.push(`<ul style="list-style:disc;padding-left:18px">`);
        Object.entries(titolari).sort((a,b)=> rolesOrder.indexOf(a[0]) - rolesOrder.indexOf(b[0]))
          .forEach(([ruolo, pid]) => { 
            const pl = rosa[pid];
            html.push(`<li><b>${ruolo}</b>: ${pl ? `${pl.nome} ${pl.cognome} (#${pl.numero})` : 'Giocatore Sconosciuto'}</li>`);
          });
        html.push(`</ul>`);
      } else {
        html.push(`<p>Formazione iniziale non disponibile.</p>`);
      }
      
      // Visualizza le sostituzioni
      if (formazioni && Object.keys(formazioni).length > 1) {
        html.push(`<h4>Sostituzioni</h4>`);
        html.push(`<ul style="list-style:disc;padding-left:18px">`);
        Object.keys(formazioni).filter(k => k !== '0').sort((a,b)=>parseInt(a)-parseInt(b)).forEach(min => {
          const sost = formazioni[min];
          const entra = rosa[sost.entra];
          const esce = rosa[sost.esce];
          
          let s = `<li><b>Minuto ${min}:</b>`;
          if (entra) s += ` Entra <b>${entra.nome} ${entra.cognome} (#${entra.numero})</b>`;
          if (esce) s += ` Esce <b>${esce.nome} ${esce.cognome} (#${esce.numero})</b>`;
          s += `</li>`;
          html.push(s);
        });
        html.push(`</ul>`);
      } else if (titolari) {
          html.push(`<h4>Sostituzioni</h4>`);
          html.push(`<p>Nessuna sostituzione registrata.</p>`);
      }

      // Visualizza la panchina
      if (panchina && panchina.length > 0) {
        const panchinaList = panchina.map(pid => {
          const p = rosa[pid];
          return p ? `${p.nome} ${p.cognome} (#${p.numero})` : 'Giocatore Sconosciuto';
        }).join(', ');
        
        html.push(`<h4>Panchina</h4>`);
        html.push(`<p>${panchinaList}</p>`);
      }

      content.innerHTML = html.join('');
    };
    
    // Funzioni Admin Formazione (Mantenute dal tuo codice originale)
    
    // Mostra il form per la Formazione
    window.showFormazioneForm = async (matchId, avv) => {
        if (!isAdmin) return;
        selectedMatchKey = matchId;
        window.showAdminSection('admin-formazione-section');
        byId('formazione-match-title').textContent = `Formazione vs ${escapeHtml(avv)}`;
        
        const [snapRosa, snapMatch] = await Promise.all([
          get(ref(db, 'rosa')),
          get(ref(db, `calendario/${matchId}`))
        ]);

        const rosa = snapRosa.val() || {};
        const match = snapMatch.val();
        const formazioni = match?.formazioni || {'0': { formazione: {} }};
        const panchina = match?.panchina || [];

        // Crea le opzioni per la selezione dei giocatori
        const playerOptions = Object.entries(rosa)
            .sort((a, b) => (a[1].numero || 999) - (b[1].numero || 999))
            .map(([id, p]) => `<option value="${id}">#${p.numero} - ${p.cognome} (${p.ruolo})</option>`).join('');

        // 1. Titolari
        const titolariForm = byId('titolari-form');
        titolariForm.innerHTML = '';
        Object.keys(POS_331).forEach(ruolo => {
            const playerId = formazioni['0']?.formazione[ruolo] || '';
            const html = `
                <div class="row" style="align-items:baseline">
                    <label style="flex-basis:150px">${ruolo}</label>
                    <select class="titolare-select" data-ruolo="${ruolo}" style="flex-grow:1;max-width:none">
                        <option value="">-- Seleziona Giocatore --</option>
                        ${playerOptions}
                    </select>
                </div>`;
            titolariForm.insertAdjacentHTML('beforeend', html);
            // Pre-seleziona il giocatore
            const select = titolariForm.querySelector(`[data-ruolo="${ruolo}"]`);
            if (select && playerId) select.value = playerId;
        });

        // 2. Panchina (Checkbox)
        const panchinaForm = byId('panchina-list');
        panchinaForm.innerHTML = '';
        Object.entries(rosa)
            .sort((a, b) => (a[1].numero || 999) - (b[1].numero || 999))
            .forEach(([id, p]) => {
                const isSelected = panchina.includes(id);
                const html = `
                    <div class="row" style="margin-bottom:6px">
                        <input type="checkbox" id="panchina-${id}" value="${id}" ${isSelected ? 'checked' : ''} class="panchina-checkbox" style="width:auto;max-width:none"/>
                        <label for="panchina-${id}" style="display:inline;margin-top:0">${p.nome} ${p.cognome} (#${p.numero})</label>
                    </div>`;
                panchinaForm.insertAdjacentHTML('beforeend', html);
            });

        // 3. Sostituzioni
        window.loadSostituzioni(matchId, rosa);
    };

    // Aggiorna la lista delle sostituzioni
    window.loadSostituzioni = (matchId, rosa) => {
        const sostList = byId('sostituzioni-list');
        sostList.innerHTML = '';
        
        get(ref(db, `calendario/${matchId}/formazioni`)).then(snap => {
            const formazioni = snap.val() || {'0': { formazione: {} }};
            const rows = Object.entries(formazioni).filter(([k]) => k !== '0').sort((a,b) => parseInt(a[0]) - parseInt(b[0]));
            
            if (!rows.length) {
                sostList.innerHTML = '<div class="help">Nessuna sostituzione registrata.</div>';
                return;
            }

            rows.forEach(([min, sost]) => {
                const entra = rosa[sost.entra]?.cognome || 'Sconosciuto';
                const esce = rosa[sost.esce]?.cognome || 'Sconosciuto';
                
                const html = `
                    <div class="card row" style="justify-content:space-between; margin-bottom:8px">
                        <div>
                            <b>Minuto ${min}:</b> Entra ${entra} | Esce ${esce}
                        </div>
                        <button class="btn btn--admin" style="background:#ff6f6f" onclick="window.removeSostituzione('${matchId}', '${min}')">Rimuovi</button>
                    </div>
                `;
                sostList.insertAdjacentHTML('beforeend', html);
            });
        });
    };

    // Salva Titolari e Panchina
    byId('save-formazione-btn')?.addEventListener('click', async () => {
        if (!isAdmin || !selectedMatchKey) return alert("Errore di sessione.");

        const titolari = {};
        const panchina = [];
        let titolariCompleti = true;

        // 1. Titolari
        document.querySelectorAll('.titolare-select').forEach(select => {
            const ruolo = select.dataset.ruolo;
            const playerId = select.value;
            if (playerId) {
                titolari[ruolo] = playerId;
            } else {
                titolariCompleti = false;
            }
        });
        
        // 2. Panchina
        document.querySelectorAll('.panchina-checkbox:checked').forEach(checkbox => {
            panchina.push(checkbox.value);
        });

        if (!titolariCompleti) return alert("Seleziona tutti i 7 titolari prima di salvare.");

        try {
            const updates = {};
            updates[`/calendario/${selectedMatchKey}/formazioni/0/formazione`] = titolari;
            updates[`/calendario/${selectedMatchKey}/panchina`] = panchina;
            await update(ref(db), updates);
            alert("Formazione iniziale e panchina salvate con successo.");
        } catch (error) {
            alert("Errore salvataggio: " + error.message);
        }
    });

    // Salva Sostituzione
    byId('add-sostituzione-btn')?.addEventListener('click', async () => {
        if (!isAdmin || !selectedMatchKey) return alert("Errore di sessione.");
        const min = parseInt(v('sost-minuto'));
        const entra = v('sost-entra');
        const esce = v('sost-esce');
        
        if (!min || min < 1 || min > 60 || !entra || !esce) return alert("Compila correttamente Minuto, Giocatore Entrante ed Uscente.");
        if (entra === esce) return alert("Giocatore Entrante e Uscente non possono essere gli stessi.");

        try {
            const updates = {};
            updates[`/calendario/${selectedMatchKey}/formazioni/${min}`] = { entra, esce };
            await update(ref(db), updates);
            alert("Sostituzione aggiunta.");
            byId('sost-minuto').value = '';
            // Ricarica la lista
            const snapRosa = await get(ref(db, 'rosa'));
            window.loadSostituzioni(selectedMatchKey, snapRosa.val() || {});
        } catch (error) {
            alert("Errore aggiunta sostituzione: " + error.message);
        }
    });

    // Rimuovi Sostituzione
    window.removeSostituzione = async (matchId, min) => {
        if (!isAdmin || !confirm(`Sei sicuro di voler rimuovere la sostituzione al minuto ${min}?`)) return;
        try {
            await remove(ref(db, `calendario/${matchId}/formazioni/${min}`));
            alert(`Sostituzione al minuto ${min} rimossa.`);
            const snapRosa = await get(ref(db, 'rosa'));
            window.loadSostituzioni(matchId, snapRosa.val() || {});
        } catch (error) {
            alert("Errore rimozione: " + error.message);
        }
    };
    
    // Pubblica Formazione
    byId('publish-formazione-btn')?.addEventListener('click', async () => {
        if (!isAdmin || !selectedMatchKey) return alert("Errore di sessione.");
        if (!confirm("Sei sicuro di voler pubblicare questa formazione? Una volta pubblicata, è visibile a tutti gli utenti.")) return;
        try {
            await update(ref(db, `calendario/${selectedMatchKey}`), { formazionePubblicata: true });
            alert("Formazione pubblicata con successo.");
        } catch (error) {
            alert("Errore pubblicazione: " + error.message);
        }
    });

    // Risultato Form
    window.showRisultatoForm = async (matchId, avv) => {
        if (!isAdmin) return;
        selectedMatchKey = matchId;
        window.showAdminSection('admin-statistiche-section');
        byId('risultato-match-title').textContent = `Risultato vs ${escapeHtml(avv)}`;
        
        const snap = await get(ref(db, `calendario/${matchId}`));
        const match = snap.val();
        
        const [golFatti, golSubiti] = (match.risultato || '0-0').split('-').map(s => parseInt(s) || 0);

        byId('risultato-fatti').value = golFatti;
        byId('risultato-subiti').value = golSubiti;
        byId('risultato-note').value = match.note || '';
        
        // Giocatori con Voto/Goal
        window.loadStatistichePerPartita(matchId);
    };
    
    // Carica i dati dei giocatori per quella partita (Admin Statistiche)
    window.loadStatistichePerPartita = async (matchId) => {
        const snapRosa = await get(ref(db, 'rosa'));
        const rosa = snapRosa.val() || {};
        const snapMatch = await get(ref(db, `calendario/${matchId}`));
        const match = snapMatch.val() || {};

        const titolari = match.formazioni?.['0']?.formazione || {};
        const subList = Object.keys(match.formazioni || {}).filter(k=>k!=='0').flatMap(k=>[match.formazioni[k].entra, match.formazioni[k].esce]);
        const allPlayed = [...new Set([...Object.values(titolari), ...subList])].filter(Boolean);
        
        const body = byId('stat-giocatori-body');
        body.innerHTML = '';
        
        const playerEntries = Object.entries(rosa)
            .filter(([id]) => allPlayed.includes(id)) // Mostra solo chi ha giocato
            .sort((a, b) => (a[1].numero || 999) - (b[1].numero || 999));

        if (!playerEntries.length) {
             body.innerHTML = '<tr><td colspan="4"><div class="help">Nessun giocatore registrato come partecipante a questa partita.</div></td></tr>';
             return;
        }

        playerEntries.forEach(([id, p]) => {
            const stat = p.statistiche?.[matchId] || {};
            const voto = stat.voto || '';
            const goal = stat.goal || 0;
            const note = stat.note || '';
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>#${p.numero} ${p.cognome}</td>
                <td><input type="number" step="0.5" class="stat-voto" data-pid="${id}" value="${voto}" min="4" max="10" style="max-width:80px"/></td>
                <td><input type="number" class="stat-goal" data-pid="${id}" value="${goal}" min="0" style="max-width:80px"/></td>
                <td><input type="text" class="stat-note" data-pid="${id}" value="${escapeHtml(note)}" placeholder="Note performance" /></td>
            `;
            body.appendChild(tr);
        });
    };

    // Salva Risultato e Statistiche
    byId('save-risultato-btn')?.addEventListener('click', async () => {
        if (!isAdmin || !selectedMatchKey) return alert("Errore di sessione.");
        const golFatti = parseInt(v('risultato-fatti'));
        const golSubiti = parseInt(v('risultato-subiti'));
        const note = v('risultato-note');

        if (isNaN(golFatti) || isNaN(golSubiti)) return alert("Inserisci un punteggio valido.");

        try {
            const updates = {};
            const risultato = `${golFatti}-${golSubiti}`;
            updates[`/calendario/${selectedMatchKey}/risultato`] = risultato;
            updates[`/calendario/${selectedMatchKey}/note`] = note;
            
            // 1. Aggiorna Statistiche Partita per Giocatori
            const statUpdates = {};
            let globalStatsUpdates = {};
            const rosaSnapshot = await get(ref(db, 'rosa'));
            const rosaData = rosaSnapshot.val() || {};
            
            document.querySelectorAll('#stat-giocatori-body tr').forEach(row => {
                const pid = row.querySelector('.stat-voto').dataset.pid;
                const voto = parseFloat(row.querySelector('.stat-voto').value) || 0;
                const goal = parseInt(row.querySelector('.stat-goal').value) || 0;
                const pNote = row.querySelector('.stat-note').value.trim();
                
                // Aggiorna la singola statistica del giocatore per la partita
                statUpdates[`/rosa/${pid}/statistiche/${selectedMatchKey}`] = { voto: voto, goal: goal, note: pNote };
                
                // Aggiorna statistiche globali (presenze, goal totali)
                const p = rosaData[pid];
                if (p) {
                   const oldGoal = p.statistiche?.[selectedMatchKey]?.goal || 0;
                   const goalDiff = goal - oldGoal;

                   if (goalDiff !== 0) {
                      const newTotalGoals = (p.goal || 0) + goalDiff;
                      globalStatsUpdates[`/rosa/${pid}/goal`] = newTotalGoals;
                   }
                   
                   // Nota: l'incremento di 'presenze' dovrebbe avvenire solo una volta
                   // Qui stiamo solo aggiornando i goal e il voto per la partita.
                   // Si assume che la 'presenza' sia stata gestita separatamente.
                }
            });
            
            await update(ref(db), updates);
            await update(ref(db), statUpdates);
            if(Object.keys(globalStatsUpdates).length > 0) await update(ref(db), globalStatsUpdates);
            
            alert(`Risultato (${risultato}) e statistiche salvate con successo.`);
            loadStatistiche(); // Ricarica la sezione Statistiche Pubblica
            loadProssimeGiornate(true); // Ricarica il Calendario Admin
            
        } catch (error) {
            alert("Errore salvataggio risultato: " + error.message);
            console.error(error);
        }
    });


    // --- CRUD Giocatori e Partite (Admin Gestione Dati) ---

    // Carica la lista di giocatori per il CRUD
    window.loadCrudGiocatori = async () => {
        const body = byId('crud-giocatori-body');
        body.innerHTML = '';
        const snap = await get(ref(db, 'rosa'));
        const val = snap.val() || {};

        Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0)).forEach(([id, g]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="number" class="crud-numero" value="${g.numero||''}" data-id="${id}" /></td>
                <td><input type="text" class="crud-nome" value="${escapeHtml(g.nome)}" data-id="${id}" /></td>
                <td><input type="text" class="crud-cognome" value="${escapeHtml(g.cognome)}" data-id="${id}" /></td>
                <td><select class="crud-ruolo" data-id="${id}">
                    <option value="Portiere" ${g.ruolo === 'Portiere' ? 'selected' : ''}>Portiere</option>
                    <option value="Difensore centrale" ${g.ruolo === 'Difensore centrale' ? 'selected' : ''}>Dif. Centrale</option>
                    <option value="Terzino sinistro" ${g.ruolo === 'Terzino sinistro' ? 'selected' : ''}>Terzino Sinistro</option>
                    <option value="Terzino destro" ${g.ruolo === 'Terzino destro' ? 'selected' : ''}>Terzino Destro</option>
                    <option value="Centrocampista centrale" ${g.ruolo === 'Centrocampista centrale' ? 'selected' : ''}>Centr. Centrale</option>
                    <option value="Centrocampista sinistro" ${g.ruolo === 'Centrocampista sinistro' ? 'selected' : ''}>Centr. Sinistro</option>
                    <option value="Centrocampista destro" ${g.ruolo === 'Centrocampista destro' ? 'selected' : ''}>Centr. Destro</option>
                    <option value="Attaccante centrale" ${g.ruolo === 'Attaccante centrale' ? 'selected' : ''}>Attaccante</option>
                </select></td>
                <td><select class="crud-stato" data-id="${id}">
                    <option value="Attivo" ${g.stato === 'Attivo' ? 'selected' : ''}>Attivo</option>
                    <option value="Infortunato" ${g.stato === 'Infortunato' ? 'selected' : ''}>Infortunato</option>
                    <option value="Squalificato" ${g.stato === 'Squalificato' ? 'selected' : ''}>Squalificato</option>
                    <option value="Indisponibile" ${g.stato === 'Indisponibile' ? 'selected' : ''}>Indisponibile</option>
                </select></td>
                <td><button class="btn" style="background:#ff6f6f" onclick="window.deleteGiocatore('${id}')">Rimuovi</button></td>
            `;
            body.appendChild(tr);
        });
    };

    // Aggiungi Giocatore
    byId('add-giocatore-btn')?.addEventListener('click', () => {
        if (!isAdmin) return;
        const newPlayer = { nome: 'Nuovo', cognome: 'Giocatore', numero: 0, ruolo: 'Portiere', stato: 'Attivo' };
        push(ref(db, 'rosa'), newPlayer).then(() => {
            window.loadCrudGiocatori();
        }).catch(err => alert("Errore: " + err.message));
    });
    
    // Salva Giocatori
    byId('save-giocatori-btn')?.addEventListener('click', async () => {
        if (!isAdmin) return;
        const updates = {};
        let success = true;

        document.querySelectorAll('#crud-giocatori-body tr').forEach(row => {
            const id = row.querySelector('.crud-numero').dataset.id;
            updates[`/rosa/${id}/numero`] = parseInt(row.querySelector('.crud-numero').value) || 0;
            updates[`/rosa/${id}/nome`] = row.querySelector('.crud-nome').value.trim();
            updates[`/rosa/${id}/cognome`] = row.querySelector('.crud-cognome').value.trim();
            updates[`/rosa/${id}/ruolo`] = row.querySelector('.crud-ruolo').value;
            updates[`/rosa/${id}/stato`] = row.querySelector('.crud-stato').value;

            if(!updates[`/rosa/${id}/nome`] || !updates[`/rosa/${id}/cognome`]) {
                success = false;
            }
        });

        if (!success) {
            return alert("Errore: Nome e Cognome non possono essere vuoti.");
        }

        try {
            await update(ref(db), updates);
            alert("Giocatori salvati con successo.");
            loadRosa(); // Aggiorna rosa pubblica
        } catch (error) {
            alert("Errore salvataggio: " + error.message);
        }
    });

    // Rimuovi Giocatore
    window.deleteGiocatore = async (id) => {
        if (!isAdmin || !confirm("Sei sicuro di voler eliminare questo giocatore?")) return;
        try {
            await remove(ref(db, `rosa/${id}`));
            alert("Giocatore eliminato.");
            window.loadCrudGiocatori();
            loadRosa(); // Aggiorna rosa pubblica
        } catch (error) {
            alert("Errore eliminazione: " + error.message);
        }
    };
    
    // Carica la lista di partite per il CRUD
    window.loadCrudPartite = async () => {
        const body = byId('crud-partite-body');
        body.innerHTML = '';
        const snap = await get(ref(db, 'calendario'));
        const val = snap.val() || {};

        const entries = Object.entries(val).sort((a,b)=> {
            const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
            return toDate(b[1].data) - toDate(a[1].data);
        });

        entries.forEach(([id, m]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="crud-data" value="${escapeHtml(m.data||'')}" data-id="${id}" style="width:100px"/></td>
                <td><input type="text" class="crud-orario" value="${escapeHtml(m.orario||'')}" data-id="${id}" style="width:80px"/></td>
                <td><input type="text" class="crud-avversaria" value="${escapeHtml(m.avversaria)}" data-id="${id}" /></td>
                <td><input type="text" class="crud-campo" value="${escapeHtml(m.campo||'')}" data-id="${id}" /></td>
                <td><select class="crud-casa" data-id="${id}">
                    <option value="true" ${m.casa ? 'selected' : ''}>Casa</option>
                    <option value="false" ${!m.casa ? 'selected' : ''}>Trasferta</option>
                </select></td>
                <td>${m.risultato || 'N/D'}</td>
                <td><button class="btn" style="background:#ff6f6f" onclick="window.deletePartita('${id}')">Rimuovi</button></td>
            `;
            body.appendChild(tr);
            
            // Applica Datepicker alla colonna Data
            $(tr).find('.crud-data').datepicker({ dateFormat:"dd/mm/yy" });
        });
    };
    
    // Aggiungi Partita
    byId('add-partita-btn')?.addEventListener('click', () => {
        if (!isAdmin) return;
        const today = new Date();
        const dd = String(today.getDate()).padStart(2, '0');
        const mm = String(today.getMonth() + 1).padStart(2, '0'); // Gennaio è 0!
        const yyyy = today.getFullYear();
        const newMatch = { data: `${dd}/${mm}/${yyyy}`, orario: '20:00', avversaria: 'Nuova Avversaria', campo: 'Campo A', casa: true, risultato: 'N/D' };
        
        push(ref(db, 'calendario'), newMatch).then(() => {
            window.loadCrudPartite();
        }).catch(err => alert("Errore: " + err.message));
    });

    // Salva Partite
    byId('save-partite-btn')?.addEventListener('click', async () => {
        if (!isAdmin) return;
        const updates = {};
        let success = true;

        document.querySelectorAll('#crud-partite-body tr').forEach(row => {
            const id = row.querySelector('.crud-data').dataset.id;
            updates[`/calendario/${id}/data`] = row.querySelector('.crud-data').value.trim();
            updates[`/calendario/${id}/orario`] = row.querySelector('.crud-orario').value.trim();
            updates[`/calendario/${id}/avversaria`] = row.querySelector('.crud-avversaria').value.trim();
            updates[`/calendario/${id}/campo`] = row.querySelector('.crud-campo').value.trim();
            updates[`/calendario/${id}/casa`] = row.querySelector('.crud-casa').value === 'true';

            if(!updates[`/calendario/${id}/data`] || !updates[`/calendario/${id}/avversaria`]) {
                success = false;
            }
        });

        if (!success) {
            return alert("Errore: Data e Avversaria non possono essere vuote.");
        }

        try {
            await update(ref(db), updates);
            alert("Partite salvate con successo.");
            loadProssimeGiornate(false); // Aggiorna calendario pubblico
        } catch (error) {
            alert("Errore salvataggio: " + error.message);
        }
    });

    // Rimuovi Partita
    window.deletePartita = async (id) => {
        if (!isAdmin || !confirm("Sei sicuro di voler eliminare questa partita? Verranno eliminate anche formazioni e candidature associate.")) return;
        try {
            await remove(ref(db, `calendario/${id}`));
            alert("Partita eliminata.");
            window.loadCrudPartite();
            loadProssimeGiornate(false); // Aggiorna calendario pubblico
        } catch (error) {
            alert("Errore eliminazione: " + error.message);
        }
    };
    
    // --- Admin Candidature ---
    
    let currentCandidatureMatchId = null;

    // Mostra il modale per le candidature
    window.showCandidatureEditor = async (matchId, avv) => {
        if (!isAdmin) return;
        currentCandidatureMatchId = matchId;
        
        const modal = byId('candidature-editor');
        byId('candidature-match-title').textContent = `Candidature vs ${escapeHtml(avv)}`;
        
        // 1. Carica la Rosa e i Giocatori Utenti
        const [snapRosa, snapUtenti, snapMatch] = await Promise.all([
            get(ref(db, 'rosa')),
            get(ref(db, 'utenti')),
            get(ref(db, `calendario/${matchId}`))
        ]);
        const rosa = snapRosa.val() || {};
        const utenti = snapUtenti.val() || {};
        const candidature = snapMatch.val()?.candidature || {};

        const body = byId('crud-candidature-body');
        body.innerHTML = '';
        
        const rosaEntries = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
        
        rosaEntries.forEach(([pid, p]) => {
            // Trova l'utente collegato (cercando nome e cognome)
            const linkedUser = Object.entries(utenti).find(([uid, u]) => 
                u.nome?.toLowerCase() === p.nome?.toLowerCase() && u.cognome?.toLowerCase() === p.cognome?.toLowerCase()
            );
            const uid = linkedUser ? linkedUser[0] : null;
            const isCandidato = candidature[uid] === true;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>#${p.numero} ${p.cognome}</td>
                <td>${uid ? uid : '<span style="color:red">Nessun utente</span>'}</td>
                <td>
                    <input type="checkbox" class="candidatura-checkbox" data-uid="${uid}" ${isCandidato ? 'checked' : ''} ${!uid ? 'disabled' : ''} style="width:auto;max-width:none"/>
                    ${uid ? '' : '<div class="help" style="display:inline-block;margin-left:8px">Admin deve creare l\'utente</div>'}
                </td>
            `;
            body.appendChild(tr);
        });

        // Mostra il modale
        modal.style.display = 'block';
    };

    // Chiude il modale Candidature
    window.closeCandidatureEditor = () => {
        byId('candidature-editor').style.display = 'none';
        currentCandidatureMatchId = null;
    };
    
    // Salva le candidature manualmente (Admin)
    byId('crud-candidature-save')?.addEventListener('click', async () => {
        if (!isAdmin || !currentCandidatureMatchId) return alert("Errore di sessione.");
        
        const updates = {};
        const refPath = `/calendario/${currentCandidatureMatchId}/candidature`;
        
        // Prima, rimuovi tutte le candidature esistenti per resettare
        await remove(ref(db, refPath));
        
        // Poi, aggiungi solo quelle selezionate
        document.querySelectorAll('.candidatura-checkbox:checked').forEach(checkbox => {
            const uid = checkbox.dataset.uid;
            if (uid) {
                updates[`${refPath}/${uid}`] = true;
            }
        });
        
        if (Object.keys(updates).length > 0) {
            await update(ref(db), updates);
        }

        alert("Candidature salvate con successo.");
        window.closeCandidatureEditor();
        loadProssimeGiornate(true); // Ricarica per aggiornare il conteggio
    });
    
</script>
</head>
<body>

  <div id="candidature-editor" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; align-items:center; justify-content:center; padding:20px;">
    <div style="background:var(--card); padding:20px; border-radius:var(--radius); width:90%; max-width:600px; position:relative;">
      <h3 id="candidature-match-title" style="margin-top:0; border-bottom:1px solid var(--line); padding-bottom:10px">Candidature</h3>
      <div class="help" style="margin-bottom:10px">La spunta indica la disponibilità (richiede che il giocatore abbia un utente collegato con lo stesso Nome e Cognome in <code>/utenti</code>).</div>
      <table class="table">
        <thead><tr><th>Giocatore</th><th>UID collegato</th><th>Disponibile</th></tr></thead>
        <tbody id="crud-candidature-body"></tbody>
      </table>
      <div class="actions" style="margin-top:10px">
        <button id="crud-candidature-save" class="btn btn--admin" type="button">Salva candidature</button>
        <button class="btn" type="button" onclick="closeCandidatureEditor()">Chiudi</button>
      </div>
    </div>
  </div>


  <div id="video-modal">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button">&times;</button>
      <div id="video-iframe-container"></div>
    </div>
  </div>


  <header>
    <div class="hero">
      <img src="https://i.ibb.co/60qYh4X/logo-tuscolano-400x400.png" alt="Logo AC Tuscolano" />
      <div class="brand">
        <h1 class="club">AC TUSCOLANO</h1>
        <p class="tag">CALCIO A 8 OVER 40</p>
      </div>
      <button id="auth-toggle-btn" class="btn">Login</button>
    </div>
  </header>

  <nav>
    <div class="nav-wrap">
      <button class="tab" data-target="rosa-section" id="rosa-tab" aria-current="page">Rosa</button>
      <button class="tab" data-target="calendario-section" id="calendario-tab">Calendario</button>
      <button class="tab" data-target="classifica-section" id="classifica-tab">Classifica</button>
      <button class="tab" data-target="statistiche-section" id="statistiche-tab">Statistiche</button>
      <button class="tab" data-target="video-section" id="video-tab">Video Partite</button>
    </div>
  </nav>

  <div id="admin-menu">
    <div class="nav-wrap">
      <button class="tab" data-admin-target="admin-inserimento-giocatori-section" id="admin-giocatori-tab">Giocatori</button>
      <button class="tab" data-admin-target="admin-inserimento-giornate-section" id="admin-giornate-tab">Partite</button>
      <button class="tab" data-admin-target="admin-calendario-section" id="admin-calendario-tab">Gest. Calendario</button>
      <button class="tab" data-admin-target="admin-gestione-dati-section" id="admin-crud-tab">CRUD Dati</button>
      <button class="tab" data-admin-target="admin-utenti-section" id="admin-utenti-tab">Utenti</button>
      <button class="tab" data-admin-target="admin-video-section" id="admin-video-tab">Gest. Video</button>
    </div>
  </div>

  <main>
    
    <section id="login-section" style="display:none">
      <h2>Accesso</h2>
      <form id="login-form">
        <label for="login-email">Email</label><input id="login-email" type="email" required />
        <label for="login-password">Password</label><input id="login-password" type="password" required />
        <div class="actions"><button class="btn btn--accent" type="submit">Accedi</button></div>
      </form>
    </section>

    <section id="rosa-section" class="content-section active">
      <h2>Rosa Completa</h2>
      <div id="rosa-list"></div>
      <div class="help" style="margin-top:14px">Aggiornato in tempo reale dal pannello Admin.</div>
    </section>
    
    <section id="calendario-section" class="content-section">
      <h2>Prossime Partite</h2>
      <div id="calendario-list"></div>
      <div class="help" style="margin-top:14px">Clicca sulle partite per vedere lo stato delle candidature.</div>
    </section>

    <section id="classifica-section" class="content-section">
      <h2>Classifica</h2>
      <div id="classifica-content"></div>
    </section>
    
    <section id="statistiche-section" class="content-section">
      <h2>Statistiche</h2>
      
      <h3>Marcatori & Performance</h3>
      <div id="statistiche-voti-list"></div>
      
      <h3 style="margin-top:24px">Risultati Partite</h3>
      <div id="statistiche-risultati-list"></div>
    </section>

    <section id="formazione-pubblica-section" class="content-section">
      <h2>Formazione Partita</h2>
      <div id="formazione-pubblica-content"></div>
    </section>

    <section id="video-section" class="content-section">
      <h2>Video Partite</h2>
      <div id="video-list-ul"></div>
      <div class="help" style="margin-top:14px">Guarda i video delle partite concluse (solo link YouTube).</div>
    </section>


    <section id="admin-inserimento-giocatori-section" style="display:none">
      <h2>Admin · Inserimento Giocatori (vecchio)</h2>
      <form id="add-player-form">
        <label>Nome</label><input id="nome" required />
        <label>Cognome</label><input id="cognome" required />
        <label>Numero Maglia</label><input id="numero" type="number" required />
        <label>Ruolo</label><select id="ruolo" required>
          <option value="Portiere">Portiere</option>
          <option value="Difensore centrale">Difensore centrale</option>
          <option value="Terzino sinistro">Terzino sinistro</option>
          <option value="Terzino destro">Terzino destro</option>
          <option value="Centrocampista centrale">Centrocampista centrale</option>
          <option value="Centrocampista sinistro">Centrocampista sinistro</option>
          <option value="Centrocampista destro">Centrocampista destro</option>
          <option value="Attaccante centrale">Attaccante centrale</option>
        </select>
        <label>Stato</label><select id="stato" required>
          <option value="Attivo">Attivo</option>
          <option value="Infortunato">Infortunato</option>
          <option value="Squalificato">Squalificato</option>
          <option value="Indisponibile">Indisponibile</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi Giocatore</button></div>
      </form>
    </section>

    <section id="admin-inserimento-giornate-section" style="display:none">
      <h2>Admin · Inserimento Partite (vecchio)</h2>
      <form id="add-match-form">
        <label>Data</label><input id="match-data" required />
        <label>Orario</label><input id="match-orario" value="20:00" />
        <label>Avversaria</label><input id="match-avversaria" required />
        <label>Campo</label><input id="match-campo" required />
        <label>Tipo</label><select id="match-casa" required>
          <option value="true">Casa</option>
          <option value="false">Trasferta</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Aggiungi Partita</button></div>
      </form>
    </section>

    <section id="admin-calendario-section" style="display:none">
      <h2>Admin · Gestione Calendario & Candidature</h2>
      <div id="admin-calendario-list" class="grid cols-3"></div>
      <div class="help" style="margin-top:14px">Qui puoi gestire Formazione, Sostituzioni e Risultato.</div>
    </section>

    <section id="admin-formazione-section" style="display:none">
      <h2 id="formazione-match-title">Admin · Gestione Formazione</h2>
      
      <h3 style="margin-top:14px">Titolari (3-3-1)</h3>
      <div id="titolari-form" class="grid cols-2" style="max-width:600px;margin-bottom:14px">
        </div>
      
      <h3 style="margin-top:24px">Panchina</h3>
      <div id="panchina-list" class="grid cols-3" style="margin-bottom:14px">
        </div>

      <div class="actions">
        <button id="save-formazione-btn" class="btn btn--admin">Salva Titolari & Panchina</button>
        <button id="publish-formazione-btn" class="btn btn--accent">Pubblica Formazione</button>
      </div>

      <h3 style="margin-top:24px">Sostituzioni</h3>
      <div class="card" style="margin-bottom:14px">
        <div class="row">
          <label style="flex-basis:100px">Minuto</label><input id="sost-minuto" type="number" min="1" max="60" style="flex-grow:1;max-width:100px"/>
          <label style="flex-basis:100px">Entra</label><select id="sost-entra" style="flex-grow:1;max-width:none">
            <option value="">-- Seleziona --</option>
          </select>
          <label style="flex-basis:100px">Esce</label><select id="sost-esce" style="flex-grow:1;max-width:none">
            <option value="">-- Seleziona --</option>
          </select>
        </div>
        <div class="actions"><button id="add-sostituzione-btn" class="btn btn--admin" type="button">Aggiungi Sostituzione</button></div>
      </div>
      <div id="sostituzioni-list"></div>
    </section>

    <section id="admin-statistiche-section" style="display:none">
      <h2 id="risultato-match-title">Admin · Inserimento Risultato & Statistiche</h2>
      
      <h3 style="margin-top:14px">Risultato Partita</h3>
      <div class="row" style="margin-bottom:14px">
        <label>Gol Fatti</label><input id="risultato-fatti" type="number" min="0" style="max-width:100px"/>
        <label>Gol Subiti</label><input id="risultato-subiti" type="number" min="0" style="max-width:100px"/>
      </div>
      <label>Note Partita</label><textarea id="risultato-note" placeholder="Note sulla partita o il campo (opzionale)"></textarea>

      <h3 style="margin-top:24px">Statistiche Giocatori</h3>
      <div class="help">I giocatori in tabella sono quelli presenti in Formazione Iniziale o Sostituzioni.</div>
      <table class="table">
        <thead><tr><th>Giocatore</th><th>Voto</th><th>Goal</th><th>Note</th></tr></thead>
        <tbody id="stat-giocatori-body"></tbody>
      </table>

      <div class="actions">
        <button id="save-risultato-btn" class="btn btn--accent" type="button">Salva Risultato & Statistiche</button>
      </div>
    </section>

    <section id="admin-candidature-section" style="display:none">
      <h2>Admin · Gestione Candidature (vecchio)</h2>
      <div class="help">Questo pannello è obsoleto. Gestisci le candidature direttamente dal pannello "Gestione Calendario".</div>
    </section>

    <section id="admin-gestione-dati-section" style="display:none">
      <h2>Admin · CRUD Giocatori & Partite</h2>
      
      <h3 style="margin-top:14px">Gestione Rosa</h3>
      <table class="table">
        <thead><tr><th>#</th><th>Nome</th><th>Cognome</th><th>Ruolo</th><th>Stato</th><th>Azione</th></tr></thead>
        <tbody id="crud-giocatori-body"></tbody>
      </table>
      <div class="actions" style="margin-top:10px">
        <button id="add-giocatore-btn" class="btn btn--admin" type="button">Aggiungi Riga</button>
        <button id="save-giocatori-btn" class="btn btn--accent" type="button">Salva Giocatori</button>
      </div>

      <h3 style="margin-top:24px">Gestione Partite (Calendario)</h3>
      <table class="table">
        <thead><tr><th>Data</th><th>Orario</th><th>Avversaria</th><th>Campo</th><th>Tipo</th><th>Risultato</th><th>Azione</th></tr></thead>
        <tbody id="crud-partite-body"></tbody>
      </table>
      <div class="actions" style="margin-top:10px">
        <button id="add-partita-btn" class="btn btn--admin" type="button">Aggiungi Riga</button>
        <button id="save-partite-btn" class="btn btn--accent" type="button">Salva Partite</button>
      </div>
    </section>
    
    <section id="admin-video-section" style="display:none">
        <h2>Admin · Inserimento Video YouTube</h2>
        <label>Seleziona Partita</label>
        <select id="video-partita-select">
            <option value="">Caricamento...</option>
        </select>

        <label style="margin-top:14px">Link YouTube (URL completo)</label>
        <input id="video-link-input" type="url" placeholder="Esempio: https://www.youtube.com/watch?v=VIDEO_ID"/>

        <div class="actions">
            <button id="save-video-btn" class="btn btn--accent" type="button">Salva Link Video</button>
        </div>
        <div class="help" style="margin-top:10px">Il link deve essere un URL di YouTube valido.</div>
    </section>

    <section id="admin-utenti-section" style="display:none">
      <h2>Admin · Inserimento utenti</h2>
      <form id="create-user-form">
        <label>Nome Giocatore</label><input id="new-nome" required />
        <label>Cognome Giocatore</label><input id="new-cognome" required />
        <label>Email</label><input id="new-email" type="email" required />
        <label>Password</label><input id="new-password" type="password" required />
        <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
      </form>
      <div class="help">L’admin resta connesso durante la creazione grazie all’autenticazione secondaria.</div>
    </section>
  </main>
  
  <footer>
    &copy; ${new Date().getFullYear()} AC Tuscolano. Gestione Dati Firebase.
  </footer>
</body>
</html>
