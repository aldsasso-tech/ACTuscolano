<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Squadra e Candidature</title>
    <!-- Carica Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- *** IMPORTANTE: VERSIONE STABILE DI REACT v18 e BABEL v6 *** -->
    <!-- Questo risolve i problemi di MIME Type Mismatch della v19 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@6/babel.min.js"></script>
    
    <!-- Caricamento delle librerie Firebase come ES Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Espone le funzioni Firebase a livello globale
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            onSnapshot,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            serverTimestamp
        };

        // Inizializzazione di base
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.firebaseAuth = getAuth(window.firebaseApp);
            window.firebaseDb = getFirestore(window.firebaseApp);
        }
    </script>

    <style>
        /* Imposta il font Inter e uno sfondo leggero */
        body { font-family: 'Inter', sans-serif; background-color: #eef2f5; }
    </style>
</head>
<body>

    <!-- Contenitore principale dell'applicazione -->
    <div id="root" class="min-h-screen flex items-center justify-center p-4"></div>

    <script type="text/babel">
        // ===============================================
        // Dati Iniziali e Tipi di Ruolo
        // ===============================================

        const { useState, useCallback, useEffect } = React;

        const ruoliDisponibili = ["Attaccante", "Centrocampista", "Difensore", "Portiere", "Allenatore"];
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Componente di Messaggio (per sostituire alert/confirm)
        function MessageBox({ message, onClose }) {
            if (!message) return null;
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm text-center">
                        <p className="text-lg font-semibold text-gray-800 mb-4">{message}</p>
                        <button
                            onClick={onClose}
                            className="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors"
                        >
                            Chiudi
                        </button>
                    </div>
                </div>
            );
        }

        // ===============================================
        // Componente Principale
        // ===============================================

        function GestioneCompletaApp() {
            // Stato dei dati ora gestito da Firestore
            const [squadra, setSquadra] = useState([]);
            const [candidature, setCandidature] = useState([]);
            const [nuovoNomeCandidato, setNuovoNomeCandidato] = useState('');
            const [nuovoRuoloCandidato, setNuovoRuoloCandidato] = useState(ruoliDisponibili[0]);
            
            // Stati di Firebase
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState(null); // Usato per errori e messaggi utente

            // --- Logica di Inizializzazione e Autenticazione (Firestore) ---
            useEffect(() => {
                const initializeFirebase = async () => {
                    // Controlla se le istanze globali sono disponibili 
                    if (!window.firebaseApp || !window.firebaseAuth || !window.firebaseDb) {
                        const errorMsg = "FATAL: I servizi Firebase non sono disponibili. La configurazione iniziale √® fallita.";
                        console.error(errorMsg);
                        setMessage(errorMsg);
                        setLoading(false); // Blocca il caricamento e mostra l'errore
                        return;
                    }

                    const auth = window.firebaseAuth;
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                    try {
                        if (initialAuthToken) {
                            await auth.signInWithCustomToken(initialAuthToken);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Firebase Authentication Error:", error);
                        setMessage(`Errore di autenticazione: ${error.message}`);
                    }

                    // Listener per lo stato di autenticazione (ottiene l'ID utente)
                    const unsubscribe = window.firebase.onAuthStateChanged(auth, user => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            // Fallback ID semplice in caso di autenticazione anonima/fallita
                            setUserId('unauth-' + Math.random().toString(36).substring(2, 9)); 
                        }
                        setIsFirebaseReady(true);
                        setLoading(false); // Fine caricamento
                    });

                    return () => unsubscribe();
                };

                initializeFirebase();
            }, []); // Esegue solo al montaggio

            // --- Logica di Caricamento Dati in Real-Time (onSnapshot) ---
            useEffect(() => {
                // Avvia i listener SOLO quando Firebase √® pronto e l'ID utente √® stato stabilito
                if (!isFirebaseReady || !userId) return;

                const db = window.firebaseDb;

                // Percorsi nel database (Public Data per una lista di squadra condivisa)
                const candidaturePath = window.firebase.collection(db, `artifacts/${APP_ID}/public/data/candidature`);
                const squadraPath = window.firebase.collection(db, `artifacts/${APP_ID}/public/data/squadra`);

                // Candidature Listener
                const unsubscribeCandidature = window.firebase.onSnapshot(candidaturePath, (snapshot) => {
                    // Ordina le candidature per timestamp decrescente
                    const newCandidature = snapshot.docs.map(doc => ({
                        ...doc.data(),
                        id: doc.id
                    })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 
                    setCandidature(newCandidature);
                }, (error) => {
                    console.error("Firestore Candidature Listener Error:", error);
                    setMessage(`Errore caricamento candidature: ${error.message}`);
                });

                // Squadra Listener
                const unsubscribeSquadra = window.firebase.onSnapshot(squadraPath, (snapshot) => {
                     // Ordina la squadra per nome in ordine alfabetico
                    const newSquadra = snapshot.docs.map(doc => ({
                        ...doc.data(),
                        id: doc.id
                    })).sort((a, b) => (a.nome || '').localeCompare(b.nome || '')); 
                    setSquadra(newSquadra);
                }, (error) => {
                    console.error("Firestore Squadra Listener Error:", error);
                    setMessage(`Errore caricamento squadra: ${error.message}`);
                });

                return () => {
                    unsubscribeCandidature();
                    unsubscribeSquadra();
                };
            }, [isFirebaseReady, userId]);

            // Funzione per aggiungere un NUOVO CANDIDATO (Persistenza su Firestore)
            const addCandidatura = useCallback(async () => {
                if (nuovoNomeCandidato.trim() === '' || !isFirebaseReady) return;

                const db = window.firebaseDb;
                const candidaturePath = window.firebase.collection(db, `artifacts/${APP_ID}/public/data/candidature`);

                const newCandidato = {
                    nome: nuovoNomeCandidato.trim(),
                    ruoloDesiderato: nuovoRuoloCandidato,
                    timestamp: window.firebase.serverTimestamp(),
                };
                
                try {
                    await window.firebase.addDoc(candidaturePath, newCandidato);
                    setNuovoNomeCandidato('');
                    setNuovoRuoloCandidato(ruoliDisponibili[0]);
                    setMessage(`Candidatura di ${nuovoNomeCandidato.trim()} inviata con successo.`);
                } catch (error) {
                    console.error("Error adding candidature: ", error);
                    setMessage(`Errore nell'invio della candidatura: ${error.message}`);
                }
            }, [nuovoNomeCandidato, nuovoRuoloCandidato, isFirebaseReady]);


            // Funzione per accettare una CANDIDATURA (Aggiunge in Squadra e Rimuove da Candidature)
            const accettaCandidato = useCallback(async (candidatoId) => {
                if (!isFirebaseReady) return;
                
                const candidato = candidature.find(c => c.id === candidatoId);
                if (!candidato) return;

                const db = window.firebaseDb;
                const candidaturaDocRef = window.firebase.doc(db, `artifacts/${APP_ID}/public/data/candidature`, candidatoId);
                const squadraPath = window.firebase.collection(db, `artifacts/${APP_ID}/public/data/squadra`);
                
                try {
                    // 1. Aggiungi alla squadra (come nuovo documento)
                    const newMembro = {
                        nome: candidato.nome,
                        ruolo: candidato.ruoloDesiderato,
                        attivo: true,
                        timestamp: window.firebase.serverTimestamp(),
                    };
                    await window.firebase.addDoc(squadraPath, newMembro);

                    // 2. Rimuovi dalle candidature
                    await window.firebase.deleteDoc(candidaturaDocRef);
                    setMessage(`Candidato ${candidato.nome} accettato e aggiunto alla squadra.`);

                } catch (error) {
                    console.error("Error accepting candidate: ", error);
                    setMessage(`Errore nell'accettazione del candidato: ${error.message}`);
                }
            }, [candidature, isFirebaseReady]);


            // Funzione per rifiutare una CANDIDATURA (Rimuove da Firestore)
            const rifiutaCandidato = useCallback(async (candidatoId) => {
                if (!isFirebaseReady) return;

                const db = window.firebaseDb;
                const candidato = candidature.find(c => c.id === candidatoId);
                const candidaturaDocRef = window.firebase.doc(db, `artifacts/${APP_ID}/public/data/candidature`, candidatoId);
                
                try {
                    await window.firebase.deleteDoc(candidaturaDocRef);
                    setMessage(`Candidatura di ${candidato?.nome || 'un candidato'} rifiutata.`);
                } catch (error) {
                    console.error("Error refusing candidate: ", error);
                    setMessage(`Errore nel rifiuto della candidatura: ${error.message}`);
                }
            }, [candidature, isFirebaseReady]);

            // Funzione per attivare/disattivare un membro della SQUADRA (Aggiorna Firestore)
            const toggleAttivo = useCallback(async (membroId, currentAttivo) => {
                if (!isFirebaseReady) return;
                
                const db = window.firebaseDb;
                const membroDocRef = window.firebase.doc(db, `artifacts/${APP_ID}/public/data/squadra`, membroId);
                
                try {
                    await window.firebase.updateDoc(membroDocRef, { attivo: !currentAttivo });
                    setMessage(`Stato membro aggiornato a ${!currentAttivo ? 'Attivo' : 'Inattivo'}.`);
                } catch (error) {
                    console.error("Error toggling active status: ", error);
                    setMessage(`Errore nell'aggiornamento dello stato: ${error.message}`);
                }
            }, [isFirebaseReady]);

            // Funzione per rimuovere un membro dalla SQUADRA (Rimuove da Firestore)
            const rimuoviMembro = useCallback(async (membroId) => {
                if (!isFirebaseReady) return;

                const db = window.firebaseDb;
                const membroDocRef = window.firebase.doc(db, `artifacts/${APP_ID}/public/data/squadra`, membroId);

                try {
                    await window.firebase.deleteDoc(membroDocRef);
                    setMessage('Membro rimosso dalla squadra.');
                } catch (error) {
                    console.error("Error removing member: ", error);
                    setMessage(`Errore nella rimozione del membro: ${error.message}`);
                }
            }, [isFirebaseReady]);
            
            // Render di caricamento
            if (loading) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-eef2f5">
                        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
                        <p className="mt-4 text-indigo-600 font-semibold">Caricamento servizi e autenticazione...</p>
                        {message && (
                            <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded max-w-md text-center">
                                Errore (in attesa): {message}
                            </div>
                        )}
                    </div>
                );
            }
            
            // Render di errore CRITICO dopo il caricamento
            if (message && !loading && !isFirebaseReady) {
                 return (
                    <div className="flex items-center justify-center h-screen">
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-8 rounded-xl shadow-lg max-w-lg" role="alert">
                            <p className="font-bold text-xl mb-2">‚ö† Errore Critico di Avvio</p>
                            <p>{message}</p>
                            <p className="mt-3 text-sm text-red-600">L'app React/Firebase non √® stata in grado di inizializzarsi correttamente. Controlla la console per i dettagli.</p>
                        </div>
                    </div>
                 );
            }

            // Render dell'applicazione principale
            return (
                <div className="bg-white shadow-2xl rounded-2xl p-6 md:p-10 w-full max-w-6xl transition-all duration-300">
                    {/* Il MessageBox gestisce i messaggi di successo o gli errori di runtime */}
                    <MessageBox 
                        message={message && !message.startsWith("FATAL:") ? message : null} 
                        onClose={() => setMessage(null)} 
                    />
                    
                    <h1 className="text-4xl font-extrabold text-indigo-800 mb-2 text-center">
                        Sistema di Gestione Team
                    </h1>
                    <p className="text-sm text-center text-gray-500 mb-6">
                        ID App: <span className="font-mono text-xs bg-gray-100 p-1 rounded">{APP_ID}</span> | 
                        ID Utente: <span className="font-mono text-xs bg-gray-100 p-1 rounded">{userId || 'N/A'}</span>
                    </p>
                    
                    {/* Contenitore Flessibile per le Due Sezioni */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        {/* -------------------- SEZIONE 1: GESTIONE CANDIDATURE -------------------- */}
                        <div className="bg-yellow-50 p-6 rounded-xl shadow-lg border border-yellow-200">
                            <h2 className="text-2xl font-bold text-yellow-800 mb-4 flex items-center">
                                <span className="mr-2">üìù</span> Gestione Candidature ({candidature.length})
                            </h2>

                            {/* Form per nuova candidatura */}
                            <div className="mb-6 p-4 bg-white rounded-lg border border-yellow-100">
                                <h3 className="text-lg font-semibold text-yellow-700 mb-3">Aggiungi Candidato</h3>
                                <div className="flex flex-col sm:flex-row gap-3">
                                    <input
                                        type="text"
                                        placeholder="Nome Candidato"
                                        value={nuovoNomeCandidato}
                                        onChange={(e) => setNuovoNomeCandidato(e.target.value)}
                                        className="flex-1 p-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 transition-shadow"
                                    />
                                    <select
                                        value={nuovoRuoloCandidato}
                                        onChange={(e) => setNuovoRuoloCandidato(e.target.value)}
                                        className="p-2 border border-yellow-300 rounded-lg bg-white"
                                    >
                                        {ruoliDisponibili.map(r => (
                                            <option key={r} value={r}>{r}</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={addCandidatura}
                                        className="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors shadow-md active:shadow-sm disabled:opacity-50"
                                        disabled={!isFirebaseReady || nuovoNomeCandidato.trim() === ''}
                                    >
                                        Invia Candidatura
                                    </button>
                                </div>
                            </div>

                            {/* Lista Candidature */}
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {candidature.length === 0 ? (
                                    <p className="text-center text-gray-500 italic p-4 bg-white rounded-lg">Nessuna candidatura in attesa.</p>
                                ) : (
                                    candidature.map((candidato) => (
                                        <div
                                            key={candidato.id}
                                            className="flex items-center justify-between p-4 rounded-lg shadow-sm bg-white border border-yellow-100"
                                        >
                                            <div className="flex-1 min-w-0">
                                                <p className="font-semibold text-gray-800 truncate">{candidato.nome}</p>
                                                <p className="text-sm text-gray-500">Ruolo Desiderato: <span className="font-medium text-yellow-700">{candidato.ruoloDesiderato}</span></p>
                                            </div>
                                            <div className="flex space-x-2 ml-4">
                                                <button
                                                    onClick={() => accettaCandidato(candidato.id)}
                                                    className="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors shadow-md disabled:opacity-50"
                                                    title="Accetta e aggiungi alla Squadra"
                                                    disabled={!isFirebaseReady}
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" /></svg>
                                                </button>
                                                <button
                                                    onClick={() => rifiutaCandidato(candidato.id)}
                                                    className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors shadow-md disabled:opacity-50"
                                                    title="Rifiuta Candidatura"
                                                    disabled={!isFirebaseReady}
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd" /></svg>
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* -------------------- SEZIONE 2: SQUADRA ATTIVA -------------------- */}
                        <div className="bg-indigo-50 p-6 rounded-xl shadow-lg border border-indigo-200">
                            <h2 className="text-2xl font-bold text-indigo-800 mb-6 flex items-center">
                                <span className="mr-2">üë•</span> Squadra Attiva ({squadra.length})
                            </h2>

                            {/* Info Utente */}
                            <div className="mb-6 p-4 bg-white rounded-lg border border-indigo-100">
                                <h3 className="text-lg font-semibold text-indigo-700 mb-1">Stato del Roster</h3>
                                <p className="text-sm text-gray-500">I dati sono sincronizzati con Firestore (ID App: `{APP_ID}`).</p>
                            </div>
                            
                            {/* Lista Membri Squadra */}
                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                {squadra.length === 0 ? (
                                    <p className="text-center text-gray-500 italic p-4 bg-white rounded-lg">La squadra non ha membri attivi. Accetta una candidatura per iniziare.</p>
                                ) : (
                                    squadra.map((membro) => (
                                        <div
                                            key={membro.id}
                                            className={`flex items-center justify-between p-4 rounded-lg shadow-md transition-all duration-200 ${
                                                membro.attivo ? 'bg-green-100 border-l-4 border-green-500' : 'bg-gray-100 border-l-4 border-gray-400 opacity-80'
                                            }`}
                                        >
                                            <div className="flex-1 min-w-0">
                                                <p className={`font-semibold text-lg truncate ${membro.attivo ? 'text-green-800' : 'text-gray-600'}`}>{membro.nome}</p>
                                                <p className="text-sm text-gray-500">{membro.ruolo}</p>
                                            </div>
                                            <div className="flex space-x-3 ml-4">
                                                <span className={`px-3 py-1 text-xs font-medium rounded-full ${membro.attivo ? 'bg-green-200 text-green-800' : 'bg-gray-300 text-gray-700'}`}>
                                                    {membro.attivo ? 'Attivo' : 'Inattivo'}
                                                </span>
                                                <button
                                                    onClick={() => toggleAttivo(membro.id, membro.attivo)}
                                                    className={`text-white p-2 rounded-full text-sm shadow-md transition-colors disabled:opacity-50 ${
                                                        membro.attivo ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-indigo-500 hover:bg-indigo-600'
                                                    }`}
                                                    title={membro.attivo ? 'Disattiva' : 'Attiva'}
                                                    disabled={!isFirebaseReady}
                                                >
                                                     <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path d={membro.attivo ? "M10 12a2 2 0 100-4 2 2 0 000 4z" : "M4 6h16v12H4V6z"} clipRule="evenodd" />
                                                        <path fillRule="evenodd" d={membro.attivo ? "M.588 8.016A13.88 13.88 0 0110 5a13.88 13.88 0 019.412 3.016a1 1 0 010 1.968A13.88 13.88 0 0110 15a13.88 13.88 0 01-9.412-3.016a1 1 0 010-1.968zM10 13a3 3 0 100-6 3 3 0 000 6z" : "M10 2a8 8 0 00-8 8c0 2.27 1.574 4.195 3.738 5.093A8.001 8.001 0 0010 18c2.27 0 4.195-1.574 5.093-3.738C16.426 14.195 18 12.27 18 10a8 8 0 00-8-8zm4 10a1 1 0 11-2 0 1 1 0 012 0z"} clipRule="evenodd" />
                                                    </svg>
                                                </button>
                                                <button
                                                    onClick={() => rimuoviMembro(membro.id)}
                                                    className="text-white p-2 rounded-full text-sm bg-gray-400 hover:bg-gray-500 transition-colors shadow-md disabled:opacity-50"
                                                    title="Rimuovi Membro"
                                                    disabled={!isFirebaseReady}
                                                >
                                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clipRule="evenodd" /></svg>
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                    </div>
                    
                </div>
            );
        }

        // Montaggio dell'App
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<GestioneCompletaApp />);

    </script>
</body>
</html>

