<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <script>
    /* ===== SCHEDULAZIONE: refresh giornaliero alle 23:00 ===== */
    function msUntilNext(hour, minute = 0, second = 0) {
      const now = new Date();
      const next = new Date(now);
      next.setHours(hour, minute, second, 0);
      if (next <= now) next.setDate(next.getDate() + 1);
      return next - now;
    }
    window.scheduleDailyClassificaRefresh = () => {
      const ms = msUntilNext(23, 0, 0);
      const infoEl = document.getElementById('classifica-next-run');
      if (infoEl) {
        const when = new Date(Date.now() + ms).toLocaleString('it-IT');
        infoEl.textContent = `Prossimo aggiornamento: ${when}`;
      }
      setTimeout(async function tick() {
        if(typeof loadClassifica === 'function') await loadClassifica();
        window.scheduleDailyClassificaRefresh();
      }, ms);
    };

    /* ===== INIZIALIZZAZIONE SCHEDULAZIONE ===== */
    document.addEventListener('DOMContentLoaded', () => {
      // Viene richiamata solo la funzione di scheduling, la navigazione è gestita nel type="module"
      if (typeof window.scheduleDailyClassificaRefresh === 'function') {
        window.scheduleDailyClassificaRefresh();
      }
    });
  </script>
  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }

    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

    /* === Effetti di transizione per le sezioni visibili (.content-section) - CORRETTO === */
    .content-section {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
      display: none; /* Inizialmente nascosto */
    }
    .content-section.active {
      opacity: 1;
      pointer-events: all;
      display: block; /* Visibile quando attivo */
    }

</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null;

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section','video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section',
      'admin-statistiche-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section'
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section'];

    // NUOVO: Funzione unificata per la gestione della visibilità con effetto fade
    const showSection = (id, isAdminSection = false) => {
        const targetId = id;
        
        ALL_SECTIONS.forEach(secId => { 
            const el = byId(secId);
            if (!el) return;
            
            if (secId === targetId) {
                // Target section: needs to fade in
                el.style.display = 'block';
                el.style.opacity = '0'; // Assicura lo stato iniziale per la transizione
                el.style.pointerEvents = 'all';
                el.classList.add('active');
                
                // Forza il reflow (per CSS transition) e imposta l'opacità finale
                setTimeout(() => { el.style.opacity = '1'; }, 50); 
                
            } else {
                // Other sections: needs to fade out and hide
                if (el.classList.contains('active')) {
                    el.style.opacity = '0';
                    el.style.pointerEvents = 'none';
                    el.classList.remove('active');
                    // Attendi la fine della transizione (0.5s) prima di nascondere completamente
                    setTimeout(() => { el.style.display = 'none'; }, 500); 
                } else {
                    el.style.display = 'none'; // Assicura che sia nascosto
                }
            }
        });

        // Handle ARIA and Admin Menu state
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
        document.querySelectorAll('#admin-menu .tab').forEach(t=>{ 
            t.setAttribute('aria-current', isAdminSection ? (t.dataset.adminTarget===id ? 'page' : 'false') : 'false');
        });

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Admin specific logic (richiama funzioni di caricamento)
        if(isAdminSection){
            if(id==='admin-calendario-section'){ loadProssimeGiornate(true); }
            if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
            if(id==='admin-candidature-section'){ loadCandidature(); }
            if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
            if (id === 'admin-video-section') loadPartitePerVideoAdmin();
        }
    };
    
    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      showSection(id, false);
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin();
        showSection(id, true);
    };

    function showLogin(){ showSection('login-section'); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); // Nasconde il form di login dopo lo stato di auth
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      if(user && isAdmin) {
         // Se admin loggato, mostra la sezione predefinita admin (es. inserimento giocatori)
         if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         // Se loggout o utente normale, mostra la sezione pubblica predefinita
         window.showPublicSection('rosa-section');
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          // Ricarica la sezione pubblica dopo il logout
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded', async ()=>{
      
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) – usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Gestione del click per i pulsanti di navigazione (per eseguire showSection)
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.stopPropagation(); 
          const target = tab.getAttribute('data-target');
          const adminTarget = tab.getAttribute('data-admin-target');
          
          if (target) {
            window.showPublicSection(target);
          } else if (adminTarget) {
            window.showAdminSection(adminTarget);
          }
        });
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      window.showPublicSection('rosa-section'); // Ora usa la logica di fade corretta
      loadRosa(); 
      loadProssimeGiornate(false); 
      loadStatistiche();
      loadClassifica();
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura (dopo il cambio di sezione)
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', loadStatistiche);
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', loadClassifica);
    });
    
   /* ===== FUNZIONE: Classifica AC Tuscolano con cache Firebase (solo admin aggiorna) ===== */
    const loadClassifica = async () => {
      const classificaContent = document.getElementById('classifica-content');
      if (!classificaContent) return;

      classificaContent.innerHTML = `<div class="help">Caricamento classifica in corso...</div>`;

      try {
        const now = new Date();
        const todayKey = now.toISOString().split('T')[0];
        const snap = await get(ref(db, 'classifica_cache'));
        const cache = snap.val() || {};
        const cachedHtml = cache.html;
        const cachedDate = cache.date;

        if (cachedHtml && cachedDate === todayKey) {
          classificaContent.innerHTML = cachedHtml;
          return;
        }

        if (!isAdmin) {
          if (cachedHtml) {
            classificaContent.innerHTML = cachedHtml;
          } else {
            classificaContent.innerHTML = `<div class="help" style="color:red">La classifica non è ancora disponibile. L'amministratore provvederà all'aggiornamento.</div>`;
          }
          return;
        }

        const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
        const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
        const response = await fetch(proxy);
        const data = await response.json();

        const parser = new DOMParser();
        const doc = parser.parseFromString(data.contents, "text/html");
        const table = doc.querySelector(".table-responsive table") || doc.querySelector("table[class*='table']") || doc.querySelector("table");

        if (!table) {
          classificaContent.innerHTML = `<div class="help">Impossibile trovare la classifica sul sito remoto.</div>`;
          return;
        }

        // Estrazione e normalizzazione delle righe della tabella
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        const theadHTML = thead ? `
          <thead>
            <tr>${Array.from(thead.querySelectorAll("th")).map(th => 
              `<th style="background:#8B0000;color:#fff;padding:8px;text-align:center;border-bottom:2px solid #ccc;font-size:0.9rem">${th.innerHTML}</th>`
            ).join('')}</tr>
          </thead>
        ` : '';

        const tbodyHTML = tbody ? Array.from(tbody.querySelectorAll("tr")).map((tr, idx) => {
          const rowHTML = Array.from(tr.querySelectorAll("td")).map(td => 
            `<td style="padding:8px;text-align:center;border-bottom:1px solid #ddd;font-size:13px;word-wrap:break-word">${td.innerHTML}</td>`
          ).join('');
          const bg = idx % 2 === 1 ? ' style="background:#f8f8f8"' : '';
          return `<tr${bg}>${rowHTML}</tr>`;
        }).join('') : '';

        const normalizedHTML = `
          <div class="help">Classifica aggiornata automaticamente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
          <div style="overflow-x:auto">
            <table class="table" style="width:100%;border-collapse:collapse;table-layout:fixed;margin-top:8px">
              ${theadHTML}
              <tbody>${tbodyHTML}</tbody>
            </table>
          </div>
          <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
          <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
        `;

        classificaContent.innerHTML = normalizedHTML;
        
        // Salva cache
        await set(ref(db, 'classifica_cache'), {
          html: normalizedHTML,
          date: todayKey,
          timestamp: Date.now()
        });

      } catch (error) {
        console.error("Errore caricamento classifica:", error);
        const snapFallback = await get(ref(db, 'classifica_cache'));
        const cache = snapFallback.val();
        if (cache && cache.html) {
          classificaContent.innerHTML = cache.html;
        } else {
          classificaContent.innerHTML = `<div class="help" style="color:red">Errore nel recupero della classifica.</div>`;
        }
      }
    };



    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");

      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");

      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;

        await update(ref(db), updates);

        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */
    
    async function loadRosa(){
      const ul = byId('rosa-list'); if(!ul) return; ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
      if(!rows.length){ ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>'; return; }
      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li'); li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> • Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    async function loadProssimeGiornate(asAdmin){
        const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
        const ul = byId(listId); if(!ul) return; ul.innerHTML='';
        const snap = await get(ref(db,'calendario'));
        const val = snap.val() || {};
        let entries = Object.entries(val);
        
        // Funzione per convertire la data (gg/mm/aaaa)
        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        // Data di oggi normalizzata a mezzanotte per confronto
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        
        entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));
        
        if(!entries.length){ 
            ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>'; 
            return; 
        }

        ul.className='grid cols-3';
        
        for(const [matchId,m] of entries){
            const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
            const cand = candSnap.val() || {};
            const candCount = Object.values(cand).filter(Boolean).length;
            const isPublished = m.formazionePubblicata === true;
            
            // Nuovo controllo sulla data della partita
            const matchDate = toDate(m.data);
            // È nel passato se la data della partita è strettamente precedente a 'today' (normalizzato)
            const isPast = matchDate < today;
            
            // Generazione condizionale del pulsante di candidatura
            let candButton = '';
            if (isPast) { 
                // Partita passata: bottone disabilitato con testo aggiornato
                candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
            } else { 
                // Partita futura: bottone attivo
                candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`;
            }
            
            const li = document.createElement('li');
            li.className='card';
            li.innerHTML = `
                <div class="row" style="justify-content:space-between;align-items:flex-start">
                    <div>
                        <div style="font-weight:800;font-size:1.05rem">vs ${m.avversaria}</div>
                        <div class="player-sub">${m.data} • ${m.orario} • ${m.campo} • ${m.casa? 'Casa':'Trasferta'}</div>
                        <div class="player-sub">Candidature: <b>${candCount}</b></div>
                        <div class="player-sub">Risultato: <b>${m.risultato||'N/D'}</b></div>
                    </div>
                    <div class="row">
                        ${!asAdmin ? `
                            ${candButton}
                            ${isPublished ? `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria)}')">Vedi Formazione</button>` : ''} 
                        `:''}
                        ${asAdmin ? `
                            <button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria)}')">Formazione & Sost.</button>
                            <button class="btn btn--admin" onclick="showRisultatoForm('${matchId}','${escapeHtml(m.avversaria)}')">Risultato</button>
                        `:''}
                    </div>
                </div>`;
            ul.appendChild(li);
        }
    }

    window.candidati = async(matchId)=>{
      const user = auth.currentUser;
      if(!user){ showLogin(); alert('Per candidarti devi effettuare il login.'); return; }
      await set(ref(db,`calendario/${matchId}/candidature/${user.uid}`), true);
      alert('Disponibilità inviata.');
      loadProssimeGiornate(false);
    };

    async function loadStatistiche(){
      const rl = byId('statistiche-risultati-list'); if(rl){ rl.innerHTML=''; }
      const gl = byId('statistiche-voti-list'); if(gl){ gl.innerHTML=''; }
      
      const snapCal = await get(ref(db,'calendario'));
      const cal = snapCal.val()||{};
      const rows = Object.entries(cal);
      
      if(rl){
        if(!rows.length) rl.innerHTML = '<div class="help">Ancora nessun risultato.</div>';
        rows.forEach(([id,m])=>{
          const li = document.createElement('li'); li.className='card';
          li.innerHTML = `<div><b>${m.data}</b> • vs ${m.avversaria} — Risultato: <b>${m.risultato||'N/D'}</b></div>`;
          rl.appendChild(li);
        });
      }
      
      const snapR = await get(ref(db,'rosa'));
      const rosa = snapR.val()||{};
      const players = Object.values(rosa);
      
      if(gl){
        if(!players.length) gl.innerHTML = '<div class="help">Rosa vuota.</div>';
        players.sort((a,b)=> (b.goal||0)-(a.goal||0)).forEach(g=>{
          const li = document.createElement('li'); li.className='card';
          li.innerHTML = `<div class="row" style="justify-content:space-between"><div><b>${g.nome} ${g.cognome}</b> <span class="pill">#${g.numero}</span></div><div class="player-sub">Voto: <b>${g.voto||0}</b> • Presenze: <b>${g.presenze||0}</b> • Goal: <b>${g.goal||0}</b></div></div>`;
          gl.appendChild(li);
        });
      }
    }

    /* Posizioni modulo 3-3-1 */
    const POS_331 = { 
      'Portiere': { top:'90%', left:'50%' }, 
      'Difensore centrale': { top:'70%', left:'50%' }, 
      'Terzino sinistro': { top:'70%', left:'25%' }, 
      'Terzino destro': { top:'70%', left:'75%' }, 
      'Centrocampista centrale': { top:'45%', left:'50%' }, 
      'Centrocampista sinistro': { top:'45%', left:'25%' }, 
      'Centrocampista destro': { top:'45%', left:'75%' },
      'Attaccante': { top:'20%', left:'50%' }
    };

    /* Formazione pubblica */
    window.showFormazionePubblica = async (matchId, avversaria) => {
      document.getElementById('formazione-pubblica-title').textContent = `Formazione vs ${avversaria}`;
      const field = document.getElementById('formazione-pubblica-field');
      field.innerHTML = '';
      
      try {
        const snap = await get(ref(db, `calendario/${matchId}/formazione`));
        const formazione = snap.val() || {};
        
        // Elenco giocatori in campo
        let giocatoriInCampoHtml = '<h4>Titolari:</h4><ul class="grid cols-2">';
        let sostitutiHtml = '<h4>Sostituti e panchina:</h4><ul class="grid cols-2">';
        
        let hasTitolari = false;
        let hasSostituti = false;

        const rosaSnap = await get(ref(db, 'rosa'));
        const rosa = rosaSnap.val() || {};
        
        for (const [key, val] of Object.entries(formazione)) {
          const g = rosa[key];
          if (!g) continue;
          const posData = POS_331[val.ruolo];
          
          if (val.titolare) {
            hasTitolari = true;
            giocatoriInCampoHtml += `<li><div class="player-title">${g.nome} ${g.cognome}</div><div class="player-sub">${val.ruolo}</div></li>`;
            if (posData) {
              const marker = document.createElement('div');
              marker.className = 'marker';
              marker.style.top = posData.top;
              marker.style.left = posData.left;
              marker.textContent = `${g.cognome} (${g.numero})`;
              field.appendChild(marker);
            }
          } else {
            hasSostituti = true;
            sostitutiHtml += `<li><div class="player-title">${g.nome} ${g.cognome}</div><div class="player-sub">${val.ruolo}</div></li>`;
          }
        }
        
        giocatoriInCampoHtml += '</ul>';
        sostitutiHtml += '</ul>';

        document.getElementById('formazione-pubblica-elenco').innerHTML = 
          (hasTitolari ? giocatoriInCampoHtml : '<p>Nessun titolare inserito.</p>') +
          (hasSostituti ? sostitutiHtml : '<p>Nessun sostituto/panchina inserito.</p>');

        window.showPublicSection('formazione-pubblica-section');

      } catch(e) {
        field.innerHTML = '<div class="help" style="color:red">Errore nel caricamento della formazione.</div>';
        console.error(e);
      }
    };


    /* Funzioni Admin (Formazione, Risultati, Candidature, CRUD) */
    
    // Admin Formazione
    let currentMatchIdFormazione = null;
    window.showFormazioneForm = async (matchId, avversaria) => {
      if(!isAdmin) return alert("Solo admin.");
      currentMatchIdFormazione = matchId;
      document.getElementById('admin-formazione-title').textContent = `Formazione & Sostituzioni vs ${avversaria}`;
      const tableBody = document.getElementById('formazione-table-body');
      tableBody.innerHTML = '<tr><td colspan="5">Caricamento rosa...</td></tr>';

      try {
        const snapRosa = await get(ref(db, 'rosa'));
        const rosa = snapRosa.val() || {};
        const snapForm = await get(ref(db, `calendario/${matchId}/formazione`));
        const formazione = snapForm.val() || {};

        let html = '';
        const sortedPlayers = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
        
        sortedPlayers.forEach(([id, g]) => {
          const form = formazione[id] || {};
          const isTitolare = form.titolare === true;
          const ruolo = form.ruolo || g.ruolo;
          
          html += `
            <tr data-player-id="${id}" data-original-ruolo="${g.ruolo}">
              <td>${g.nome} ${g.cognome}</td>
              <td>#${g.numero}</td>
              <td>
                <select name="ruolo-${id}" class="formazione-ruolo" data-player-id="${id}">
                  <option value="${g.ruolo}" ${ruolo === g.ruolo ? 'selected' : ''}>${g.ruolo}</option>
                  <option value="Portiere" ${ruolo === 'Portiere' ? 'selected' : ''}>Portiere</option>
                  <option value="Difensore centrale" ${ruolo === 'Difensore centrale' ? 'selected' : ''}>Difensore centrale</option>
                  <option value="Terzino sinistro" ${ruolo === 'Terzino sinistro' ? 'selected' : ''}>Terzino sinistro</option>
                  <option value="Terzino destro" ${ruolo === 'Terzino destro' ? 'selected' : ''}>Terzino destro</option>
                  <option value="Centrocampista centrale" ${ruolo === 'Centrocampista centrale' ? 'selected' : ''}>Centrocampista centrale</option>
                  <option value="Centrocampista sinistro" ${ruolo === 'Centrocampista sinistro' ? 'selected' : ''}>Centrocampista sinistro</option>
                  <option value="Centrocampista destro" ${ruolo === 'Centrocampista destro' ? 'selected' : ''}>Centrocampista destro</option>
                  <option value="Attaccante" ${ruolo === 'Attaccante' ? 'selected' : ''}>Attaccante</option>
                </select>
              </td>
              <td style="text-align:center">
                <input type="checkbox" class="formazione-titolare" data-player-id="${id}" ${isTitolare ? 'checked' : ''}>
              </td>
              <td>
                  <input type="text" class="formazione-voto" data-player-id="${id}" placeholder="Voto" value="${form.voto || ''}" style="width:70px">
              </td>
            </tr>
          `;
        });
        
        tableBody.innerHTML = html;
        window.showAdminSection('admin-formazione-section');
        
      } catch(e) {
        tableBody.innerHTML = `<tr><td colspan="5" style="color:red">Errore caricamento: ${e.message}</td></tr>`;
      }
    };
    
    byId('save-formazione-btn')?.addEventListener('click', async () => {
      if (!isAdmin || !currentMatchIdFormazione) return alert("Errore: partita non selezionata.");
      const updates = {};
      const matchKey = currentMatchIdFormazione;
      let titolariCount = 0;
      
      const rosaSnap = await get(ref(db, 'rosa'));
      const rosa = rosaSnap.val() || {};
      
      const rows = document.querySelectorAll('#formazione-table-body tr');
      const formazioneUpdates = {};
      const votoUpdates = {};

      rows.forEach(row => {
        const playerId = row.dataset.playerId;
        const ruoloSelect = row.querySelector('.formazione-ruolo');
        const titolareCheckbox = row.querySelector('.formazione-titolare');
        const votoInput = row.querySelector('.formazione-voto');
        
        const ruolo = ruoloSelect.value;
        const titolare = titolareCheckbox.checked;
        const voto = votoInput.value.trim();

        if (titolare) {
          titolariCount++;
        }
        
        // Prepara update per formazione
        if (titolare || ruolo !== rosa[playerId]?.ruolo) { // Salva solo se titolare o ruolo modificato
           formazioneUpdates[playerId] = { ruolo, titolare };
        } else if (voto) {
          // Se non titolare ma c'è un voto, salva solo il voto
          formazioneUpdates[playerId] = { titolare: false, ruolo: rosa[playerId]?.ruolo, voto };
        } else {
          // Se il giocatore non è titolare e non ha modifiche, lo rimuovo dalla formazione
          formazioneUpdates[playerId] = null; // Uso null per eliminare la chiave
        }
        
        // Aggiorna voto nel giocatore, se presente e valido
        if(voto){
           const playerVoto = parseFloat(voto);
           if(!isNaN(playerVoto) && playerVoto >= 0){
             votoUpdates[playerId] = { voto: playerVoto };
           }
        }
      });
      
      // Controllo numero titolari
      if(titolariCount > 8){
        return alert(`Attenzione: hai selezionato ${titolariCount} titolari. Il massimo consentito è 8.`);
      }

      try {
        // Applica gli aggiornamenti alla formazione
        await set(ref(db, `calendario/${matchKey}/formazione`), formazioneUpdates);
        
        // Aggiorna i voti individuali nella rosa (per statistiche)
        for(const [playerId, data] of Object.entries(votoUpdates)){
           await update(ref(db, `rosa/${playerId}`), { voto: data.voto });
        }
        
        alert('Formazione e voti salvati con successo!');
        
      } catch(e) {
        alert('Errore salvataggio: ' + e.message);
        console.error(e);
      }
    });
    
    // Admin Risultati
    let currentMatchIdRisultato = null;
    window.showRisultatoForm = async (matchId, avversaria) => {
      if(!isAdmin) return alert("Solo admin.");
      currentMatchIdRisultato = matchId;
      document.getElementById('admin-risultato-title').textContent = `Inserisci Risultato vs ${avversaria}`;
      
      try {
        const snap = await get(ref(db, `calendario/${matchId}`));
        const partita = snap.val() || {};
        
        // Pre-popola il campo risultato
        document.getElementById('match-risultato').value = partita.risultato || '';
        document.getElementById('match-goal-fatti').value = partita.goalFatti || '';
        document.getElementById('match-goal-subiti').value = partita.goalSubiti || '';
        
        // Carica le presenze/goal per l'aggiornamento statistiche
        await loadPresenzeGoal(matchId);

        window.showAdminSection('admin-statistiche-section');

      } catch(e) {
        alert('Errore caricamento risultato: ' + e.message);
        console.error(e);
      }
    };
    
    // Funzione helper per caricare i dati dei giocatori per presenze/goal
    window.loadPresenzeGoal = async (matchId) => {
      const tableBody = byId('presenze-goal-table-body');
      tableBody.innerHTML = '<tr><td colspan="4">Caricamento presenze/goal...</td></tr>';

      try {
        const snapRosa = await get(ref(db, 'rosa'));
        const rosa = snapRosa.val() || {};
        const snapPartita = await get(ref(db, `calendario/${matchId}`));
        const partita = snapPartita.val() || {};
        const snapFormazione = await get(ref(db, `calendario/${matchId}/formazione`));
        const formazione = snapFormazione.val() || {};
        
        let html = '';
        const sortedPlayers = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
        
        sortedPlayers.forEach(([id, g]) => {
          // Controlla se il giocatore era in formazione (anche se panchinaro)
          const isInFormazione = formazione.hasOwnProperty(id); 

          if (!isInFormazione) return;
          
          // Presenze e goal salvati in `calendario/matchId/statistiche`
          const stats = partita.statistiche && partita.statistiche[id] ? partita.statistiche[id] : {};
          
          html += `
            <tr data-player-id="${id}">
              <td>${g.nome} ${g.cognome}</td>
              <td>
                <input type="number" class="stats-presenze" data-player-id="${id}" value="${stats.presenza ? 1 : 0}" min="0" max="1" style="width:50px">
              </td>
              <td>
                <input type="number" class="stats-goal" data-player-id="${id}" value="${stats.goal || 0}" min="0" style="width:70px">
              </td>
            </tr>
          `;
        });
        
        tableBody.innerHTML = html || '<tr><td colspan="4">Nessun giocatore in formazione per questa partita.</td></tr>';
        
      } catch(e) {
        tableBody.innerHTML = `<tr><td colspan="4" style="color:red">Errore caricamento: ${e.message}</td></tr>`;
      }
    };

    byId('save-risultato-btn')?.addEventListener('click', async () => {
      if (!isAdmin || !currentMatchIdRisultato) return alert("Errore: partita non selezionata.");
      
      const matchKey = currentMatchIdRisultato;
      const risultato = byId('match-risultato').value.trim();
      const goalFatti = parseInt(byId('match-goal-fatti').value, 10) || 0;
      const goalSubiti = parseInt(byId('match-goal-subiti').value, 10) || 0;
      
      if (!risultato) return alert("Inserisci il risultato della partita.");
      if (isNaN(goalFatti) || isNaN(goalSubiti)) return alert("Goal fatti/subiti devono essere numeri validi.");
      
      const updates = {};
      const statsUpdates = {}; // Aggiornamenti per /rosa
      const matchStats = {}; // Aggiornamenti per /calendario/matchId/statistiche

      try {
        // 1. Aggiorna i dati della partita
        updates[`/calendario/${matchKey}/risultato`] = risultato;
        updates[`/calendario/${matchKey}/goalFatti`] = goalFatti;
        updates[`/calendario/${matchKey}/goalSubiti`] = goalSubiti;
        
        // 2. Raccogli e prepara l'aggiornamento delle statistiche individuali
        const rosaSnap = await get(ref(db, 'rosa'));
        const rosa = rosaSnap.val() || {};
        
        // Rimuovi le vecchie statistiche della partita se esistono, per ricalcolare
        const oldSnap = await get(ref(db, `calendario/${matchKey}/statistiche`));
        const oldStats = oldSnap.val() || {};
        
        for(const [playerId, g] of Object.entries(rosa)){
          const oldPresence = oldStats[playerId]?.presenza || 0;
          const oldGoal = oldStats[playerId]?.goal || 0;
          
          // Inizializza gli aggiornamenti per la rosa con i valori correnti
          statsUpdates[playerId] = {
            presenze: g.presenze || 0,
            goal: g.goal || 0
          };
          
          // Sottrai i vecchi valori per annullare l'impatto di un salvataggio precedente
          statsUpdates[playerId].presenze -= oldPresence;
          statsUpdates[playerId].goal -= oldGoal;
        }
        
        // Leggi i nuovi valori dalla tabella
        const rows = document.querySelectorAll('#presenze-goal-table-body tr');
        rows.forEach(row => {
          const playerId = row.dataset.playerId;
          const presenzaInput = row.querySelector('.stats-presenze');
          const goalInput = row.querySelector('.stats-goal');
          
          const newPresence = parseInt(presenzaInput.value, 10) || 0;
          const newGoal = parseInt(goalInput.value, 10) || 0;
          
          // Aggiungi i nuovi valori
          if(statsUpdates[playerId]){
            statsUpdates[playerId].presenze += newPresence;
            statsUpdates[playerId].goal += newGoal;
            
            // Salva le statistiche specifiche della partita
            matchStats[playerId] = {
              presenza: newPresence,
              goal: newGoal
            };
          }
        });
        
        // 3. Esegui l'aggiornamento del calendario
        updates[`/calendario/${matchKey}/statistiche`] = matchStats;
        await update(ref(db), updates);
        
        // 4. Esegui l'aggiornamento della rosa
        for(const [playerId, data] of Object.entries(statsUpdates)){
           await update(ref(db, `rosa/${playerId}`), data);
        }

        alert('Risultato e statistiche salvati con successo!');
        
        // Ritorna al calendario admin
        window.showAdminSection('admin-calendario-section'); 
        
      } catch(e) {
        alert('Errore salvataggio risultato/statistiche: ' + e.message);
        console.error(e);
      }
    });

    // Admin Pubblica Formazione
    byId('publish-formazione-btn')?.addEventListener('click', async () => {
      if (!isAdmin || !currentMatchIdFormazione) return alert("Errore: partita non selezionata.");
      if (confirm('Sei sicuro di voler pubblicare la formazione? Gli utenti la vedranno subito.')) {
        try {
          await update(ref(db, `calendario/${currentMatchIdFormazione}`), {
            formazionePubblicata: true
          });
          alert('Formazione pubblicata con successo!');
          window.showAdminSection('admin-calendario-section');
        } catch(e) {
          alert('Errore pubblicazione: ' + e.message);
          console.error(e);
        }
      }
    });


    // Admin Candidature (loadCandidature è chiamata in showAdminSection)
    window.loadCandidature = async () => {
        const select = byId('candidature-match-select');
        select.innerHTML = '<option value="">Caricamento...</option>';
        byId('candidature-editor').style.display = 'none';

        try {
            const snapshot = await get(ref(db, 'calendario'));
            const partite = snapshot.val() || {};
            let options = '<option value="">Seleziona una prossima partita</option>';

            const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
            const today = new Date(); today.setHours(0, 0, 0, 0); 
            
            const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[a].data) - toDate(partite[b].data)); // Ordina dalla più vicina

            sortedKeys.forEach(key => {
                const p = partite[key];
                const matchDate = toDate(p.data);
                if (matchDate >= today) { // Solo partite future
                    const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
                    options += `<option value="${key}">vs ${p.avversaria} (${dataOra})</option>`;
                }
            });

            select.innerHTML = options;
            select.removeEventListener('change', loadCandidatureDettagli);
            select.addEventListener('change', loadCandidatureDettagli);
            
        } catch(e) {
            console.error(e);
            select.innerHTML = '<option value="">Errore caricamento partite</option>';
        }
    };
    
    let currentCandidatureMatchId = null;
    window.loadCandidatureDettagli = async () => {
        const matchId = byId('candidature-match-select').value;
        const tableBody = byId('crud-candidature-body');
        tableBody.innerHTML = '';
        
        if (!matchId) {
            byId('candidature-editor').style.display = 'none';
            return;
        }

        currentCandidatureMatchId = matchId;
        
        try {
            const snapRosa = await get(ref(db, 'rosa'));
            const rosa = snapRosa.val() || {};
            const snapUtenti = await get(ref(db, 'utenti'));
            const utenti = snapUtenti.val() || {};
            const snapCandidature = await get(ref(db, `calendario/${matchId}/candidature`));
            const candidature = snapCandidature.val() || {};
            
            let html = '';
            const sortedPlayers = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
            
            sortedPlayers.forEach(([playerId, g]) => {
                const fullName = `${g.nome} ${g.cognome}`;
                
                // Cerca l'UID dell'utente con lo stesso nome e cognome
                const userEntry = Object.entries(utenti).find(([uid, u]) => 
                    u.nome === g.nome && u.cognome === g.cognome
                );
                
                const userUid = userEntry ? userEntry[0] : 'N/D';
                const isCandidato = candidature.hasOwnProperty(userUid) && candidature[userUid] === true;
                
                html += `
                    <tr data-player-id="${playerId}" data-user-uid="${userUid}">
                        <td>${fullName} (#${g.numero})</td>
                        <td>${userUid}</td>
                        <td style="text-align:center">
                            <input type="checkbox" class="candidatura-checkbox" data-user-uid="${userUid}" ${isCandidato ? 'checked' : ''}>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            byId('candidature-editor').style.display = 'block';

        } catch(e) {
            console.error(e);
            tableBody.innerHTML = `<tr><td colspan="3" style="color:red">Errore caricamento dettagli candidature: ${e.message}</td></tr>`;
        }
    };
    
    byId('crud-candidature-save')?.addEventListener('click', async () => {
        if (!isAdmin || !currentCandidatureMatchId) return alert("Errore: partita non selezionata.");
        
        const matchKey = currentCandidatureMatchId;
        const updates = {};
        
        document.querySelectorAll('#crud-candidature-body tr').forEach(row => {
            const userUid = row.dataset.userUid;
            if (userUid === 'N/D') return; // Salta giocatori senza UID collegato
            
            const isCandidato = row.querySelector('.candidatura-checkbox').checked;
            
            updates[userUid] = isCandidato ? true : null; // null per eliminare la candidatura
        });
        
        try {
            // Elimina tutte le candidature esistenti per poi riscriverle in un solo set (più pulito)
            await set(ref(db, `calendario/${matchKey}/candidature`), {}); 
            
            // Applica i nuovi stati
            for(const [uid, stato] of Object.entries(updates)){
                if(stato === true){
                    await set(ref(db, `calendario/${matchKey}/candidature/${uid}`), true);
                } else {
                    // Non serve fare nulla se è null, sono state rimosse tutte sopra
                }
            }
            
            alert('Candidature salvate con successo!');
            // Ricarica per mostrare i risultati salvati
            loadCandidatureDettagli();

        } catch(e) {
            alert('Errore salvataggio candidature: ' + e.message);
            console.error(e);
        }
    });

    window.closeCandidatureEditor = () => {
        byId('candidature-editor').style.display = 'none';
        currentCandidatureMatchId = null;
        byId('candidature-match-select').value = '';
    };

    // Admin CRUD Giocatori / Partite (loadCrudGiocatori e loadCrudPartite sono chiamate in showAdminSection)

    window.loadCrudGiocatori = async () => {
        const tableBody = byId('crud-giocatori-body');
        tableBody.innerHTML = '<tr><td colspan="5">Caricamento rosa...</td></tr>';
        
        try {
            const snapRosa = await get(ref(db, 'rosa'));
            const rosa = snapRosa.val() || {};
            let html = '';
            
            const sortedPlayers = Object.entries(rosa).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));
            
            sortedPlayers.forEach(([id, g]) => {
                html += `
                    <tr data-id="${id}">
                        <td><input type="text" class="crud-nome" value="${g.nome}" placeholder="Nome"></td>
                        <td><input type="text" class="crud-cognome" value="${g.cognome}" placeholder="Cognome"></td>
                        <td><input type="number" class="crud-numero" value="${g.numero}" placeholder="Num." style="width:50px"></td>
                        <td>
                            <select class="crud-ruolo">
                                <option value="${g.ruolo}" selected>${g.ruolo}</option>
                                <option value="Portiere">Portiere</option>
                                <option value="Difensore">Difensore</option>
                                <option value="Centrocampista">Centrocampista</option>
                                <option value="Attaccante">Attaccante</option>
                                <option value="Allenatore">Allenatore</option>
                            </select>
                        </td>
                        <td>
                            <select class="crud-stato">
                                <option value="${g.stato}" selected>${g.stato}</option>
                                <option value="Disponibile">Disponibile</option>
                                <option value="Indisponibile">Indisponibile</option>
                            </select>
                        </td>
                        <td style="text-align:center">
                            <button class="btn btn--accent btn--delete-giocatore" data-id="${id}">Elimina</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        } catch(e) {
            tableBody.innerHTML = `<tr><td colspan="6" style="color:red">Errore caricamento: ${e.message}</td></tr>`;
        }
    };
    
    window.saveCrudGiocatori = async () => {
        if(!isAdmin) return alert("Solo admin.");
        const updates = {};
        let isValid = true;
        
        document.querySelectorAll('#crud-giocatori-body tr').forEach(row => {
            const id = row.dataset.id;
            const nome = row.querySelector('.crud-nome').value.trim();
            const cognome = row.querySelector('.crud-cognome').value.trim();
            const numero = parseInt(row.querySelector('.crud-numero').value, 10);
            const ruolo = row.querySelector('.crud-ruolo').value;
            const stato = row.querySelector('.crud-stato').value;
            
            if (!nome || !cognome || isNaN(numero) || !ruolo || !stato) {
                isValid = false;
                return;
            }
            
            updates[id] = { nome, cognome, numero, ruolo, stato };
        });
        
        if (!isValid) return alert("Compila tutti i campi dei giocatori correttamente.");
        
        try {
            await set(ref(db, 'rosa'), updates);
            alert('Rosa aggiornata con successo!');
            loadCrudGiocatori(); // Ricarica
            loadRosa(); // Aggiorna sezione pubblica
        } catch(e) {
            alert('Errore salvataggio: ' + e.message);
            console.error(e);
        }
    };
    
    window.deleteCrudGiocatore = async (id) => {
        if(!isAdmin) return alert("Solo admin.");
        if (!confirm('Sei sicuro di voler eliminare questo giocatore?')) return;
        
        try {
            await remove(ref(db, `rosa/${id}`));
            alert('Giocatore eliminato con successo!');
            loadCrudGiocatori(); // Ricarica
            loadRosa(); // Aggiorna sezione pubblica
        } catch(e) {
            alert('Errore eliminazione: ' + e.message);
            console.error(e);
        }
    };
    
    // Delega gli eventi di eliminazione
    document.getElementById('crud-giocatori-body')?.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn--delete-giocatore')) {
            deleteCrudGiocatore(e.target.dataset.id);
        }
    });

    window.loadCrudPartite = async () => {
        const tableBody = byId('crud-partite-body');
        tableBody.innerHTML = '<tr><td colspan="5">Caricamento calendario...</td></tr>';
        
        try {
            const snapCal = await get(ref(db, 'calendario'));
            const cal = snapCal.val() || {};
            let html = '';

            const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
            const sortedMatches = Object.entries(cal).sort((a,b)=> toDate(a[1].data) - toDate(b[1].data)); // Ordina dalla più vecchia alla più nuova
            
            sortedMatches.forEach(([id, m]) => {
                html += `
                    <tr data-id="${id}">
                        <td><input type="text" class="crud-data" value="${m.data}" placeholder="gg/mm/aaaa" style="width:90px"></td>
                        <td><input type="text" class="crud-orario" value="${m.orario}" placeholder="hh:mm" style="width:60px"></td>
                        <td><input type="text" class="crud-avversaria" value="${m.avversaria}" placeholder="Avversaria"></td>
                        <td><input type="text" class="crud-campo" value="${m.campo}" placeholder="Campo"></td>
                        <td>
                            <select class="crud-casa">
                                <option value="true" ${m.casa ? 'selected' : ''}>Casa</option>
                                <option value="false" ${!m.casa ? 'selected' : ''}>Trasferta</option>
                            </select>
                        </td>
                        <td style="text-align:center">
                            <button class="btn btn--accent btn--delete-partita" data-id="${id}">Elimina</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        } catch(e) {
            tableBody.innerHTML = `<tr><td colspan="6" style="color:red">Errore caricamento: ${e.message}</td></tr>`;
        }
    };
    
    window.saveCrudPartite = async () => {
        if(!isAdmin) return alert("Solo admin.");
        const updates = {};
        let isValid = true;
        
        document.querySelectorAll('#crud-partite-body tr').forEach(row => {
            const id = row.dataset.id;
            const data = row.querySelector('.crud-data').value.trim();
            const orario = row.querySelector('.crud-orario').value.trim();
            const avversaria = row.querySelector('.crud-avversaria').value.trim();
            const campo = row.querySelector('.crud-campo').value.trim();
            const casa = row.querySelector('.crud-casa').value === 'true';
            
            if (!data || !orario || !avversaria || !campo) {
                isValid = false;
                return;
            }
            
            updates[id] = { 
                data, orario, avversaria, campo, casa, 
                risultato: document.querySelector(`[data-id="${id}"]`).risultato || 'N/D' // Mantieni il risultato esistente
            };
        });
        
        if (!isValid) return alert("Compila tutti i campi delle partite correttamente.");
        
        try {
            await set(ref(db, 'calendario'), updates);
            alert('Calendario aggiornato con successo!');
            loadCrudPartite(); // Ricarica
            loadProssimeGiornate(false); // Aggiorna sezione pubblica
        } catch(e) {
            alert('Errore salvataggio: ' + e.message);
            console.error(e);
        }
    };
    
    window.deleteCrudPartita = async (id) => {
        if(!isAdmin) return alert("Solo admin.");
        if (!confirm('Sei sicuro di voler eliminare questa partita? (Attenzione: verranno rimosse anche formazioni, risultati e statistiche associate!)')) return;
        
        try {
            await remove(ref(db, `calendario/${id}`));
            alert('Partita eliminata con successo!');
            loadCrudPartite(); // Ricarica
            loadProssimeGiornate(false); // Aggiorna sezione pubblica
        } catch(e) {
            alert('Errore eliminazione: ' + e.message);
            console.error(e);
        }
    };
    
    // Delega gli eventi di eliminazione
    document.getElementById('crud-partite-body')?.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn--delete-partita')) {
            deleteCrudPartita(e.target.dataset.id);
        }
    });


    // Listener per i pulsanti Salva/Aggiorna nelle sezioni CRUD
    byId('crud-giocatori-save')?.addEventListener('click', window.saveCrudGiocatori);
    byId('crud-partite-save')?.addEventListener('click', window.saveCrudPartite);

    
    /* Admin Inserimento Giornate */
    byId('new-player-form')?.addEventListener('submit', async e => {
        e.preventDefault();
        if (!isAdmin) return alert("Solo admin.");

        const nome = v('new-player-nome').trim();
        const cognome = v('new-player-cognome').trim();
        const numero = parseInt(v('new-player-numero'), 10);
        const ruolo = v('new-player-ruolo');
        const stato = v('new-player-stato');

        if (!nome || !cognome || isNaN(numero) || !ruolo || !stato) {
            return alert("Compila tutti i campi.");
        }

        try {
            const newPlayerRef = push(ref(db, 'rosa'));
            await set(newPlayerRef, {
                nome, 
                cognome, 
                numero, 
                ruolo, 
                stato,
                presenze: 0,
                goal: 0,
                voto: 0
            });
            
            alert('Giocatore inserito con successo!');
            e.target.reset();
            loadRosa(); // Aggiorna la sezione pubblica

        } catch(error) {
            alert('Errore inserimento giocatore: ' + error.message);
            console.error(error);
        }
    });

    byId('new-match-form')?.addEventListener('submit', async e => {
      e.preventDefault();
      if (!isAdmin) return alert("Solo admin.");
      
      const data = v('match-data').trim();
      const orario = v('match-orario').trim();
      const avversaria = v('match-avversaria').trim();
      const campo = v('match-campo').trim();
      const casa = byId('match-casa').checked;

      if (!data || !orario || !avversaria || !campo) {
        return alert("Compila tutti i campi.");
      }

      try {
        const newMatchRef = push(ref(db, 'calendario'));
        await set(newMatchRef, {
          data, 
          orario, 
          avversaria, 
          campo, 
          casa,
          risultato: 'N/D',
          linkVideo: ''
        });
        
        alert('Partita inserita con successo!');
        e.target.reset();
        loadProssimeGiornate(false); // Aggiorna la sezione pubblica

      } catch(error) {
        alert('Errore inserimento partita: ' + error.message);
        console.error(error);
      }
    });

  </script>
</head>
<body>

  <div id="video-modal">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button">&times;</button>
      <div id="video-iframe-container">
        </div>
    </div>
  </div>


  <header>
    <div class="hero">
      <img src="https://firebasestorage.googleapis.com/v0/b/actuscolano.appspot.com/o/logo_tuscolano.png?alt=media&token=d141e6b7-850d-4076-a494-1a9829f0f9b6" alt="AC Tuscolano Logo"/>
      <div class="brand">
        <h1 class="club">AC Tuscolano</h1>
        <p class="tag">Gestione Squadra & Risultati</p>
      </div>
      <button id="auth-toggle-btn" class="btn" type="button" onclick="handleAuthToggle()">Login</button>
    </div>
  </header>

  <nav id="admin-menu" style="display:none">
    <div class="nav-wrap">
      <button class="tab btn--admin" type="button" data-admin-target="admin-inserimento-giocatori-section">Nuovo Giocatore</button>
      <button class="tab btn--admin" type="button" data-admin-target="admin-inserimento-giornate-section">Nuova Partita</button>
      <button class="tab btn--admin" type="button" data-admin-target="admin-calendario-section">Calendario Admin</button>
      <button class="tab btn--admin" type="button" data-admin-target="admin-candidature-section">Candidature</button>
      <button class="tab btn--admin" type="button" data-admin-target="admin-gestione-dati-section">CRUD Dati</button>
      <button class="tab btn--admin" type="button" data-admin-target="admin-utenti-section">Nuovo Utente</button>
      <button class="tab btn--admin" type="button" data-admin-target="admin-video-section">Gestione Video</button>
    </div>
  </nav>

  <nav>
    <div class="nav-wrap">
      <button id="rosa-tab" class="tab" type="button" data-target="rosa-section">Rosa</button>
      <button id="calendario-tab" class="tab" type="button" data-target="calendario-section">Calendario</button>
      <button id="statistiche-tab" class="tab" type="button" data-target="statistiche-section">Statistiche</button>
      <button id="video-tab" class="tab" type="button" data-target="video-section">Video Partite</button>
      <button id="classifica-tab" class="tab" type="button" data-target="classifica-section">Classifica</button>
    </div>
  </nav>

  <main>

    <section id="login-section" class="content-section">
      <h2>Accesso Utenti</h2>
      <form id="login-form">
        <label for="login-email">Email</label>
        <input id="login-email" type="email" required />
        <label for="login-password">Password</label>
        <input id="login-password" type="password" required />
        <div class="actions"><button class="btn btn--accent" type="submit">Accedi</button></div>
      </form>
      <div class="help" style="margin-top:10px">Se sei un giocatore ma non hai le credenziali, contatta l'admin.</div>
    </section>

    <section id="rosa-section" class="content-section active">
      <h2>Rosa Completa</h2>
      <ul id="rosa-list">
        </ul>
    </section>

    <section id="calendario-section" class="content-section">
      <h2>Prossime Partite & Risultati</h2>
      <ul id="calendario-list">
        </ul>
    </section>
    
    <section id="classifica-section" class="content-section">
      <h2>Classifica - Over 40 Roma Sud</h2>
      <div id="classifica-content">
        </div>
    </section>

    <section id="statistiche-section" class="content-section">
      <h2>Statistiche Squadra & Giocatori</h2>
      
      <h3>Risultati Partite</h3>
      <ul id="statistiche-risultati-list" class="grid cols-3">
        </ul>
      
      <h3 style="margin-top:20px">Prestazioni Individuali (Goal & Voto)</h3>
      <ul id="statistiche-voti-list" class="grid cols-2">
        </ul>
    </section>
    
    <section id="formazione-pubblica-section" class="content-section">
      <h2 id="formazione-pubblica-title">Formazione</h2>
      
      <div id="formazione-pubblica-elenco">
        </div>
      
      <h3>Campo (Modulo 3-3-1)</h3>
      <div id="formazione-pubblica-field" class="field">
        </div>
    </section>
    
    <section id="video-section" class="content-section">
      <h2>Video Highlights Partite</h2>
      <ul id="video-list-ul" class="grid cols-2">
        </ul>
      <div class="help" style="margin-top:10px">Clicca su 'Guarda Video' per aprire il player in modale.</div>
    </section>
    
    <section id="admin-inserimento-giocatori-section" class="content-section">
      <h2>Admin · Inserimento Giocatore</h2>
      <form id="new-player-form">
        <label>Nome</label><input id="new-player-nome" required />
        <label>Cognome</label><input id="new-player-cognome" required />
        <label>Numero Maglia</label><input id="new-player-numero" type="number" min="1" max="99" required />
        <label>Ruolo Principale</label>
        <select id="new-player-ruolo" required>
          <option value="Portiere">Portiere</option>
          <option value="Difensore">Difensore</option>
          <option value="Centrocampista">Centrocampista</option>
          <option value="Attaccante">Attaccante</option>
          <option value="Allenatore">Allenatore</option>
        </select>
        <label>Stato</label>
        <select id="new-player-stato" required>
          <option value="Disponibile">Disponibile</option>
          <option value="Indisponibile">Indisponibile</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Salva Giocatore</button></div>
      </form>
    </section>
    
    <section id="admin-inserimento-giornate-section" class="content-section">
      <h2>Admin · Inserimento Partita</h2>
      <form id="new-match-form">
        <label>Data</label><input id="match-data" required placeholder="gg/mm/aaaa" />
        <label>Orario</label><input id="match-orario" required placeholder="hh:mm" />
        <label>Avversaria</label><input id="match-avversaria" required />
        <label>Campo</label><input id="match-campo" required />
        <label style="display:flex;align-items:center;gap:10px;margin-top:10px">
          <input id="match-casa" type="checkbox" style="width:auto;max-width:none" checked /> Partita in Casa
        </label>
        <div class="actions"><button class="btn btn--admin" type="submit">Salva Partita</button></div>
      </form>
    </section>

    <section id="admin-calendario-section" class="content-section">
      <h2>Admin · Gestione Partite</h2>
      <ul id="admin-calendario-list">
        </ul>
    </section>

    <section id="admin-formazione-section" class="content-section">
      <h2 id="admin-formazione-title">Admin · Formazione & Voto</h2>
      <div class="help">Seleziona i titolari (max 8) e inserisci il voto per i giocatori che hanno giocato.</div>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead>
            <tr><th>Giocatore</th><th>#</th><th>Ruolo (Formaz.)</th><th>Titolare</th><th>Voto</th></tr>
          </thead>
          <tbody id="formazione-table-body">
            </tbody>
        </table>
      </div>
      <div class="actions">
        <button id="save-formazione-btn" class="btn btn--admin" type="button">Salva Formazione & Voti</button>
        <button id="publish-formazione-btn" class="btn btn--admin" type="button">Pubblica Formazione</button>
      </div>
    </section>

    <section id="admin-statistiche-section" class="content-section">
      <h2 id="admin-risultato-title">Admin · Inserisci Risultato & Statistiche</h2>
      
      <div class="row" style="align-items:flex-end">
        <div style="flex-grow:1;max-width:180px">
          <label>Risultato (es. 2-1)</label>
          <input id="match-risultato" type="text" placeholder="Es: 2-1" required style="max-width:180px"/>
        </div>
        <div style="flex-grow:1;max-width:140px">
          <label>Goal Fatti</label>
          <input id="match-goal-fatti" type="number" min="0" placeholder="0" style="max-width:140px"/>
        </div>
        <div style="flex-grow:1;max-width:140px">
          <label>Goal Subiti</label>
          <input id="match-goal-subiti" type="number" min="0" placeholder="0" style="max-width:140px"/>
        </div>
      </div>

      <h3 style="margin-top:20px">Presenze e Goal Individuali</h3>
      <div class="help">Inserisci 1 in Presenza se il giocatore ha giocato, e il numero di goal. Le statistiche totali verranno aggiornate.</div>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead>
            <tr><th>Giocatore</th><th>Presenza (1/0)</th><th>Goal</th></tr>
          </thead>
          <tbody id="presenze-goal-table-body">
            </tbody>
        </table>
      </div>
      <div class="actions">
        <button id="save-risultato-btn" class="btn btn--admin" type="button">Salva Risultato & Statistiche</button>
      </div>
    </section>
    
    <section id="admin-video-section" class="content-section">
      <h2>Admin · Gestione Link Video</h2>
      <label>Seleziona Partita</label>
      <select id="video-partita-select" style="max-width:460px;">
        </select>
      <label style="margin-top:14px">Link YouTube Video Highlights</label>
      <input id="video-link-input" type="url" placeholder="Incolla qui l'URL completo di YouTube" style="max-width:460px;"/>
      <div class="help">Assicurati che sia un link valido a YouTube (es. youtube.com/watch?v=...)</div>
      <div class="actions">
        <button id="save-video-btn" class="btn btn--admin" type="button" disabled>Salva Link Video</button>
      </div>
    </section>

    <section id="admin-gestione-dati-section" class="content-section">
      <h2>Admin · Modifica/Elimina Dati (CRUD)</h2>
      
      <h3 style="margin-top:0">Gestione Giocatori</h3>
      <div class="help">Modifica o elimina i giocatori esistenti. Premi "Salva" per rendere permanenti le modifiche.</div>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead>
            <tr><th>Nome</th><th>Cognome</th><th>#</th><th>Ruolo</th><th>Stato</th><th>Azione</th></tr>
          </thead>
          <tbody id="crud-giocatori-body">
            </tbody>
        </table>
      </div>
      <div class="actions">
        <button id="crud-giocatori-save" class="btn btn--admin" type="button">Salva Modifiche Giocatori</button>
      </div>
      
      <h3 style="margin-top:20px">Gestione Calendario</h3>
      <div class="help">Modifica o elimina le partite esistenti. Attenzione: eliminare una partita rimuove anche formazioni, risultati e statistiche associate.</div>
      <div style="overflow-x:auto;">
        <table class="table">
          <thead>
            <tr><th>Data</th><th>Orario</th><th>Avversaria</th><th>Campo</th><th>Casa/Trasf.</th><th>Azione</th></tr>
          </thead>
          <tbody id="crud-partite-body">
            </tbody>
        </table>
      </div>
      <div class="actions">
        <button id="crud-partite-save" class="btn btn--admin" type="button">Salva Modifiche Partite</button>
      </div>

    </section>
    
    <section id="admin-candidature-section" class="content-section">
      <h2>Admin · Gestione Candidature</h2>
      <label>Seleziona Partita</label>
      <select id="candidature-match-select" style="max-width:460px;">
        </select>
      
      <div id="candidature-editor" class="card" style="margin-top:16px; padding:18px; display:none">
          <h3>Stato Candidature</h3>
          <div class="help">Controlla e modifica lo stato di disponibilità dei giocatori per la partita selezionata (richiede che il giocatore abbia un utente collegato con lo stesso Nome e Cognome in <code>/utenti</code>).</div>
          <table class="table">
            <thead><tr><th>Giocatore</th><th>UID collegato</th><th>Disponibile</th></tr></thead>
            <tbody id="crud-candidature-body"></tbody>
          </table>
          <div class="actions" style="margin-top:10px">
            <button id="crud-candidature-save" class="btn btn--admin" type="button">Salva candidature</button>
            <button class="btn" type="button" onclick="closeCandidatureEditor()">Chiudi</button>
          </div>
        </div>
    </section>

    <section id="admin-utenti-section" class="content-section">
      <h2>Admin · Inserimento utenti</h2>
      <form id="create-user-form">
        <label>Nome Giocatore</label><input id="new-nome" required />
        <label>Cognome Giocatore</label><input id="new-cognome" required />
        <label>Email</label><input id="new-email" type="email" required />
        <label>Password</label><input id="new-password" type="password" required />
        <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
      </form>
      <div class="help">L’admin resta connesso durante la creazione grazie all’autenticazione secondaria.</div>
    </section>
  </main>
  
  <footer>
    <div style="max-width:1200px;margin:0 auto">© AC Tuscolano - Gestione Squadra</div>
  </footer>
</body>
</html>
