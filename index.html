<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);
      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UIEmoji"}
    a{color:inherit}
    /* Header */
    header{position:sticky;top:0;z-index:50;background:linear-gradient(90deg,var(--red),#ff4a3d);color:var(--white);border-bottom:6px solid var(--yellow);box-shadow:0 6px 16px rgba(218,0,0,.15)}
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}
    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}
    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:900px) {.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px) {.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field::before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:grab}
    .marker.can-be-reg{padding:8px 10px; font-size:12px; min-width: 100px;}
    /* Addestilamento per il jquery-ui draggable */
    .ui-draggable-disabled{opacity:.5}
    .deposito-editor{background:#fff}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.celld{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select{max-width:none !important;margin-top:0;padding:6px 8px;border-radius:8px;font-size:.9rem}
    .table .input--transparent{background:transparent;border:2px dashed var(--line);filter:none;font-weight:600}
    .table .input--transparent:hover{box-shadow:none}
    .table .cell_index{text-align:center}
    .table .cell_icon{text-align:center}
    .table .icon{width:16px;height:auto;vertical-align:middle}
     /* Editor Candidature */
    #crud-candidature-editor{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75;);z-index:50; display: none; align-items: center; justify-content: center;}
    #crud-candidature-content{background:var(--card);max-width:600px;margin:10vh auto;border-radius:var(--radius);padding:18px}
    #id-warning{font-size:.7rem}

    /* NUOVI STILI */
    /* Formazione Drag & Drop */
    #formazione-admin-section .grid-container {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 18px;
    }
    #formazione-admin-section .field-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    #formazione-substitutes-list {
        min-height: 120px;
        border: 2px dashed var(--line);
        border-radius: 12px;
        padding: 8px;
        margin-top: 10px;
        background: var(--bg);
    }
    #formazione-players-list {
        margin-top: 10px;
        max-height: 400px;
        overflow-y: auto;
    }
    #formazione-players-list li {
        margin-bottom: 6px;
    }
    .ui-draggable-dragging {
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .ui-droppable-hover {
        border-color: var(--red) !important;
        background: #fefefe !important;
    }
    
    /* Mobile adjustments */
    @media (max-width: 900px) {
        #formazione-admin-section .grid-container {
            grid-template-columns: 1fr;
        }
        #formazione-admin-section .field-controls {
            order: -1; /* Metti i controlli sopra il campo su mobile */
        }
        .grid.cols-3{grid-template-columns: repeat(2,minmax(0,1fr)) !important;}
    }
    @media (max-width: 640px) {
        .grid.cols-3{grid-template-columns: 1fr !important;}
    }
    
    
    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}

    /* === Effetti di transizione per le sezioni === */
    .content-section {
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
    }
    .content-section.active {
        opacity: 1;
        pointer-events: all;
    }
    /* === Stili per la Modal Video === */
    #video-modal{display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px;}
    #video-iframe-container{position: relative; width: 100%; padding-bottom: 56.25%; /* 16:9 Aspect Ratio */ height: 0; border-radius: var(--radius); overflow: hidden;}
    #video-iframe{position: absolute; top: 0; left: 0; width: 100%; height: 100%;}
    #video-modal-content{background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;}
    #close-video-modal{position:absolute; top:-10px; right:-10px; z-index:110; font-size:1.2rem; line-height:1.2;}

  </style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNu1lIA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebaseapp.com",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializza l'app
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXt pvBDfmVIrNT2QVy eBincV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    
    // Seconda app per creare utenti senza sloggare l'admin
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml = (s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#x27;'})[c]);

    /* ** ARRAY SEZIONI AGGIORNATI E COMPLETI ** */
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section','video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
        'admin-inserimento-giocatori-section',
        'admin-inserimento-giornate-section',
        'admin-calendario-section',
        'admin-formazione-section',
        'admin-statistiche-section',
        'admin-candidature-section',
        'admin-gestione-dati-section',
        'admin-utenti-section',
        'admin-video-section'
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; 
    
    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
        ALL_SECTIONS.forEach(secId => {
            const el = byId(secId);
            if (el) el.style.display = (secId === id) ? 'block' : 'none';
        });
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id?'page':'false'); });
        document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
        window.scrollTo({top: 0, behavior: 'smooth'});
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); // Protezione base
        
        ALL_SECTIONS.forEach(secId => { 
            const el = byId(secId); 
            if (el) el.style.display = (secId === id) ? 'block' : 'none';
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dal pubblico
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
             t.setAttribute('aria-current', t.dataset.adminTarget===id?'page':'false'); 
        });

        // Ricarica i dati specifici per la sezione admin
        if(id==='admin-calendario-section'){ loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); 

        window.scrollTo({top: 0, behavior: 'smooth'});
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'flex' : 'none'; 
        byId('auth-toggle-btn').textContent = isAdmin ? 'Logout Admin' : 'Accesso Admin';
        byId('auth-toggle-btn').classList.toggle('btn--admin', isAdmin);
        byId('auth-toggle-btn').classList.toggle('btn--accent', !isAdmin);

        if(isAdmin){
            // Se admin loggato, mostra la sezione admin di default
            if(byId('admin-inserimento-giocatori-section').style.display === 'none') {
               window.showAdminSection('admin-inserimento-giocatori-section');
            }
        } else {
            // Se sloggato, mostra la sezione pubblica di default
            window.showPublicSection('rosa-section');
        }
    }
    
    function setAuthButton(user){ 
        const b=byId('auth-toggle-btn'); 
        if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } 
        else { b.textContent='Accesso Admin'; b.classList.remove('btn--accent'); }
    }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
        isAdmin = !!user && (user.uid === ADMIN_UID); 
        setAuthButton(user);
        hideLogin(); 
        
        if(user && isAdmin){
            if(byId('admin-inserimento-giocatori-section').style.display === 'none'){
                window.showAdminSection('admin-inserimento-giocatori-section');
            }
        } else {
            window.showPublicSection('rosa-section');
        }
        toggleAdminUI(); 
    });
    
    window.handleAuthToggle = ()=>{
        const user = auth.currentUser;
        if(user){
            signOut(auth).then(()=>{ hideLogin(); }).catch(err=>alert("Errore logout: "+err.message));
        } else {
            showLogin();
        }
    };
    
    // Login Form Submit
    document.addEventListener('DOMContentLoaded', () => {
        byId('login-form')?.addEventListener('submit',e=>{
            e.preventDefault();
            const email = v('login-email').trim();
            const pw = v('login-password');
            signInWithEmailAndPassword(auth, email, pw)
                .then(()=>{ hideLogin(); })
                .catch(err=>alert("Errore login: "+err.message));
        });
        
        // Create User Form Submit (Admin only)
        byId('create-user-form')?.addEventListener('submit', async e=>{
            e.preventDefault();
            if (!isAdmin) return alert("Solo l'admin può creare utenze.");
            const nome = v('new-nome');
            const cognome = v('new-cognome');
            const email = v('new-email').trim();
            const pw = v('new-password');
            if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
            
            try{
                const cred = await createUserWithEmailAndPassword(adminSecondaryAuth, email, pw);
                const uid = cred.user.uid;
                await set(ref(db,'utenti/'+uid),{email,nome,cognome});
                alert('Utenza creata con successo. UID: '+uid);
                e.target.reset();
            }catch(err){ alert('Errore creazione: '+ (err.message||err)); }
        });
    });

    // Navigazione
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const target = tab.getAttribute('data-target') || tab.getAttribute('data-admin-target');
            const isPublic = PUBLIC_SECTIONS.includes(target);
            const current = document.querySelector('.content-section.active');
            const next = byId(target);
            if (!next || current === next) return;

            if (current) {
                current.classList.remove('active');
                current.style.opacity = '0';
                current.style.pointerEvents = 'none';
            }

            setTimeout(() => {
                ALL_SECTIONS.forEach(secId => {
                    const el = byId(secId);
                    if (el) el.style.display = (secId === target) ? 'block' : 'none';
                });
                
                if (next) {
                    next.style.display = 'block';
                    next.classList.add('active');
                    next.style.opacity = '1';
                    next.style.pointerEvents = 'all';
                }
                
                // Aggiornamento dinamico
                if (target === 'classifica-section') loadClassifica();
                if (target === 'rosa-section') loadRosa();
                if (target === 'calendario-section') loadProssimeGiornate(false);
                if (target === 'statistiche-section') loadStatistiche();
                if (target === 'video-section') loadVideoList();

                // Admin Sections
                if (target === 'admin-calendario-section') loadProssimeGiornate(true);
                if (target === 'admin-candidature-section') loadCandidature();
                if (target === 'admin-gestione-dati-section') { window.loadCrudGiocatori(); window.loadCrudPartite(); }
                if (target === 'admin-video-section') loadPartitePerVideoAdmin();
                if (target === 'admin-inserimento-giornate-section') { $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }

            }, 400); // Ritardo per l'effetto fade-out
            
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
    });

    // Default: Carica i dati iniziali
    document.addEventListener('DOMContentLoaded', () => {
        loadRosa(); 
        loadProssimeGiornate(false); 
        loadStatistiche();
        loadClassifica();
        window.scheduleDailyClassificaRefresh();
    });
    
    
    // ===== SCHEDULAZIONE: refresh giornaliero alle 23:00 (avvia solo se definito) ===== 
    function msUntilNext(hour, minute = 0, second = 0) {
      const now = new Date();
      const next = new Date(now);
      next.setHours(hour, minute, second, 0);
      if (next <= now) next.setDate(next.getDate() + 1);
      return next - now;
    }
    window.scheduleDailyClassificaRefresh = () => {
      const ms = msUntilNext(23, 0, 0);
      const infoEl = byId('classifica-next-run');
      if (infoEl) {
        const when = new Date(Date.now() + ms).toLocaleString('it-IT');
        infoEl.textContent = `Prossimo aggiornamento: ${when}`;
      }
      setTimeout(async function tick() {
        await loadClassifica();
        window.scheduleDailyClassificaRefresh();
      }, ms);
    };

    /* =========================================================================
     * FUNZIONI ROSA
     * ========================================================================= */
    async function loadRosa() {
        const rosaList = byId('rosa-list');
        if (!rosaList) return;
        rosaList.innerHTML = '<li>Caricamento giocatori...</li>';

        try {
            const snapshot = await get(ref(db, 'giocatori'));
            const giocatori = [];
            snapshot.forEach(childSnapshot => {
                const data = childSnapshot.val();
                if (data.status === 'attivo') {
                    giocatori.push({ ...data, id: childSnapshot.key });
                }
            });

            giocatori.sort((a, b) => {
                if (a.ruolo === 'P' && b.ruolo !== 'P') return -1;
                if (a.ruolo !== 'P' && b.ruolo === 'P') return 1;
                return a.cognome.localeCompare(b.cognome);
            });

            rosaList.innerHTML = '';
            giocatori.forEach(g => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="card">
                        <div class="row">
                            <span class="pill">${g.ruolo}</span>
                            <div>
                                <div class="player-title">${escapeHtml(g.nome)} ${escapeHtml(g.cognome)}</div>
                                <div class="player-sub">N. ${g.numero || 'N/D'}</div>
                            </div>
                        </div>
                    </div>
                `;
                rosaList.appendChild(li);
            });

        } catch (e) {
            console.error("Errore caricamento rosa:", e);
            rosaList.innerHTML = '<li>Errore nel caricamento della rosa.</li>';
        }
    }
    
    /* =========================================================================
     * FUNZIONI ROSA ADMIN: SALVATAGGIO NUOVO GIOCATORE
     * ========================================================================= */
    window.saveNewPlayer = async () => {
        if (!isAdmin) return;
        const nome = v('nome');
        const cognome = v('cognome');
        const numero = v('numero');
        const ruolo = v('ruolo');
        const status = v('status');

        if (!nome || !cognome || !ruolo || !status) return alert("Compila tutti i campi obbligatori!");

        const newPlayer = {
            nome: escapeHtml(nome),
            cognome: escapeHtml(cognome),
            numero: escapeHtml(numero),
            ruolo: escapeHtml(ruolo),
            status: escapeHtml(status),
            // Statistiche base (inizializzate a 0)
            presenze: 0, gol: 0, assist: 0
        };

        try {
            await push(ref(db, 'giocatori'), newPlayer);
            alert("Giocatore salvato con successo!");
            byId('new-player-form').reset();
            loadRosa(); // Aggiorna la rosa pubblica
        } catch (e) {
            console.error("Errore salvataggio giocatore:", e);
            alert("Errore durante il salvataggio del giocatore.");
        }
    };


    /* =========================================================================
     * FUNZIONI CALENDARIO
     * ========================================================================= */
    async function loadProssimeGiornate(isAdminView) {
        const listId = isAdminView ? 'admin-prossime-giornate-list' : 'calendario-list';
        const list = byId(listId);
        if (!list) return;
        list.innerHTML = '<li>Caricamento partite...</li>';

        try {
            const snapshot = await get(ref(db, 'partite'));
            const partite = snapshot.val() || {};
            const matchKeys = Object.keys(partite).sort();
            
            list.innerHTML = '';

            let nextMatchId = null;
            let nextMatchData = null;
            const now = Date.now();
            
            const nextMatches = [];
            
            // Trova la prossima partita non giocata
            for (const key of matchKeys) {
                const data = partite[key];
                const matchTimestamp = new Date(data.giorno + ' ' + (data.ora || '20:00')).getTime();

                if (!data.giocata || matchTimestamp > now) {
                    if (nextMatchId === null) {
                        nextMatchId = key;
                        nextMatchData = data;
                    }
                    nextMatches.push({ key, data });
                }
            }
            
            // Mostra le prossime 5 partite
            nextMatches.slice(0, 5).forEach(match => {
                const li = document.createElement('li');
                const giorno = match.data.giorno.split('-').reverse().join('/');
                const orario = match.data.ora || 'N/D';
                const giocata = match.data.giocata ? `<span class="pill" style="background:#5cb85c;color:#fff;">Giocata</span>` : '';
                const pubblicata = match.data.formazionePubblicata ? `<span class="pill" style="background:#007bff;color:#fff;">Formazione Uff.</span>` : '';
                
                let actions = '';
                if (isAdminView) {
                    actions = `
                        <button class="btn btn--admin" type="button" 
                                onclick="window.showFormazioneForm('${match.key}', ${JSON.stringify(match.data).replace(/"/g, '&quot;')})">
                            Modifica Formazione
                        </button>
                    `;
                } else if (match.data.formazionePubblicata) {
                    actions = `
                        <button class="btn btn--accent" type="button" 
                                onclick="window.showFormazionePubblica('${match.key}', ${JSON.stringify(match.data).replace(/"/g, '&quot;')})">
                            Vedi Formazione Ufficiale
                        </button>
                    `;
                }

                li.innerHTML = `
                    <div class="card">
                        <div class="row">
                            <div>
                                <div class="player-title">${escapeHtml(match.data.avversario)} (${match.data.tipoPartita})</div>
                                <div class="player-sub">${giorno} - ${orario} (${match.data.luogo})</div>
                            </div>
                            <div style="margin-left:auto; display:flex; gap: 8px;">
                                ${giocata} ${pubblicata}
                            </div>
                        </div>
                        <div class="actions">${actions}</div>
                    </div>
                `;
                list.appendChild(li);
            });
            
            if (nextMatches.length === 0) {
                list.innerHTML = '<li><div class="help">Non ci sono prossime partite in programma.</div></li>';
            }
            
        } catch (e) {
            console.error("Errore caricamento calendario:", e);
            list.innerHTML = '<li><div class="help">Errore nel caricamento del calendario.</div></li>';
        }
    }

    // Funzione per salvare una nuova giornata (Admin)
    window.saveNewMatch = async () => {
        if (!isAdmin) return;
        const avversario = v('avversario');
        const giorno = v('match-data');
        const ora = v('match-ora');
        const luogo = v('match-luogo');
        const tipoPartita = v('tipo-partita');
        
        if (!avversario || !giorno || !luogo || !tipoPartita) return alert("Compila tutti i campi!");
        
        const newMatch = {
            avversario: escapeHtml(avversario),
            giorno: escapeHtml(giorno.split('/').reverse().join('-')), // Formato YYYY-MM-DD
            ora: escapeHtml(ora),
            luogo: escapeHtml(luogo),
            tipoPartita: escapeHtml(tipoPartita),
            giocata: false,
            // ... (altri campi se necessari)
        };
        
        try {
            await push(ref(db, 'partite'), newMatch);
            alert("Giornata salvata con successo!");
            byId('new-match-form').reset();
            loadProssimeGiornate(true); // Ricarica il calendario admin
        } catch (e) {
            console.error("Errore salvataggio giornata:", e);
            alert("Errore durante il salvataggio della giornata.");
        }
    };
    
    /* =========================================================================
     * FUNZIONI FORMAZIONE ID Drag and Drop
     * ========================================================================= */

    let currentFormazione = { titolari: {}, panchina: [] };
    let allGiocatori = {};
    let currentMatchId = null;

    // --- Drag and Drop Core ---

    /** Rende i giocatori disponibili trascinabili e imposta le aree droppabili (campo e panchina) */
    function initDragAndDrop() {
        // Rimuove i drag/drop handler precedenti
        $("#formazione-players-list .player-card, #formazione-substitutes-list .player-card").draggable('destroy');
        $(".marker.can-be-reg").draggable('destroy').droppable('destroy');
        $("#formazione-field").droppable('destroy');
        $("#formazione-substitutes-list").droppable('destroy');
        
        // 1. Giocatori disponibili (Panchina + Non convocati)
        $("#formazione-players-list .player-card, #formazione-substitutes-list .player-card").draggable({
            revert: "invalid", // Torna indietro se non droppato su target valido
            helper: "clone",   // Clona l'elemento mentre lo trascini
            cursor: "grabbing",
            zIndex: 100,
            start: function(event, ui) {
                $(this).css('opacity', '0.5'); // Nasconde l'originale
            },
            stop: function(event, ui) {
                $(this).css('opacity', '1'); // Riappare l'originale (se revert: invalid)
            }
        });

        // 2. Campo (Target droppabile per i titolari)
        $("#formazione-field").droppable({
            accept: ".player-card, .marker.can-be-reg",
            drop: handleDrop
        });

        // 3. Area sostituti/disponibili (Target droppabile per tornare in panchina o lista)
        $("#formazione-substitutes-list").droppable({
            accept: ".marker.can-be-reg",
            drop: handleSubstituteDrop
        });
        
        // 4. Rende i marker sul campo trascinabili e droppabili
        $(".marker.can-be-reg").each(function() {
            makeMarkerDraggable($(this));
        });
    }

    /** Gestisce il drop di un giocatore sul campo */
    function handleDrop(event, ui) {
        const $droppable = $(this);
        const offset = $droppable.offset();
        
        // Calcola la posizione percentuale (x, y) all'interno del campo
        const x = ((ui.offset.left + (ui.helper.width() / 2) - offset.left) / $droppable.width()) * 100;
        const y = ((ui.offset.top + (ui.helper.height() / 2) - offset.top) / $droppable.height()) * 100;

        let giocatoreId;
        let $draggedElement;
        let isMarker = false;

        if (ui.helper.hasClass('player-card') || ui.draggable.hasClass('player-card')) {
            // Drop da lista Giocatori Disponibili/Panchina (il clone è l'helper, l'originale è draggable)
            $draggedElement = ui.draggable;
            giocatoreId = $draggedElement.data('giocatore-id');
            
            // Se viene da un player-card in panchina, rimuovilo dalla panchina
            if (currentFormazione.panchina.includes(giocatoreId)) {
                 currentFormazione.panchina = currentFormazione.panchina.filter(id => id !== giocatoreId);
            }
        } else if (ui.draggable.hasClass('marker')) {
            // Drag di un Marker già esistente (l'elemento trascinato è l'originale)
            giocatoreId = ui.draggable.data('giocatore-id');
            isMarker = true;
            
            // Se è un drag di marker, aggiorniamo solo la posizione finale in handleMarkerStop
            if (currentFormazione.titolari[giocatoreId]) {
                 currentFormazione.titolari[giocatoreId].x = x.toFixed(2);
                 currentFormazione.titolari[giocatoreId].y = y.toFixed(2);
            }
            renderFormazioneField(); // Ridisegna per aggiornare il marker
            return; 
        } else {
            return; 
        }
        
        // Se è un drag di player-card, e il giocatore è già titolare, non fare nulla
        if (currentFormazione.titolari[giocatoreId] && !isMarker) {
            console.warn(`Giocatore ${giocatoreId} è già in campo.`);
            return;
        }

        // Aggiunge/Aggiorna il giocatore alla formazione titolare nel modello
        currentFormazione.titolari[giocatoreId] = { x: x.toFixed(2), y: y.toFixed(2) };
        
        // Rimuove il giocatore dalla lista dei disponibili (o nasconde la card se è un drag da player-card)
        $(`#player-card-${giocatoreId}`).hide(); 

        // Rigenera la UI del campo e della panchina
        renderFormazioneField();
        renderSubstitutesList();
    }

    /** Gestisce il drop di un Marker sull'area Sostituti (per tornare in panchina) */
    function handleSubstituteDrop(event, ui) {
        const $draggedElement = ui.draggable;
        const giocatoreId = $draggedElement.data('giocatore-id');
        
        // 1. Rimuovi il giocatore dai titolari nel modello
        if (currentFormazione.titolari[giocatoreId]) {
            delete currentFormazione.titolari[giocatoreId];
        }
        
        // 2. Aggiungi il giocatore alla panchina nel modello (se non è già lì)
        if (!currentFormazione.panchina.includes(giocatoreId) && currentFormazione.panchina.length < 12) {
            currentFormazione.panchina.push(giocatoreId);
        }
        
        // 3. Aggiorna UI
        renderFormazioneField();
        renderSubstitutesList();
        renderAvailablePlayersList();
    }
    
    /** Aggiorna la posizione del marker nel modello alla fine del trascinamento sul campo */
    function handleMarkerStop(event, ui) {
        const $marker = $(this);
        const giocatoreId = $marker.data('giocatore-id');
        const $field = $("#formazione-field");
        
        const offset = $field.offset();
        // Calcola la posizione percentuale (x, y) all'interno del campo
        const x = ((ui.offset.left + ($marker.width() / 2) - offset.left) / $field.width()) * 100;
        const y = ((ui.offset.top + ($marker.height() / 2) - offset.top) / $field.height()) * 100;
        
        // Aggiorna la posizione nel modello
        if (currentFormazione.titolari[giocatoreId]) {
            currentFormazione.titolari[giocatoreId].x = x.toFixed(2);
            currentFormazione.titolari[giocatoreId].y = y.toFixed(2);
        }
        
        renderFormazioneField(); // Ridisegna per assicurare la posizione finale
    }

    /** Rende un marker sul campo trascinabile e droppabile per riposizionarlo */
    function makeMarkerDraggable($marker) {
        const $field = $("#formazione-field");
        
        $marker.draggable({
            containment: $field,
            cursor: "move",
            zIndex: 110,
            stop: handleMarkerStop,
        });

        // Rendi il marker droppabile per SWAP con un player-card
        $marker.droppable({
            accept: "#formazione-players-list .player-card, #formazione-substitutes-list .player-card",
            hoverClass: "ui-droppable-hover",
            drop: function(event, ui) {
                // Se un player-card viene droppato su un marker (SWAP)
                const oldGiocatoreId = $marker.data('giocatore-id');
                const newGiocatoreId = ui.draggable.data('giocatore-id');
                
                if(oldGiocatoreId === newGiocatoreId) return; 

                // 1. Swap nel modello (Mantieni la posizione del vecchio, ma cambia l'ID del nuovo)
                const pos = currentFormazione.titolari[oldGiocatoreId];
                delete currentFormazione.titolari[oldGiocatoreId];
                currentFormazione.titolari[newGiocatoreId] = pos;
                
                // 2. Il vecchio titolare va in panchina (se non è già in panchina e c'è spazio)
                if (!currentFormazione.panchina.includes(oldGiocatoreId) && currentFormazione.panchina.length < 12) {
                     currentFormazione.panchina.push(oldGiocatoreId);
                }
                
                // 3. Rimuovi il nuovo titolare dalla panchina (se era in panchina)
                currentFormazione.panchina = currentFormazione.panchina.filter(id => id !== newGiocatoreId);
                
                // 4. Aggiorna UI
                renderFormazioneField();
                renderSubstitutesList();
                renderAvailablePlayersList();
            }
        });
    }


    // --- Rendering ---

    /** Disegna i marker dei titolari sul campo (Admin View) */
    function renderFormazioneField() {
        const $field = $("#formazione-field");
        $field.find('.marker').remove(); // Rimuove tutti i vecchi marker

        Object.entries(currentFormazione.titolari).forEach(([giocatoreId, pos]) => {
            const giocatore = allGiocatori[giocatoreId];
            if (!giocatore) return;

            const $marker = $(`
                <div class="marker can-be-reg" id="marker-${giocatoreId}" data-giocatore-id="${giocatoreId}">
                    <div class="player-title">${giocatore.nome} ${giocatore.cognome}</div>
                </div>
            `);
            
            $marker.css({
                left: `${pos.x}%`,
                top: `${pos.y}%`,
                'z-index': 10 
            });
            
            $marker.data('giocatore-id', giocatoreId);
            $field.append($marker);
            
            makeMarkerDraggable($marker);
        });
        
        // Aggiorna il contatore dei titolari
        $("#titolari-count").text(Object.keys(currentFormazione.titolari).length);
        
        // Aggiorna la visibilità delle card disponibili/panchina
        renderAvailablePlayersList();
        renderSubstitutesList();
    }

    /** Renderizza la lista dei giocatori disponibili (non titolari, non panchina) */
    function renderAvailablePlayersList() {
        const $list = $("#formazione-players-list");
        $list.empty();
        
        Object.values(allGiocatori)
            .sort((a, b) => a.cognome.localeCompare(b.cognome))
            .forEach(giocatore => {
                const giocatoreId = giocatore.key;
                
                // Se è titolare o in panchina, non mostrarlo qui
                if (currentFormazione.titolari[giocatoreId] || currentFormazione.panchina.includes(giocatoreId)) {
                    return;
                }

                const cardHtml = `
                    <li id="player-card-${giocatoreId}">
                        <div class="card player-card" data-giocatore-id="${giocatoreId}">
                            <div class="player-title">${giocatore.nome} ${giocatore.cognome}</div>
                            <div class="player-sub">${giocatore.ruolo}</div>
                        </div>
                    </li>
                `;
                $list.append(cardHtml);
            });

        // Rende i nuovi elementi drag-and-droppabili
        initDragAndDrop(); 
    }

    /** Renderizza la lista dei giocatori in panchina (sostituti) */
    function renderSubstitutesList() {
        const $list = $("#formazione-substitutes-list ul");
        $list.empty();
        
        // Contatore panchina
        $("#substitutes-count").text(currentFormazione.panchina.length);
        
        currentFormazione.panchina.forEach(giocatoreId => {
            const giocatore = allGiocatori[giocatoreId];
            if (!giocatore) return;

            const cardHtml = `
                <li id="player-card-${giocatoreId}" style="display:inline-block; margin: 4px;">
                    <div class="card player-card" data-giocatore-id="${giocatoreId}" style="padding: 8px; font-size: 0.9em; min-width: 120px;">
                        <div class="player-title">${giocatore.nome} ${giocatore.cognome}</div>
                        <div class="player-sub">${giocatore.ruolo}</div>
                    </div>
                </li>
            `;
            $list.append(cardHtml);
        });

        // Rende i nuovi elementi drag-and-droppabili
        initDragAndDrop(); 
    }


    // --- Admin Logic ---

    /** Carica i giocatori e la formazione esistente per una partita */
    window.showFormazioneForm = async (matchId, matchData) => {
        if (!isAdmin) return;
        
        currentMatchId = matchId;
        window.showAdminSection('admin-formazione-section');
        
        // 1. Carica tutti i giocatori
        await loadGiocatoriForFormazione(); 
        
        // 2. Carica la formazione esistente
        const snap = await get(ref(db, `partite/${matchId}/formazione`));
        const dbFormazione = snap.val() || { titolari: {}, panchina: [] };
        
        // Inizializza il modello con i dati del DB, assicurandosi che panchina sia un array
        currentFormazione = {
            titolari: dbFormazione.titolari || {},
            // Assicurati che panchina sia un array, altrimenti crea un array di chiavi
            panchina: Array.isArray(dbFormazione.panchina) ? dbFormazione.panchina : (dbFormazione.panchina ? Object.keys(dbFormazione.panchina) : [])
        };
        
        // 3. Popola l'intestazione
        $("#formazione-match-title").text(`Formazione per ${matchData.avversario} (${matchData.giorno.split('-').reverse().join('/')})`);
        
        // 4. Imposta lo stato di pubblicazione
        const isPubblicata = matchData.formazionePubblicata || false;
        $("#toggle-publish-formazione").text(isPubblicata ? "Ritira Pubblicazione" : "Pubblica Formazione");
        $("#toggle-publish-formazione").data('published', isPubblicata);

        // 5. Renderizza la UI
        renderFormazioneField();
        renderSubstitutesList();
        renderAvailablePlayersList(); 
        
        // 6. Inizializza il drag and drop
        initDragAndDrop();
    }

    /** Carica tutti i giocatori attivi da /giocatori/ per popolare la lista */
    async function loadGiocatoriForFormazione() {
        allGiocatori = {};
        const giocatoriSnap = await get(ref(db, 'giocatori/'));
        giocatoriSnap.forEach(snap => {
            const data = snap.val();
            // Includi tutti, non solo gli attivi, per la formazione
            // if (data.status !== 'attivo') return; 
            allGiocatori[snap.key] = { ...data, key: snap.key };
        });
    }

    /** Salva la formazione attuale nel database */
    async function saveFormazione() {
        if (!isAdmin || !currentMatchId) {
            alert("Errore: ID Partita mancante o non Admin.");
            return;
        }
        
        // Controllo basico: 11 titolari
        const numTitolari = Object.keys(currentFormazione.titolari).length;
        if (numTitolari > 0 && numTitolari !== 11) {
            if (!confirm(`Attenzione: hai selezionato ${numTitolari} titolari. La formazione standard ne richiede 11. Vuoi comunque salvare?`)) {
                return;
            }
        }

        try {
            await set(ref(db, `partite/${currentMatchId}/formazione`), {
                titolari: currentFormazione.titolari,
                panchina: currentFormazione.panchina 
            });
            alert("Formazione salvata con successo!");
        } catch (e) {
            console.error("Errore salvataggio formazione:", e);
            alert("Errore durante il salvataggio della formazione.");
        }
    }

    /** Pubblica o ritira la formazione */
    async function toggleFormazionePublish() {
        if (!isAdmin || !currentMatchId) return;
        
        const $btn = $("#toggle-publish-formazione");
        const isCurrentlyPublished = $btn.data('published');
        const newState = !isCurrentlyPublished;
        
        if (newState) {
            // Prima di pubblicare, verifica che ci siano esattamente 11 titolari
            if (Object.keys(currentFormazione.titolari).length !== 11) {
                alert("Impossibile pubblicare: Devono esserci esattamente 11 titolari.");
                return;
            }
        }

        const confirmMsg = newState 
            ? "Sei sicuro di voler PUBBLICARE la formazione? Sarà visibile a tutti."
            : "Sei sicuro di voler RITIRARE la pubblicazione della formazione? Non sarà più visibile.";

        if (!confirm(confirmMsg)) {
            return;
        }

        try {
            await update(ref(db, `partite/${currentMatchId}`), {
                formazionePubblicata: newState
            });
            
            $btn.data('published', newState);
            $btn.text(newState ? "Ritira Pubblicazione" : "Pubblica Formazione");
            alert(newState ? "Formazione pubblicata!" : "Pubblicazione ritirata.");
        } catch (e) {
            console.error("Errore pubblicazione formazione:", e);
            alert("Errore durante la modifica dello stato di pubblicazione.");
        }
    }

    // Associa il listener ai bottoni di Admin Formazione
    $(document).ready(() => {
        $("#save-formazione-btn").on('click', saveFormazione);
        $("#toggle-publish-formazione").on('click', toggleFormazionePublish);
    });


    // --- Public Logic ---

    /** Carica e mostra la formazione pubblicata */
    window.showFormazionePubblica = async (matchId, matchData) => {
        // 1. Carica tutti i giocatori (necessari per i nomi)
        await loadGiocatoriForFormazione(); 
        
        // 2. Carica la formazione
        const snap = await get(ref(db, `partite/${matchId}/formazione`));
        const dbFormazione = snap.val() || { titolari: {}, panchina: [] };

        // 3. Popola l'intestazione
        $("#formazione-pubblica-match-title").text(`Formazione Ufficiale per ${matchData.avversario} (${matchData.giorno.split('-').reverse().join('/')})`);
        
        // 4. Aggiorna il modello per il rendering
        currentFormazione = {
            titolari: dbFormazione.titolari || {},
            panchina: Array.isArray(dbFormazione.panchina) ? dbFormazione.panchina : (dbFormazione.panchina ? Object.keys(dbFormazione.panchina) : [])
        };

        // 5. Renderizza il campo e la panchina
        renderFormazionePubblicaField();
        renderFormazionePubblicaPanchina();

        // 6. Mostra la sezione
        window.showPublicSection('formazione-pubblica-section');
    }

    /** Disegna i marker dei titolari sul campo per la vista pubblica (solo visualizzazione) */
    function renderFormazionePubblicaField() {
        const $field = $("#formazione-pubblica-field");
        $field.empty(); // Rimuove tutti i vecchi marker

        Object.entries(currentFormazione.titolari).forEach(([giocatoreId, pos]) => {
            const giocatore = allGiocatori[giocatoreId];
            if (!giocatore) return;

            const $marker = $(`
                <div class="marker">
                    <div class="player-title">${giocatore.nome} ${giocatore.cognome}</div>
                </div>
            `);
            
            $marker.css({
                left: `${pos.x}%`,
                top: `${pos.y}%`,
                'z-index': 10 
            });
            
            $field.append($marker);
        });
    }

    /** Renderizza la lista dei giocatori in panchina per la vista pubblica */
    function renderFormazionePubblicaPanchina() {
        const $list = $("#formazione-pubblica-panchina-list");
        $list.empty();
        
        if (currentFormazione.panchina.length === 0) {
            $list.html("<li><div class='help'>Nessun sostituto in panchina.</div></li>");
            return;
        }
        
        currentFormazione.panchina.forEach(giocatoreId => {
            const giocatore = allGiocatori[giocatoreId];
            if (!giocatore) return;

            const listItem = `
                <li style="display:inline-block; margin: 4px;">
                    <div class="card" style="padding: 8px; font-size: 0.9em; min-width: 120px;">
                        <div class="player-title">${giocatore.nome} ${giocatore.cognome}</div>
                        <div class="player-sub">${giocatore.ruolo}</div>
                    </div>
                </li>
            `;
            $list.append(listItem);
        });
    }

    /* =========================================================================
     * FUNZIONI STATISTICHE
     * ========================================================================= */
    async function loadStatistiche() {
        const section = byId('statistiche-section');
        section.innerHTML = '<h2>Statistiche Squadra</h2><p>Caricamento statistiche...</p>';

        try {
            const snapshot = await get(ref(db, 'giocatori'));
            let stats = [];
            snapshot.forEach(child => {
                const data = child.val();
                if (data.status === 'attivo') {
                    stats.push({
                        nome: data.nome,
                        cognome: data.cognome,
                        presenze: data.presenze || 0,
                        gol: data.gol || 0,
                        assist: data.assist || 0,
                    });
                }
            });

            if (stats.length === 0) {
                section.innerHTML = '<h2>Statistiche Squadra</h2><p>Nessun dato statistico disponibile.</p>';
                return;
            }

            const renderTable = (data, title, sortKey) => {
                data.sort((a, b) => b[sortKey] - a[sortKey]);
                let table = `<h3>${title}</h3>`;
                table += `<table class="table">
                    <thead><tr><th>Nome</th><th>${sortKey.charAt(0).toUpperCase() + sortKey.slice(1)}</th></tr></thead>
                    <tbody>`;
                data.slice(0, 10).forEach(g => {
                    if (g[sortKey] > 0) {
                        table += `<tr><td>${escapeHtml(g.nome)} ${escapeHtml(g.cognome)}</td><td>${g[sortKey]}</td></tr>`;
                    }
                });
                table += `</tbody></table>`;
                return table;
            };

            let html = '<h2>Statistiche Squadra</h2>';
            html += renderTable(stats, 'Classifica Marcatori', 'gol');
            html += renderTable(stats, 'Classifica Assist-man', 'assist');
            html += renderTable(stats, 'Classifica Presenze', 'presenze');

            section.innerHTML = html;
            
            // Admin View (placeholder)
            if (isAdmin) {
                 byId('admin-statistiche-section').innerHTML = '<h2>Admin · Modifica Statistiche</h2><p>Questa sezione richiede un\'interfaccia complessa per l\'editing delle statistiche per partita. Si consiglia di utilizzare la sezione CRUD Dati per l\'aggiornamento rapido.</p>';
            }

        } catch (e) {
            console.error("Errore caricamento statistiche:", e);
            section.innerHTML = '<h2>Statistiche Squadra</h2><p>Errore nel caricamento dei dati statistici.</p>';
        }
    }

    /* =========================================================================
     * FUNZIONI CLASSIFICA (Scraping/Cache)
     * ========================================================================= */
    async function loadClassifica() {
        const classificaContent = byId('classifica-content');
        if (!classificaContent) return;
        classificaContent.innerHTML = '<div class="help">Caricamento classifica...</div>';

        const todayKey = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        const url = 'https://www.romatornei.it/classifiche/716'; // Esempio: URL fittizio della classifica

        try {
            // 1. Controlla la cache
            const snap = await get(ref(db, 'classifica_cache'));
            const cache = snap.val();
            if (cache && cache.date === todayKey) {
                classificaContent.innerHTML = cache.html;
                window.scheduleDailyClassificaRefresh();
                return;
            }

            // 2. Richiesta di scraping (Simulazione - VAI AGGIUNGI IL TUO ENDPOINT SERVER-SIDE!)
            // Questa chiamata API è un placeholder fittizio: dovresti implementare un endpoint
            // server-side (es. Cloud Function) per effettuare il fetch e lo scraping.
            
            const response = await fetch('https://jsonplaceholder.typicode.com/posts/1'); // Endpoint fittizio
            const data = await response.json(); // Consuma la risposta fittizia
            
            // Simulo l'HTML scraping
            const simulatedTableHTML = `
                <table>
                    <thead>
                        <tr><th>Pos</th><th>Squadra</th><th>Pt</th><th>G</th><th>V</th><th>N</th><th>P</th><th>GF</th><th>GS</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>1</td><td>AC Tuscolano</td><td>40</td><td>15</td><td>13</td><td>1</td><td>1</td><td>60</td><td>10</td></tr>
                        <tr><td>2</td><td>AS Fittizia</td><td>35</td><td>15</td><td>11</td><td>2</td><td>2</td><td>55</td><td>15</td></tr>
                        <tr><td>3</td><td>FC Esempio</td><td>30</td><td>15</td><td>10</td><td>0</td><td>5</td><td>40</td><td>20</td></tr>
                        <tr><td>4</td><td>Real Madrid B</td><td>25</td><td>15</td><td>8</td><td>1</td><td>6</td><td>30</td><td>25</td></tr>
                        <tr><td>5</td><td>Lazio Amatori</td><td>20</td><td>15</td><td>6</td><td>2</td><td>7</td><td>20</td><td>30</td></tr>
                    </tbody>
                </table>
            `;
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(simulatedTableHTML, 'text/html');
            const table = doc.querySelector('table');

            const theadHTML = table.querySelector('thead').outerHTML;
            const tbodyRows = Array.from(table.querySelectorAll('tbody tr'));
            
            const tbodyHTML = tbodyRows.map((tr, idx) => {
                const rowHTML = Array.from(tr.querySelectorAll('td')).map(td =>
                    `<td class="celld" style="text-align:center;border-bottom:1px solid #ddd;font-size:13px;word-wrap:break-word">${td.innerHTML}</td>`
                ).join('');
                const bg = idx % 2 === 1 ? ' style="background:#f8f8f8"' : '';
                return `<tr${bg}>${rowHTML}</tr>`;
            }).join('');

            const normalizedHTML = `
                <div class="help">Classifica aggiornata automaticamente (Simulato scraping da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a>)</div>
                <div style="overflow-x:auto">
                    <table class="table" style="width:100%;border-collapse:collapse;table-layout:fixed;margin-top:8px">
                        ${theadHTML}
                        <tbody>${tbodyHTML}</tbody>
                    </table>
                </div>
                <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
                <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
            `;

            classificaContent.innerHTML = normalizedHTML;

            // Salva cache
            await set(ref(db, 'classifica_cache'), {
                html: normalizedHTML,
                date: todayKey,
                timestamp: Date.now()
            });
        } catch (e) {
            console.error("Errore scraping/caricamento classifica:", e);
            try {
                // Se fallisce, prova a caricare dalla cache anche se datata
                const snap2 = await get(ref(db, 'classifica_cache'));
                const cache2 = snap2.val();
                if (cache2) {
                    classificaContent.innerHTML = cache2.html;
                    classificaContent.innerHTML += `<div class="help" style="color:var(--red);">⚠️ Errore aggiornamento. Visualizzazione dati di cache del ${new Date(cache2.timestamp).toLocaleString("it-IT")}.</div>`;
                } else {
                     classificaContent.innerHTML = '<div class="help">Impossibile caricare la classifica. Riprova più tardi.</div>';
                }
            } catch(e2) {
                 classificaContent.innerHTML = '<div class="help">Impossibile caricare la classifica. Riprova più tardi.</div>';
            }
        }
        window.scheduleDailyClassificaRefresh();
    }
    
    /* =========================================================================
     * FUNZIONI CRUD DATI (GIOCATORI E PARTITE)
     * ========================================================================= */

    // --- Giocatori ---
    window.loadCrudGiocatori = async () => {
        if (!isAdmin) return;
        byId('crud-partite-editor').style.display = 'none';
        byId('crud-giocatori-editor').style.display = 'block';

        const tbody = byId('crud-giocatori-body');
        tbody.innerHTML = '<tr><td colspan="6">Caricamento giocatori...</td></tr>';

        try {
            const snapshot = await get(ref(db, 'giocatori'));
            let giocatori = [];
            snapshot.forEach(child => giocatori.push({ id: child.key, ...child.val() }));

            giocatori.sort((a, b) => a.cognome.localeCompare(b.cognome));
            
            const ruoli = ['P', 'D', 'C', 'A'];
            const statusList = ['attivo', 'inattivo', 'ceduto'];

            tbody.innerHTML = giocatori.map(g => `
                <tr data-id="${g.id}">
                    <td><input type="text" class="input--transparent" data-field="nome" value="${escapeHtml(g.nome)}" /></td>
                    <td><input type="text" class="input--transparent" data-field="cognome" value="${escapeHtml(g.cognome)}" /></td>
                    <td><input type="number" class="input--transparent" data-field="numero" value="${g.numero || ''}" style="max-width: 50px;" /></td>
                    <td>
                        <select data-field="ruolo">
                            ${ruoli.map(r => `<option value="${r}" ${g.ruolo === r ? 'selected' : ''}>${r}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select data-field="status">
                            ${statusList.map(s => `<option value="${s}" ${g.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                    <td class="cell_icon">
                        <button class="btn btn--accent" type="button" onclick="window.updateGiocatore('${g.id}')">💾</button>
                        <button class="btn btn--admin" type="button" onclick="window.deleteGiocatore('${g.id}')">🗑️</button>
                    </td>
                </tr>
            `).join('');

        } catch (e) {
            console.error("Errore caricamento CRUD Giocatori:", e);
            tbody.innerHTML = '<tr><td colspan="6">Errore nel caricamento dei dati.</td></tr>';
        }
    }

    window.updateGiocatore = async (id) => {
        if (!isAdmin) return;
        const row = document.querySelector(`#crud-giocatori-body tr[data-id="${id}"]`);
        if (!row) return;

        const updatedData = {};
        Array.from(row.querySelectorAll('[data-field]')).forEach(el => {
            updatedData[el.dataset.field] = escapeHtml(el.value);
        });
        
        // Converti numero maglia in numero
        updatedData.numero = parseInt(updatedData.numero) || null;

        try {
            await update(ref(db, `giocatori/${id}`), updatedData);
            alert("Giocatore aggiornato con successo!");
            loadRosa(); // Aggiorna le viste pubbliche
            window.loadCrudGiocatori(); // Ricarica la tabella
        } catch (e) {
            console.error("Errore aggiornamento giocatore:", e);
            alert("Errore nell'aggiornamento del giocatore.");
        }
    }

    window.deleteGiocatore = async (id) => {
        if (!isAdmin || !confirm("Sei sicuro di voler eliminare questo giocatore?")) return;
        try {
            await remove(ref(db, `giocatori/${id}`));
            alert("Giocatore eliminato con successo!");
            loadRosa();
            window.loadCrudGiocatori();
        } catch (e) {
            console.error("Errore eliminazione giocatore:", e);
            alert("Errore nell'eliminazione del giocatore.");
        }
    }


    // --- Partite ---
    window.loadCrudPartite = async () => {
        if (!isAdmin) return;
        byId('crud-giocatori-editor').style.display = 'none';
        byId('crud-partite-editor').style.display = 'block';

        const tbody = byId('crud-partite-body');
        tbody.innerHTML = '<tr><td colspan="7">Caricamento partite...</td></tr>';

        try {
            const snapshot = await get(ref(db, 'partite'));
            let partite = [];
            snapshot.forEach(child => partite.push({ id: child.key, ...child.val() }));

            partite.sort((a, b) => new Date(b.giorno) - new Date(a.giorno)); // Ordina per data decrescente
            
            const tipi = ['Campionato', 'Amichevole', 'Coppa'];

            tbody.innerHTML = partite.map(p => {
                const giornoDisp = p.giorno ? p.giorno.split('-').reverse().join('/') : '';
                return `
                    <tr data-id="${p.id}">
                        <td><input type="text" class="input--transparent" data-field="avversario" value="${escapeHtml(p.avversario)}" /></td>
                        <td><input type="text" class="input--transparent" data-field="giorno" value="${giornoDisp}" style="max-width: 90px;" /></td>
                        <td><input type="text" class="input--transparent" data-field="ora" value="${escapeHtml(p.ora || '')}" style="max-width: 60px;" /></td>
                        <td><input type="text" class="input--transparent" data-field="luogo" value="${escapeHtml(p.luogo)}" /></td>
                        <td>
                            <select data-field="tipoPartita" style="max-width: 110px;">
                                ${tipi.map(t => `<option value="${t}" ${p.tipoPartita === t ? 'selected' : ''}>${t}</option>`).join('')}
                            </select>
                        </td>
                        <td class="cell_icon">
                            <input type="checkbox" data-field="giocata" ${p.giocata ? 'checked' : ''} style="width: auto; max-width: none;" />
                        </td>
                        <td class="cell_icon">
                            <button class="btn btn--accent" type="button" onclick="window.updatePartita('${p.id}')">💾</button>
                            <button class="btn btn--admin" type="button" onclick="window.deletePartita('${p.id}')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (e) {
            console.error("Errore caricamento CRUD Partite:", e);
            tbody.innerHTML = '<tr><td colspan="7">Errore nel caricamento dei dati.</td></tr>';
        }
    }

    window.updatePartita = async (id) => {
        if (!isAdmin) return;
        const row = document.querySelector(`#crud-partite-body tr[data-id="${id}"]`);
        if (!row) return;

        const updatedData = {};
        Array.from(row.querySelectorAll('[data-field]')).forEach(el => {
            if (el.type === 'checkbox') {
                updatedData[el.dataset.field] = el.checked;
            } else {
                updatedData[el.dataset.field] = escapeHtml(el.value);
            }
        });

        // Conversione data da GG/MM/AAAA a YYYY-MM-DD
        const giornoRaw = updatedData.giorno;
        if (giornoRaw.includes('/')) {
            updatedData.giorno = giornoRaw.split('/').reverse().join('-');
        }

        try {
            await update(ref(db, `partite/${id}`), updatedData);
            alert("Partita aggiornata con successo!");
            loadProssimeGiornate(true); // Aggiorna calendario admin
            window.loadCrudPartite(); // Ricarica la tabella
        } catch (e) {
            console.error("Errore aggiornamento partita:", e);
            alert("Errore nell'aggiornamento della partita.");
        }
    }

    window.deletePartita = async (id) => {
        if (!isAdmin || !confirm("Sei sicuro di voler eliminare questa partita?")) return;
        try {
            await remove(ref(db, `partite/${id}`));
            alert("Partita eliminata con successo!");
            loadProssimeGiornate(true);
            window.loadCrudPartite();
        } catch (e) {
            console.error("Errore eliminazione partita:", e);
            alert("Errore nell'eliminazione della partita.");
        }
    }


    /* =========================================================================
     * FUNZIONI CANDIDATURE
     * ========================================================================= */

    let allUsers = {};
    let allGiocatoriCandidature = {};

    async function loadCandidature() {
        if (!isAdmin) return;

        const list = byId('candidature-list');
        list.innerHTML = '<li>Caricamento dati...</li>';

        try {
            // 1. Carica tutti i giocatori
            const giocatoriSnap = await get(ref(db, 'giocatori'));
            allGiocatoriCandidature = {};
            giocatoriSnap.forEach(snap => {
                const g = snap.val();
                allGiocatoriCandidature[snap.key] = { id: snap.key, ...g, isDisponibile: g.isDisponibile || false };
            });

            // 2. Carica tutti gli utenti (per il match automatico)
            const usersSnap = await get(ref(db, 'utenti'));
            allUsers = {};
            usersSnap.forEach(snap => {
                allUsers[snap.key] = snap.val();
            });

            // 3. Esegui il match e prepara l'output
            const giocatoriArray = Object.values(allGiocatoriCandidature).sort((a, b) => a.cognome.localeCompare(b.cognome));

            list.innerHTML = giocatoriArray.map(g => {
                const userMatch = Object.entries(allUsers).find(([uid, u]) => 
                    u.nome.toLowerCase() === g.nome.toLowerCase() && u.cognome.toLowerCase() === g.cognome.toLowerCase()
                );
                const isAutoAvailable = !!userMatch && g.status === 'attivo'; // Condizione per auto-disponibilità

                let statoBadge = `<span class="pill" style="background:#ccc; color:#444;">N/D</span>`;
                if (isAutoAvailable) {
                    statoBadge = `<span class="pill" style="background:#5cb85c; color:#fff;">Auto Disponibile</span>`;
                } else if (g.isDisponibile) {
                     statoBadge = `<span class="pill" style="background:#007bff; color:#fff;">Manuale Disponibile</span>`;
                } else if (g.status !== 'attivo') {
                     statoBadge = `<span class="pill" style="background:var(--red); color:#fff;">${g.status.toUpperCase()}</span>`;
                }

                return `
                    <li>
                        <div class="card">
                            <div class="row" style="align-items:flex-start">
                                <div>
                                    <div class="player-title">${escapeHtml(g.nome)} ${escapeHtml(g.cognome)}</div>
                                    <div class="player-sub">${g.ruolo} - N. ${g.numero || 'N/D'}</div>
                                </div>
                                <div style="margin-left: auto;">${statoBadge}</div>
                            </div>
                        </div>
                    </li>
                `;
            }).join('');
            
            // Aggiungi il bottone per l'editor manuale
            list.insertAdjacentHTML('afterend', `
                <div class="actions" style="margin-top: 15px;">
                    <button class="btn btn--admin" type="button" onclick="window.openCandidatureEditor()">Modifica Candidature Manuali</button>
                </div>
            `);

        } catch (e) {
            console.error("Errore caricamento candidature:", e);
            list.innerHTML = '<li>Errore nel caricamento delle candidature.</li>';
        }
    }

    window.openCandidatureEditor = () => {
        if (!isAdmin) return;
        const body = byId('crud-candidature-body');
        body.innerHTML = '';
        byId('crud-candidature-editor').style.display = 'flex';

        const giocatoriArray = Object.values(allGiocatoriCandidature).sort((a, b) => a.cognome.localeCompare(b.cognome));

        giocatoriArray.forEach(g => {
            const userMatch = Object.entries(allUsers).find(([uid, u]) => 
                u.nome.toLowerCase() === g.nome.toLowerCase() && u.cognome.toLowerCase() === g.cognome.toLowerCase()
            );
            const hasUid = !!userMatch;
            const uidText = hasUid ? `UID: ${userMatch[0].substring(0, 8)}...` : 'Nessun UID';

            // Solo i giocatori non auto-disponibili possono essere gestiti manualmente
            const isAutoAvailable = hasUid && g.status === 'attivo';
            const checkboxDisabled = isAutoAvailable ? 'disabled' : '';
            const checkboxChecked = g.isDisponibile ? 'checked' : '';
            const rowClass = isAutoAvailable ? ' style="opacity: 0.5;" title="Auto-disponibile, non modificabile manualmente"' : '';

            const row = document.createElement('tr');
            row.setAttribute('data-id', g.id);
            row.innerHTML = `
                <td style="font-weight:700;">${escapeHtml(g.nome)} ${escapeHtml(g.cognome)}</td>
                <td class="player-sub">${uidText}</td>
                <td class="cell_icon">
                    <input type="checkbox" id="candidatura-${g.id}" ${checkboxChecked} ${checkboxDisabled} style="width: auto; max-width: none;" />
                </td>
            `;
            body.appendChild(row);
        });
        
        byId('id-warning').innerHTML = `⚠️ Solo i giocatori non **Attivi** o **senza UID** possono essere gestiti manualmente. I giocatori **Attivi con UID** sono considerati **Auto Disponibili**.`;
    }

    window.saveCandidature = async () => {
        if (!isAdmin) return;
        try {
            const updatePromises = [];
            const rows = byId('crud-candidature-body').querySelectorAll('tr');

            rows.forEach(row => {
                const id = row.getAttribute('data-id');
                const checkbox = row.querySelector('input[type="checkbox"]');
                
                // Ignora se disabilitato (auto-disponibile)
                if(checkbox.disabled) return;

                const isDisponibile = checkbox.checked;
                
                // Aggiorna solo se lo stato è cambiato o se deve essere impostato
                if (allGiocatoriCandidature[id].isDisponibile !== isDisponibile) {
                     updatePromises.push(
                        update(ref(db, `giocatori/${id}`), { isDisponibile: isDisponibile })
                     );
                }
            });

            await Promise.all(updatePromises);
            alert("Candidature aggiornate con successo!");
            window.closeCandidatureEditor();
            loadCandidature();
        } catch (e) {
            console.error("Errore salvataggio candidature:", e);
            alert("Errore nel salvataggio delle candidature.");
        }
    }

    window.closeCandidatureEditor = () => {
        byId('crud-candidature-editor').style.display = 'none';
    }


    /* =========================================================================
     * FUNZIONI VIDEO
     * ========================================================================= */

    // --- Admin ---
    async function loadPartitePerVideoAdmin() {
        if (!isAdmin) return;
        const select = byId('video-match-select');
        select.innerHTML = '<option value="">Caricamento...</option>';

        try {
            const snapshot = await get(ref(db, 'partite'));
            const partite = snapshot.val() || {};
            
            let options = '<option value="">Seleziona una partita...</option>';
            Object.entries(partite).sort(([keyA, pA], [keyB, pB]) => new Date(pB.giorno) - new Date(pA.giorno)).forEach(([key, p]) => {
                const giorno = p.giorno.split('-').reverse().join('/');
                options += `<option value="${key}">${giorno} - ${escapeHtml(p.avversario)} (${p.tipoPartita})</option>`;
            });
            
            select.innerHTML = options;
            byId('video-editor-container').style.display = 'none';

        } catch (e) {
            console.error("Errore caricamento partite per video:", e);
            select.innerHTML = '<option value="">Errore caricamento</option>';
        }
    }

    window.loadVideoLink = async () => {
        if (!isAdmin) return;
        const matchId = v('video-match-select');
        const linkInput = byId('video-link');
        const container = byId('video-editor-container');
        
        if (!matchId) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'block';
        linkInput.value = 'Caricamento link esistente...';

        try {
            const snap = await get(ref(db, `partite/${matchId}/videoLink`));
            const videoLink = snap.val() || '';
            linkInput.value = videoLink;
        } catch (e) {
            console.error("Errore caricamento video link:", e);
            linkInput.value = 'Errore nel recupero del link.';
        }
    }

    window.saveVideoLink = async () => {
        if (!isAdmin) return;
        const matchId = v('video-match-select');
        const videoLink = v('video-link').trim();

        if (!matchId) {
            alert("Seleziona una partita.");
            return;
        }
        
        // Validazione base per l'URL di embed di YouTube
        const youtubeEmbedRegex = /^https:\/\/www\.youtube\.com\/embed\/[a-zA-Z0-9_-]+(\?.*)?$/;
        if (videoLink && !youtubeEmbedRegex.test(videoLink)) {
            alert("Inserisci un link YouTube valido in formato EMBED URL (es. https://www.youtube.com/embed/CODICE).");
            return;
        }

        try {
            await update(ref(db, `partite/${matchId}`), {
                videoLink: escapeHtml(videoLink)
            });
            alert("Link video salvato con successo!");
            loadVideoList(); // Aggiorna la lista pubblica
        } catch (e) {
            console.error("Errore salvataggio video link:", e);
            alert("Errore durante il salvataggio del link.");
        }
    }

    // --- Public ---
    async function loadVideoList() {
        const list = byId('video-list');
        list.innerHTML = 'Caricamento video...';
        
        try {
            const snapshot = await get(ref(db, 'partite'));
            const partite = snapshot.val() || {};
            
            const videoMatches = Object.entries(partite)
                .filter(([, p]) => p.videoLink && p.videoLink.length > 0)
                .map(([key, p]) => ({ key, ...p }))
                .sort((a, b) => new Date(b.giorno) - new Date(a.giorno)); // Ordina per data decrescente

            if (videoMatches.length === 0) {
                list.innerHTML = '<div class="help" style="grid-column: 1 / -1;">Nessun highlight video disponibile al momento.</div>';
                return;
            }

            list.innerHTML = videoMatches.map(p => {
                const giorno = p.giorno.split('-').reverse().join('/');
                return `
                    <div class="card" onclick="window.openVideoModal('${p.videoLink}')" style="cursor:pointer; transition: transform 180ms ease;">
                        <div style="height: 100px; background: #000; border-radius: 8px; overflow: hidden; position: relative;">
                             <img src="https://img.youtube.com/vi/${extractYoutubeId(p.videoLink)}/hqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.7;" alt="Anteprima Video">
                             <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 32px;">▶️</span>
                        </div>
                        <div style="padding-top: 10px;">
                            <div class="player-title">${escapeHtml(p.avversario)}</div>
                            <div class="player-sub">${giorno} (${p.tipoPartita})</div>
                        </div>
                    </div>
                `;
            }).join('');

        } catch (e) {
            console.error("Errore caricamento video list:", e);
            list.innerHTML = '<div class="help" style="grid-column: 1 / -1;">Errore nel caricamento dei video.</div>';
        }
    }

    function extractYoutubeId(url) {
        // Esempio: https://www.youtube.com/embed/dQw4w9WgXcQ
        try {
            const urlObj = new URL(url);
            const parts = urlObj.pathname.split('/');
            return parts[parts.length - 1].split('?')[0];
        } catch (e) {
            return '';
        }
    }

    window.openVideoModal = (videoLink) => {
        const modal = byId('video-modal');
        const iframe = byId('video-iframe');
        iframe.src = videoLink;
        modal.style.display = 'flex';
    }

    window.closeVideoModal = () => {
        const modal = byId('video-modal');
        const iframe = byId('video-iframe');
        iframe.src = ''; // Ferma la riproduzione
        modal.style.display = 'none';
    }

    // Aggiungi listener per la chiusura e salvataggio del modal
    $(document).ready(() => {
        $("#close-video-modal").on('click', window.closeVideoModal);
        $("#save-video-btn").on('click', window.saveVideoLink);
    });

  </script>
</head>
<body>

  <header>
    <div class="hero">
      <img src="https://i.ibb.co/L8f3Hk2/logo-club.png" alt="Logo AC Tuscolano" />
      <div class="brand">
        <p class="club">AC Tuscolano</p>
        <p class="tag">La Squadra del Cuore</p>
      </div>
      <button id="auth-toggle-btn" class="btn btn--accent" type="button" onclick="handleAuthToggle()">Accesso Admin</button>
    </div>
  </header>

  <nav id="admin-menu">
    <div class="nav-wrap">
        <div class="help" style="color:#fff; font-weight: bold;">ADMIN:</div>
        <button class="tab" data-admin-target="admin-inserimento-giocatori-section">Giocatori</button>
        <button class="tab" data-admin-target="admin-inserimento-giornate-section">Nuova Giornata</button>
        <button class="tab" data-admin-target="admin-calendario-section">Formazione/Pubblica</button>
        <button class="tab" data-admin-target="admin-candidature-section">Candidature</button>
        <button class="tab" data-admin-target="admin-statistiche-section">Statistiche</button>
        <button class="tab" data-admin-target="admin-video-section">Video</button>
        <button class="tab" data-admin-target="admin-gestione-dati-section">CRUD Dati</button>
        <button class="tab" data-admin-target="admin-utenti-section">Utenti</button>
    </div>
  </nav>

  <nav>
    <div class="nav-wrap">
      <button id="rosa-tab" class="tab" data-target="rosa-section" aria-current="page">Rosa</button>
      <button id="calendario-tab" class="tab" data-target="calendario-section">Calendario</button>
      <button id="statistiche-tab" class="tab" data-target="statistiche-section">Statistiche</button>
      <button id="classifica-tab" class="tab" data-target="classifica-section">Classifica</button>
      <button id="video-tab" class="tab" data-target="video-section">Video</button>
    </div>
  </nav>

  <main>
    
    <section id="login-section">
      <h2>Accesso Admin</h2>
      <form id="login-form">
        <label for="login-email">Email</label>
        <input id="login-email" type="email" required />
        <label for="login-password">Password</label>
        <input id="login-password" type="password" required />
        <div class="actions">
          <button class="btn btn--accent" type="submit">Accedi</button>
        </div>
      </form>
    </section>

    <section id="rosa-section" class="content-section active">
      <h2>Rosa Giocatori</h2>
      <ul id="rosa-list" class="grid cols-3">
        </ul>
    </section>

    <section id="calendario-section" class="content-section">
      <h2>Prossime Giornate & Avvisi</h2>
      <ul id="calendario-list">
        </ul>
    </section>
    
    <section id="formazione-pubblica-section" class="content-section">
      <h2 id="formazione-pubblica-match-title">Formazione Ufficiale</h2>
      <div id="formazione-pubblica-field" class="field">
        </div>
      
      <h3 style="margin-top: 18px; border-bottom: 1px solid var(--line); padding-bottom: 6px;">Sostituti in Panchina</h3>
      <ul id="formazione-pubblica-panchina-list" style="display:flex; flex-wrap:wrap; gap: 8px;">
        </ul>
      <div class="help" style="margin-top: 12px;">La Formazione Ufficiale è visibile qui solo se è stata pubblicata dall'admin.</div>
    </section>

    <section id="statistiche-section" class="content-section">
      <h2>Statistiche Squadra</h2>
      </section>

    <section id="classifica-section" class="content-section">
      <h2>Classifica Campionato</h2>
      <div id="classifica-content">
          <div class="help">Caricamento classifica...</div>
      </div>
    </section>
    
    <section id="video-section" class="content-section">
      <h2>Highlights</h2>
      <div id="video-list" class="grid cols-3">
        </div>
    </section>

    <section id="admin-inserimento-giocatori-section" class="content-section" style="display:none">
      <h2>Admin · Inserimento Giocatori</h2>
      <form id="new-player-form">
        <label for="nome">Nome Giocatore</label><input id="nome" required />
        <label for="cognome">Cognome Giocatore</label><input id="cognome" required />
        <label for="numero">Numero Maglia</label><input id="numero" type="number" min="1" max="99" />
        <label for="ruolo">Ruolo</label>
        <select id="ruolo" required>
          <option value="">Seleziona Ruolo</option>
          <option value="P">Portiere</option>
          <option value="D">Difensore</option>
          <option value="C">Centrocampista</option>
          <option value="A">Attaccante</option>
        </select>
        <label for="status">Status</label>
        <select id="status" required>
          <option value="attivo">Attivo</option>
          <option value="inattivo">Inattivo</option>
          <option value="ceduto">Ceduto</option>
        </select>
        <div class="actions">
          <button class="btn btn--admin" type="button" onclick="window.saveNewPlayer()">Salva Giocatore</button>
        </div>
      </form>
    </section>

    <section id="admin-inserimento-giornate-section" class="content-section" style="display:none">
      <h2>Admin · Inserimento Nuova Giornata</h2>
      <form id="new-match-form">
        <label for="avversario">Avversario</label><input id="avversario" required />
        <label for="tipo-partita">Tipo Partita</label>
        <select id="tipo-partita" required>
          <option value="Campionato">Campionato</option>
          <option value="Amichevole">Amichevole</option>
          <option value="Coppa">Coppa</option>
        </select>
        <label for="match-data">Data (GG/MM/AA)</label><input id="match-data" required />
        <label for="match-ora">Ora</label><input id="match-ora" value="20:00" />
        <label for="match-luogo">Luogo</label><input id="match-luogo" required />
        <div class="actions">
          <button class="btn btn--admin" type="button" onclick="window.saveNewMatch()">Salva Giornata</button>
        </div>
      </form>
    </section>
    
    <section id="admin-calendario-section" class="content-section" style="display:none">
      <h2>Admin · Partite & Formazione</h2>
      <h3>Prossime partite</h3>
      <ul id="admin-prossime-giornate-list">
        </ul>
      <div class="help" style="margin-top: 12px;">Clicca su "Modifica Formazione" per gestire titolari e panchina.</div>
    </section>

    <section id="admin-formazione-section" class="content-section" style="display:none">
        <h2 id="formazione-match-title">Admin · Modifica Formazione</h2>
        <div class="grid-container">
            <div id="formazione-field-container">
                <div id="formazione-field" class="field">
                    </div>
                <div class="help" style="margin-top: 8px;">Trascina i giocatori dal pannello di destra sul campo verde per schierarli titolari e posizionali. Trascina un titolare sul pannello Sostituti per metterlo in panchina.</div>
            </div>

            <div class="field-controls">
                <div class="card">
                    <div class="player-title">Stato Formazione:</div>
                    <div class="help">Titolari: <span id="titolari-count">0</span> / 11</div>
                    <div class="help">Panchina: <span id="substitutes-count">0</span> / 12</div>
                    <div class="actions" style="margin-top: 10px;">
                        <button id="save-formazione-btn" class="btn btn--admin" type="button">Salva Formazione</button>
                        <button id="toggle-publish-formazione" class="btn btn--accent" type="button" data-published="false">Pubblica Formazione</button>
                    </div>
                </div>
                
                <div id="formazione-substitutes-container" class="card">
                    <div class="player-title" style="margin-bottom: 6px;">Sostituti (Panchina)</div>
                    <div id="formazione-substitutes-list">
                        <ul style="display:flex; flex-wrap:wrap; gap: 4px;">
                            </ul>
                    </div>
                    <div class="help">Trascina un titolare qui per metterlo in panchina.</div>
                </div>

                <div id="formazione-available-container" class="card" style="flex-grow: 1;">
                    <div class="player-title">Giocatori Disponibili</div>
                    <ul id="formazione-players-list">
                        </ul>
                    <div class="help">Trascina un giocatore sul campo per schierarlo titolare, o sull'area Sostituti per metterlo in panchina.</div>
                </div>
            </div>
        </div>
    </section>

    <section id="admin-statistiche-section" class="content-section" style="display:none">
      <h2>Admin · Modifica Statistiche</h2>
      <p>Questa sezione richiede un'interfaccia complessa per l'editing delle statistiche per partita. Si consiglia di utilizzare la sezione CRUD Dati per l'aggiornamento rapido.</p>
    </section>

    <section id="admin-candidature-section" class="content-section" style="display:none">
      <h2>Admin · Gestione Candidature</h2>
      <ul id="candidature-list" class="grid cols-2">
        </ul>
    </section>

    <section id="admin-gestione-dati-section" class="content-section" style="display:none">
      <h2>Admin · CRUD Dati</h2>
      <button class="tab btn--admin" onclick="window.loadCrudGiocatori()">Modifica Giocatori</button>
      <button class="tab btn--admin" onclick="window.loadCrudPartite()">Modifica Partite</button>
      
      <div id="crud-giocatori-editor" style="margin-top: 15px;">
        <h3>Gestione Giocatori</h3>
        <table class="table" id="crud-giocatori-table">
          <thead><tr><th>Nome</th><th>Cognome</th><th>N.</th><th>Ruolo</th><th>Status</th><th>Azioni</th></tr></thead>
          <tbody id="crud-giocatori-body"></tbody>
        </table>
      </div>
      
      <div id="crud-partite-editor" style="margin-top: 15px; display: none;">
        <h3>Gestione Partite</h3>
        <table class="table" id="crud-partite-table">
          <thead><tr><th>Avversario</th><th>Data</th><th>Ora</th><th>Luogo</th><th>Tipo</th><th>Giocata</th><th>Azioni</th></tr></thead>
          <tbody id="crud-partite-body"></tbody>
        </table>
      </div>
    </section>
    
    <section id="admin-video-section" class="content-section" style="display:none">
      <h2>Admin · Gestione Video Highlights</h2>
      <label for="video-match-select">Seleziona Partita</label>
      <select id="video-match-select" onchange="window.loadVideoLink()"></select>
      
      <div id="video-editor-container" style="margin-top: 10px; display: none;">
        <label for="video-link">Link YouTube (Embed URL)</label>
        <input id="video-link" placeholder="Esempio: https://www.youtube.com/embed/dQw4w9WgXcQ" />
        <div class="actions">
          <button id="save-video-btn" class="btn btn--admin" type="button">Salva Link Video</button>
        </div>
      </div>
      
      <div class="help" style="margin-top: 15px;">Solo l'URL di embed di YouTube è supportato. Esempio corretto: <code>https://www.youtube.com/embed/CODICE</code></div>
    </section>

    <section id="admin-utenti-section" class="content-section" style="display:none">
      <h2>Admin · Inserimento utenti</h2>
      <form id="create-user-form">
        <label>Nome Giocatore</label><input id="new-nome" required />
        <label>Cognome Giocatore</label><input id="new-cognome" required />
        <label>Email</label><input id="new-email" type="email" required />
        <label>Password</label><input id="new-password" type="password" required />
        <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
      </form>
      <div class="help">L’admin resta connesso durante la creazione grazie all’autenticazione secondaria.</div>
    </section>
  </main>
  
  <div id="video-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 20px;">
    <div id="video-modal-content" style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button" style="position:absolute; top:-10px; right:-10px; z-index:110; font-size:1.2rem; line-height:1.2;">&times;</button>
      <div id="video-iframe-container" style="position: relative; width: 100%; padding-bottom: 56.25%; height: 0; border-radius: var(--radius); overflow: hidden;">
        <iframe id="video-iframe" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
  </div>

  <div id="crud-candidature-editor">
    <div id="crud-candidature-content">
      <h2>Modifica Candidature Manuali</h2>
      <div class="help" id="id-warning"></div>
      <table class="table">
        <thead><tr><th>Giocatore</th><th>UID collegato</th><th>Disponibile</th></tr></thead>
        <tbody id="crud-candidature-body"></tbody>
      </table>
      <div class="actions" style="margin-top:10px">
        <button id="crud-candidature-save" class="btn btn--admin" type="button" onclick="window.saveCandidature()">Salva candidature</button>
        <button class="btn" type="button" onclick="window.closeCandidatureEditor()">Chiudi</button>
      </div>
    </div>
  </div>


  <footer>
    &copy; 2024 AC Tuscolano. Gestione Squadra | Sviluppato per uso interno.
  </footer>

</body>
</html>
