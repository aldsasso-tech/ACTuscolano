<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AC Tuscolano | Gestione Squadra</title>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css"/>

  <script>
/* ===== SCHEDULAZIONE: refresh giornaliero alle 23:00 ===== */
function msUntilNext(hour, minute = 0, second = 0) {
  const now = new Date();
  const next = new Date(now);
  next.setHours(hour, minute, second, 0);
  if (next <= now) next.setDate(next.getDate() + 1);
  return next - now;
}
window.scheduleDailyClassificaRefresh = () => {
  const ms = msUntilNext(23, 0, 0);
  const infoEl = document.getElementById('classifica-next-run');
  if (infoEl) {
    const when = new Date(Date.now() + ms).toLocaleString('it-IT');
    infoEl.textContent = `Prossimo aggiornamento: ${when}`;
  }
  setTimeout(async function tick() {
    // La funzione loadClassifica viene definita nello script modulare (Firebase)
    if (typeof loadClassifica === 'function') {
      await loadClassifica();
    }
    window.scheduleDailyClassificaRefresh();
  }, ms);
};


/* ===== EFFETTO FADE NAVIGAZIONE (solo .content-section, fix visibilit√† completa) ===== */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.getAttribute('data-target');
    const current = document.querySelector('.content-section.active');
    const next = document.getElementById(target);
    if (!next || current === next) return;

    if (current) {
      current.style.opacity = '0';
      current.style.pointerEvents = 'none';
      setTimeout(() => {
        current.classList.remove('active');
        next.classList.add('active');
        next.style.opacity = '0';
        next.style.pointerEvents = 'all';
        setTimeout(() => { next.style.opacity = '1'; }, 50);
      }, 400);
    } else {
      // Caso iniziale: nessuna sezione attiva
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      next.classList.add('active');
      next.style.opacity = '1';
      next.style.pointerEvents = 'all';
    }

    // Aggiorna contenuto dinamico
    if (target === 'classifica-section' && typeof loadClassifica === 'function') {
      setTimeout(() => loadClassifica(), 600);
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  // Imposta la prima sezione pubblica come attiva all'avvio
  const firstSection = document.querySelector('.content-section');
  if (firstSection) firstSection.classList.add('active');
  
  // Avvia lo scheduler
  if (typeof window.scheduleDailyClassificaRefresh === 'function') {
    window.scheduleDailyClassificaRefresh();
  }
});
</script>
<style>
    /* CSS originale */
    :root{
      /* Brand */
      --white:#ffffff;
      --yellow:#ffd700;
      --red:#da0000;
      --ink:#1f2328;
      --ink-sub:#495057;

      /* Surfaces */
      --bg:#f7f7f9;
      --card:#ffffff;
      --line:#e6e8ec;

      /* Effects */
      --radius:16px;
      --shadow:0 1px 2px rgba(16,24,40,.06), 0 10px 16px rgba(16,24,40,.06);
      --ring:0 0 0 3px rgba(218,0,0,.12);

      /* Motion */
      --duration:180ms;
      --ease:cubic-bezier(.2,.6,.2,1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
    a{color:inherit}

    /* Header */
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,var(--red),#ff4a3d);
      color:var(--white);
      border-bottom:6px solid var(--yellow);
      box-shadow:0 6px 16px rgba(218,0,0,.15);
    }
    .hero{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:16px;padding:14px 16px}
    .hero img{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))}
    .brand{display:flex;flex-direction:column}
    .brand .club{margin:0;line-height:1.05;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,3vw,34px)}
    .brand .tag{margin:0;opacity:.92;font-weight:600;font-size:clamp(12px,2vw,14px)}

    /* Top nav */
    nav{background:var(--yellow);border-bottom:1px solid #f0d200}
    .nav-wrap{max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px 16px;align-items:center}
    .tab,.btn{appearance:none;border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:var(--card);color:var(--ink);text-decoration:none;display:inline-flex;align-items:center;gap:6px;transition:all var(--duration) var(--ease);box-shadow:inset 0 0 0 1px var(--line)}
    .tab:hover,.btn:hover{transform:translateY(-1px)}
    .tab[aria-current="page"]{box-shadow:inset 0 0 0 2px var(--red)}
    .btn--accent{background:var(--red);color:#fff;box-shadow:none}
    .btn--accent:hover{filter:brightness(.96)}
    .btn--admin{background:#111;color:#fff}
    .btn--admin:hover{filter:brightness(1.08)}
    #auth-toggle-btn{margin-left:auto}

    /* Layout */
    main{max-width:1200px;margin:18px auto;padding:0 16px}
    section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    #login-section{display:none}
    section h2{margin:0 0 14px 0;color:var(--red);border-bottom:3px solid var(--yellow);padding-bottom:6px}

    label{font-weight:700;margin-top:10px;display:block}
    input,select,textarea{width:100%;max-width:460px;padding:10px;border:1px solid var(--line);border-radius:12px;margin-top:6px;background:#fff}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:var(--ring)}
    form .actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
    .help{color:var(--ink-sub);font-size:.92rem}

    /* Reusable */
    ul{list-style:none;padding:0;margin:0}
    .grid{display:grid;gap:12px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.grid.cols-3{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:640px){.grid.cols-2,.grid.cols-3{grid-template-columns:1fr}}

    .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:var(--shadow)}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .pill{background:var(--yellow);color:#111;border-radius:999px;padding:4px 10px;font-weight:800;font-size:.8rem}

    .player-title{font-weight:800}
    .player-sub{color:var(--ink-sub);font-size:.95rem}

    /* Field */
    .field{position:relative;background:#0e7a0d;border:2px solid #fff;border-radius:14px;height:360px;color:#fff;margin-top:10px;overflow:hidden}
    .field:before{content:"";position:absolute;left:50%;top:0;bottom:0;width:2px;background:#fff;opacity:.25;transform:translateX(-50%)}
    .marker{position:absolute;transform:translate(-50%,-50%);background:var(--yellow);color:#111;border:1px solid #fff;border-radius:999px;padding:6px 8px;font-size:11px;line-height:1;text-align:center;min-width:72px;max-width:90px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Admin bar */
    #admin-menu{display:none;background:var(--red);padding:8px 16px}
    #admin-menu .tab{background:var(--yellow);color:#111;box-shadow:none;border-radius:12px}

    /* Table-like list */
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px 10px;border-bottom:1px solid var(--line);text-align:left}
    .table thead th{font-size:.9rem;color:#000}
    .table input, .table select {max-width: none !important; margin-top: 0; padding: 6px 8px; border-radius: 8px; font-size: 0.9rem;}
    
    /* NUOVI STILI: Modale Video */
    #video-modal{
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.85); 
        z-index: 100; 
        align-items: center; 
        justify-content: center; 
        padding: 20px;
    }
    #close-video-modal{
        position: absolute; 
        top: -10px; 
        right: -10px; 
        z-index: 110; 
        font-size: 1.2rem; 
        line-height: 1.2;
    }
    #video-iframe-container{
        position: relative; 
        width: 100%; 
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0; 
        border-radius: var(--radius); 
        overflow: hidden;
    }

    /* Footer */
    footer{background:var(--ink-sub);color:#fff;padding:10px 16px;margin-top:22px;font-size:.8rem;text-align:center;border-top:4px solid var(--yellow)}

    @media (prefers-reduced-motion: reduce){.tab,.btn{transition:none}}
  

/* === Effetti di transizione per le sezioni visibili (.content-section) === */
.content-section {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s ease;
}
.content-section.active {
  opacity: 1;
  pointer-events: all;
}


</style>

  <script type="module">
    /* Firebase v9 (modular) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, getIdTokenResult, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js';
    import { getDatabase, ref, set, push, get, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQLQYXcwyFt5luNw1iA5N2-EfnbF1Bc7U",
      authDomain: "actuscolano.firebaseapp.com",
      databaseURL: "https://actuscolano-default-rtdb.firebaseio.com",
      projectId: "actuscolano",
      storageBucket: "actuscolano.firebasestorage.app",
      messagingSenderId: "62685359731",
      appId: "1:62685359731:web:26819bedd94fcb1ce8c406",
      measurementId: "G-TSVH8PH4RC"
    };

    // Inizializzazioni
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const ADMIN_UID = "tbHGXtpvBDfmVIrNT2QVyeBinCV2"; // Controlla il tuo UID corretto
    let isAdmin = false;
    let selectedMatchKey = null; // Usato nella sezione admin-video-section

    // Seconda app per creare utenti senza sloggarci
    const adminSecondaryApp = initializeApp(firebaseConfig, "adminSecondary");
    const adminSecondaryAuth = getAuth(adminSecondaryApp);

    /* Helpers */
    const byId = (id)=>document.getElementById(id);
    const v = (id)=>byId(id)?.value || '';
    const escapeHtml=(s='')=>s.toString().replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

    // ** ARRAY SEZIONI AGGIORNATI E COMPLETI **
    const PUBLIC_SECTIONS = ['rosa-section','calendario-section','statistiche-section','formazione-pubblica-section','video-section', 'classifica-section'];
    const ADMIN_SECTIONS = [
      'admin-inserimento-giocatori-section',
      'admin-inserimento-giornate-section',
      'admin-calendario-section',
      'admin-formazione-section',
      'admin-statistiche-section',
      'admin-candidature-section',
      'admin-gestione-dati-section',
      'admin-utenti-section',
      'admin-video-section' // Aggiunto per il video
    ];
    const ALL_SECTIONS = [...PUBLIC_SECTIONS, ...ADMIN_SECTIONS, 'login-section']; // Includo il login per nasconderlo

    // Funzione per mostrare le sezioni pubbliche
    window.showPublicSection = (id = 'rosa-section') => {
      ALL_SECTIONS.forEach(secId => { 
        const el = byId(secId); 
        // Logica per gestire la visibilit√† con la transizione CSS
        const isTarget = (secId === id);
        
        if (el) {
          if (isTarget) {
            el.style.display = 'block'; // Necessario per far partire la transizione
            // Assicurati che l'opacit√† sia 0 prima di aggiungere 'active' se non lo √®
            if (!el.classList.contains('active')) {
                el.style.opacity = '0';
                setTimeout(() => {
                    el.classList.add('active');
                    el.style.opacity = '1';
                }, 50);
            }
          } else {
             // Nasconde le altre sezioni gradualmente o immediatamente
            if (el.classList.contains('active')) {
                el.style.opacity = '0';
                el.style.pointerEvents = 'none';
                setTimeout(() => {
                    el.classList.remove('active');
                    el.style.display = 'none';
                }, 500); // 500ms per la transizione + 100ms di buffer
            } else {
                el.style.display = 'none';
            }
          }
        }
      });
      document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', t.dataset.target===id ? 'page' : 'false'); });
      document.querySelectorAll('#admin-menu .tab').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dall'admin
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
    
    // Funzione per mostrare le sezioni admin
    window.showAdminSection = (id) => {
        if(!isAdmin) return showLogin(); // Protezione base
        
        ALL_SECTIONS.forEach(secId => { 
            const el = byId(secId); 
            const isTarget = (secId === id);

            if (el) {
                if (isTarget) {
                    el.style.display = 'block'; 
                    if (!el.classList.contains('active')) {
                        el.style.opacity = '0';
                        setTimeout(() => {
                            el.classList.add('active');
                            el.style.opacity = '1';
                        }, 50);
                    }
                } else {
                    if (el.classList.contains('active')) {
                        el.style.opacity = '0';
                        el.style.pointerEvents = 'none';
                        setTimeout(() => {
                            el.classList.remove('active');
                            el.style.display = 'none';
                        }, 500); 
                    } else {
                        el.style.display = 'none';
                    }
                }
            }
        });
        
        document.querySelectorAll('.tab[data-target]').forEach(t=>{ t.setAttribute('aria-current', 'false'); }); // Rimuove current dal pubblico
        document.querySelectorAll(`#admin-menu .tab`).forEach(t=>{ 
            t.setAttribute('aria-current', t.dataset.adminTarget===id ? 'page' : 'false');
        });

        // Ricarica i dati specifici per la sezione admin (dal tuo codice originale)
        if(id==='admin-calendario-section'){ loadProssimeGiornate(true); }
        if(id==='admin-inserimento-giornate-section'){ $("#match-data").datepicker({ dateFormat:"dd/mm/yy", minDate:0 }); }
        if(id==='admin-candidature-section'){ loadCandidature(); }
        if(id==='admin-gestione-dati-section'){ window.loadCrudGiocatori(); window.loadCrudPartite(); }
        if (id === 'admin-video-section') loadPartitePerVideoAdmin(); // Carica per la sezione video
        if (id === 'admin-statistiche-section') loadAdminStatistiche();

        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function showLogin(){ byId('login-section').style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
    function hideLogin(){ byId('login-section').style.display='none'; }
    function toggleAdminUI(){ 
        byId('admin-menu').style.display = isAdmin ? 'block' : 'none'; 
        if (!isAdmin) {
             // Se l'admin fa logout, torna alla sezione pubblica di default
             window.showPublicSection('rosa-section');
        }
    }
    function setAuthButton(user){ const b=byId('auth-toggle-btn'); if(user){ b.textContent='Logout'; b.classList.add('btn--accent'); } else { b.textContent='Login'; b.classList.remove('btn--accent'); } }

    /* Auth */
    onAuthStateChanged(auth, async (user)=>{
      isAdmin = !!user && (user.uid===ADMIN_UID); 
      setAuthButton(user);
      hideLogin(); // Nasconde il form di login dopo lo stato di auth
      toggleAdminUI(); // Aggiorna la UI
      
      // Assicura che una sezione sia visibile al cambio di stato
      const currentActive = document.querySelector('.content-section.active');
      
      if(user && isAdmin) {
         // Se admin loggato, mostra la sezione predefinita admin (es. inserimento giocatori)
         if(!currentActive || PUBLIC_SECTIONS.includes(currentActive.id)){
            window.showAdminSection('admin-inserimento-giocatori-section');
         }
      } else {
         // Se loggout o utente normale, mostra la sezione pubblica predefinita
         if(!currentActive || ADMIN_SECTIONS.includes(currentActive.id)){
            window.showPublicSection('rosa-section');
         }
      }
    });
    
    window.handleAuthToggle = ()=>{
      const user = auth.currentUser;
      if(user){
        signOut(auth).then(()=>{
          hideLogin();
          // Ricarica la sezione pubblica dopo il logout
          window.showPublicSection('rosa-section');
        });
      } else {
        showLogin();
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      // Login
      byId('login-form')?.addEventListener('submit',e=>{
        e.preventDefault();
        const email = v('login-email').trim();
        const pw = v('login-password');
        signInWithEmailAndPassword(auth,email,pw).then(()=>{ hideLogin(); }).catch(err=>alert("Errore login: "+err.message));
      });

      // Creazione utente (admin) ‚Äì usa auth secondario
      byId('create-user-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('new-nome');
        const cognome = v('new-cognome');
        const email = v('new-email').trim();
        const pw = v('new-password');
        if(!nome||!cognome||!email||!pw) return alert("Compila tutti i campi!");
        try{
          const mod = await import('https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js');
          const cred = await mod.createUserWithEmailAndPassword(adminSecondaryAuth,email,pw);
          const uid = cred.user.uid;
          await set(ref(db,'utenti/'+uid),{email, nome, cognome});
          alert('Utenza creata con successo. UID: '+uid);
          e.target.reset();
        }catch(err){ alert('Errore creazione: '+(err?.message||err)); }
      });

      // Default: Carico le sezioni pubbliche e mostro la rosa
      // L'attivazione visuale √® gestita nel primo script e nell'onAuthStateChanged
      loadRosa(); 
      loadProssimeGiornate(false); 
      loadStatistiche();
      loadClassifica(); // ** NUOVO: Carica la classifica all'avvio
      
      // Associazione evento per salvare il link video
      byId('save-video-btn')?.addEventListener('click', saveVideoLink);

      // Associo gli eventi di navigazione pubblici per ricaricare i dati all'apertura
      byId('rosa-tab')?.addEventListener('click', loadRosa);
      byId('calendario-tab')?.addEventListener('click', () => loadProssimeGiornate(false));
      byId('statistiche-tab')?.addEventListener('click', loadStatistiche);
      byId('video-tab')?.addEventListener('click', loadVideoList);
      byId('classifica-tab')?.addEventListener('click', loadClassifica); // ** NUOVO: Evento per la classifica
    });
    
   /* ===== NUOVA FUNZIONE: Classifica Statica (Aggiornata con i dati forniti dall'utente) ===== */
    
/* ===== FUNZIONE: Classifica AC Tuscolano con cache Firebase (solo admin aggiorna) ===== */
const loadClassifica = async () => {
  const classificaContent = document.getElementById('classifica-content');
  if (!classificaContent) return;

  classificaContent.innerHTML = `<div class="help">Caricamento classifica in corso...</div>`;

  try {
    const now = new Date();
    const todayKey = now.toISOString().split('T')[0];
    const snap = await get(ref(db, 'classifica_cache'));
    const cache = snap.val() || {};
    const cachedHtml = cache.html;
    const cachedDate = cache.date;

    if (cachedHtml && cachedDate === todayKey) {
      classificaContent.innerHTML = cachedHtml;
      return;
    }

    if (!isAdmin) {
      if (cachedHtml) {
        classificaContent.innerHTML = cachedHtml;
      } else {
        classificaContent.innerHTML = `<div class="help" style="color:red">La classifica non √® ancora disponibile. L'amministratore provveder√† all'aggiornamento.</div>`;
      }
      return;
    }

    const url = "https://www.romatornei.it/calcio-a-8-over-40-roma-sud/";
    const proxy = "https://api.allorigins.win/get?url=" + encodeURIComponent(url) + "&cacheBust=" + Date.now();
    const response = await fetch(proxy);
    const data = await response.json();

    const parser = new DOMParser();
    const doc = parser.parseFromString(data.contents, "text/html");
    const table = doc.querySelector(".table-responsive table") || doc.querySelector("table[class*='table']") || doc.querySelector("table");

    if (!table) {
      classificaContent.innerHTML = `<div class="help">Impossibile trovare la classifica sul sito remoto.</div>`;
      return;
    }

    // Stile AC Tuscolano
    table.querySelectorAll("img").forEach(img => {
      img.style.maxWidth = "25px";
      img.style.height = "auto";
      img.style.verticalAlign = "middle";
    });

    table.style.width = "100%";
    table.style.borderCollapse = "collapse";
    table.querySelectorAll("th").forEach(th => {
      th.style.backgroundColor = "#8B0000";
      th.style.color = "#fff";
      th.style.padding = "8px";
      th.style.textAlign = "center";
      th.style.borderBottom = "2px solid #ccc";
    });
    table.querySelectorAll("td").forEach(td => {
      td.style.padding = "8px";
      td.style.textAlign = "center";
      td.style.borderBottom = "1px solid #ddd";
    });
    table.querySelectorAll("tr:nth-child(even)").forEach(tr => {
      tr.style.backgroundColor = "#f8f8f8";
    });

    const htmlContent = `
      <div class="help">Classifica aggiornata automaticamente da <a href="${url}" target="_blank" rel="noopener">romatornei.it</a></div>
      <div style="overflow-x:auto;">${table.outerHTML}</div>
      <div class="help" style="margin-top:8px;">Ultimo aggiornamento: ${new Date().toLocaleString("it-IT")}</div>
      <div id="classifica-next-run" class="help" style="margin-top:4px;"></div>
    `;

    classificaContent.innerHTML = htmlContent;
    await set(ref(db, 'classifica_cache'), {
      html: htmlContent,
      date: todayKey,
      timestamp: Date.now()
    });
  } catch (error) {
    console.error("Errore caricamento classifica:", error);
    const snapFallback = await get(ref(db, 'classifica_cache'));
    const cache = snapFallback.val();
    if (cache && cache.html) {
      classificaContent.innerHTML = cache.html;
    } else {
      classificaContent.innerHTML = `<div class="help" style="color:red">Errore nel recupero della classifica.</div>`;
    }
  }
};



    /* ===== NUOVE FUNZIONI VIDEO (INTEGRATE) ===== */

    const getYouTubeId = (url) => {
      if (!url) return null;
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    };

    window.openVideoModal = (youtubeLink) => {
      const videoId = getYouTubeId(youtubeLink);
      if (!videoId) return alert("Link YouTube non valido.");
      
      const iframeSrc = `https://www.youtube.com/embed/${videoId}?rel=0&autoplay=1&modestbranding=1&controls=1&showinfo=0&fs=1&iv_load_policy=3&enablejsapi=1`;
      
      const iframeHtml = `
        <iframe 
          width="100%" 
          height="100%" 
          src="${iframeSrc}" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen 
          style="position:absolute; top:0; left:0; width:100%; height:100%; border-radius:14px;"
          title="Video Partita AC Tuscolano"
        ></iframe>
      `;
      
      byId('video-iframe-container').innerHTML = iframeHtml;
      byId('video-modal').style.display = 'flex';
    };

    byId('close-video-modal')?.addEventListener('click', () => {
      byId('video-modal').style.display = 'none';
      byId('video-iframe-container').innerHTML = ''; // Ferma la riproduzione
    });
    
    // Carica la lista di partite con video (Sezione Pubblica)
    window.loadVideoList = async () => {
      const ul = byId('video-list-ul');
      if (!ul) return;
      ul.innerHTML = '<li>Caricamento video...</li>';

      try {
        const snapshot = await get(ref(db, 'calendario')); // Usa 'calendario' come il resto del tuo codice
        const partite = snapshot.val() || {};
        let html = '';

        const sortedKeys = Object.keys(partite).sort((a, b) => {
          const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
          const dateA = toDate(partite[a].data);
          const dateB = toDate(partite[b].data);
          return dateB - dateA;
        });

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D' && p.linkVideo) {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const campo = p.campo ? escapeHtml(p.campo) : 'Campo sconosciuto';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';

            html += `
              <li class="card" style="margin-bottom:12px; display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                <div>
                  <strong>vs ${avversario} - ${p.risultato}</strong><br>
                  <span class="player-sub">${dataOra} | ${campo}</span>
                </div>
                <button class="btn btn--accent" onclick="window.openVideoModal('${escapeHtml(p.linkVideo)}')">Guarda Video</button>
              </li>
            `;
          }
        });

        ul.innerHTML = html || '<li>Nessuna partita conclusa con video inserito.</li>';
      } catch(error) {
        console.error("Errore caricamento lista video:", error);
        ul.innerHTML = '<li>Errore durante il caricamento dei video.</li>';
      }
    };
    
    /* FUNZIONI ADMIN VIDEO */

    // Carica le partite per il menu a tendina Admin (solo quelle concluse)
    const loadPartitePerVideoAdmin = async () => {
      const select = byId('video-partita-select');
      select.innerHTML = '<option value="">Caricamento...</option>';
      byId('video-link-input').value = '';
      byId('save-video-btn').disabled = true;

      try {
        const snapshot = await get(ref(db, 'calendario'));
        const partite = snapshot.val() || {};
        let options = '<option value="">Seleziona una partita conclusa</option>';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };
        
        const sortedKeys = Object.keys(partite).sort((a, b) => toDate(partite[b].data) - toDate(partite[a].data));

        sortedKeys.forEach(key => {
          const p = partite[key];
          if (p.risultato && p.risultato !== 'N/D') {
            const dataOra = p.data && p.orario ? `${p.data} ${p.orario}` : 'Data/Ora sconosciuta';
            const avversario = p.avversaria ? escapeHtml(p.avversaria) : 'Avversario sconosciuto';
            const videoStatus = p.linkVideo ? ' [VIDEO ESISTENTE]' : '';
            options += `<option value="${key}" data-link="${escapeHtml(p.linkVideo || '')}">vs ${avversario} - ${p.risultato} (${dataOra})${videoStatus}</option>`;
          }
        });

        select.innerHTML = options;
        select.removeEventListener('change', updateVideoForm);
        select.addEventListener('change', updateVideoForm);
        updateVideoForm();
        byId('save-video-btn').disabled = false;
        
      } catch(error) {
        console.error("Errore caricamento partite admin video:", error);
        select.innerHTML = '<option value="">Errore caricamento</option>';
      }
    };

    // Aggiorna il campo input quando la partita selezionata cambia
    const updateVideoForm = () => {
      const select = byId('video-partita-select');
      selectedMatchKey = select.value;
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedMatchKey && selectedOption) {
        const currentLink = selectedOption.dataset.link || '';
        byId('video-link-input').value = currentLink;
        byId('save-video-btn').textContent = currentLink ? 'Aggiorna Link Video' : 'Salva Link Video';
      } else {
        byId('video-link-input').value = '';
        byId('save-video-btn').textContent = 'Salva Link Video';
      }
    };

    // Salva il link video nel database
    const saveVideoLink = async () => {
      if (!isAdmin) return alert("Solo admin.");
      if (!selectedMatchKey) return alert("Seleziona prima una partita.");
      const linkVideo = v('video-link-input').trim();
      if (!linkVideo) return alert("Inserisci il link YouTube.");
      if (!getYouTubeId(linkVideo)) return alert("Il link non sembra essere un URL YouTube valido.");

      try {
        const updates = {};
        updates[`/calendario/${selectedMatchKey}/linkVideo`] = linkVideo;
        await update(ref(db), updates);
        alert('Link video salvato con successo!');
        loadPartitePerVideoAdmin();
        loadVideoList(); // Aggiorna anche la sezione pubblica immediatamente
      } catch(error) {
        alert('Errore salvataggio link: ' + error.message);
        console.error(error);
      }
    };

    /* ===== Funzioni Originali dell'Utente (Integrate) ===== */

    async function loadRosa(){
      const ul = byId('rosa-list');
      if(!ul) return;
      ul.innerHTML='';
      const snap = await get(ref(db,'rosa'));
      const val = snap.val() || {};
      const rows = Object.entries(val).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));

      if(!rows.length){
        ul.innerHTML = '<div class="help">Nessun giocatore inserito.</div>';
        return;
      }

      ul.className='grid cols-2';
      rows.forEach(([id,g])=>{
        const li = document.createElement('li');
        li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="player-title">${g.nome} ${g.cognome} <span class="pill">#${g.numero}</span></div>
              <div class="player-sub">Ruolo: <b>${g.ruolo}</b> ‚Ä¢ Stato: <b>${g.stato}</b></div>
            </div>
          </div>`;
        ul.appendChild(li);
      });
    }

    async function loadProssimeGiornate(asAdmin){
      const listId = asAdmin ? 'admin-calendario-list' : 'calendario-list';
      const ul = byId(listId);
      if(!ul) return;
      ul.innerHTML='';
      const snap = await get(ref(db,'calendario'));
      const val = snap.val() || {};
      let entries = Object.entries(val);

      // Funzione per convertire la data (gg/mm/aaaa)
      const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };

      // Data di oggi normalizzata a mezzanotte per confronto
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      entries.sort((a,b)=> toDate(b[1].data)-toDate(a[1].data));

      if(!entries.length){
        ul.innerHTML = '<div class="help">Nessuna partita a calendario.</div>';
        return;
      }

      ul.className='grid cols-3';
      for(const [matchId,m] of entries){
        const candSnap = await get(ref(db,`calendario/${matchId}/candidature`));
        const cand = candSnap.val() || {};
        const candCount = Object.values(cand).filter(Boolean).length;
        const isPublished = m.formazionePubblicata === true;

        // Nuovo controllo sulla data della partita
        const matchDate = toDate(m.data);

        // √à nel passato se la data della partita √® strettamente precedente a 'today' (normalizzato)
        const isPast = matchDate < today;

        // Generazione condizionale del pulsante di candidatura
        let candButton = '';
        if (isPast) {
            // Partita passata: bottone disabilitato con testo aggiornato
            candButton = `<button class="btn" disabled style="opacity:0.6;cursor:not-allowed">Candidatura scaduta</button>`;
        } else {
            // Partita futura: bottone attivo
            candButton = `<button class="btn btn--accent" onclick="candidati('${matchId}')">Candidatura</button>`;
        }

        const li = document.createElement('li');
        li.className='card';
        li.innerHTML = `
          <div class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
              <div style="font-weight:800;font-size:1.05rem">vs ${m.avversaria}</div>
              <div class="player-sub">${m.data} ‚Ä¢ ${m.orario} ‚Ä¢ ${m.campo} ‚Ä¢ ${m.casa? 'Casa':'Trasferta'}</div>
              <div class="player-sub">Candidature: <b>${candCount}</b></div>
              <div class="player-sub">Risultato: <b>${m.risultato||'N/D'}</b></div>
            </div>
            <div class="row">
              ${!asAdmin ? `
                ${candButton}
                ${isPublished ? `<button class="btn" onclick="showFormazionePubblica('${matchId}','${escapeHtml(m.avversaria)}')">Vedi Formazione</button>` : ''}
              `:''}
              ${asAdmin ? `
                <button class="btn btn--admin" onclick="showFormazioneForm('${matchId}','${escapeHtml(m.avversaria)}')">Inserisci Formazione</button>
                <button class="btn btn--admin" onclick="showCandidatureEditor('${matchId}','${escapeHtml(m.avversaria)}')">Gestisci Cand.</button>
                ${m.formazionePubblicata 
                    ? `<button class="btn btn--admin" onclick="toggleFormazionePubblica('${matchId}', false)">Nascondi Formaz.</button>` 
                    : `<button class="btn btn--admin" onclick="toggleFormazionePubblica('${matchId}', true)">Pubblica Formaz.</button>`}
              `:''}
            </div>
          </div>
        `;
        ul.appendChild(li);
      }
    }

    // Funzione Candidati: gestisce la candidatura del giocatore
    window.candidati = async (matchId) => {
        const user = auth.currentUser;
        if (!user) return alert("Devi essere loggato per candidarti.");

        // Recupera nome e cognome dell'utente loggato dal nodo /utenti
        const userSnap = await get(ref(db, 'utenti/' + user.uid));
        const userData = userSnap.val();

        if (!userData || !userData.nome || !userData.cognome) {
            return alert("I tuoi dati utente non sono completi. Contatta un amministratore.");
        }

        const nomeCognome = `${userData.nome} ${userData.cognome}`;
        
        // Cerca l'ID del giocatore in /rosa usando nome e cognome
        const rosaSnap = await get(ref(db, 'rosa'));
        const rosaData = rosaSnap.val();
        let playerId = null;

        for (const id in rosaData) {
            const g = rosaData[id];
            if (`${g.nome} ${g.cognome}`.toLowerCase() === nomeCognome.toLowerCase()) {
                playerId = id;
                break;
            }
        }

        if (!playerId) {
            return alert(`Il tuo account non √® collegato a un giocatore in rosa. Sei registrato come ${nomeCognome}. Contatta un amministratore.`);
        }

        // Verifica lo stato attuale
        const candSnap = await get(ref(db, `calendario/${matchId}/candidature/${playerId}`));
        const isCandidato = candSnap.val() === true;
        
        if (isCandidato) {
            // Rimuovi candidatura
            if (confirm("Sei gi√† candidato. Vuoi ritirare la tua candidatura?")) {
                await set(ref(db, `calendario/${matchId}/candidature/${playerId}`), null);
                alert("Candidatura ritirata con successo.");
            }
        } else {
            // Inserisci candidatura
            if (confirm("Vuoi candidarti per questa partita?")) {
                await set(ref(db, `calendario/${matchId}/candidature/${playerId}`), true);
                alert("Candidatura inserita con successo.");
            }
        }
        
        // Aggiorna l'interfaccia dopo l'azione
        loadProssimeGiornate(false);
    };

    // Funzione Formazione Pubblica
    window.showFormazionePubblica = async (matchId, avversaria) => {
        const modal = byId('formazione-pubblica-section');
        const list = byId('formazione-pubblica-list');
        const title = byId('formazione-pubblica-title');
        
        if (!modal || !list || !title) return;

        title.textContent = `Formazione vs ${avversaria}`;
        list.innerHTML = '<div class="help">Caricamento formazione...</div>';
        
        const snap = await get(ref(db, `calendario/${matchId}/formazione`));
        const formazione = snap.val() || {};

        let html = '';
        const ruoliOrder = ['Portiere', 'Difensore', 'Centrocampista', 'Attaccante', 'Riserva'];

        // Raggruppa i giocatori per ruolo
        const formazionePerRuolo = ruoliOrder.reduce((acc, ruolo) => {
            acc[ruolo] = [];
            return acc;
        }, {});

        // Popola la mappa con i nomi dei giocatori
        for (const ruolo in formazione) {
            for (const nomeCognome in formazione[ruolo]) {
                if(formazione[ruolo][nomeCognome] === true){
                    formazionePerRuolo[ruolo].push(nomeCognome);
                }
            }
        }
        
        // Genera l'HTML per ruolo
        ruoliOrder.forEach(ruolo => {
            if (formazionePerRuolo[ruolo].length > 0) {
                html += `<div style="margin-bottom:16px;">
                            <h3 style="margin-top:0; color:var(--ink); border-bottom:1px solid var(--line); padding-bottom:4px">${ruolo} (${formazionePerRuolo[ruolo].length})</h3>
                            <ul class="grid cols-2" style="list-style:disc; margin-left:20px; padding-left:0;">`;
                
                formazionePerRuolo[ruolo].forEach(giocatore => {
                    html += `<li style="font-weight:600; margin-bottom:4px;">${escapeHtml(giocatore)}</li>`;
                });
                
                html += `</ul></div>`;
            }
        });

        list.innerHTML = html || '<div class="help" style="color:red">Formazione non ancora inserita o pubblicata.</div>';

        // Mostra la sezione Formazione Pubblica e nasconde le altre
        window.showPublicSection('formazione-pubblica-section');
    };

    // Funzione Formazione Admin
    window.showFormazioneForm = async (matchId, avversaria) => {
        if(!isAdmin) return;
        const form = byId('admin-formazione-form');
        const title = byId('admin-formazione-title');
        const matchInput = byId('formazione-match-id');
        const saveBtn = byId('formazione-save-btn');
        
        title.textContent = `Formazione vs ${avversaria}`;
        matchInput.value = matchId;
        saveBtn.disabled = false;
        
        // 1. Carica la lista di giocatori dal nodo /rosa
        const rosaSnap = await get(ref(db, 'rosa'));
        const rosaData = rosaSnap.val() || {};
        
        // 2. Carica la lista di candidature per la partita
        const candSnap = await get(ref(db, `calendario/${matchId}/candidature`));
        const candidati = candSnap.val() || {}; // {playerId: true, ...}
        
        // 3. Carica la formazione gi√† salvata (se esiste)
        const formazioneSnap = await get(ref(db, `calendario/${matchId}/formazione`));
        const formazioneSalvata = formazioneSnap.val() || {}; // {Ruolo: {NomeCognome: true, ...}, ...}
        
        const giocatori = [];
        for(const id in rosaData){
            const g = rosaData[id];
            const nomeCognome = `${g.nome} ${g.cognome}`;
            
            // Trova il giocatore in candidati usando il playerId
            const isCandidato = candidati[id] === true;
            
            // Cerca il ruolo attuale in formazioneSalvata
            let ruoloSelezionato = 'Riserva'; // Default
            for(const ruolo in formazioneSalvata){
                if(formazioneSalvata[ruolo][nomeCognome] === true){
                    ruoloSelezionato = ruolo;
                    break;
                }
            }
            
            giocatori.push({
                id,
                nomeCognome,
                ruoloSquadra: g.ruolo, // Ruolo definito in /rosa
                isCandidato: isCandidato,
                ruoloSelezionato: ruoloSelezionato,
            });
        }
        
        // Ordina: Candidati prima, poi per ruolo squadra
        giocatori.sort((a, b) => {
            if (a.isCandidato !== b.isCandidato) {
                return a.isCandidato ? -1 : 1; // Candidati prima
            }
            return a.ruoloSquadra.localeCompare(b.ruoloSquadra);
        });

        // Genera la tabella
        const tbody = byId('admin-formazione-body');
        tbody.innerHTML = '';
        const ruoliDisponibili = ['Portiere', 'Difensore', 'Centrocampista', 'Attaccante', 'Riserva', 'Assente'];

        giocatori.forEach(g => {
            const tr = document.createElement('tr');
            let selectOptions = ruoliDisponibili.map(r => 
                `<option value="${r}" ${g.ruoloSelezionato === r ? 'selected' : ''}>${r}</option>`
            ).join('');

            const badge = g.isCandidato ? '<span class="pill" style="background:#5cb85c; color:#fff">Candidato</span>' : '';

            tr.innerHTML = `
                <td>${g.nomeCognome} ${badge}</td>
                <td><select data-giocatore="${g.nomeCognome}" class="formazione-ruolo">${selectOptions}</select></td>
                <td>${g.ruoloSquadra}</td>
            `;
            tbody.appendChild(tr);
        });

        // Mostra la sezione
        window.showAdminSection('admin-formazione-section');
    };

    // Funzione di salvataggio Formazione
    byId('admin-formazione-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        
        const matchId = v('formazione-match-id');
        if(!matchId) return alert("ID partita mancante.");

        const saveBtn = byId('formazione-save-btn');
        saveBtn.disabled = true;

        const formazioneDaSalvare = {}; // Struttura {Ruolo: {NomeCognome: true, ...}}
        const selectElements = document.querySelectorAll('.formazione-ruolo');
        
        selectElements.forEach(select => {
            const nomeCognome = select.dataset.giocatore;
            const ruolo = select.value;
            
            if(ruolo !== 'Assente'){
                if(!formazioneDaSalvare[ruolo]) formazioneDaSalvare[ruolo] = {};
                formazioneDaSalvare[ruolo][nomeCognome] = true;
            }
            // Gli 'Assenti' non vengono salvati nel nodo /formazione
        });

        try {
            const updates = {};
            // Rimuove la vecchia formazione e inserisce la nuova
            updates[`/calendario/${matchId}/formazione`] = formazioneDaSalvare;
            updates[`/calendario/${matchId}/formazionePubblicata`] = false; // Forza a nascondere dopo il salvataggio
            
            await update(ref(db), updates);
            alert('Formazione salvata con successo! Ricorda di pubblicarla.');
            loadProssimeGiornate(true); // Ricarica il calendario Admin
            window.showAdminSection('admin-calendario-section');
        } catch (error) {
            alert('Errore salvataggio formazione: ' + error.message);
            console.error(error);
        } finally {
            saveBtn.disabled = false;
        }
    });

    // Funzione per Pubblicare/Nascondere la Formazione
    window.toggleFormazionePubblica = async (matchId, shouldPublish) => {
        if(!isAdmin) return alert("Solo admin.");
        try {
            await update(ref(db, `calendario/${matchId}`), {
                formazionePubblicata: shouldPublish
            });
            alert(`Formazione ${shouldPublish ? 'pubblicata' : 'nascosta'} con successo!`);
            loadProssimeGiornate(true); // Ricarica il calendario Admin
        } catch (error) {
            alert(`Errore nella gestione della pubblicazione: ${error.message}`);
        }
    };

    // Funzione Statistiche
    async function loadStatistiche(){
        const ul = byId('statistiche-list');
        if(!ul) return;
        ul.innerHTML = '<li>Caricamento statistiche...</li>';

        const rosaSnap = await get(ref(db, 'rosa'));
        const rosaData = rosaSnap.val() || {};
        
        const stats = {}; // {playerId: {gol: 0, assist: 0, presenze: 0, nome: '', cognome: ''}}

        // Inizializza le statistiche di ogni giocatore
        for(const id in rosaData){
            stats[id] = {
                gol: rosaData[id].gol || 0,
                assist: rosaData[id].assist || 0,
                presenze: rosaData[id].presenze || 0,
                nome: rosaData[id].nome,
                cognome: rosaData[id].cognome
            };
        }

        // Funzione di rendering
        const renderStats = (data, title, sortKey, isDesc = true) => {
            let sorted = Object.values(data).filter(p => p[sortKey] > 0).sort((a, b) => {
                let diff = (a[sortKey] || 0) - (b[sortKey] || 0);
                if (isDesc) diff *= -1;
                if (diff === 0) {
                    return a.cognome.localeCompare(b.cognome);
                }
                return diff;
            }).slice(0, 5); // Solo la top 5

            if(!sorted.length) return '';

            let html = `
                <div class="card" style="margin-bottom:12px;">
                    <h3 style="margin-top:0; color:var(--red); border-bottom:1px solid var(--line); padding-bottom:4px">${title}</h3>
                    <ol style="padding-left:20px;">
            `;

            sorted.forEach((p, index) => {
                const value = p[sortKey];
                const pill = `<span class="pill" style="background:#ddd; color:#111; margin-left:4px;">${value}</span>`;
                html += `<li style="font-weight:600; margin-bottom:6px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span>${p.nome} ${p.cognome}</span>
                                ${pill}
                            </div>
                        </li>`;
            });

            html += `</ol></div>`;
            return html;
        };

        let html = '<div class="grid cols-3">';
        
        // Statistiche Top 5
        html += renderStats(stats, 'Top Goal Scorer ‚öΩÔ∏è', 'gol');
        html += renderStats(stats, 'Top Assist Man üéØ', 'assist');
        html += renderStats(stats, 'Presenze üèÉ‚Äç‚ôÇÔ∏è', 'presenze');

        html += '</div>';
        
        // Tabella completa
        let tableHtml = `
            <h2>Statistiche Dettagliate</h2>
            <div style="overflow-x:auto;">
            <table class="table" style="min-width:500px">
                <thead><tr><th>Nome</th><th>Ruolo</th><th>Gol</th><th>Assist</th><th>Presenze</th></tr></thead>
                <tbody>
        `;
        
        // Ordina per presenze decrescenti, poi per cognome
        const allPlayersSorted = Object.values(stats).sort((a, b) => {
            const diffPresenze = (b.presenze || 0) - (a.presenze || 0);
            if (diffPresenze !== 0) return diffPresenze;
            return a.cognome.localeCompare(b.cognome);
        });

        allPlayersSorted.forEach(p => {
            const playerRosa = Object.values(rosaData).find(g => g.nome === p.nome && g.cognome === p.cognome);
            const ruolo = playerRosa ? playerRosa.ruolo : 'N/D';
            
            tableHtml += `
                <tr>
                    <td>${p.nome} ${p.cognome}</td>
                    <td>${ruolo}</td>
                    <td>${p.gol || 0}</td>
                    <td>${p.assist || 0}</td>
                    <td>${p.presenze || 0}</td>
                </tr>
            `;
        });
        
        tableHtml += '</tbody></table></div>';
        
        ul.innerHTML = html + tableHtml;
    }


    /* FUNZIONI CRUD DATI (admin-gestione-dati-section) */

    // Load Giocatori (Crud)
    window.loadCrudGiocatori = async () => {
        const body = byId('crud-giocatori-body');
        if(!body) return;
        body.innerHTML = '<tr><td colspan="6">Caricamento...</td></tr>';

        const snap = await get(ref(db, 'rosa'));
        const data = snap.val() || {};
        let html = '';
        const ruoli = ['Portiere', 'Difensore', 'Centrocampista', 'Attaccante', 'Riserva'];
        const stati = ['Attivo', 'Infortunato', 'Squalificato', 'Inattivo'];

        Object.entries(data).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0)).forEach(([id, g]) => {
            const ruoliOptions = ruoli.map(r => `<option value="${r}" ${g.ruolo === r ? 'selected' : ''}>${r}</option>`).join('');
            const statiOptions = stati.map(s => `<option value="${s}" ${g.stato === s ? 'selected' : ''}>${s}</option>`).join('');

            html += `
                <tr data-id="${id}">
                    <td><input type="text" value="${g.nome}" data-key="nome" /></td>
                    <td><input type="text" value="${g.cognome}" data-key="cognome" /></td>
                    <td><input type="number" value="${g.numero}" data-key="numero" style="max-width:80px" /></td>
                    <td><select data-key="ruolo">${ruoliOptions}</select></td>
                    <td><select data-key="stato">${statiOptions}</select></td>
                    <td style="min-width:140px; text-align:center;">
                        <input type="number" value="${g.gol||0}" data-key="gol" style="width:50px; display:inline-block; margin-right:5px;" title="Gol" />
                        <input type="number" value="${g.assist||0}" data-key="assist" style="width:50px; display:inline-block;" title="Assist" />
                    </td>
                    <td><button class="btn btn--accent" onclick="deleteGiocatore('${id}')" title="Elimina">&times;</button></td>
                </tr>
            `;
        });

        body.innerHTML = html || '<tr><td colspan="7">Nessun giocatore inserito.</td></tr>';
        
        // Aggiungi listener per salvare i dati dei giocatori
        document.querySelectorAll('#crud-giocatori-body input, #crud-giocatori-body select').forEach(el => {
            el.addEventListener('change', window.updateGiocatore);
        });
    };

    // Update Giocatore (Crud)
    window.updateGiocatore = async (e) => {
        if(!isAdmin) return;
        const row = e.target.closest('tr');
        const id = row.dataset.id;
        const key = e.target.dataset.key;
        let value = e.target.value;

        if (key === 'numero' || key === 'gol' || key === 'assist') {
            value = parseInt(value) || 0;
            // Assicura che i numeri non siano negativi
            if (value < 0) value = 0;
            e.target.value = value; // Aggiorna il campo input
        }

        try {
            const updatePath = `/rosa/${id}/${key}`;
            await update(ref(db), { [updatePath]: value });
            // console.log(`Aggiornato ${key} di ${id} a ${value}`);
        } catch (error) {
            alert('Errore aggiornamento: ' + error.message);
            console.error(error);
        }
    };

    // Delete Giocatore (Crud)
    window.deleteGiocatore = async (id) => {
        if(!isAdmin || !confirm("Sei sicuro di voler eliminare questo giocatore?")) return;
        try {
            await remove(ref(db, 'rosa/' + id));
            alert('Giocatore eliminato.');
            window.loadCrudGiocatori(); // Ricarica la lista
        } catch (error) {
            alert('Errore eliminazione: ' + error.message);
        }
    };

    // Load Partite (Crud)
    window.loadCrudPartite = async () => {
        const body = byId('crud-partite-body');
        if(!body) return;
        body.innerHTML = '<tr><td colspan="6">Caricamento...</td></tr>';

        const snap = await get(ref(db, 'calendario'));
        const data = snap.val() || {};
        let html = '';

        const toDate = (d)=>{ const [dd,mm,yyyy] = String(d||'').split('/'); return new Date(`${mm}/${dd}/${yyyy}`); };

        const sortedEntries = Object.entries(data).sort((a, b) => toDate(b[1].data) - toDate(a[1].data));

        sortedEntries.forEach(([id, m]) => {
            const casaChecked = m.casa ? 'checked' : '';
            const campo = m.campo || '';
            const orario = m.orario || '';
            const risultato = m.risultato || 'N/D';

            html += `
                <tr data-id="${id}">
                    <td><input type="text" value="${m.avversaria}" data-key="avversaria" /></td>
                    <td><input type="text" value="${m.data}" data-key="data" style="max-width:100px" /></td>
                    <td><input type="text" value="${orario}" data-key="orario" style="max-width:80px" /></td>
                    <td><input type="text" value="${campo}" data-key="campo" /></td>
                    <td style="text-align:center;">
                        <input type="checkbox" data-key="casa" ${casaChecked} style="max-width:30px;" />
                    </td>
                    <td><input type="text" value="${risultato}" data-key="risultato" style="max-width:80px" /></td>
                    <td><button class="btn btn--accent" onclick="deletePartita('${id}')" title="Elimina">&times;</button></td>
                </tr>
            `;
        });

        body.innerHTML = html || '<tr><td colspan="7">Nessuna partita inserita.</td></tr>';
        
        // Aggiungi listener per salvare i dati delle partite
        document.querySelectorAll('#crud-partite-body input[type="text"], #crud-partite-body input[type="checkbox"]').forEach(el => {
            el.addEventListener('change', window.updatePartita);
        });
    };

    // Update Partita (Crud)
    window.updatePartita = async (e) => {
        if(!isAdmin) return;
        const row = e.target.closest('tr');
        const id = row.dataset.id;
        const key = e.target.dataset.key;
        let value;

        if (e.target.type === 'checkbox') {
            value = e.target.checked;
        } else {
            value = e.target.value;
        }

        try {
            const updatePath = `/calendario/${id}/${key}`;
            await update(ref(db), { [updatePath]: value });
            // console.log(`Aggiornato ${key} di ${id} a ${value}`);
        } catch (error) {
            alert('Errore aggiornamento: ' + error.message);
            console.error(error);
        }
    };

    // Delete Partita (Crud)
    window.deletePartita = async (id) => {
        if(!isAdmin || !confirm("Sei sicuro di voler eliminare questa partita?")) return;
        try {
            await remove(ref(db, 'calendario/' + id));
            alert('Partita eliminata.');
            window.loadCrudPartite(); // Ricarica la lista
        } catch (error) {
            alert('Errore eliminazione: ' + error.message);
        }
    };

    // Funzione Candidature Editor Admin
    let currentMatchIdForCandidature = null;

    window.showCandidatureEditor = async (matchId, avversaria) => {
        if(!isAdmin) return;
        
        currentMatchIdForCandidature = matchId;
        
        const editor = byId('admin-candidature-editor');
        const title = byId('crud-candidature-title');
        const body = byId('crud-candidature-body');
        
        title.textContent = `Gestione Candidature vs ${avversaria}`;
        body.innerHTML = '<tr><td colspan="3">Caricamento...</td></tr>';
        
        // 1. Carica la rosa completa
        const rosaSnap = await get(ref(db, 'rosa'));
        const rosaData = rosaSnap.val() || {};
        
        // 2. Carica le candidature attuali per la partita
        const candSnap = await get(ref(db, `calendario/${matchId}/candidature`));
        const candidati = candSnap.val() || {};
        
        // 3. Carica i dati utente per il collegamento (opzionale)
        const utentiSnap = await get(ref(db, 'utenti'));
        const utentiData = utentiSnap.val() || {};

        let html = '';
        
        const giocatori = Object.entries(rosaData).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));

        giocatori.forEach(([playerId, g]) => {
            const nomeCognome = `${g.nome} ${g.cognome}`;
            const isCandidato = candidati[playerId] === true;
            
            // Cerca l'UID collegato
            const utenteCollegato = Object.entries(utentiData).find(([uid, u]) => 
                u.nome.toLowerCase() === g.nome.toLowerCase() && 
                u.cognome.toLowerCase() === g.cognome.toLowerCase()
            );

            const uidCollegato = utenteCollegato ? utenteCollegato[0] : 'N/D';
            const uidStyle = utenteCollegato ? 'style="color:green"' : 'style="color:red"';

            html += `
                <tr data-player-id="${playerId}">
                    <td>${nomeCognome}</td>
                    <td ${uidStyle}>${uidCollegato}</td>
                    <td style="text-align:center;">
                        <input type="checkbox" class="candidatura-checkbox" data-player-id="${playerId}" ${isCandidato ? 'checked' : ''} style="max-width:30px;" />
                    </td>
                </tr>
            `;
        });
        
        body.innerHTML = html || '<tr><td colspan="3">Nessun giocatore in rosa.</td></tr>';
        
        editor.style.display = 'block';
    };

    window.closeCandidatureEditor = () => {
        currentMatchIdForCandidature = null;
        byId('admin-candidature-editor').style.display = 'none';
        loadProssimeGiornate(true); // Ricarica calendario admin
    };

    // Save Candidature Editor Admin
    byId('crud-candidature-save')?.addEventListener('click', async () => {
        if(!isAdmin || !currentMatchIdForCandidature) return;
        
        const saveBtn = byId('crud-candidature-save');
        saveBtn.disabled = true;

        const updatedCandidature = {};
        const checkboxes = document.querySelectorAll('.candidatura-checkbox');
        
        checkboxes.forEach(cb => {
            const playerId = cb.dataset.playerId;
            if(cb.checked){
                updatedCandidature[playerId] = true;
            }
        });
        
        try {
            // Aggiorna il nodo 'candidature' per la partita
            await set(ref(db, `calendario/${currentMatchIdForCandidature}/candidature`), updatedCandidature);
            alert('Candidature salvate con successo.');
            window.closeCandidatureEditor();
        } catch (error) {
            alert('Errore salvataggio candidature: ' + error.message);
            console.error(error);
        } finally {
            saveBtn.disabled = false;
        }
    });


    // Inserimento Giocatori (Admin)
    byId('insert-giocatore-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const nome = v('giocatore-nome');
        const cognome = v('giocatore-cognome');
        const numero = parseInt(v('giocatore-numero'));
        const ruolo = v('giocatore-ruolo');
        
        if(!nome||!cognome||!numero||!ruolo) return alert("Compila tutti i campi!");
        
        try{
            const newRef = push(ref(db,'rosa'));
            await set(newRef,{ nome, cognome, numero, ruolo, stato:'Attivo', gol:0, assist:0, presenze:0 });
            alert('Giocatore inserito con successo.');
            e.target.reset();
            loadRosa(); 
            window.loadCrudGiocatori(); // Aggiorna la CRUD
        }catch(err){ alert('Errore inserimento: '+(err?.message||err)); }
    });

    // Inserimento Giornate (Admin)
    byId('insert-giornata-form')?.addEventListener('submit',async e=>{
        e.preventDefault();
        if(!isAdmin) return alert("Solo admin.");
        const avversaria = v('match-avversaria');
        const data = v('match-data');
        const orario = v('match-orario');
        const campo = v('match-campo');
        const casa = byId('match-casa').checked;
        
        if(!avversaria||!data||!orario||!campo) return alert("Compila tutti i campi!");
        
        try{
            const newRef = push(ref(db,'calendario'));
            await set(newRef,{ avversaria, data, orario, campo, casa, risultato:'N/D' });
            alert('Partita inserita con successo.');
            e.target.reset();
            loadProssimeGiornate(false); // Aggiorna il calendario pubblico
            loadProssimeGiornate(true); // Aggiorna il calendario admin
            window.loadCrudPartite(); // Aggiorna la CRUD
        }catch(err){ alert('Errore inserimento: '+(err?.message||err)); }
    });
    
    // Inserimento Statistiche (Admin)
    let selectedPlayerId = null;

    window.loadAdminStatistiche = async () => {
        const select = byId('stat-giocatore-select');
        select.innerHTML = '<option value="">Caricamento...</option>';
        byId('stat-gol').value = 0;
        byId('stat-assist').value = 0;
        byId('stat-presenze').value = 0;

        try {
            const snap = await get(ref(db, 'rosa'));
            const data = snap.val() || {};
            let options = '<option value="">Seleziona un giocatore</option>';
            
            const sortedPlayers = Object.entries(data).sort((a,b)=> (a[1].numero||0)-(b[1].numero||0));

            sortedPlayers.forEach(([id, g]) => {
                options += `<option value="${id}" data-gol="${g.gol||0}" data-assist="${g.assist||0}" data-presenze="${g.presenze||0}">#${g.numero} ${g.nome} ${g.cognome}</option>`;
            });

            select.innerHTML = options;
            select.removeEventListener('change', updateStatForm);
            select.addEventListener('change', updateStatForm);
            updateStatForm(); // Inizializza il form
            
        } catch(error) {
            console.error("Errore caricamento giocatori admin stat:", error);
            select.innerHTML = '<option value="">Errore caricamento</option>';
        }
    };

    const updateStatForm = () => {
        const select = byId('stat-giocatore-select');
        selectedPlayerId = select.value;
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedPlayerId && selectedOption) {
            byId('stat-gol').value = selectedOption.dataset.gol;
            byId('stat-assist').value = selectedOption.dataset.assist;
            byId('stat-presenze').value = selectedOption.presenze;
            byId('stat-save-btn').disabled = false;
        } else {
            byId('stat-gol').value = 0;
            byId('stat-assist').value = 0;
            byId('stat-presenze').value = 0;
            byId('stat-save-btn').disabled = true;
        }
    };

    byId('insert-stat-form')?.addEventListener('submit', async e => {
        e.preventDefault();
        if (!isAdmin || !selectedPlayerId) return alert("Seleziona un giocatore.");

        const gol = parseInt(v('stat-gol')) || 0;
        const assist = parseInt(v('stat-assist')) || 0;
        const presenze = parseInt(v('stat-presenze')) || 0;
        
        if(gol < 0 || assist < 0 || presenze < 0) return alert("I valori devono essere positivi o zero.");
        
        const saveBtn = byId('stat-save-btn');
        saveBtn.disabled = true;

        try {
            const updates = {};
            updates[`/rosa/${selectedPlayerId}/gol`] = gol;
            updates[`/rosa/${selectedPlayerId}/assist`] = assist;
            updates[`/rosa/${selectedPlayerId}/presenze`] = presenze;
            
            await update(ref(db), updates);
            alert('Statistiche aggiornate con successo!');
            loadAdminStatistiche(); // Ricarica il form
            loadStatistiche(); // Aggiorna la sezione pubblica
        } catch(error) {
            alert('Errore aggiornamento statistiche: ' + error.message);
            console.error(error);
        } finally {
            saveBtn.disabled = false;
        }
    });
    
    // Carica la lista delle candidature
    async function loadCandidature(){
        const ul = byId('candidature-list');
        if(!ul) return;
        ul.innerHTML = '<li>Caricamento candidature...</li>';
        
        const rosaSnap = await get(ref(db, 'rosa'));
        const rosaData = rosaSnap.val() || {};
        
        const candMap = {}; // Mappa {playerId: {nome, cognome, nCandidature}}

        // Inizializza la mappa con tutti i giocatori
        for(const id in rosaData){
            candMap[id] = {
                nome: rosaData[id].nome,
                cognome: rosaData[id].cognome,
                nCandidature: 0
            };
        }
        
        // Cerca tutte le candidature
        const calendarioSnap = await get(ref(db, 'calendario'));
        const calendarioData = calendarioSnap.val() || {};
        
        let totalCandidature = 0;

        for(const matchId in calendarioData){
            const candidature = calendarioData[matchId].candidature || {};
            for(const playerId in candidature){
                if(candidature[playerId] === true && candMap[playerId]){
                    candMap[playerId].nCandidature += 1;
                    totalCandidature += 1;
                }
            }
        }
        
        // Genera la lista
        const playersWithCandidature = Object.values(candMap)
            .filter(p => p.nCandidature > 0)
            .sort((a, b) => b.nCandidature - a.nCandidature); // Ordina per numero di candidature

        let html = '';
        
        if(!playersWithCandidature.length){
            html = '<div class="help">Nessuna candidatura registrata.</div>';
        } else {
            html = `
                <div class="help" style="margin-bottom:12px;">Totale candidature registrate: <b>${totalCandidature}</b></div>
                <div class="grid cols-2">
            `;
            playersWithCandidature.forEach(p => {
                html += `
                    <li class="card">
                        <div class="row" style="justify-content:space-between">
                            <strong>${p.nome} ${p.cognome}</strong>
                            <span class="pill">${p.nCandidature}</span>
                        </div>
                    </li>
                `;
            });
            html += '</div>';
        }
        
        ul.innerHTML = html;
    }

  </script>
</head>
<body>

  <header>
    <div class="hero">
      <img src="https://example.com/logo.png" alt="AC Tuscolano Logo"/>
      <div class="brand">
        <h1 class="club">A.C. Tuscolano</h1>
        <p class="tag">La gestione squadra a portata di click.</p>
      </div>
      <button id="auth-toggle-btn" class="btn" onclick="handleAuthToggle()">Login</button>
    </div>
  </header>

  <nav>
    <div class="nav-wrap">
      <button class="tab" id="rosa-tab" data-target="rosa-section" aria-current="page">La Nostra Rosa</button>
      <button class="tab" id="calendario-tab" data-target="calendario-section">Calendario & Partite</button>
      <button class="tab" id="statistiche-tab" data-target="statistiche-section">Statistiche</button>
      <button class="tab" id="classifica-tab" data-target="classifica-section">Classifica</button>
      <button class="tab" id="video-tab" data-target="video-section">Video Highlights</button>
    </div>
  </nav>

  <div id="admin-menu">
    <div class="nav-wrap">
      <button class="tab btn--admin" id="admin-giocatori-tab" data-admin-target="admin-inserimento-giocatori-section" onclick="window.showAdminSection('admin-inserimento-giocatori-section')">Giocatori</button>
      <button class="tab btn--admin" id="admin-giornate-tab" data-admin-target="admin-inserimento-giornate-section" onclick="window.showAdminSection('admin-inserimento-giornate-section')">Partite</button>
      <button class="tab btn--admin" id="admin-calendario-tab" data-admin-target="admin-calendario-section" onclick="window.showAdminSection('admin-calendario-section')">Calendario Admin</button>
      <button class="tab btn--admin" id="admin-statistiche-tab" data-admin-target="admin-statistiche-section" onclick="window.showAdminSection('admin-statistiche-section')">Statistiche</button>
      <button class="tab btn--admin" id="admin-candidature-tab" data-admin-target="admin-candidature-section" onclick="window.showAdminSection('admin-candidature-section')">Candidature</button>
      <button class="tab btn--admin" id="admin-gestione-tab" data-admin-target="admin-gestione-dati-section" onclick="window.showAdminSection('admin-gestione-dati-section')">CRUD Dati</button>
      <button class="tab btn--admin" id="admin-video-tab" data-admin-target="admin-video-section" onclick="window.showAdminSection('admin-video-section')">Admin Video</button>
      <button class="tab btn--admin" id="admin-utenti-tab" data-admin-target="admin-utenti-section" onclick="window.showAdminSection('admin-utenti-section')">Utenti</button>
    </div>
  </div>

  <main>

    <section id="login-section" class="content-section" style="display:none; opacity:1; pointer-events:all;">
      <h2>Accesso Amministratori e Giocatori</h2>
      <form id="login-form">
        <label for="login-email">Email</label><input id="login-email" type="email" required />
        <label for="login-password">Password</label><input id="login-password" type="password" required />
        <div class="actions"><button class="btn btn--accent" type="submit">Accedi</button></div>
      </form>
      <div class="help" style="margin-top:10px">Solo gli utenti registrati (amministratori o giocatori) possono accedere.</div>
    </section>

    <section id="rosa-section" class="content-section">
      <h2>La Nostra Rosa</h2>
      <ul id="rosa-list">
        </ul>
    </section>

    <section id="calendario-section" class="content-section">
      <h2>Calendario e Risultati</h2>
      <div class="help">Clicca su "Candidatura" per confermare la tua disponibilit√† alla partita. Puoi ritirare la candidatura in qualsiasi momento prima della partita.</div>
      <ul id="calendario-list">
        </ul>
    </section>

    <section id="classifica-section" class="content-section">
      <h2>Classifica Ufficiale</h2>
      <div id="classifica-content">
        </div>
    </section>
    
    <section id="statistiche-section" class="content-section">
      <h2>Statistiche Squadra</h2>
      <div id="statistiche-list">
        </div>
    </section>
    
    <section id="video-section" class="content-section">
      <h2>Video Highlights Partite</h2>
      <ul id="video-list-ul">
        </ul>
    </section>

    <section id="formazione-pubblica-section" class="content-section">
      <h2 id="formazione-pubblica-title">Formazione Ufficiale</h2>
      <div id="formazione-pubblica-list">
        </div>
      <div class="actions" style="margin-top:20px;">
          <button class="btn" onclick="window.showPublicSection('calendario-section')">Torna al Calendario</button>
      </div>
    </section>

    <section id="admin-inserimento-giocatori-section" class="content-section">
      <h2>Admin ¬∑ Inserimento Giocatori</h2>
      <form id="insert-giocatore-form">
        <label>Nome Giocatore</label><input id="giocatore-nome" required />
        <label>Cognome Giocatore</label><input id="giocatore-cognome" required />
        <label>Numero Maglia</label><input id="giocatore-numero" type="number" min="1" max="99" required />
        <label>Ruolo</label>
        <select id="giocatore-ruolo" required>
          <option value="">Seleziona ruolo</option>
          <option value="Portiere">Portiere</option>
          <option value="Difensore">Difensore</option>
          <option value="Centrocampista">Centrocampista</option>
          <option value="Attaccante">Attaccante</option>
          <option value="Riserva">Riserva</option>
        </select>
        <div class="actions"><button class="btn btn--admin" type="submit">Inserisci Giocatore</button></div>
      </form>
    </section>

    <section id="admin-inserimento-giornate-section" class="content-section">
      <h2>Admin ¬∑ Inserimento Partite</h2>
      <form id="insert-giornata-form">
        <label>Avversaria</label><input id="match-avversaria" required />
        <label>Data (gg/mm/aaaa)</label><input id="match-data" required />
        <label>Orario (hh:mm)</label><input id="match-orario" type="time" required />
        <label>Campo di Gioco</label><input id="match-campo" required />
        <div class="row" style="margin-top:10px">
          <input type="checkbox" id="match-casa" style="max-width:30px; margin-top:0;" />
          <label for="match-casa" style="display:inline-block; margin-top:0; font-weight:400;">Partita in Casa</label>
        </div>
        <div class="actions"><button class="btn btn--admin" type="submit">Inserisci Partita</button></div>
      </form>
    </section>

    <section id="admin-calendario-section" class="content-section">
      <h2>Admin ¬∑ Gestione Calendario & Formazioni</h2>
      <div class="help">Clicca sui pulsanti per gestire Formazione e Candidature. Il risultato si inserisce dalla sezione CRUD Dati.</div>
      <ul id="admin-calendario-list">
        </ul>
    </section>

    <section id="admin-formazione-section" class="content-section">
      <h2 id="admin-formazione-title">Admin ¬∑ Inserisci Formazione</h2>
      <div class="help">Seleziona il ruolo che il giocatore avr√† per la partita. Seleziona 'Assente' per escluderlo. I candidati sono in evidenza.</div>
      <form id="admin-formazione-form">
        <input type="hidden" id="formazione-match-id" />
        <div style="overflow-x:auto;">
          <table class="table">
            <thead><tr><th>Giocatore</th><th>Ruolo Partita</th><th>Ruolo di Squadra</th></tr></thead>
            <tbody id="admin-formazione-body"></tbody>
          </table>
        </div>
        <div class="actions"><button id="formazione-save-btn" class="btn btn--admin" type="submit">Salva Formazione</button></div>
      </form>
    </section>

    <section id="admin-statistiche-section" class="content-section">
      <h2>Admin ¬∑ Inserisci Statistiche Individuali</h2>
      <form id="insert-stat-form">
        <label>Giocatore</label>
        <select id="stat-giocatore-select" required onchange="updateStatForm()">
          <option value="">Caricamento...</option>
        </select>
        
        <label>Gol</label><input id="stat-gol" type="number" min="0" required />
        <label>Assist</label><input id="stat-assist" type="number" min="0" required />
        <label>Presenze</label><input id="stat-presenze" type="number" min="0" required />

        <div class="actions"><button id="stat-save-btn" class="btn btn--admin" type="submit" disabled>Aggiorna Statistiche</button></div>
      </form>
    </section>
    
    <section id="admin-candidature-section" class="content-section">
      <h2>Admin ¬∑ Riepilogo Candidature Totali</h2>
      <ul id="candidature-list">
        </ul>
      <div class="help" style="margin-top:20px;">Per gestire le candidature di una singola partita, usa il pulsante "Gestisci Cand." nella sezione **Calendario Admin**.</div>
    </section>

    <section id="admin-video-section" class="content-section">
        <h2>Admin ¬∑ Inserimento Link Video</h2>
        <div class="help">Seleziona una partita conclusa e incolla il link YouTube degli highlights.</div>
        <label>Partita Conclusa</label>
        <select id="video-partita-select" required>
          <option value="">Caricamento...</option>
        </select>
        <label>Link Video YouTube</label>
        <input id="video-link-input" type="url" placeholder="Esempio: https://youtu.be/ID_VIDEO" required />
        <div class="actions"><button id="save-video-btn" class="btn btn--admin" type="button" disabled>Salva Link Video</button></div>
    </section>


    <section id="admin-gestione-dati-section" class="content-section">
      <h2>Admin ¬∑ CRUD Dati</h2>
      <div class="help">Modifica i dati direttamente nelle celle della tabella per salvarli.</div>

      <h3>Gestione Giocatori</h3>
      <div style="overflow-x:auto;">
        <table class="table" style="min-width:700px">
          <thead><tr><th>Nome</th><th>Cognome</th><th>Num.</th><th>Ruolo</th><th>Stato</th><th>Statistiche (Gol/Assist)</th><th>Azioni</th></tr></thead>
          <tbody id="crud-giocatori-body"></tbody>
        </table>
      </div>

      <h3 style="margin-top:20px;">Gestione Partite</h3>
      <div class="help">Il risultato (es. 3-1) deve essere inserito qui.</div>
      <div style="overflow-x:auto;">
        <table class="table" style="min-width:700px">
          <thead><tr><th>Avversaria</th><th>Data</th><th>Ora</th><th>Campo</th><th>Casa</th><th>Risultato</th><th>Azioni</th></tr></thead>
          <tbody id="crud-partite-body"></tbody>
        </table>
      </div>
      
      <div id="admin-candidature-editor" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; align-items:center; justify-content:center; padding:20px;">
        <div class="card" style="width:100%; max-width:600px; padding:18px;">
          <h3 id="crud-candidature-title" style="margin-top:0;">Gestione Candidature</h3>
          <div class="help">Spunta la casella per considerare il giocatore disponibile. L'UID collegato indica se il giocatore ha un utente (richiede che il giocatore abbia un utente collegato con lo stesso Nome e Cognome in <code>/utenti</code>).</div>
          <table class="table">
            <thead><tr><th>Giocatore</th><th>UID collegato</th><th>Disponibile</th></tr></thead>
            <tbody id="crud-candidature-body"></tbody>
          </table>
          <div class="actions" style="margin-top:10px">
            <button id="crud-candidature-save" class="btn btn--admin" type="button">Salva candidature</button>
            <button class="btn" type="button" onclick="closeCandidatureEditor()">Chiudi</button>
          </div>
        </div>
      </div>
    </section>

    <section id="admin-utenti-section" class="content-section">
      <h2>Admin ¬∑ Inserimento utenti</h2>
      <form id="create-user-form">
        <label>Nome Giocatore</label><input id="new-nome" required />
        <label>Cognome Giocatore</label><input id="new-cognome" required />
        <label>Email</label><input id="new-email" type="email" required />
        <label>Password</label><input id="new-password" type="password" required />
        <div class="actions"><button class="btn btn--admin" type="submit">Crea utenza</button></div>
      </form>
      <div class="help">L‚Äôadmin resta connesso durante la creazione grazie all‚Äôautenticazione secondaria.</div>
    </section>
  </main>
  
  <div id="video-modal">
    <div style="background:var(--ink); padding:0; border-radius:var(--radius); width:90%; max-width:800px; position:relative;">
      <button id="close-video-modal" class="btn btn--accent" type="button">&times;</button>
      <div id="video-iframe-container">
        </div>
    </div>
  </div>

  <footer>
    &copy; 2024 AC Tuscolano. Tutti i diritti riservati.
  </footer>

</body>
</html>
